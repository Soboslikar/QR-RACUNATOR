<!DOCTYPE html>\n<html lang=\"hr\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n  <title>QR RAƒåUNATOR</title>\n  <meta property=\"og:title\" content=\"QR RAƒåUNATOR\" />\n  <meta property=\"og:description\" content=\"Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih raƒçuna i automatsko zbrajanje iznosa. Ukljuƒçuje povijest i pretragu.\"/>\n  <meta name=\"description\" content=\"Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih raƒçuna i automatsko zbrajanje iznosa. Ukljuƒçuje povijest i pretragu.\">\n  <meta property=\"og:type\" content=\"website\" />\n  <meta property=\"og:url\" content=\"https://soboslikar.github.io/QR-RACUNATOR/\" />\n  <script src=\"https://unpkg.com/html5-qrcode\" type=\"text/javascript\"></script>\n  <style>\n    /* CSS (Iz prethodne verzije + ≈°iri gumb + STICKY HEADER + ODABIR KAMERE) */\n    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }\n    body.scanner-view #history-page { display: none; }\n    body.history-view { background-color: white; }\n    /* Osigurava da history-page zauzima cijelu visinu i omoguƒáava flex layout */\n    body.history-view #history-page {\n        display: flex;\n        flex-direction: column;\n        padding: 0; /* Uklonjen padding da sticky header ide do ruba */\n        min-height: calc(100vh - 1em); /* Oduzima body padding */\n        max-height: calc(100vh - 1em); /* Oduzima body padding */\n        box-sizing: border-box;\n        overflow: hidden; /* Sprjeƒçava dvostruki scrollbar */\n    }\n    /* DODANO: Sakrij nove elemente kamere u history view */\n    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator,\n    body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay {\n        display: none !important;\n    }\n    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }\n    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }\n    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }\n    #total-container { position: fixed; top: 23.5em; left: 49%; transform: translateX(-50%); z-index: 5; /* Poveƒáan z-index */ display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; }\n    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }\n    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }\n    #ocisti-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }\n    #ocisti-button.confirm-mode { background-color: yellow; color: black; }\n    #session-name-container { position: fixed; top: 27em; left: 50%; transform: translateX(-50%); z-index: 5; /* Poveƒáan z-index */ display: flex; justify-content: center; align-items: center; min-height: 35px; width: 250px; text-align: center; margin-top: 10px; }\n    #add-name-btn { padding: 0.4em 0.8em; font-size: 0.9em; background-color: #e0e0e0; color: black; display: block; }\n    #session-name-input { font-size: 1.5em; padding: 0.3em 0.5em; border: 1px solid #ccc; border-radius: 3px; width: 220px; display: none; }\n    #session-name-display { font-size: 1.1em; font-weight: bold; color: yellow; background-color: rgba(0, 0, 0, 0.5); padding: 0.3em 0.8em; border-radius: 5px; display: none; align-items: center; gap: 8px; }\n    #session-name-display .edit-icon { cursor: pointer; font-size: 0.8em; font-weight: normal; color: white; text-decoration: underline; }\n    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }\n    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; animation: pulse 0.5s ease-in-out 3 alternate; position: fixed; top: 12.8em; left: 50%; transform: translateX(-50%); z-index: 5; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }\n    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }\n    #delete-warning { font-weight: bold; display: none; text-align: center; position: fixed; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; z-index: 5; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }\n    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }\n    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }\n    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }\n    #history ul { list-style: none; padding: 0; margin: 0; }\n    #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }\n    #history li:last-child { border-bottom: none; }\n    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }\n    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }\n    .red-btn { background: #ff0000; color: yellow; }\n    .yellow-btn { background-color: yellow; color: black; }\n    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }\n    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }\n    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }\n    #share-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); animation: none; }\n    #history-page { display: none; } /* Poƒçetno sakriveno */\n\n    /* --- STICKY HEADER STYLES --- */\n    #history-sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }\n    #history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5em; }\n    /* --- END STICKY HEADER STYLES --- */\n\n    #history-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }\n    #back-to-scanner-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }\n    #back-to-scanner-btn:active { background-color: darkgreen; }\n\n    /* history-content sada treba zauzeti ostatak prostora i skrolati */\n    #history-content { flex-grow: 1; overflow-y: auto; padding: 1em; position: relative; }\n\n     /* Stilovi za liste unutar history-content ostaju isti */\n     #scan-group-list, #all-days-list-rendered, #search-results ul, #search-results-all-days ul { list-style: none; padding: 0; margin: 0; }\n     #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }\n     #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }\n     .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }\n     .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }\n     .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }\n     #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }\n     #detail-scan-list { list-style: none; padding: 0; margin: 0; }\n     #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}\n     #detail-scan-list li:last-child { border-bottom: none; }\n\n     /* Pretraga SVI DANI - sada unutar sticky headera */\n     #all-days-search-container { background-color: white; padding: 0.5em 0; margin-bottom: 0.2em; }\n     #all-days-search-container input { flex-grow: 1; padding: 0.5em; min-width: 50px; font-size: 0.9em; }\n     #all-days-search-container button { padding: 0.5em 0.6em; font-size: 0.9em; flex-shrink: 0; }\n\n     /* Pretraga JEDAN DAN - sada unutar sticky headera */\n      #search-container { display: none; padding: 1em 0; margin-bottom: 1em; }\n      #search-container > div:first-child { display: flex; gap: 10px; margin-bottom: 0.8em; }\n      #search-summary-info-day { display: none; justify-content: space-between; align-items: center; padding: 0.6em 0; font-size: 1.1em; margin-top: 0.8em; border-top: 1px solid #eee; }\n      #search-results { /* Ovaj div OSTAJE u #history-content */ }\n\n     /* Stilovi za prikaz dana/sesija u listi ostaju isti */\n     #all-days-list-rendered li { background-color: #f0f0f0; border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 8px; }\n     #all-days-list-rendered li:hover { background-color: #e0e0e0; }\n\n     /* Sa≈æetak i info elementi - unutar sticky headera */\n     #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }\n    /* Uklanjanje gornje linije za prvi element u dynamic headeru */\n     #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }\n\n     /* Specifiƒçni stilovi koji overrideaju gornje */\n     #all-days-summary-info, #search-summary-info-day { display: none; justify-content: space-between; align-items: center; font-size: 1.1em; }\n     #history-date-info, #history-summary-info, #detail-summary-info { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }\n     #detail-header-info { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.5em; border-bottom: 1px solid #ccc; border-top: none; }\n     #detail-summary-info { border-top: none; }\n     #all-days-search-container { padding-bottom: 0.2em; border-bottom: 1px solid #eee; }\n     #search-container { display: none; border-bottom: 1px solid #eee; }\n\n    /* --- NOVI STILOVI --- */\n    #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }\n    #running-text-container span { display: inline-block; padding-left: 100%; font-size: 1.4em; font-weight: bold; color: yellow; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); animation: marquee 8s linear infinite; white-space: pre; /* <<< DODANA OVA LINIJA */}\n    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }\n\n    #share-prompt-overlay {\n        position: absolute;\n        top: 7em;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 60%;\n        height: auto;\n        background-color: rgba(0, 0, 0, 0.75);\n        color: lightgreen;\n        font-size: 1.3em;\n        font-weight: bold;\n        text-align: center;\n        padding: 1.5em 1em;\n        border-radius: 10px;\n        z-index: 4;\n        display: none;\n        box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n        line-height: 1.4;\n        align-items: center;\n        justify-content: center;\n    }\n    /* IZMJENA: Uklonjena pozadina kvaƒçice */\n    #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }\n\n    /* NOVI Stil za gumb za promjenu kamere */\n    #switch-camera-btn {\n        position: fixed; /* Zaljepljen za ekran */\n        top: 10px;       /* Udaljenost od vrha */\n        right: 10px;     /* Udaljenost od desnog ruba */\n        z-index: 5;      /* Iznad #reader, ali ispod nekih poruka mo≈æda */\n        padding: 6px 8px; /* Malo veƒái padding */\n        background-color: rgba(0, 0, 0, 0.5); /* Poluprozirna pozadina */\n        color: white;\n        border: none;\n        border-radius: 50%; /* Okrugli gumb */\n        font-size: 1.4em;  /* Veliƒçina ikonice */\n        line-height: 1;    /* Da ikonica bude centrirana */\n        cursor: pointer;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n        display: none; /* Poƒçetno skriven, JS ga prikazuje */\n    }\n    #switch-camera-btn:active {\n        background-color: rgba(0, 0, 0, 0.7);\n    }\n\n    /* NOVI Stil za overlay s popisom kamera */\n    #camera-selection-overlay {\n        position: fixed; /* Zaljepljen za ekran */\n        top: 55px;       /* Ispod gumba (prilagodi ako treba) */\n        right: 10px;\n        background-color: white;\n        border: 1px solid #ccc;\n        border-radius: 5px;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n        z-index: 6;      /* Iznad gumba */\n        padding: 5px 0; /* Gore/dolje padding */\n        display: none;   /* Poƒçetno skriven */\n        max-height: 150px; /* Ograniƒçenje visine ako ima puno kamera */\n        overflow-y: auto; /* Scroll ako treba */\n        min-width: 150px; /* Minimalna ≈°irina */\n    }\n    #camera-list {\n        list-style: none;\n        padding: 0;\n        margin: 0;\n    }\n    #camera-list li {\n        padding: 8px 12px;\n        cursor: pointer;\n        font-size: 0.9em;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n    }\n    #camera-list li:hover {\n        background-color: #f0f0f0;\n    }\n    #camera-list li.selected-camera { /* Opcionalno: za oznaƒçavanje trenutne */\n        font-weight: bold;\n        background-color: #e0e0e0;\n    }\n\n    /* --- KRAJ NOVIH STILOVA --- */\n\n    @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }\n    @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } } /* Poveƒáan s 1s na 1.5s */\n    @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }\n  </style>\n</head>\n<body class=\"scanner-view\">\n\n  <div id=\"counter-deactivated-indicator\" style=\"display: none;\">‚úî</div>\n  <div id=\"header\">QR RAƒåUNATOR</div>\n  <div id=\"scan-instruction\">Pozicioniraj qr kod unutar kvadrata kamere</div>\n  <div id=\"running-text-container\" style=\"display: none;\"><span></span></div>\n  <div id=\"share-prompt-overlay\" style=\"display: none;\">KLIKNI ZELENI GUMB<br>I PODIJELI RAƒåUNATOR<br>PORUKA ƒÜE NESTATI</div>\n\n  <div id=\"reader\"></div>\n\n  <!-- NOVI ELEMENTI za odabir kamere -->\n  <button id=\"switch-camera-btn\" style=\"display: none;\">üîÑ</button>\n  <div id=\"camera-selection-overlay\" style=\"display: none;\">\n      <ul id=\"camera-list\"></ul>\n  </div>\n  <!-- KRAJ NOVIH ELEMENATA -->\n\n  <div id=\"loaded-message\" style=\"display: none;\">UƒåITANO</div>\n  <div id=\"duplicate-warning\" style=\"display: none;\">TAJ RAƒåUN JE URAƒåUNAT</div>\n  <div id=\"total-container\"> <div id=\"total\">UKUPNO: 0.00 ‚Ç¨</div> <button id=\"ocisti-button\" onclick=\"startOcistiConfirm()\" style=\"display: none;\">SPREMI<br>I OƒåISTI</button> </div>\n  <div id=\"session-name-container\"> <button id=\"add-name-btn\" onclick=\"startAddName()\">DODAJ NAZIV</button> <input type=\"text\" id=\"session-name-input\" placeholder=\"Unesi naziv sesije...\" maxlength=\"30\"> <span id=\"session-name-display\"> <span id=\"session-name-text\"></span> <span class=\"edit-icon\" onclick=\"startAddName()\">Uredi</span> </span> </div>\n  <div id=\"invoice-count\">0 RAƒåUNA</div>\n  <div id=\"history\" style=\"display: none;\"> <ul id=\"historyList\"></ul> </div>\n  <button class=\"red-btn\" id=\"remove-from-list-btn\" onclick=\"startRemoveFromList()\" style=\"display:none;\">Obri≈°i iz liste</button>\n  <button id=\"history-toggle-btn\">POVIJEST</button>\n  <button id=\"share-button\" style=\"display: none;\">DIJELI RAƒåUNATOR</button>\n  <div id=\"delete-warning\" style=\"display: none;\"></div>\n\n  <div id=\"history-page\">\n      <div id=\"history-sticky-header\">\n          <div id=\"history-header\"> <button id=\"back-to-scanner-btn\">< NA SKENER</button> <h1>POVIJEST</h1> </div>\n          <div id=\"history-dynamic-header-content\"></div>\n      </div>\n      <div id=\"history-content\"></div>\n  </div>\n\n  <audio id=\"scan-sound\" src=\"https://actions.google.com/sounds/v1/cartoon/pop.ogg\" preload=\"auto\"></audio>\n  <audio id=\"click-sound\" src=\"https://cdn.jsdelivr.net/gh/himalayasingh/music-player-1@master/music/2.mp3\" preload=\"auto\"></audio>\n  <audio id=\"remove-sound\" src=\"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg\" preload=\"auto\"></audio>\n\n  <script>\n    // *** GLOBALNE VARIJABLE I KONSTANTE ***\n    const MAX_HISTORY_ITEMS = 500;\n    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';\n    const COUNTER_KEY = 'qrCalculatorCounter';\n    const COUNTER2_KEY = 'qrCalculatorCounter2';\n    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';\n    // Molim VAS provjerite ovaj URL i zamijenite ga SVOJIM Apps Script URL-om!\n    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMqcnA/exec'; // PAZNJA: PROVJERITE URL!!!\n    const CAMERA_ID_KEY = 'qrCalculatorSelectedCameraID'; // KLJUƒå za spremanje odabranog ID-a kamere\n\n    let ukupno = 0;\n    let povijest = [];\n    let removeConfirm = false;\n    let ocistiConfirm = false;\n    const removeBtnInitialText = 'Obri≈°i iz liste';\n    const ocistiBtnInitialText = 'SPREMI<br>I OƒåISTI';\n    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';\n    let html5QrCodeInstance = null;\n    let isScannerActive = false; // Flag za praƒáenje stanja skenera\n    let visibilityListenerAttached = false;\n    let currentSessionName = null;\n    let removeNameConfirm = false;\n    let currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);\n    let previousHistoryViewState = 'day-view';\n    let lastSearchTerm = '';\n    let brojac = 0;\n    let brojac2 = 0;\n    let tekstPoruka = \"\";\n    let isCounterDecrementActive = true;\n\n    // Kljuƒçevi za localStorage za UserID i nesaƒçuvanu sesiju\n    const USER_ID_KEY = 'qrCalculatorUserID';\n    const FIRST_USE_KEY = 'qrCalculatorFirstUseTimestamp';\n    const UNSAVED_COUNT_KEY = 'qrCalculatorUnsavedCount';\n    const UNSAVED_AMOUNT_KEY = 'qrCalculatorUnsavedAmount';\n\n    // Placeholderi za ID i prvi timestamp\n    let currentUserID = null;\n    let firstUseTimestamp = null;\n\n    // DOM Elementi (DEKLARIRANI GLOBALNO, DODIJELJENI u DOMContentLoaded)\n    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator;\n    // NOVI DOM Elementi za kameru\n    let switchCameraButton, cameraSelectionOverlay, cameraListUl;\n\n\n    // *** POMOƒÜNE FUNKCIJE ***\n    const parseTime = (timeStr) => { if (!timeStr || typeof timeStr !== 'string' || timeStr === '??:??' || timeStr.length !== 5 || timeStr[2] !== ':') return -1; const parts = timeStr.split(':'); const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return -1; return hours * 60 + minutes; };\n    function playSound(id) { const sound = document.getElementById(id); if (sound) { sound.pause(); sound.currentTime = 0; sound.play().catch(error => { if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') console.warn(`Zvuk \"${id}\" gre≈°ka:`, error); }); } else console.warn(`Audio element \"${id}\" nije pronaƒëen.`); }\n    function getISODateString(date) { if (!(date instanceof Date) || isNaN(date)) { console.error(\"getISODateString primio neispravan datum:\", date); return null; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }\n      function normalizeDateForSearch(dateString) {\n        if (!dateString || typeof dateString !== 'string') return null;\n        let cleanedString = dateString.trim().replace(/[.\\s]$/, '');\n        cleanedString = cleanedString.replace(/\\s/g, '');\n        const parts = cleanedString.split(/[.\\/\\-]/);\n        if (parts.length === 3) {\n            let [d, m, y] = parts.map(part => parseInt(part.trim(), 10));\n            if (isNaN(d) || isNaN(m) || isNaN(y) || d < 1 || d > 31 || m < 1 || m > 12 || y < 0) { return cleanedString.toLowerCase(); }\n            if (y >= 0 && y <= 99) { const currentYear = new Date().getFullYear(); const currentCentury = Math.floor(currentYear / 100) * 100; const yearWithCentury = currentCentury + y; y = yearWithCentury; if (y < 1970 || y > currentYear + 50) { return cleanedString.toLowerCase(); } } else if (y < 1970 || y > new Date().getFullYear() + 50) { return cleanedString.toLowerCase(); }\n             const finalYear = y; const finalMonth = String(m).padStart(2, '0'); const finalDay = String(d).padStart(2, '0'); const isoDate = `${finalYear}-${finalMonth}-${finalDay}`; return isoDate;\n        }\n        return cleanedString.toLowerCase();\n    }\n    function showTemporaryMessage(messageText, duration = 1500) { if (!loadedMsg) return; loadedMsg.innerText = messageText; loadedMsg.style.display = 'block'; loadedMsg.style.animation = 'none'; loadedMsg.offsetHeight; loadedMsg.style.animation = 'zoomFade 1s ease-out'; setTimeout(() => { if (loadedMsg && loadedMsg.innerText === messageText) { loadedMsg.style.display = 'none'; } }, duration); }\n\n    // Generisanje jednostavnog UUID-a\n    function generateUUID() {\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n      });\n    }\n\n    // Dobijanje ili kreiranje UserID i FirstUseTimestamp\n    function initializeUserTracking() {\n      currentUserID = localStorage.getItem(USER_ID_KEY);\n      firstUseTimestamp = localStorage.getItem(FIRST_USE_KEY);\n\n      if (!currentUserID) {\n        console.log(\"Generiram novi UserID i FirstUseTimestamp.\");\n        currentUserID = generateUUID();\n        firstUseTimestamp = new Date().toISOString();\n        try {\n          localStorage.setItem(USER_ID_KEY, currentUserID);\n          localStorage.setItem(FIRST_USE_KEY, firstUseTimestamp);\n        } catch (error) {\n          console.error(\"Gre≈°ka spremanja UserID/FirstUse u localStorage:\", error);\n          currentUserID = 'localStorage_error_' + generateUUID(); // Fallback ID\n          firstUseTimestamp = new Date().toISOString();\n        }\n      }\n      console.log(\"UserID:\", currentUserID, \"FirstUse:\", firstUseTimestamp);\n    }\n\n    // Funkcija za slanje log podataka\n    async function sendLogData(eventData) {\n      // PAZNJA: PROVJERITE URL!\n      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMqcnA')) { // Dodao provjeru za default placeholder URL\n          console.warn(\"Logovanje onemoguƒáeno: APPS_SCRIPT_URL nije postavljen ili je placeholder.\");\n          return;\n      }\n      const dataToSend = {\n          ...eventData,\n          UserID: currentUserID,\n          FirstUseTimestamp: firstUseTimestamp,\n          Timestamp: new Date().toISOString(),\n          Counter1: brojac,\n          Counter2: brojac2,\n          Active: isCounterDecrementActive,\n          UserAgent: navigator.userAgent\n      };\n      console.log(`Poku≈°avam poslati log '${dataToSend.Event}':`, dataToSend);\n      try {\n          // Koristimo 'no-cors' mode jer Apps Script web app vraƒáa CORS header '*'\n          // U nekim sluƒçajevima fetch bez cors moda mo≈æe proƒái i bez OPTIONS pre-flight\n          const response = await fetch(APPS_SCRIPT_URL, {\n              method: 'POST',\n              mode: 'no-cors', // Va≈æno za slanje na Apps Script\n              cache: 'no-cache',\n              // headers: {'Content-Type': 'text/plain;charset=utf-8'}, // Nije potrebno u no-cors modu, a mo≈æe i smetati\n              redirect: 'follow',\n              body: JSON.stringify(dataToSend)\n          });\n          // U 'no-cors' modu ne mo≈æemo provjeriti response.ok ili status\n          console.log(`Log zahtev '${dataToSend.Event}' poslan (no-cors). Proverite Apps Script logove za potvrdu uspeha.`);\n      } catch (error) {\n          console.error(`Gre≈°ka prilikom slanja loga '${dataToSend.Event}':`, error);\n      }\n    }\n\n\n    // *** FUNKCIJE ZA LOKALNU POHRANU ***\n    function saveFullHistoryToLocalStorage(fullHistory) { try { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(fullHistory)); console.log(\"Puna povijest spremljena.\"); } catch (error) { console.error(\"Gre≈°ka spremanja:\", error); alert(\"Gre≈°ka: Nije moguƒáe spremiti povijest.\"); } }\n    function loadFullHistoryFromLocalStorage() { try { const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY); if (historyJson) { const loadedHistory = JSON.parse(historyJson); return loadedHistory.map(group => ({ timestamp: group.timestamp || Date.now(), lastQrTime: group.lastQrTime || '??:??', name: group.name || null, racuni: Array.isArray(group.racuni) ? group.racuni.map(item => ({ ...item, scanTimestamp: item.scanTimestamp || 0 })) : [] })); } return []; } catch (error) { console.error(\"Gre≈°ka uƒçitavanja:\", error); return []; } }\n    function loadCountersState() { const storedBrojac = localStorage.getItem(COUNTER_KEY); const storedBrojac2 = localStorage.getItem(COUNTER2_KEY); const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY); brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null; brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 10) : 0; isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true; if (isNaN(brojac)) brojac = null; if (isNaN(brojac2)) brojac2 = 0; console.log(\"Uƒçitano stanje:\", { brojac, brojac2, isCounterDecrementActive }); updateDeactivatedIndicator(); }\n    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }\n    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }\n    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }\n\n    // *** FUNKCIJE ZA DOHVAƒÜANJE PODATAKA IZ SHEETA ***\n    async function fetchSheetData() { console.log(\"Poku≈°avam dohvatiti podatke iz Google Sheeta...\"); if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMqcnA')) { console.warn(\"URL Google Apps Scripta nije postavljen ili je placeholder!\"); tekstPoruka = \"\"; initializeCounters(); updateRunningText(); return Promise.reject(new Error(\"URL nije postavljen\")); } try { const response = await fetch(APPS_SCRIPT_URL); if (!response.ok) { throw new Error(`HTTP gre≈°ka ${response.status}`); } const data = await response.json(); console.log(\"Podaci dohvaƒáeni:\", data); let newPrag = data.pragBrojac !== undefined ? parseInt(data.pragBrojac, 10) : 0; if (isNaN(newPrag) || newPrag < 0) { newPrag = 0; } else if (newPrag > 500) { newPrag = 500; } brojac2 = newPrag; saveBrojac2(); tekstPoruka = data.trceciTekst || \"\"; initializeCounters(); updateRunningText(); return Promise.resolve(); } catch (error) { console.error(\"Gre≈°ka pri dohvaƒáanju podataka iz Sheeta:\", error); tekstPoruka = \"\"; initializeCounters(); updateRunningText(); return Promise.reject(error); } }\n\n    // *** INICIJALIZACIJA BROJAƒåA ***\n    function initializeCounters() { console.log(\"Inicijalizacija brojaƒça...\"); if (brojac === null) { console.log(\"Brojaƒç 1 nije inicijaliziran, postavljanje na brojaƒç 2.\"); brojac = brojac2; saveBrojac(); } else { console.log(\"Brojaƒç 1 uƒçitan s vrijedno≈°ƒáu:\", brojac); } checkSharePrompt(); updateRunningTextVisibility(); }\n\n    // *** FUNKCIJE ZA A≈ΩURIRANJE PRIKAZA ***\n    function checkOcistiButtonVisibility() { if (!ocistiButton) return; ocistiButton.style.display = (povijest.length > 0 && ukupno > 0) ? 'block' : 'none'; if ((povijest.length === 0 || ukupno <= 0) && ocistiConfirm) { resetOcistiMode(); } }\n    function updateDisplay() { if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} ‚Ç¨`; const count = povijest.length; if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAƒåUN' : 'RAƒåUNA'}`; if (document.body.classList.contains('scanner-view')) { updateSmallHistoryList(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); checkOcistiButtonVisibility(); updateNameDisplay(); } };\n    function updateSmallHistoryList() { if (!historyList || !historyDiv) return; if (povijest.length > 0) { historyDiv.style.display = 'block'; historyList.innerHTML = ''; const recentHistory = povijest; recentHistory.forEach((item, index) => { const globalIndex = povijest.length - recentHistory.length + index; const listItem = document.createElement('li'); listItem.innerText = `${globalIndex + 1}. ${item.time} - ${item.amount.toFixed(2)} ‚Ç¨`; historyList.appendChild(listItem); }); historyDiv.scrollTop = historyDiv.scrollHeight; } else { historyDiv.style.display = 'none'; } }\n    function checkRemoveButtonVisibility() { if (!removeButton) return; removeButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if (povijest.length === 0 && !currentSessionName && (removeConfirm || removeNameConfirm)) resetRemoveMode(); }\n    function handleInfoDeleteMessageVisibility() { const isScannerView = document.body.classList.contains('scanner-view'); if (!deleteWarningDiv || !isScannerView) { if(deleteWarningDiv) deleteWarningDiv.style.display = 'none'; return; } let shouldDisplay = false, textToShow = '', modeClass = ''; if (removeConfirm && povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; textToShow = `OBRI≈†I ${lastItem.time} = ${lastItem.amount.toFixed(2)} ‚Ç¨?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (removeNameConfirm && currentSessionName) { textToShow = `OBRI≈†I NAZIV \"${currentSessionName}\"?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length > 0 && deleteWarningDiv.dataset.lastScanText) { textToShow = deleteWarningDiv.dataset.lastScanText; modeClass = 'info-mode'; shouldDisplay = true; } if (shouldDisplay) { deleteWarningDiv.innerText = textToShow; deleteWarningDiv.className = `delete-warning ${modeClass}`; deleteWarningDiv.style.display = 'block'; } else { deleteWarningDiv.style.display = 'none'; } }\n    function updateRunningText() { if (runningTextSpan) { runningTextSpan.textContent = tekstPoruka; } updateRunningTextVisibility(); }\n    function updateRunningTextVisibility() { const shouldShowText = tekstPoruka && (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') && document.body.classList.contains('scanner-view'); if (runningTextContainer) { runningTextContainer.style.display = shouldShowText ? 'block' : 'none'; if (shouldShowText && runningTextSpan) { runningTextSpan.style.animation = 'none'; runningTextSpan.offsetHeight; runningTextSpan.style.animation = ''; } } }\n    function checkSharePrompt() { const shouldShowPrompt = brojac === 0 && brojac2 > 0 && document.body.classList.contains('scanner-view'); if (sharePromptOverlay) { sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none'; updateRunningTextVisibility(); } }\n    function updateDeactivatedIndicator() { if (counterDeactivatedIndicator) { counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view')) ? 'block' : 'none'; } }\n\n    // *** FUNKCIJE ZA RESETIRANJE STANJA GUMBA ***\n    function resetRemoveMode() { if (!removeButton) return; removeButton.innerText = removeBtnInitialText; removeButton.classList.remove('yellow-btn'); removeButton.classList.add('red-btn'); removeConfirm = false; removeNameConfirm = false; if (deleteWarningDiv && deleteWarningDiv.dataset.beforeConfirmText) { deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.beforeConfirmText; } else if (deleteWarningDiv && povijest.length === 0) { delete deleteWarningDiv.dataset.lastScanText; } handleInfoDeleteMessageVisibility(); checkRemoveButtonVisibility(); }\n    function resetOcistiMode() { if (!ocistiButton) return; ocistiButton.innerHTML = ocistiBtnInitialText; ocistiButton.classList.remove('confirm-mode'); ocistiConfirm = false; checkOcistiButtonVisibility(); }\n\n    // *** FUNKCIJE ZA NAZIV SESIJE ***\n    function startAddName() { if (!addNameBtn || !sessionNameInput || !sessionNameDisplay) return; playSound('click-sound'); addNameBtn.style.display = 'none'; sessionNameDisplay.style.display = 'none'; sessionNameInput.style.display = 'block'; sessionNameInput.value = currentSessionName || ''; sessionNameInput.focus(); sessionNameInput.select(); }\n\n    // Modificirana saveName funkcija\n    function saveName() {\n        if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return;\n        const inputText = sessionNameInput.value.trim();\n\n        if (inputText === \"##--##\") {\n            showTemporaryMessage(\"RJE≈†ENO\");\n            isCounterDecrementActive = false;\n            saveCounterActiveState();\n            updateDeactivatedIndicator();\n            sessionNameInput.value = '';\n            sessionNameInput.style.display = 'none';\n            updateNameDisplay();\n            checkRemoveButtonVisibility();\n            return;\n        } else if (inputText === \"##00##\") {\n            showTemporaryMessage(\"RESETIRANO\");\n            brojac = 0;\n            brojac2 = 0;\n            isCounterDecrementActive = true;\n            saveBrojac();\n            saveBrojac2();\n            saveCounterActiveState();\n            localStorage.removeItem(CAMERA_ID_KEY); // <<< RESETIRAJ SPREMLJENU KAMERU\n            updateDeactivatedIndicator();\n            sessionNameInput.value = '';\n            sessionNameInput.style.display = 'none';\n            updateNameDisplay();\n            checkSharePrompt();\n            updateRunningTextVisibility();\n            checkRemoveButtonVisibility();\n            // Opcionalno: restartaj skener da primijeni default kameru\n            // if (document.body.classList.contains('scanner-view') && isScannerActive) {\n            //     stopScanner().then(() => setTimeout(initializeScanner, 100)); // Dodan setTimeout\n            // }\n            return;\n        }\n        const newName = inputText;\n        currentSessionName = newName || null;\n        sessionNameInput.style.display = 'none';\n        updateNameDisplay();\n        checkRemoveButtonVisibility();\n    }\n\n    function updateNameDisplay() { if (!addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (currentSessionName) { sessionNameText.textContent = currentSessionName; sessionNameDisplay.style.display = 'flex'; addNameBtn.style.display = 'none'; } else { sessionNameDisplay.style.display = 'none'; addNameBtn.style.display = 'block'; } }\n\n    // *** FUNKCIJE ZA UPRAVLJANJE TRENUTNOM SESIJOM SKENIRANJA ***\n    function startRemoveFromList() { if (!removeButton || !document.body.classList.contains('scanner-view')) return; if (removeNameConfirm) { playSound('remove-sound'); currentSessionName = null; resetRemoveMode(); updateNameDisplay(); return; } if (removeConfirm) { if (povijest.length > 0) { const removed = povijest.pop(); ukupno -= removed.amount; playSound('remove-sound'); if (povijest.length === 0 && currentSessionName) { removeButton.innerHTML = 'Obri≈°i<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; handleInfoDeleteMessageVisibility(); } else { if (povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; if (deleteWarningDiv) deleteWarningDiv.dataset.lastScanText = `ZADNJI RAƒåUN: ${lastItem.time} = ${lastItem.amount.toFixed(2)} ‚Ç¨`; } else { if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText; } resetRemoveMode(); } } else { resetRemoveMode(); } updateDisplay(); return; } if (povijest.length > 0) { removeButton.innerText = 'Potvrdi'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = true; removeNameConfirm = false; playSound('click-sound'); if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmText = deleteWarningDiv.dataset.lastScanText; if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText; handleInfoDeleteMessageVisibility(); } else if (currentSessionName) { removeButton.innerHTML = 'Obri≈°i<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; playSound('click-sound'); handleInfoDeleteMessageVisibility(); } }\n    function startOcistiConfirm() { if (!ocistiButton || !document.body.classList.contains('scanner-view')) return; if (!ocistiConfirm) { ocistiButton.innerHTML = ocistiConfirmText; ocistiButton.classList.add('confirm-mode'); ocistiConfirm = true; playSound('click-sound'); } else { ocistiTrenutnoSkeniranje(); resetOcistiMode(); } }\n\n    // Funkcija za spremanje sesije\n    function ocistiTrenutnoSkeniranje() {\n        if (povijest.length === 0 && !currentSessionName) return;\n        const vrijemeCiscenja = Date.now();\n        const sortiraniRacuniZaSpremanje = [...povijest].sort((a, b) => { const timeA = parseTime(a.time); const timeB = parseTime(b.time); if (timeA === -1 && timeB !== -1) return -1; if (timeA !== -1 && timeB === -1) return 1; if (timeA === -1 && timeB === -1) return (a.scanTimestamp || 0) - (b.scanTimestamp || 0); return timeA - timeB; });\n        let zadnjeValidnoVrijemeIzSortiraneListe = '??:??';\n        for (let i = sortiraniRacuniZaSpremanje.length - 1; i >= 0; i--) { if (sortiraniRacuniZaSpremanje[i].time && sortiraniRacuniZaSpremanje[i].time !== '??:??') { zadnjeValidnoVrijemeIzSortiraneListe = sortiraniRacuniZaSpremanje[i].time; break; } }\n        const novaGrupa = {\n            timestamp: vrijemeCiscenja,\n            lastQrTime: zadnjeValidnoVrijemeIzSortiraneListe,\n            name: currentSessionName || null,\n            racuni: sortiraniRacuniZaSpremanje\n        };\n        console.log(\"Spremam sesiju:\", novaGrupa);\n        let punaPovijest = loadFullHistoryFromLocalStorage();\n        punaPovijest.push(novaGrupa);\n        saveFullHistoryToLocalStorage(punaPovijest);\n        const sessionTotalAmount = novaGrupa.racuni.reduce((sum, item) => sum + item.amount, 0);\n        const sessionDetails = { sessionName: novaGrupa.name, invoiceCount: novaGrupa.racuni.length, totalAmount: sessionTotalAmount.toFixed(2), lastQrTime: novaGrupa.lastQrTime };\n        const eventData = { Event: 'session_saved', Details: JSON.stringify(sessionDetails) };\n        sendLogData(eventData);\n        try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); console.log(\"Obrisano nesaƒçuvano stanje nakon spremanja sesije.\"); } catch (lsError) { console.error(\"Gre≈°ka brisanja nesaƒçuvanog stanja iz localStorage:\", lsError); }\n        povijest = [];\n        ukupno = 0;\n        currentSessionName = null;\n        if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.beforeConfirmText; }\n        resetRemoveMode();\n        resetOcistiMode();\n        updateDisplay();\n        console.log(\"Trenutna sesija spremljena i oƒçi≈°ƒáena.\");\n        alert(\"Skeniranje spremljeno u povijest!\");\n    }\n\n    // *** OBRADA SKENIRANOG QR KODA ***\n    function handleScan(decodedText) {\n        // Resetiranje confirmation stanja ako sken proradi\n        if (removeNameConfirm) resetRemoveMode();\n        if (removeConfirm) resetRemoveMode();\n        if (ocistiConfirm) resetOcistiMode();\n        if (loadedMsg) loadedMsg.style.display = 'none'; // Sakrij privremene poruke\n        if (duplicateWarning) duplicateWarning.style.display = 'none';\n\n        // Validacija QR koda i izvlaƒçenje iznosa i vremena\n        try {\n            const qrParts = decodedText.split('?');\n            if (qrParts.length < 2) {\n                 console.warn(\"Skeniran nepoznati QR kod:\", decodedText);\n                // Ovdje mo≈æete dodati privremenu poruku korisniku\n                 showTemporaryMessage(\"Nije fiskalni raƒçun?\", 1500);\n                 return; // Ignoriraj nepoznati format\n            }\n            const params = new URLSearchParams(qrParts[1]);\n            const iznosCentStr = params.get('izn');\n            const datv = params.get('datv'); // Datum i vrijeme\n            const bRac = params.get('br'); // Broj raƒçuna\n            const bPos = params.get('bp'); // Broj poslovnice\n            const bNap = params.get('bn'); // Broj naplatnog ureƒëaja\n             const u = params.get('u'); // Ukupni iznos na raƒçunu (trebalo bi biti isto kao izn)\n\n            if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) {\n                 console.warn(\"QR kod nema validan 'izn' parametar:\", decodedText);\n                 showTemporaryMessage(\"Nije fiskalni raƒçun.\", 1500);\n                 return; // Ignoriraj ako nema iznosa\n            }\n\n            const iznosCenti = parseFloat(iznosCentStr);\n            const iznosEura = iznosCenti / 100;\n\n            // Provjera duplikata\n            // 1. U trenutnoj sesiji\n            const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText);\n\n            // 2. U spremljenim sesijama (unutar zadnjih 30 dana)\n            let isDuplicateInRecentSaved = false;\n            const fullHistory = loadFullHistoryFromLocalStorage();\n            if (fullHistory.length > 0) {\n                 const thirtyDaysAgoTimestamp = Date.now() - (30 * 24 * 60 * 60 * 1000); // Timestamp prije 30 dana\n                 // Filtriraj samo sesije unutar zadnjih 30 dana radi performansi\n                 const recentHistory = fullHistory.filter(grupa => (grupa.timestamp || 0) >= thirtyDaysAgoTimestamp);\n                 isDuplicateInRecentSaved = recentHistory.some(grupa =>\n                     Array.isArray(grupa.racuni) && grupa.racuni.some(item => item.qrCode === decodedText)\n                 );\n                 if(isDuplicateInRecentSaved) console.log(\"Duplikat pronaƒëen u zadnjih 30 dana spremljene povijesti.\");\n            }\n\n            if (isDuplicateInCurrent || isDuplicateInRecentSaved) {\n                console.warn(\"Duplikat pronaƒëen:\", decodedText);\n                if (duplicateWarning) {\n                    duplicateWarning.style.display = 'block';\n                    // Reset animacije\n                    duplicateWarning.style.animation = 'none';\n                    duplicateWarning.offsetHeight; // Trigger reflow\n                    duplicateWarning.style.animation = 'pulse 0.5s ease-in-out 3 alternate';\n                    setTimeout(() => {\n                        if (duplicateWarning) duplicateWarning.style.display = 'none';\n                    }, 1500);\n                }\n                return; // Ne dodaj duplikat\n            }\n\n            // Parsiranje vremena (pobolj≈°ano rukovanje razliƒçitim formatima i gre≈°kama)\n            let time = '??:??';\n            if (datv && typeof datv === 'string' && datv.length >= 12) { // Minimalna du≈æina za hhmmSS format unutar YYYYMMDD\n                const timePartIndex = 8; // Vrijeme poƒçinje nakon 8 znakova datuma (YYYYMMDD)\n                if (datv.length >= timePartIndex + 4) { // Provjeri ima li barem hhmm\n                    const hourStr = datv.substring(timePartIndex, timePartIndex + 2);\n                    const minuteStr = datv.substring(timePartIndex + 2, timePartIndex + 4);\n                    const hour = parseInt(hourStr, 10);\n                    const minute = parseInt(minuteStr, 10);\n                    if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {\n                         time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;\n                    } else {\n                         time = '??:??';\n                         console.warn(`Neva≈æeƒái format vremena u datv '${datv}'`, decodedText);\n                    }\n                } else {\n                     time = '??:??';\n                     console.warn(`datv prekratak za vrijeme '${datv}'`, decodedText);\n                }\n            } else {\n                 time = '??:??';\n                 console.warn(`datv nedostaje ili nije string '${datv}'`, decodedText);\n            }\n\n\n            if (instructionDiv) instructionDiv.style.display = 'none'; // Sakrij uputu nakon prvog skena\n\n            // Kreiraj novi item i dodaj ga u povijest\n            const newItem = {\n                amount: iznosEura,\n                qrCode: decodedText,\n                time: time,\n                datv: datv || '', // Saƒçuvaj cijeli datv string\n                 // Saƒçuvaj i ostale kljuƒçne podatke ako ih ima, npr. za buduƒáu upotrebu ili logiranje\n                 br: bRac || '',\n                 bp: bPos || '',\n                 bn: bNap || '',\n                 scanTimestamp: Date.now() // Vrijeme skeniranja\n             };\n            povijest.push(newItem);\n            ukupno += iznosEura;\n\n            // Smanji brojaƒç ako je aktivan i veƒái od 0\n            if (isCounterDecrementActive && brojac > 0) {\n                brojac--;\n                console.log(\"Brojaƒç smanjen na:\", brojac);\n                saveBrojac();\n                checkSharePrompt(); // Provjeri treba li prikazati Share Prompt\n            } else {\n                 console.log(\"Brojaƒç nije smanjen. Aktivno:\", isCounterDecrementActive, \"Vrijednost:\", brojac);\n            }\n\n            // Spremi trenutno nesaƒçuvano stanje u localStorage (za sluƒçaj osvje≈æavanja ili crasha)\n            try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error(\"Gre≈°ka spremanja nesaƒçuvanog stanja u localStorage:\", lsError); }\n\n\n            playSound('scan-sound'); // Reproduciraj zvuk uspje≈°nog skena\n            updateDisplay(); // A≈æuriraj UI (ukupno, broj raƒçuna, mala povijest)\n            showTemporaryMessage(\"UƒåITANO\", 1000); // Prikaz privremene poruke\n\n            // A≈æuriraj poruku \"Zadnji raƒçun\"\n            if (deleteWarningDiv) {\n                 deleteWarningDiv.dataset.lastScanText = `ZADNJI RAƒåUN: ${newItem.time} = ${newItem.amount.toFixed(2)} ‚Ç¨`;\n                 handleInfoDeleteMessageVisibility(); // Poka≈æi ili a≈æuriraj poruku\n            }\n\n        } catch (error) {\n            console.error(\"Gre≈°ka obrade QR:\", error, decodedText);\n             // Prikazi generiƒçku gre≈°ku ako obrada QR-a faila unatoƒç validnom formatu\n             showTemporaryMessage(\"Gre≈°ka obrade QR koda.\", 1500);\n            // Sakrij druge poruke koje bi se mogle prikazivati\n            if (loadedMsg) loadedMsg.style.display = 'none';\n            if (duplicateWarning) duplicateWarning.style.display = 'none';\n        }\n    }\n\n\n    // *** FUNKCIJE ZA UPRAVLJANJE SKENEROM ***\n\n    // Pomoƒána funkcija za provjeru je li element skriven (direktno ili preko roditelja)\n    function isElementOrParentHidden(element) {\n        if (!element) return true; // Element ne postoji -> skriven\n        let currentElement = element;\n        while (currentElement && currentElement !== document.body) {\n             // Provjeri display, visibility i opacity\n            const style = window.getComputedStyle(currentElement);\n            if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') {\n                 console.log(`Element ${currentElement.id || currentElement.tagName} je skriven (display, visibility, or opacity).`);\n                return true;\n            }\n             // Mo≈æete dodati provjeru veliƒçine ako sumnjate da se element ne renderira ispravno\n             // No, za potrebe detekcije vidljivosti za kameru, display: none je najva≈æniji.\n            currentElement = currentElement.parentElement;\n        }\n        return false; // Nije pronaƒëen nijedan skriveni roditelj ili sam element\n    }\n\n\n    // Modificirana initializeScanner funkcija\n    function initializeScanner() {\n        console.log(\"[initializeScanner] Pokrenuto.\");\n        if (document.body.classList.contains('history-view')) {\n            console.log(\"[initializeScanner] Veƒá u history view, odustajem.\");\n            return Promise.resolve(); // Vrati resolved promise ako ne radimo ni≈°ta\n        }\n        if (isScannerActive) {\n            console.log(\"[initializeScanner] Skener je veƒá oznaƒçen kao aktivan, odustajem od ponovnog pokretanja.\");\n             // Ipak, ako je oznaƒçen kao aktivan, ali iz nekog razloga ne radi (npr. gre≈°ka koja nije uhvaƒáena),\n             // ovo bi moglo sprijeƒçiti oporavak. Bolje bi bilo provjeriti stanje instance ako je moguƒáe,\n             // ali html5-qrcode ne nudi lako \"is truly scanning\" provjeru.\n             // Za sada ostavljamo ovako, oslanjajuƒái se na isScannerActive flag.\n            return Promise.resolve(); // Vrati resolved promise ako je veƒá aktivan\n        }\n\n        console.log(\"[initializeScanner] Priprema...\");\n        // Oƒçisti prethodne poruke/video. Va≈æno je ovo napraviti PRIJE startanja.\n        if (readerDiv) readerDiv.innerHTML = '';\n        if (instructionDiv) instructionDiv.style.display = 'none'; // Sakrij uputu dok se ne pokrene\n        if (switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb dok kamera ne radi\n        if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay\n\n        // A≈æuriraj UI elemente specifiƒçne za skener\n        checkSharePrompt();\n        updateRunningTextVisibility();\n        updateDeactivatedIndicator();\n\n        // Kreiraj NOVU instancu svaki put kad se initialize pozove? NO.html5-qrcode preporuƒçuje re-use.\n        if (!html5QrCodeInstance) {\n             console.log(\"[initializeScanner] Kreiram novu Html5Qrcode instancu.\");\n             html5QrCodeInstance = new Html5Qrcode(\"reader\");\n        } else {\n             console.log(\"[initializeScanner] Koristim postojeƒáu Html5Qrcode instancu.\");\n        }\n\n        const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };\n\n        // Dohvati kamere. Ova Promise hvata gre≈°ke pristupa (npr. dozvole odbijene).\n        return Html5Qrcode.getCameras().then(devices => {\n            if (!devices || devices.length === 0) {\n                 const msg = \"Nema dostupnih kamera na ureƒëaju.\";\n                 console.error(\"[initializeScanner]\", msg);\n                 if (readerDiv) readerDiv.innerHTML = `<div style=\"padding: 20px; color: red;\">${msg}</div>`;\n                 isScannerActive = false;\n                 html5QrCodeInstance = null; // Nulliraj instancu ako nema kamera ili pristupa\n                 if (switchCameraButton) switchCameraButton.style.display = 'none'; // Nema kamera, nema gumba\n                 if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay\n                 return Promise.reject(new Error(msg));\n            }\n            console.log(\"[initializeScanner] Dostupne kamere:\", devices);\n\n            let selectedCameraId = null;\n            const savedCameraId = localStorage.getItem(CAMERA_ID_KEY);\n\n            // Logika odabira kamere (spremljena > stra≈ænja > prva)\n            if (savedCameraId) {\n                const cameraExists = devices.some(d => d.id === savedCameraId);\n                if (cameraExists) {\n                    console.log(\"[initializeScanner] Koristim spremljenu kameru:\", savedCameraId);\n                    selectedCameraId = savedCameraId;\n                } else {\n                    console.warn(\"[initializeScanner] Spremljena kamera nije pronaƒëena u listi dostupnih, bri≈°em iz localStorage.\");\n                    localStorage.removeItem(CAMERA_ID_KEY);\n                }\n            }\n\n            if (!selectedCameraId) {\n                 // Prioritiziraj stra≈ænju kameru po labvelu\n                const rearCamera = devices.find(d =>\n                    d.label.toLowerCase().includes('back') ||\n                    d.label.toLowerCase().includes('zadnja') ||\n                    d.label.toLowerCase().includes('environment')\n                );\n\n                if (rearCamera) {\n                    console.log(\"[initializeScanner] Nema spremljene ili spremljena nije dostupna. Koristim pronaƒëenu stra≈ænju kameru:\", rearCamera.id);\n                    selectedCameraId = rearCamera.id;\n                } else if (devices.length > 0) {\n                     // Ako nema stra≈ænje po labelu, probaj prvu dostupnu (ƒçesto je to prednja na mobitelima)\n                    console.log(\"[initializeScanner] Nema prepoznate stra≈ænje kamere, koristim prvu dostupnu:\", devices[0].id);\n                    selectedCameraId = devices[0].id;\n                }\n            }\n\n            // Osiguraj da imamo *neki* ID ako ima kamera (ovo bi trebalo biti true ako je devices.length > 0)\n            if (!selectedCameraId && devices.length > 0) {\n                 selectedCameraId = devices[0].id; // Fallback na prvu ako sve propadne\n                 console.warn(\"[initializeScanner] Nije uspio odabir po logici, fallback na prvu dostupnu:\", selectedCameraId);\n            } else if (!selectedCameraId && devices.length === 0) {\n                 // Ovo bi veƒá trebalo biti uhvaƒáeno gore\n                 const msg = \"Nije moguƒáe odabrati kameru (nema dostupnih).\";\n                 console.error(\"[initializeScanner]\", msg);\n                 if (readerDiv) readerDiv.innerHTML = `<div style=\"padding: 20px; color: red;\">${msg}</div>`;\n                 isScannerActive = false;\n                 html5QrCodeInstance = null;\n                 if (switchCameraButton) switchCameraButton.style.display = 'none';\n                 if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';\n                 return Promise.reject(new Error(msg));\n            }\n\n            const finalCameraId = selectedCameraId; // Camera ID to actually attempt to start\n\n            // Provjera vidljivosti elementa ƒçitaƒça prije starta\n            if (!readerDiv || isElementOrParentHidden(readerDiv)) {\n                 const msg = '[initializeScanner] Reader element nije pronaƒëen ili je skriven. Ne mogu startati kameru.';\n                 console.error(msg, readerDiv);\n                 // Prikaz poruke u readerDiv ili unutar body ako readerDiv ne postoji\n                 if (readerDiv) readerDiv.innerHTML = `<div style=\"padding:20px; color: red;\">${msg}<br>Poku≈°ajte osvje≈æiti.</div>`;\n                 else document.body.insertAdjacentHTML('beforeend', `<div style=\"padding: 20px; color: red;\">${msg}</div>`);\n                 isScannerActive = false; // Skener nije aktivan\n                 if (switchCameraButton) switchCameraButton.style.display = 'none'; // Ne mo≈æe startati, nema gumba\n                 if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay\n                 // Ne nulliraj instancu ovdje, mo≈æda se readerDiv pojavi kasnije ili se rije≈°i problem vidljivosti\n                 return Promise.reject(new Error(msg));\n            }\n\n            console.log(`[initializeScanner] Poku≈°avam startati kameru ID: ${finalCameraId}`);\n            // Startaj skener. Ova Promise hvata gre≈°ke specifiƒçne za startanje (npr. OverconstrainedError, nije moguƒáe dobiti stream).\n            return html5QrCodeInstance.start(\n                finalCameraId,\n                qrConfig,\n                handleScan,\n                (errorMessage) => { /* Ignoriraj non-matched QR. Dodati logiku za tihe gre≈°ke ako treba. */ }\n            ).then(() => {\n                console.log(`>>> [initializeScanner] start() OK za kameru ID: ${finalCameraId}`);\n                isScannerActive = true;\n                // Spremi ID *uspje≈°no pokrenute* kamere\n                localStorage.setItem(CAMERA_ID_KEY, finalCameraId);\n                console.log(\"[initializeScanner] Spremljen ID aktivne kamere u localStorage:\", finalCameraId);\n\n                // Poka≈æi gumb za promjenu tek kad je kamera uspje≈°no startala i ako ima vi≈°e opcija\n                if (switchCameraButton && devices.length > 1) {\n                     switchCameraButton.style.display = 'block';\n                }\n                // Sakrij overlay ako je bio otvoren\n                if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';\n\n\n                console.log(\"[initializeScanner] Prikazujem uputu i ve≈æem listener.\");\n                // Prikaz upute SAMO ako je scanner view i skener aktivan\n                if (instructionDiv && document.body.classList.contains('scanner-view')) {\n                    instructionDiv.style.display = 'block';\n                }\n                // Attach visibility listener ƒçim je skener view potencijalno aktivan\n                if (!visibilityListenerAttached) {\n                    attachVisibilityListener();\n                }\n                console.log(\"[initializeScanner] Zavr≈°eno uspje≈°no.\");\n                return Promise.resolve(); // Resolve promise jer je start uspje≈°an\n\n            }).catch(err => {\n                // Gre≈°ka pri startanju kamere (npr. browser je odbio startati odabranu kameru)\n                console.error(`>>> [initializeScanner] start() FAILED za kameru ID ${finalCameraId}:`, err);\n                isScannerActive = false; // Osiguraj da je false\n\n                // !!! KLJUƒåNA PROMJENA: Bri≈°i spremljeni ID ako start ne uspije !!!\n                console.log(\"[initializeScanner] Start kamere neuspje≈°an, bri≈°em spremljeni CAMERA_ID_KEY.\");\n                localStorage.removeItem(CAMERA_ID_KEY);\n\n                // Prikaz specifiƒçne poruke gre≈°ke u readerDiv\n                if (readerDiv) {\n                    let errorMsg = `Gre≈°ka startanja kamere (${err.name || 'UnknownError'}).`;\n                    if (err.message) errorMsg += ` Detalji: ${err.message}`;\n                    if (err.name === 'NotAllowedError') errorMsg += \"<br>Provjerite dozvole preglednika za kameru.\";\n                     else if (err.name === 'NotFoundError') errorMsg += \"<br>Odabrana kamera nije pronaƒëena.\";\n                     else if (err.name === 'OverconstrainedError') errorMsg += \"<br>Kamera ne podr≈æava tra≈æene postavke.\";\n                     else if (err.name === 'NotReadableError') errorMsg += \"<br>Kamera je zauzeta ili nedostupna.\";\n\n                     if (readerDiv) readerDiv.innerHTML = `<div style=\"padding: 20px; color: red;\">${errorMsg}</div>`;\n                }\n                if (instructionDiv) instructionDiv.style.display = 'none';\n\n                 // Poka≈æi gumb AKO je bilo vi≈°e od 1 kamere pronaƒëeno u getCameras,\n                 // ƒçak i ako start faila, da korisnik mo≈æe probati drugu\n                 if (switchCameraButton && devices && devices.length > 1) {\n                     switchCameraButton.style.display = 'block';\n                }\n                 // Sakrij overlay ako je bio otvoren\n                 if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';\n\n\n                // Ovdje NEMOJ nullirati html5QrCodeInstance, treba nam za eventualno startanje druge kamere preko gumba\n                return Promise.reject(err); // Propagiraj gre≈°ku startanja\n            });\n\n        }).catch(err => {\n            // Ovo hvata gre≈°ke iz Html5Qrcode.getCameras() (npr. NotAllowedError - globalno, nema ureƒëaja)\n            console.error(\"[initializeScanner] Gre≈°ka dohvaƒáanja kamera:\", err);\n            isScannerActive = false;\n            if (readerDiv) {\n                let errorMsg = `Gre≈°ka pristupa kamerama (${err.name || 'UnknownError'}).`;\n                if (err.message) errorMsg += ` Detalji: ${err.message}`;\n                if (err.name === 'NotAllowedError') errorMsg += \"<br>Provjerite dozvole preglednika za kameru.\";\n                 else if (err.name === 'NotFoundError') errorMsg += \"<br>Nema dostupnih kamera na ureƒëaju.\";\n\n                 if (readerDiv) readerDiv.innerHTML = `<div style=\"padding: 20px; color: red;\">${errorMsg}</div>`;\n            }\n            if (instructionDiv) instructionDiv.style.display = 'none';\n            if (switchCameraButton) switchCameraButton.style.display = 'none'; // Nema kamera ili pristup odbijen, nema gumba\n             if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay\n\n            // Nulliraj instancu samo ako je globalni problem (npr. nema dozvola, nema ureƒëaja)\n            html5QrCodeInstance = null;\n            return Promise.reject(err); // Propagiraj gre≈°ku getCameras\n        });\n    };\n\n\n    // Modificirana stopScanner funkcija\n    function stopScanner() {\n        console.log(\"[stopScanner] Pokrenuto.\");\n        // Sakrij sve elemente specifiƒçne za skener odmah\n        if(runningTextContainer) runningTextContainer.style.display = 'none';\n        if(sharePromptOverlay) sharePromptOverlay.style.display = 'none';\n        if(counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';\n        if(switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb kad se skener gasi\n        if(cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij i overlay\n        if(instructionDiv) instructionDiv.style.display = 'none'; // Sakrij uputu\n\n\n        const instanceToStop = html5QrCodeInstance; // Koristi referencu na instancu\n        if (instanceToStop && isScannerActive) {\n            console.log(\"[stopScanner] Skener je aktivan, poku≈°avam zaustaviti...\");\n            isScannerActive = false; // Postavi na false PRIJE poziva stop()\n\n            // html5-qrcode stop() vraƒáa Promise\n            return instanceToStop.stop().then(() => {\n                console.log(\"[stopScanner] Skener uspje≈°no zaustavljen.\");\n                if (readerDiv) readerDiv.innerHTML = ''; // Oƒçisti prikaz\n                // Ne treba ni≈°ta vraƒáati, samo resolved promise\n            }).catch(err => {\n                // Gre≈°ka pri stopiranju mo≈æe znaƒçiti da je kamera veƒá bila u lo≈°em stanju.\n                console.warn(\"[stopScanner] Gre≈°ka pri zaustavljanju skenera:\", err);\n                 // Ovdje NE bri≈°i spremljeni ID, jer ≈æelimo poku≈°ati ponovno s istom kamerom ako se vraƒáamo na view\n                 // ili ako ju je korisnik odabrao. Brisanje ID-a se dogaƒëa samo ako start() faila.\n                if (readerDiv) readerDiv.innerHTML = ''; // Oƒçisti prikaz svejedno\n                 // Vrati resolved promise unatoƒç gre≈°ci stopiranja, jer je skener efektivno prestao raditi\n                 // i ≈æelimo da se iduƒáa akcija (npr. initializeScanner) nastavi.\n                 return Promise.resolve(); // Va≈æno: resolve da lanac ide dalje\n            });\n        } else {\n             console.log(\"[stopScanner] Skener nije aktivan ili instanca ne postoji, nema potrebe za zaustavljanjem.\");\n             isScannerActive = false; // Osiguraj da je false\n             if (readerDiv) readerDiv.innerHTML = ''; // Oƒçisti za svaki sluƒçaj\n             return Promise.resolve(); // Vrati resolved promise jer je stanje kao da je zaustavljen\n        }\n    };\n\n\n    // *** NOVE FUNKCIJE za odabir kamere ***\n\n    function toggleCameraSelection() {\n         playSound('click-sound');\n         if (!cameraSelectionOverlay || !cameraListUl || !switchCameraButton) {\n              console.warn(\"toggleCameraSelection: Nedostaju DOM elementi.\");\n              showTemporaryMessage(\"Gre≈°ka u UI elementima kamere.\", 1500);\n              return;\n         }\n\n         // Ako je overlay vidljiv, sakrij ga i izaƒëi\n         if (cameraSelectionOverlay.style.display === 'block') {\n             console.log(\"toggleCameraSelection: Sakrivam overlay (veƒá je bio vidljiv).\");\n             cameraSelectionOverlay.style.display = 'none';\n             return;\n         }\n\n         console.log(\"toggleCameraSelection: Dohvaƒáam kamere za prikaz.\");\n         // Inaƒçe, dohvati kamere i prika≈æi ih\n         Html5Qrcode.getCameras().then(devices => {\n             if (!devices || devices.length <= 1) { // Poka≈æi popis samo ako ih ima > 1 (ukljuƒçujuƒái 0, 1)\n                 const msg = devices && devices.length === 0 ? \"Nema dostupnih kamera.\" : \"Nema vi≈°e kamera za odabir.\";\n                 console.log(\"toggleCameraSelection:\", msg);\n                 showTemporaryMessage(msg, 2000);\n                 if(switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb ako nema opcija\n                 if(cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij za svaki sluƒçaj\n                 return;\n             }\n             console.log(\"toggleCameraSelection: Pronaƒëeno\", devices.length, \"kamera.\");\n\n             cameraListUl.innerHTML = ''; // Oƒçisti prethodni popis\n             // Dohvati trenutno aktivnu (ili zadnje spremljenu) KAD se prikazuje lista\n             const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY);\n             console.log(\"toggleCameraSelection: Trenutno/Spremljena kamera ID\", currentActiveCameraId);\n\n             devices.forEach(device => {\n                 const listItem = document.createElement('li');\n                 // Prikaz labela mo≈æe biti dug, koristi textContent\n                 listItem.textContent = device.label || `Kamera ID: ${device.id.substring(0, 8)}...`; // Fallback label\n                 listItem.dataset.cameraId = device.id; // Spremi ID u data atribut\n                 listItem.title = device.label || device.id; // Puni label u tooltipu\n\n                 // Oznaci trenutno odabranu\n                 if (device.id === currentActiveCameraId) {\n                     listItem.classList.add('selected-camera');\n                      console.log(`toggleCameraSelection: Oznaƒçavam kao odabranu: ${device.id}`);\n                 }\n\n                 cameraListUl.appendChild(listItem); // Dodaj element u UL\n             });\n\n             // Dodaj listener na UL element (event delegation)\n             // Ukloni stari listener ako postoji PRIJE dodavanja novog\n             cameraListUl.removeEventListener('click', handleCameraListClick);\n             cameraListUl.addEventListener('click', handleCameraListClick);\n             console.log(\"toggleCameraSelection: Listener dodan na #camera-list.\");\n\n             // Poka≈æi overlay s popisom kamera\n             cameraSelectionOverlay.style.display = 'block';\n             console.log(\"toggleCameraSelection: Prikazujem overlay.\");\n\n         }).catch(err => {\n             console.error(\"toggleCameraSelection: Gre≈°ka dohvaƒáanja kamera za popis:\", err);\n             showTemporaryMessage(`Gre≈°ka pri listanju kamera (${err.name || ''}).`, 2000);\n             if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij ako je gre≈°ka\n         });\n    }\n\n    // Funkcija za rukovanje klikom na listu kamera (delegation)\n    function handleCameraListClick(event) {\n        console.log(\"handleCameraListClick: Klik detektiran.\", event.target);\n        const clickedLi = event.target.closest('li[data-cameraId]'); // Pronaƒëi najbli≈æi LI sa data-cameraId\n\n        if (clickedLi && clickedLi.dataset.cameraId) {\n            const selectedCameraId = clickedLi.dataset.cameraId;\n            const selectedCameraLabel = clickedLi.textContent.trim(); // Uzmi tekst kao label\n            console.log(\"handleCameraListClick: Kliknuto na kameru:\", selectedCameraId);\n            switchCamera(selectedCameraId, selectedCameraLabel);\n        } else {\n             console.log(\"handleCameraListClick: Kliknuto izvan LI elementa kamere.\");\n             // Ovdje mo≈æete dodati logiku za zatvaranje overlay-a ako je kliknuto unutar UL ali ne na LI\n             // (globalClickListener veƒá radi veƒáinu posla za klikove izvan overlay-a)\n        }\n    }\n\n\n    function switchCamera(selectedCameraId, cameraLabel) {\n        console.log(`switchCamera: Pokrenuto. Odabrana ID=${selectedCameraId}, Label=${cameraLabel || 'N/A'}`);\n        playSound('click-sound');\n\n        // Sakrij overlay odmah\n        if (cameraSelectionOverlay) {\n             console.log(\"switchCamera: Sakrivam overlay.\");\n             cameraSelectionOverlay.style.display = 'none';\n        }\n\n        // Provjeri da li je odabrana ista kamera koja je veƒá aktivna i da li skener radi\n        const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY);\n        if(selectedCameraId === currentActiveCameraId && isScannerActive) {\n            console.log(\"switchCamera: Odabrana je veƒá aktivna kamera, nema potrebe za restartom.\");\n            showTemporaryMessage(\"Ta kamera je veƒá aktivna.\", 1500);\n            return;\n        }\n\n        // Spremi novi odabir u localStorage PRIJE poku≈°aja startanja\n        localStorage.setItem(CAMERA_ID_KEY, selectedCameraId);\n        console.log(\"switchCamera: Spremljen novi ID u localStorage:\", selectedCameraId);\n\n        // Prikaz privremene poruke da se kamera mijenja\n        showTemporaryMessage(`Mijenjam na: ${cameraLabel || 'Kamera'}...`, 1500); // Poveƒáan trajanje poruke\n\n        // Zaustavi trenutni skener, a zatim (u finally bloku) pokreni novi\n        console.log(\"switchCamera: Zaustavljam trenutni skener...\");\n        stopScanner().finally(() => {\n             // Koristimo finally blok kako bismo osigurali da se initializeScanner pozove\n             // bez obzira je li stop() uspio ili ne.\n             console.log(\"switchCamera: stopScanner finally blok. Pokreƒáem initializeScanner za novu kameru...\");\n             // Dodan mali delay prije pokretanja initializeScanner kako bi se osiguralo da\n             // prethodni stream kamere bude u potpunosti osloboƒëen od strane browsera/OS-a.\n             // Vrijednost (npr. 50ms, 100ms) mo≈æe varirati ovisno o ureƒëaju i browseru.\n             setTimeout(() => {\n                // initializeScanner ƒáe sada proƒçitati novi CAMERA_ID_KEY iz localStorage\n                // i poku≈°ati startati tu kameru.\n                initializeScanner().then(() => {\n                    console.log(\"switchCamera: Nova kamera uspje≈°no pokrenuta.\");\n                    showTemporaryMessage(`Kamera ${cameraLabel || 'promijenjena'}!`, 1500); // Poruka o uspjehu\n                }).catch(initErr => {\n                    console.error(\"switchCamera: initializeScanner nakon switcha FAILED:\", initErr);\n                    showTemporaryMessage(`Gre≈°ka kod promjene kamere (${initErr.name || ''}).`, 3000); // Poruka o gre≈°ci\n                    // Gre≈°ku startanja hvata i initializeScanner i bri≈°e CAMERA_ID_KEY\n                    // ako je potrebno.\n                });\n             }, 100); // Poveƒáan delay na 100ms za veƒáu pouzdanost\n        });\n    }\n\n\n    // *** FUNKCIJE ZA PROMJENU PRIKAZA (VIEW) ***\n    // Modificirana switchToScannerView\n    function switchToScannerView() {\n        console.log(\"switchToScannerView: Pokrenuto.\");\n        if (document.body.classList.contains('scanner-view')) {\n            console.log(\"switchToScannerView: Veƒá u scanner view.\");\n            // Ako smo veƒá u scanner view, ali skener nije aktivan, poku≈°aj ga pokrenuti.\n            if (!isScannerActive) {\n                console.log(\"switchToScannerView: Skener nije aktivan, poku≈°avam inicijalizirati...\");\n                initializeScanner().catch(err => console.error(\"Inicijalizacija skenera (u postojeƒáem viewu) zavr≈°ila s gre≈°kom:\", err));\n            } else {\n                 console.log(\"switchToScannerView: Skener je veƒá aktivan, samo a≈æuriram UI.\");\n                 // A≈æuriraj UI elemente specifiƒçne za skener\n                 checkSharePrompt();\n                 updateRunningTextVisibility();\n                 updateDeactivatedIndicator();\n                 // Poka≈æi gumb ako treba (async provjera unutar then)\n                 Html5Qrcode.getCameras().then(devices => {\n                     if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                        switchCameraButton.style.display = 'block';\n                     }\n                 }).catch(()=>{/* ignore error */});\n            }\n             // U oba sluƒçaja, pobrini se da visibility listener bude vezan\n            if (!visibilityListenerAttached) {\n                 attachVisibilityListener();\n            }\n            return;\n        }\n\n        // Ako dolazimo iz history view-a:\n\n        // Resetiraj confirmation gumbe iz history view-a\n        const clearBtn = document.getElementById('clear-history-btn'); if (clearBtn && clearBtn.dataset.confirming === 'true') { clearBtn.innerText = \"IZBRI≈†I SVU POVIJEST\"; clearBtn.classList.remove('confirm-mode'); clearBtn.dataset.confirming = 'false'; } // Resetiraj stanje gumba u history viewu\n        const deleteSessionBtn = document.getElementById('delete-session-btn'); if (deleteSessionBtn && deleteSessionBtn.dataset.confirming === 'true') { deleteSessionBtn.innerText = \"IZBRI≈†I OVAJ SKEN\"; deleteSessionBtn.classList.remove('confirm-mode'); deleteSessionBtn.dataset.confirming = 'false'; } // Resetiraj stanje gumba u history viewu\n        const clearDayBtn = document.getElementById('clear-day-btn'); if (clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = \"IZBRI≈†I OVAJ DAN\"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } // Resetiraj stanje gumba u history viewu\n\n        // Oƒçisti dinamiƒçki header povijesti\n        if (historyDynamicHeaderContentDiv) historyDynamicHeaderContentDiv.innerHTML = '';\n\n        // Promijeni klase body elementa za promjenu stila i sakrivanje/prikaz elemenata\n        document.body.classList.remove('history-view');\n        document.body.classList.add('scanner-view');\n        document.body.style.backgroundColor = '#f4f4f4'; // Postavi boju pozadine za scanner view\n\n        // Resetiraj stanje prikaza povijesti na default (current day view) za iduƒái put\n        currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);\n        previousHistoryViewState = 'day-view';\n\n        // A≈æuriraj prikaz elemenata skenera (ukupno, broj raƒçuna, mala povijest)\n        updateDisplay();\n\n        // Pokreni inicijalizaciju skenera NAKON promjene view-a i kratkog odmaka.\n        // Ovo je ASINKRONO, pa ƒáe se UI a≈æuriranja nastaviti.\n        requestAnimationFrame(() => {\n             setTimeout(() => {\n                 console.log(\"switchToScannerView: Pokreƒáem initializeScanner nakon timeouta...\");\n                 initializeScanner().catch(err => console.error(\"Inicijalizacija skenera (nakon switcha) zavr≈°ila s gre≈°kom:\", err));\n                 // Ve≈æi visibility listener ako veƒá nije vezan\n                 if (!visibilityListenerAttached) {\n                     attachVisibilityListener();\n                 }\n             }, 100); // Poveƒáan delay za prebacivanje view-a\n        });\n\n        console.log(\"switchToScannerView: Zavr≈°eno (asinkrono pokretanje skenera).\");\n    }\n\n    // Modificirana switchToHistoryView\n    function switchToHistoryView() {\n        console.log(\"switchToHistoryView: Pokrenuto.\");\n        if (document.body.classList.contains('history-view')) {\n            console.log(\"switchToHistoryView: Veƒá u history view, samo renderiram.\");\n            // Ako smo veƒá u history view, samo ponovno renderiraj trenutni prikaz\n            // (npr. ako se osvje≈æi history page bez potpunog reload-a stranice).\n            renderHistoryView(currentlyViewedDate);\n            return;\n        }\n\n        // Ako dolazimo iz scanner view-a:\n\n        // Resetiraj confirmation gumbe u scanner view-u ako su bili aktivni\n        if (removeConfirm || removeNameConfirm) resetRemoveMode();\n        if (ocistiConfirm) resetOcistiMode();\n\n        console.log(\"switchToHistoryView: Zaustavljam skener...\");\n        // Zaustavi skener. stopScanner je ASINKRONA operacija.\n        stopScanner().finally(() => {\n            // Ovaj blok koda ƒáe se izvr≈°iti NAKON ≈°to stopScanner zavr≈°i (uspje≈°no ili s gre≈°kom).\n            console.log(\"switchToHistoryView: stopScanner finally blok. Mijenjam klase i renderiram history.\");\n\n            // Promijeni klase body elementa za promjenu stila i sakrivanje/prikaz elemenata\n            document.body.classList.remove('scanner-view');\n            document.body.classList.add('history-view');\n            document.body.style.backgroundColor = 'white'; // Postavi boju pozadine za history view\n\n            // Sakrij elemente specifiƒçne za skener (koji mo≈æda nisu sakriveni u stopScanner)\n            if (counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';\n            if (switchCameraButton) switchCameraButton.style.display = 'none';\n            if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';\n            if (instructionDiv) instructionDiv.style.display = 'none';\n            if (runningTextContainer) runningTextContainer.style.display = 'none';\n            if (sharePromptOverlay) sharePromptOverlay.style.display = 'none';\n\n            // Renderiraj poƒçetni prikaz povijesti (current day view)\n            renderHistoryView(currentlyViewedDate); // currentlyViewedDate se resetira u switchToScannerView\n\n            console.log(\"switchToHistoryView: Zavr≈°eno (renderiranje history view-a).\");\n        });\n         // NAPOMENA: Kod koji slijedi NAKON stopScanner().finally() ƒáe se izvr≈°iti ODMAH,\n         // PRIJE nego ≈°to se stopiranje zavr≈°i i before finally blok.\n    }\n\n    // *** FUNKCIJE ZA RENDERIRANJE HISTORY VIEWA ***\n    // (Ove funkcije ostaju nepromijenjene)\n    function clearDynamicHeaderContent() { if (historyDynamicHeaderContentDiv) { historyDynamicHeaderContentDiv.innerHTML = ''; } }\n    function renderHistoryView(dateToShow = currentlyViewedDate) { console.log(\"renderHistoryView: Pokrenuto za datum:\", dateToShow); previousHistoryViewState = 'day-view'; currentlyViewedDate = new Date(dateToShow); currentlyViewedDate.setHours(0,0,0,0); const punaPovijest = loadFullHistoryFromLocalStorage(); console.log(\"renderHistoryView: Uƒçitana povijest iz localStorage:\", punaPovijest); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) { console.error(\"renderHistoryView: Kritiƒçni DOM elementi nedostaju!\"); return; } clearDynamicHeaderContent(); const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: 'numeric' }; let imeDana = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDatuma); const startOfDay = new Date(currentlyViewedDate); const endOfDay = new Date(currentlyViewedDate); endOfDay.setHours(23, 59, 59, 999); const sesijeZaPrikazaniDan = punaPovijest.filter(grupa => { const grupaDate = new Date(grupa.timestamp); return grupaDate >= startOfDay && grupaDate <= endOfDay; }); sesijeZaPrikazaniDan.sort((a, b) => a.timestamp - b.timestamp); const brojRacunaOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); const dateInfoDiv = document.createElement('div'); dateInfoDiv.id = 'history-date-info'; const currentViewDateStr = getISODateString(currentlyViewedDate); const hasOtherDays = punaPovijest.some(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr && grupaDateStr !== currentViewDateStr; }); dateInfoDiv.innerHTML = `<span style=\"font-weight: bold;\">${imeDana}, ${formatiraniDatum}</span> <button id=\"history-view-toggle-btn\" style=\"background-color: yellow; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold;\" ${!hasOtherDays ? 'disabled' : ''}>OSTALI DANI ></button>`; historyDynamicHeaderContentDiv.appendChild(dateInfoDiv); const historyViewToggleButton = dateInfoDiv.querySelector('#history-view-toggle-btn'); if (historyViewToggleButton) { const newHistoryViewToggleButton = historyViewToggleButton.cloneNode(true); historyViewToggleButton.parentNode.replaceChild(newHistoryViewToggleButton, historyViewToggleButton); if (!newHistoryViewToggleButton.disabled) { newHistoryViewToggleButton.addEventListener('click', () => { playSound('click-sound'); renderAllDaysView(); }); newHistoryViewToggleButton.style.cursor = 'pointer'; newHistoryViewToggleButton.style.opacity = '1'; } else { newHistoryViewToggleButton.style.cssText += ';cursor: not-allowed; opacity: 0.7;'; } } const summaryInfoDiv = document.createElement('div'); summaryInfoDiv.id = 'history-summary-info'; summaryInfoDiv.innerHTML = `<span>RAƒåUNA: <span style=\"font-weight: bold;\">${brojRacunaOvajDan}</span></span> <span style=\"font-weight: bold;\">UKUPNO: ${ukupanIznosOvajDan.toFixed(2)} ‚Ç¨</span>`; historyDynamicHeaderContentDiv.appendChild(summaryInfoDiv); const uputaHtml = `<p id=\"history-select-group-text\" style=\"text-align: center; color: black; font-weight: bold; font-style: normal; margin-bottom: 1em; margin-top: 0.5em; font-size: 0.9em;\">IZABERI SKEN ILI <button id=\"start-search-btn\" style=\"background:none; border:none; padding:0; color:blue; text-decoration:underline; cursor:pointer; font-size:inherit; font-weight:bold;\">(TRA≈ΩI)</button></p>`; let sesijeHtml = '<ul id=\"scan-group-list\" style=\"list-style: none; padding: 0; margin: 0;\">'; if (sesijeZaPrikazaniDan.length === 0) { sesijeHtml += '<li style=\"text-align:center; color: grey; border: none; cursor: default; padding: 1em 0;\"><i>Nema spremljenih skenova za ovaj dan.</i></li>'; } else { sesijeZaPrikazaniDan.forEach((sesija, index) => { sesijeHtml += generirajHtmlZaSpremljenuGrupu(sesija, index + 1); }); } sesijeHtml += '</ul>'; historyContentDiv.innerHTML = uputaHtml + sesijeHtml; if (sesijeZaPrikazaniDan.length > 0) { const clearDayButton = document.createElement('button'); clearDayButton.id = 'clear-day-btn'; clearDayButton.className = 'red-btn'; clearDayButton.style.margin = '2em auto 1em auto'; clearDayButton.style.display = 'block'; clearDayButton.innerText = 'IZBRI≈†I OVAJ DAN'; historyContentDiv.appendChild(clearDayButton); clearDayButton.dataset.confirming = 'false'; const newClearDayBtn = clearDayButton.cloneNode(true); clearDayButton.parentNode.replaceChild(newClearDayBtn, clearDayButton); newClearDayBtn.addEventListener('click', () => { if (newClearDayBtn.disabled) return; playSound('click-sound'); if (newClearDayBtn.dataset.confirming === 'false') { newClearDayBtn.innerText = \"Potvrdi Brisanje Dana?\"; newClearDayBtn.classList.add('confirm-mode'); newClearDayBtn.dataset.confirming = 'true'; } else { deleteScansForDay(currentlyViewedDate); } }); const dayParentPageClickHandler = (e) => { const currentClearDayBtn = document.getElementById('clear-day-btn'); if (currentClearDayBtn && currentClearDayBtn.dataset.confirming === 'true' && !currentClearDayBtn.contains(e.target)) { currentClearDayBtn.innerText = \"IZBRI≈†I OVAJ DAN\"; currentClearDayBtn.classList.remove('confirm-mode'); currentClearDayBtn.dataset.confirming = 'false'; } }; historyPageDiv.removeEventListener('click', dayParentPageClickHandler, true); historyPageDiv.addEventListener('click', dayParentPageClickHandler, true); } const groupList = document.getElementById('scan-group-list'); if (groupList) { const newGroupList = groupList.cloneNode(true); groupList.parentNode.replaceChild(newGroupList, groupList); newGroupList.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); previousHistoryViewState = 'day-view'; renderGroupDetailView(selectedGroup); } else { console.error(\"Nije pronaƒëena grupa:\", timestamp); alert(\"Gre≈°ka otvaranja detalja.\"); } } }); } const searchBtn = document.getElementById('start-search-btn'); if(searchBtn) { const newSearchBtn = searchBtn.cloneNode(true); searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn); newSearchBtn.addEventListener('click', startSearch); } console.log(\"renderHistoryView: Renderiranje zavr≈°eno.\"); })\n    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) { const vrijemeSpremanja = new Date(grupa.timestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class=\"session-name-history\">${grupa.name} U ${vrijemeSpremanjaFormatirano}</span>` : `<span class=\"scan-time-history\">SKEN U ${vrijemeSpremanjaFormatirano}</span>`; return `<li data-timestamp=\"${grupa.timestamp}\" style=\"background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease;\"><span style=\"flex-shrink: 0; display: inline-flex; align-items: center; min-width: 0; flex-grow: 1; overflow: hidden;\"><span style=\"margin-right: 5px; flex-shrink: 0;\">${redniBroj}.</span> ${prikazNaziva}</span><span class=\"scan-group-last-qr-time\" style=\"flex-shrink: 0; margin-left: 15px;\">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style=\"font-weight: bold; margin-left: auto; padding-left: 10px; flex-shrink: 0;\">${ukupnoGrupa.toFixed(2)} ‚Ç¨</span></li>`; }\n    function renderGroupDetailView(groupData) { if (!historyContentDiv || !groupData || !groupData.racuni || !historyDynamicHeaderContentDiv) { console.error(\"Nedostaju podaci za detalje.\"); renderHistoryView(); return; } clearDynamicHeaderContent(); const sessionTimestamp = groupData.timestamp; const vrijemeSpremanja = new Date(sessionTimestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = groupData.racuni.reduce((sum, item) => sum + item.amount, 0); const brojRacunaSesije = groupData.racuni.length; const naslovDetalja = groupData.name ? groupData.name : `SKEN U ${vrijemeSpremanjaFormatirano}`; const detailHeaderDiv = document.createElement('div'); detailHeaderDiv.id = 'detail-header-info'; detailHeaderDiv.innerHTML = `<button id=\"back-to-group-list-btn\" style=\"background-color: #6c757d; color: white; padding: 0.4em 0.8em; font-size: 0.9em; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;\">< Lista</button><h3 style=\"margin: 0; text-align: center; flex-grow: 1; font-size: 1.1em;\">${naslovDetalja}</h3><span style=\"font-weight: bold; font-size: 1.1em; flex-shrink: 0; padding-left: 5px;\">${ukupnoGrupa.toFixed(2)} ‚Ç¨</span>`; historyDynamicHeaderContentDiv.appendChild(detailHeaderDiv); const detailSummaryDiv = document.createElement('div'); detailSummaryDiv.id = 'detail-summary-info'; detailSummaryDiv.innerHTML = `<span>RAƒåUNA: <span style=\"font-weight: bold;\">${brojRacunaSesije}</span></span><span style=\"font-weight: bold;\">UKUPNO: ${ukupnoGrupa.toFixed(2)} ‚Ç¨</span>`; historyDynamicHeaderContentDiv.appendChild(detailSummaryDiv); let detailListHtml = '<ul id=\"detail-scan-list\">'; const racuniZaPrikaz = groupData.racuni; racuniZaPrikaz.forEach((racun, index) => { const vrijemeRacuna = racun.time !== '??:??' ? `${racun.time}` : 'Vrijeme?'; detailListHtml += `<li><span style=\"color: #333; min-width: 80px;\">${index + 1}. ${vrijemeRacuna}</span><span style=\"font-weight: bold; margin-left: auto;\">${racun.amount.toFixed(2)} ‚Ç¨</span></li>`; }); detailListHtml += `</ul>`; detailListHtml += `<button id=\"delete-session-btn\" class=\"red-btn\" data-timestamp=\"${sessionTimestamp}\" style=\"margin: 2em auto 1em auto; display: block;\">IZBRI≈†I OVAJ SKEN</button>`; historyContentDiv.innerHTML = detailListHtml; const backBtn = document.getElementById('back-to-group-list-btn'); if (backBtn) { const newBackBtn = backBtn.cloneNode(true); backBtn.parentNode.replaceChild(newBackBtn, backBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); console.log(\"Vraƒáanje iz detalja, prethodno stanje:\", previousHistoryViewState); switch (previousHistoryViewState) { case 'day-search-results': renderHistoryView(currentlyViewedDate); startSearch(); const searchInputDay = document.getElementById('search-input'); if(searchInputDay) searchInputDay.value = lastSearchTerm; executeSearch(); break; case 'all-days-search-results': renderAllDaysView(); const searchInputAll = document.getElementById('all-days-search-input'); if(searchInputAll) searchInputAll.value = lastSearchTerm; executeAllDaysSearch(); break; case 'day-view': default: renderHistoryView(currentlyViewedDate); break; } }); } const deleteSessionBtn = document.getElementById('delete-session-btn'); if(deleteSessionBtn) { deleteSessionBtn.dataset.confirming = 'false'; const newDeleteSessionBtn = deleteSessionBtn.cloneNode(true); deleteSessionBtn.parentNode.replaceChild(newDeleteSessionBtn, deleteSessionBtn); newDeleteSessionBtn.addEventListener('click', () => { playSound('click-sound'); if (newDeleteSessionBtn.dataset.confirming === 'false') { newDeleteSessionBtn.innerText = \"Potvrdi brisanje?\"; newDeleteSessionBtn.classList.add('confirm-mode'); newDeleteSessionBtn.dataset.confirming = 'true'; } else { const timestampToDelete = newDeleteSessionBtn.dataset.timestamp; deleteSpecificSession(timestampToDelete); } }); const detailClickHandler = (e) => { const currentDeleteBtn = document.getElementById('delete-session-btn'); if (currentDeleteBtn && currentDeleteBtn.dataset.confirming === 'true' && !currentDeleteBtn.contains(e.target)) { currentDeleteBtn.innerText = \"IZBRI≈†I OVAJ SKEN\"; currentDeleteBtn.classList.remove('confirm-mode'); currentDeleteBtn.dataset.confirming = 'false'; historyPageDiv.removeEventListener('click', detailClickHandler, true); } }; historyPageDiv.removeEventListener('click', detailClickHandler, true); historyPageDiv.addEventListener('click', detailClickHandler, true); } else { console.warn(\"Gumb #delete-session-btn nije pronaƒëen.\"); } }\n    function deleteSpecificSession(timestampString) { if (!timestampString) { console.error(\"Poku≈°aj brisanja bez timestampa.\"); alert(\"Gre≈°ka: Nije moguƒáe identificirati sken.\"); return; } const timestampToDelete = Number(timestampString); if (isNaN(timestampToDelete)) { console.error(\"Neva≈æeƒái timestamp za brisanje:\", timestampString); alert(\"Gre≈°ka: Neva≈æeƒái identifikator skena.\"); const deleteBtn = document.getElementById('delete-session-btn'); if(deleteBtn && deleteBtn.dataset.confirming === 'true') { deleteBtn.innerText = \"IZBRI≈†I OVAJ SKEN\"; deleteBtn.classList.remove('confirm-mode'); deleteBtn.dataset.confirming = 'false'; } return; } console.log(\"Brisanje sesije s timestampom:\", timestampToDelete); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const filtriranaPovijest = punaPovijest.filter(grupa => { if (typeof grupa.timestamp !== 'number' || isNaN(grupa.timestamp)) { return true; } return grupa.timestamp !== timestampToDelete; }); const newLength = filtriranaPovijest.length; console.log(`Originalna du≈æina: ${originalLength}, Nova du≈æina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); alert(\"Sken obrisan iz povijesti.\"); renderHistoryView(currentlyViewedDate); } else { console.warn(\"Sesija za brisanje nije pronaƒëena:\", timestampToDelete); alert(\"Gre≈°ka: Sken nije pronaƒëen.\"); const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = \"IZBRI≈†I OVAJ DAN\"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } } }\n    function renderAllDaysView() { previousHistoryViewState = 'all-days-view'; const punaPovijest = loadFullHistoryFromLocalStorage(); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) return; clearDynamicHeaderContent(); const searchBarHtml = `<div id=\"all-days-search-container\"><div style=\"display: flex; gap: 5px;\"><input type=\"text\" id=\"all-days-search-input\" placeholder=\"UPI≈†I ZA PRETRAGU...\" style=\"flex-grow: 1; padding: 0.5em; font-size: 0.9em;\"><button id=\"execute-all-days-search-btn\" style=\"padding: 0.5em 0.6em; font-size: 0.9em;\">Tra≈æi</button><button id=\"close-all-days-search-btn\" style=\"padding: 0.5em 0.6em; background-color: #ccc; font-size: 0.9em;\">Svi Dani</button></div></div><div id=\"all-days-summary-info\" style=\"display: none;\"></div>`; historyDynamicHeaderContentDiv.innerHTML = searchBarHtml; const resultsPlaceholderHtml = `<div id=\"search-results-all-days\"><p style=\"text-align:center; color: grey; padding: 1em 0;\"><i>Unesite pojam za pretragu ili kliknite \"Svi Dani\" za prikaz liste.</i></p></div>`; historyContentDiv.innerHTML = resultsPlaceholderHtml; const searchInput = document.getElementById('all-days-search-input'); const executeBtn = document.getElementById('execute-all-days-search-btn'); const closeBtn = document.getElementById('close-all-days-search-btn'); const searchResultsContainer = document.getElementById('search-results-all-days'); const allDaysSummaryContainer = document.getElementById('all-days-summary-info'); const sessionsByDate = punaPovijest.reduce((acc, session) => { const dateStr = getISODateString(new Date(session.timestamp)); if (!dateStr) return acc; if (!acc[dateStr]) { acc[dateStr] = { date: new Date(session.timestamp), sessions: [], totalAmount: 0, totalCount: 0 }; acc[dateStr].date.setHours(0, 0, 0, 0); } acc[dateStr].sessions.push(session); acc[dateStr].totalAmount += session.racuni.reduce((sum, item) => sum + item.amount, 0); acc[dateStr].totalCount += session.racuni.length; return acc; }, {}); const sortedDays = Object.values(sessionsByDate).sort((a, b) => b.date - a.date); if(searchInput && executeBtn && closeBtn && searchResultsContainer && allDaysSummaryContainer) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeAllDaysSearch(); }); const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', () => { executeAllDaysSearch(); }); const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); newSearchInput.value = ''; renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAƒåUNA: <span style=\"font-weight: bold;\">${totalCountAll}</span></span><span style=\"font-weight: bold;\">UKUPNO: ${totalAmountAll.toFixed(2)} ‚Ç¨</span>`; allDaysSummaryContainer.style.display = punaPovijest.length > 0 ? 'flex' : 'none'; }); } else { console.error(\"Nisu pronaƒëeni svi elementi za pretragu u All Days View.\"); } if (punaPovijest.length > 0) { const backButtonHtml = `<button id=\"back-to-current-day-btn\" style=\"background-color: #6c757d; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;\">< NATRAG</button>`; const clearAllButtonHtml = `<button id=\"clear-history-btn\" class=\"red-btn\" style=\"padding: 0.5em 1em; font-size: 1em;\">IZBRI≈†I SVU POVIJEST</button>`; const buttonsHtml = `<div style=\"text-align: center; margin-top: 1.5em; margin-bottom: 1em;\">${backButtonHtml}${clearAllButtonHtml}</div>`; if (!document.getElementById('back-to-current-day-btn') && !document.getElementById('clear-history-btn')) { historyContentDiv.insertAdjacentHTML('beforeend', buttonsHtml); } const backToDayBtn = document.getElementById('back-to-current-day-btn'); if (backToDayBtn) { const newBackBtn = backToDayBtn.cloneNode(true); backToDayBtn.parentNode.replaceChild(newBackBtn, backToDayBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); renderHistoryView(currentlyViewedDate); }); } const clearAllBtn = document.getElementById('clear-history-btn'); if (clearAllBtn) { if (punaPovijest.length === 0) { clearAllBtn.disabled = true; clearAllBtn.style.opacity = '0.6'; clearAllBtn.style.cursor = 'not-allowed'; } else { clearAllBtn.disabled = false; clearAllBtn.style.opacity = '1'; clearAllBtn.style.cursor = 'pointer'; } clearAllBtn.dataset.confirming = 'false'; const newClearAllBtn = clearAllBtn.cloneNode(true); clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn); newClearAllBtn.addEventListener('click', () => { if (newClearAllBtn.disabled) return; playSound('click-sound'); if (newClearAllBtn.dataset.confirming === 'false') { newClearAllBtn.innerText = \"Potvrdi Brisanje SVEGA?\"; newClearAllBtn.classList.add('confirm-mode'); newClearAllBtn.dataset.confirming = 'true'; } else { localStorage.removeItem(HISTORY_STORAGE_KEY); localStorage.removeItem(COUNTER_KEY); localStorage.removeItem(COUNTER2_KEY); localStorage.removeItem(COUNTER_ACTIVE_KEY); localStorage.removeItem(USER_ID_KEY); localStorage.removeItem(FIRST_USE_KEY); localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); localStorage.removeItem(CAMERA_ID_KEY); /* <<< DODANO BRISANJE KAMERE */ alert(\"Sva spremljena povijest i podaci brojaƒça/kamere obrisani.\"); currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0,0,0,0); loadCountersState(); initializeUserTracking(); fetchSheetData().then(() => { renderAllDaysView(); }).catch(() => { renderAllDaysView(); }); } }); const allDaysParentClickHandler = (e) => { const currentClearAllBtn = document.getElementById('clear-history-btn'); if (currentClearAllBtn && currentClearAllBtn.dataset.confirming === 'true' && !currentClearAllBtn.contains(e.target)) { currentClearAllBtn.innerText = \"IZBRI≈†I SVU POVIJEST\"; currentClearAllBtn.classList.remove('confirm-mode'); currentClearAllBtn.dataset.confirming = 'false'; } }; historyPageDiv.removeEventListener('click', allDaysParentClickHandler, true); historyPageDiv.addEventListener('click', allDaysParentClickHandler, true); } } if (punaPovijest.length > 0 && searchResultsContainer && allDaysSummaryContainer) { renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAƒåUNA: <span style=\"font-weight: bold;\">${totalCountAll}</span></span><span style=\"font-weight: bold;\">UKUPNO: ${totalAmountAll.toFixed(2)} ‚Ç¨</span>`; allDaysSummaryContainer.style.display = 'flex'; } else { if (allDaysSummaryContainer) allDaysSummaryContainer.style.display = 'none'; } }\n    function renderAllDaysList(daysData, containerElement) { if (!containerElement) return; const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; let daysHtml = '<ul id=\"all-days-list-rendered\" style=\"list-style: none; padding: 0; margin: 0;\">'; if (daysData.length === 0) { if (containerElement.id === 'search-results-all-days' && document.getElementById('all-days-search-input')?.value.trim()) { daysHtml += '<li style=\"text-align:center; color: grey; padding: 1em 0;\"><i>Nema rezultata za tra≈æeni pojam.</i></li>'; } else { daysHtml += '<li style=\"text-align:center; color: grey; padding: 1em 0;\"><i>Nema spremljene povijesti.</i></li>'; } } else { daysData.forEach(dayInfo => { let imeDana = dayInfo.date.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = dayInfo.date.toLocaleDateString('hr-HR', opcijeDatuma); const isoDate = getISODateString(dayInfo.date); daysHtml += `<li data-date-iso=\"${isoDate}\" style=\"background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;\"><span style=\"font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;\">${imeDana}, ${formatiraniDatum}</span><div style=\"flex-shrink: 0; text-align: right;\"><span style=\"font-size: 0.9em; color: #555; white-space: nowrap;\">Raƒçuna: ${dayInfo.totalCount}</span><span style=\"font-weight: bold; margin-left: 15px; white-space: nowrap;\">${dayInfo.totalAmount.toFixed(2)} ‚Ç¨</span></div></li>`; }); } daysHtml += '</ul>'; containerElement.innerHTML = daysHtml; const listElement = containerElement.querySelector('ul'); if (listElement) { const newListElement = listElement.cloneNode(true); listElement.parentNode.replaceChild(newListElement, listElement); newListElement.addEventListener('click', (e) => { const clickedDayLi = e.target.closest('li[data-date-iso]'); if (clickedDayLi && clickedDayLi.dataset.dateIso) { const selectedDate = new Date(clickedDayLi.dataset.dateIso + 'T00:00:00'); playSound('click-sound'); currentlyViewedDate = selectedDate; renderHistoryView(selectedDate); } }); } }\n    function executeAllDaysSearch() { const searchInput = document.getElementById('all-days-search-input'); const resultsContainer = document.getElementById('search-results-all-days'); const summaryContainer = document.getElementById('all-days-summary-info'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); console.log(\"--- executeAllDaysSearch ---\"); console.log(\"Tra≈æim pojam:\", searchTerm); console.log(\"Normalizirani datum za pretragu:\", normalizedSearchDate); resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm) { return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; const opcijeDana = { weekday: 'long' }; const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' }; const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' }; punaPovijest.forEach((grupa, index) => { const sessionDate = new Date(grupa.timestamp); console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { console.log(\"    MATCH: Toƒçan datum!\"); match = true; } if (!match) { console.log(\"    Provjeravam kao tekst...\"); if (formattedDateShort.includes(searchTerm)) { console.log(\"    MATCH: Kratki datum sadr≈æi pojam.\"); match = true; } else if (formattedDateNumeric.includes(searchTerm)) { console.log(\"    MATCH: Numeriƒçki datum sadr≈æi pojam.\"); match = true; } else if (dayName.includes(searchTerm)) { console.log(`    MATCH: Ime dana ('${dayName}') sadr≈æi pojam ('${searchTerm}').`); match = true; } else if (sessionName && sessionName.includes(searchTerm)) { console.log(\"    MATCH: Naziv sesije sadr≈æi pojam.\"); match = true; } else { console.log(\"    Nema tekstualnog matcha.\"); } } if (match) { searchResults.push(grupa); } }); console.log(\"Ukupno pronaƒëeno rezultata (Svi Dani):\", searchResults.length); renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); resultsContainer.style.display = 'block'; console.log(\"--- kraj executeAllDaysSearch ---\"); }\n    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) { if (!containerElement || !summaryContainer) return; containerElement.innerHTML = ''; summaryContainer.innerHTML = ''; summaryContainer.style.display = 'none'; if (results.length === 0) { containerElement.innerHTML = '<p style=\"text-align:center; color: grey; padding: 1em 0;\"><i>Nema rezultata za tra≈æeni pojam.</i></p>'; return; } const brojRacunaRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); summaryContainer.innerHTML = `<span>RAƒåUNA: <span style=\"font-weight: bold;\">${brojRacunaRezultati}</span></span><span style=\"font-weight: bold;\">UKUPNO: ${ukupanIznosRezultati.toFixed(2)} ‚Ç¨</span>`; summaryContainer.style.display = 'flex'; results.sort((a, b) => b.timestamp - a.timestamp); let resultsHtml = '<ul id=\"search-results-list\" style=\"list-style: none; padding: 0; margin: 0;\">'; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; results.forEach(grupa => { const vrijemeSpremanja = new Date(grupa.timestamp); const datumString = vrijemeSpremanja.toLocaleDateString('hr-HR', opcijeDatuma); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class=\"session-name-history\">${grupa.name}</span>` : `<span class=\"scan-time-history\">SKEN</span>`; resultsHtml += `<li data-timestamp=\"${grupa.timestamp}\" style=\"border: 1px solid #eee; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; cursor: pointer;\"><div style=\"font-weight: bold; margin-right: 8px; color: #666;\">${datumString}</div><div style=\"flex-grow: 1; min-width: 100px; display: inline-flex; align-items: center;\">${prikazNaziva} <span style=\"font-size:0.9em; color:#555; margin-left: 5px;\">u ${vrijemeSpremanjaFormatirano}</span></div><div style=\"flex-shrink: 0; margin-left: auto; padding-left: 10px; text-align: right;\"><span class=\"scan-group-last-qr-time\">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style=\"font-weight: bold; margin-left: 10px;\">${ukupnoGrupa.toFixed(2)} ‚Ç¨</span></div></li>`; }); resultsHtml += '</ul>'; containerElement.innerHTML = resultsHtml; const resultsList = containerElement.querySelector('ul'); if (resultsList) { const newResultsList = resultsList.cloneNode(true); resultsList.parentNode.replaceChild(newResultsList, resultsList); newResultsList.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const punaPovijest = loadFullHistoryFromLocalStorage(); const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); if (containerElement.id === 'search-results') { previousHistoryViewState = 'day-search-results'; lastSearchTerm = document.getElementById('search-input')?.value.trim() || ''; } else if (containerElement.id === 'search-results-all-days') { previousHistoryViewState = 'all-days-search-results'; lastSearchTerm = document.getElementById('all-days-search-input')?.value.trim() || ''; } currentlyViewedDate = new Date(selectedGroup.timestamp); currentlyViewedDate.setHours(0,0,0,0); renderGroupDetailView(selectedGroup); } else { console.error(\"Nije pronaƒëena grupa iz rezultata pretrage:\", timestamp); alert(\"Gre≈°ka pri otvaranju detalja.\"); } } }); } }\n    function executeSearch() { const searchInput = document.getElementById('search-input'); const resultsContainer = document.getElementById('search-results'); const summaryContainer = document.getElementById('search-summary-info-day'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); console.log(\"--- executeSearch (Sada pretra≈æuje SVE DANE) ---\"); console.log(\"Tra≈æim pojam:\", searchTerm); console.log(\"Normalizirani datum za pretragu:\", normalizedSearchDate); resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm) { resultsContainer.innerHTML = '<p style=\"text-align:center; color: grey;\"><i>Unesite pojam za pretragu (datum, dan, naziv).</i></p>'; return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; const opcijeDana = { weekday: 'long' }; const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' }; const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' }; punaPovijest.forEach((grupa, index) => { const sessionDate = new Date(grupa.timestamp); console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { console.log(\"    MATCH: Toƒçan datum!\"); match = true; } if (!match) { console.log(\"    Provjeravam kao tekst...\"); if (formattedDateShort.includes(searchTerm)) { console.log(\"    MATCH: Kratki datum sadr≈æi pojam.\"); match = true; } else if (formattedDateNumeric.includes(searchTerm)) { console.log(\"    MATCH: Numeriƒçki datum sadr≈æi pojam.\"); match = true; } else if (dayName.includes(searchTerm)) { console.log(`    MATCH: Ime dana ('${dayName}') sadr≈æi pojam ('${searchTerm}').`); match = true; } else if (sessionName && sessionName.includes(searchTerm)) { console.log(\"    MATCH: Naziv sesije sadr≈æi pojam.\"); match = true; } else { console.log(\"    Nema tekstualnog matcha.\"); } } if (match) { searchResults.push(grupa); } }); console.log(\"Ukupno pronaƒëeno rezultata (SVI DANI):\", searchResults.length); renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; console.log(\"--- kraj executeSearch (SVI DANI) ---\"); }\n    function startSearch() { playSound('click-sound'); console.log(\"Pokretanje pretrage (sada pretra≈æuje SVE)...\"); if (!historyContentDiv || !historyDynamicHeaderContentDiv) return; const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn) clearDayBtn.style.display = 'none'; const dateInfoDiv = document.getElementById('history-date-info'); const summaryInfoDiv = document.getElementById('history-summary-info'); if (dateInfoDiv) dateInfoDiv.style.display = 'none'; if (summaryInfoDiv) summaryInfoDiv.style.display = 'none'; let searchContainer = document.getElementById('search-container'); if (!searchContainer) { searchContainer = document.createElement('div'); searchContainer.id = 'search-container'; searchContainer.innerHTML = `<div style=\"display: flex; gap: 10px; margin-bottom: 0.8em;\"><input type=\"text\" id=\"search-input\" placeholder=\"Pretra≈æi SVE (Datum, Dan, Naziv)...\" style=\"flex-grow: 1; padding: 0.5em;\"><button id=\"execute-search-btn\" style=\"padding: 0.5em 1em;\">Tra≈æi</button><button id=\"close-search-btn\" style=\"padding: 0.5em 1em; background-color: #ccc;\">Zatvori</button></div><div id=\"search-summary-info-day\" style=\"display: none;\"></div>`; historyDynamicHeaderContentDiv.appendChild(searchContainer); } searchContainer.style.display = 'block'; historyContentDiv.innerHTML = '<div id=\"search-results\"><p style=\"text-align:center; color: grey;\"><i>Unesite pojam za pretragu.</i></p></div>'; const searchResultsDiv = document.getElementById('search-results'); if(searchResultsDiv) searchResultsDiv.style.display = 'block'; const searchInput = document.getElementById('search-input'); const executeBtn = document.getElementById('execute-search-btn'); const closeBtn = document.getElementById('close-search-btn'); const searchSummaryDay = document.getElementById('search-summary-info-day'); if (searchInput) { searchInput.value = ''; searchInput.focus(); } if (searchSummaryDay) { searchSummaryDay.style.display = 'none'; searchSummaryDay.innerHTML = ''; } if (executeBtn) { const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', executeSearch); } if (closeBtn) { const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); if (searchContainer) searchContainer.style.display = 'none'; renderHistoryView(currentlyViewedDate); }); } if (searchInput) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, newSearchInput); // Ispravljeno: zamijeni samog sebe newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeSearch(); }); } }\n    function deleteScansForDay(dateToDelete) { if (!(dateToDelete instanceof Date) || isNaN(dateToDelete)) { console.error(\"Poku≈°aj brisanja dana s neispravnim datumom.\"); alert(\"Gre≈°ka: Nije moguƒáe identificirati dan za brisanje.\"); return; } const dateToDeleteStr = getISODateString(dateToDelete); if (!dateToDeleteStr) return; console.log(\"Brisanje svih skenova za dan:\", dateToDeleteStr); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const filtriranaPovijest = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr !== dateToDeleteStr; }); const newLength = filtriranaPovijest.length; console.log(`Originalna du≈æina: ${originalLength}, Nova du≈æina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); alert(`Svi skenovi za ${dateToDelete.toLocaleDateString('hr-HR')} obrisani.`); renderAllDaysView(); } else { console.warn(\"Nisu pronaƒëeni skenovi za brisanje za dan:\", dateToDeleteStr); alert(\"Gre≈°ka: Nisu pronaƒëeni skenovi za ovaj dan.\"); const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = \"IZBRI≈†I OVAJ DAN\"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } } }\n\n    // *** EVENT LISTENERI ***\n    // Modificirana handleVisibilityChange\n     function handleVisibilityChange() {\n        if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) {\n             console.log(\"Aplikacija postala vidljiva u Scanner View.\");\n            // Ako skener nije aktivan (nakon skrolovanja, prebacivanja taba, minimiziranja aplikacije), pokreni ga.\n            if (!isScannerActive) {\n                console.log(\"Vidljivo & ScannerView: Skener nije aktivan, pozivam initializeScanner.\");\n                 initializeScanner().catch(err => console.error(\"Inicijalizacija skenera (visibility change) zavr≈°ila s gre≈°kom:\", err)); // Poku≈°aj inicijalizirati\n            } else {\n                 console.log(\"Vidljivo & ScannerView: Skener je veƒá (ili bi trebao biti) aktivan. A≈æuriram UI.\");\n                 // Ako je skener veƒá bio aktivan, samo osvje≈æi UI prikaze\n                 checkSharePrompt();\n                 updateRunningTextVisibility();\n                 updateDeactivatedIndicator();\n                 // Pobrini se da gumb za promjenu kamere bude vidljiv ako treba\n                 Html5Qrcode.getCameras().then(devices => {\n                     if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                        switchCameraButton.style.display = 'block';\n                     }\n                 }).catch(()=>{/* ignore error */});\n            }\n        } else if (document.visibilityState === 'hidden') {\n             console.log(\"Aplikacija postala nevidljiva, zaustavljam skener.\");\n            stopScanner(); // Zaustavi skener kad tab nije vidljiv\n        }\n    };\n\n    function attachVisibilityListener() {\n        if (visibilityListenerAttached) return;\n        document.addEventListener(\"visibilitychange\", handleVisibilityChange);\n        visibilityListenerAttached = true;\n        console.log(\"Visibility listener dodan.\");\n    }\n\n    // Modificirana globalClickListener da zatvori overlay\n    function globalClickListener(event) {\n        // Zatvori popis kamera ako se klikne izvan njega i izvan gumba za promjenu kamere\n        if (cameraSelectionOverlay && cameraSelectionOverlay.style.display === 'block') {\n             const isClickInsideOverlay = cameraSelectionOverlay.contains(event.target);\n             const isClickOnSwitchButton = switchCameraButton && switchCameraButton.contains(event.target);\n             // Provjeri i da li je kliknuto na listu (ul) ali ne direktno na li unutar nje (ovo se rukuje delegacijom u handleCameraListClick)\n             const isClickOnCameraListUl = cameraListUl && cameraListUl.contains(event.target);\n             const isClickOnCameraListItem = event.target.closest('#camera-list li'); // Provjeri je li kliknuto na li\n\n             // Sakrij overlay ako je klik izvan overlay-a I izvan gumba\n             if (!isClickInsideOverlay && !isClickOnSwitchButton) {\n                 console.log(\"globalClickListener: Klik izvan overlay-a i gumba, sakrivam overlay.\");\n                 cameraSelectionOverlay.style.display = 'none';\n             }\n              // Dodatna provjera: Ako je kliknuto na UL ali ne na LI, takoƒëer sakrij overlay\n              // (Ovo mo≈æe biti korisno ako je padding oko liste velik i klikne se 'izmeƒëu' itema)\n             if (isClickOnCameraListUl && !isClickOnCameraListItem) {\n                console.log(\"globalClickListener: Klik unutar UL ali ne na LI, sakrivam overlay.\");\n                cameraSelectionOverlay.style.display = 'none';\n             }\n        }\n\n        // Ostatak logike za resetiranje gumba (remove, ocisti) i spremanje imena\n        const isClickOnRemoveButton = removeButton && removeButton.contains(event.target); const isClickOnDeleteWarning = deleteWarningDiv && deleteWarningDiv.style.display !== 'none' && deleteWarningDiv.contains(event.target); if ((removeConfirm || removeNameConfirm) && !isClickOnRemoveButton && !isClickOnDeleteWarning) { resetRemoveMode(); } // Resetiraj remove confirmation ako klikne≈° negdje drugdje\n        const isClickOnOcistiButton = ocistiButton && ocistiButton.contains(event.target); if (ocistiConfirm && !isClickOnOcistiButton) { resetOcistiMode(); } // Resetiraj ocisti confirmation ako klikne≈° negdje drugdje\n        const isClickOnNameInput = sessionNameInput && sessionNameInput.contains(event.target); const isClickOnAddNameBtn = addNameBtn && addNameBtn.contains(event.target); const isClickOnEditIcon = event.target.classList.contains('edit-icon'); if (sessionNameInput && sessionNameInput.style.display === 'block' && !isClickOnNameInput && !isClickOnAddNameBtn && !isClickOnEditIcon) { saveName(); } // Spremi naziv ako klikne≈° izvan inputa/gumba\n    }\n\n\n    // *** INICIJALIZACIJA APLIKACIJE ***\n    document.addEventListener('DOMContentLoaded', () => {\n        console.log(\"DOM spreman...\");\n        // Dohvati SVE DOM elemente i dodijeli ih globalnim varijablama\n        totalDiv = document.getElementById('total');\n        totalContainer = document.getElementById('total-container');\n        ocistiButton = document.getElementById('ocisti-button');\n        invoiceCountDiv = document.getElementById('invoice-count');\n        historyList = document.getElementById('historyList');\n        removeButton = document.getElementById('remove-from-list-btn');\n        duplicateWarning = document.getElementById('duplicate-warning');\n        loadedMsg = document.getElementById('loaded-message');\n        instructionDiv = document.getElementById('scan-instruction');\n        deleteWarningDiv = document.getElementById('delete-warning');\n        shareButton = document.getElementById('share-button');\n        readerDiv = document.getElementById('reader');\n        historyToggleButton = document.getElementById('history-toggle-btn');\n        historyDiv = document.getElementById('history');\n        historyPageDiv = document.getElementById('history-page');\n        backToScannerButton = document.getElementById('back-to-scanner-btn');\n        historyContentDiv = document.getElementById('history-content');\n        sessionNameContainer = document.getElementById('session-name-container');\n        addNameBtn = document.getElementById('add-name-btn');\n        sessionNameInput = document.getElementById('session-name-input');\n        sessionNameDisplay = document.getElementById('session-name-display');\n        sessionNameText = document.getElementById('session-name-text');\n        historyStickyHeaderDiv = document.getElementById('history-sticky-header');\n        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');\n        runningTextContainer = document.getElementById('running-text-container');\n        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;\n        sharePromptOverlay = document.getElementById('share-prompt-overlay');\n        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');\n        // NOVI ELEMENTI KAMERE\n        switchCameraButton = document.getElementById('switch-camera-btn');\n        cameraSelectionOverlay = document.getElementById('camera-selection-overlay');\n        cameraListUl = document.getElementById('camera-list');\n\n        // Provjera jesu li svi kritiƒçni DOM elementi pronaƒëeni\n        if (!totalDiv || !totalContainer || !ocistiButton || !invoiceCountDiv || !historyList || !removeButton || !duplicateWarning || !loadedMsg || !instructionDiv || !deleteWarningDiv || !shareButton || !readerDiv || !historyToggleButton || !historyDiv || !historyPageDiv || !backToScannerButton || !historyContentDiv || !sessionNameContainer || !addNameBtn || !sessionNameInput || !sessionNameDisplay || !sessionNameText || !historyStickyHeaderDiv || !historyDynamicHeaderContentDiv || !runningTextContainer || !runningTextSpan || !sharePromptOverlay || !counterDeactivatedIndicator || !switchCameraButton || !cameraSelectionOverlay || !cameraListUl ) {\n            console.error(\"GRE≈†KA: Nedostaju kritiƒçni DOM elementi! Ne mogu nastaviti.\");\n            document.body.innerHTML = '<div style=\"padding: 20px; color: red; font-weight: bold;\">Gre≈°ka uƒçitavanja aplikacije. Nedostaju potrebni elementi. Osvje≈æite stranicu. Ako se problem ponavlja, provjerite konzolu preglednika.</div>';\n            return; // Prekini izvr≈°avanje skripte ako elementi nedostaju\n        }\n         console.log(\"Svi kritiƒçni DOM elementi pronaƒëeni.\");\n\n        // Dodaj globalni listener za rukovanje klikovima izvan elemenata (zatvaranje overlay-a, reset gumba)\n        document.body.addEventListener('click', globalClickListener, true); // Koristimo capturing fazu (true)\n\n        // Ve≈æi listenere na statiƒçke gumbe (koji su uvijek u DOM-u)\n\n        // Listener za gumb POVIJEST\n        historyToggleButton.addEventListener('click', () => { console.log(\"Klik na 'POVIJEST'.\"); playSound('click-sound'); switchToHistoryView(); });\n\n        // Listener za gumb < NA SKENER\n        backToScannerButton.addEventListener('click', () => { console.log(\"Klik na '< NA SKENER'.\"); playSound('click-sound'); switchToScannerView(); });\n\n        // Listener za SHARE gumb (ako je podr≈æano)\n        if (navigator.share) {\n             shareButton.style.display = 'block'; // Poka≈æi gumb ako je dijeljenje podr≈æano\n             shareButton.addEventListener('click', async () => {\n                 console.log(\"Klik na 'DIJELI'.\");\n                 // Resetiraj potvrde prije dijeljenja\n                 if (removeConfirm || removeNameConfirm) resetRemoveMode();\n                 if (ocistiConfirm) resetOcistiMode();\n\n                 const shareData = {\n                     title: 'QR SKENER-RAƒåUNATOR',\n                     text: 'Skenira i zbraja raƒçune bez instaliranja',\n                     url: 'https://soboslikar.github.io/QR-RACUNATOR/'\n                 };\n                 try {\n                     await navigator.share(shareData);\n                     console.log('Share dijalog zatvoren (vjerojatno uspje≈°no ili korisnik odustao).');\n                     // Ovdje se brojaƒç NE resetira automatski, samo ako je ##00## kod unesen\n                     // Nema potrebe za dodatnom logikom ovdje vezanom za brojaƒç.\n                 } catch (err) {\n                     console.error('Gre≈°ka dijeljenja:', err);\n                     if (err.name === 'AbortError') {\n                         console.log('Korisnik odustao od dijeljenja (AbortError).');\n                     } else {\n                         console.log('Do≈°lo je do druge gre≈°ke pri dijeljenju.');\n                         // Mo≈æda prikazati poruku korisniku ako dijeljenje nije uspjelo?\n                         // showTemporaryMessage(\"Dijeljenje nije uspjelo.\", 2000);\n                     }\n                 }\n             });\n        } else {\n             shareButton.style.display = 'none'; // Sakrij gumb ako dijeljenje nije podr≈æano\n             console.log(\"Web Share API nije podr≈æan u ovom pregledniku.\");\n        }\n\n        // Listener za UNOS IMENA (Enter/Escape)\n        sessionNameInput.addEventListener('keydown', (e) => {\n             if (e.key === 'Enter') {\n                 e.preventDefault(); // Sprijeƒçi defaultno pona≈°anje (npr. submit forme)\n                 saveName();\n             } else if (e.key === 'Escape') {\n                 // Vrati originalni naziv i sakrij input\n                 sessionNameInput.value = currentSessionName || '';\n                 sessionNameInput.style.display = 'none';\n                 updateNameDisplay();\n             }\n        });\n\n        // *** NOVI LISTENER za gumb za promjenu kamere ***\n        switchCameraButton.addEventListener('click', toggleCameraSelection);\n\n\n        // --- REDOSLIJED INICIJALIZACIJE APLIKACIJE --- (Va≈æno!) ---\n\n        // 1. Uƒçitaj lokalno stanje brojaƒça i aktivnost.\n        loadCountersState();\n\n        // 2. Inicijalizuj UserID i FirstUseTimestamp za logiranje.\n        initializeUserTracking();\n\n        // 3. Pokreni dohvaƒáanje podataka iz Google Sheeta u pozadini (asinkrono).\n        // Ovo ƒáe a≈æurirati brojaƒç2 i runningText, ali ne blokira ostatak inicijalizacije.\n        fetchSheetData().then(() => {\n            console.log(\"Sheet podaci uspje≈°no dohvaƒáeni i primijenjeni.\");\n            // Nakon uspje≈°nog dohvaƒáanja, provjeri prompt i a≈æuriraj UI ako je potrebno\n            if (document.body.classList.contains('scanner-view')) {\n                checkSharePrompt();\n                updateRunningTextVisibility();\n                 // Provjeri vidljivost gumba za kameru ponovno nakon ≈°to znamo koliko je kamera dostupno\n                 Html5Qrcode.getCameras().then(devices => {\n                     if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                        switchCameraButton.style.display = 'block';\n                     }\n                 }).catch(()=>{/* ignore error */});\n            }\n            // Logiraj uspje≈°no uƒçitavanje aplikacije NAKON ≈°to su podaci s weba dohvaƒáeni\n             logAppLoadedState(null); // Null jer nema gre≈°ke dohvata\n\n        }).catch(error => {\n             console.error(\"Gre≈°ka pri pozadinskom dohvaƒáanju podataka iz Sheeta:\", error);\n             // Ako je do≈°lo do gre≈°ke pri dohvaƒáanju, i dalje logiraj uƒçitavanje aplikacije, ali zabilje≈æi gre≈°ku\n             logAppLoadedState(error);\n             // UI a≈æuriranja u sluƒçaju gre≈°ke - veƒáina se ionako radi u updateDisplay ili se oslanja na inicijalne loadCountersState\n             if (document.body.classList.contains('scanner-view')) {\n                 checkSharePrompt(); // Provjeri prompt na temelju lokalnih brojaƒça\n                 updateRunningTextVisibility(); // Tekst ƒáe biti prazan jer fetch nije uspio\n                 // Provjeri vidljivost gumba za kameru\n                  Html5Qrcode.getCameras().then(devices => {\n                     if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                        switchCameraButton.style.display = 'block';\n                     }\n                 }).catch(()=>{/* ignore error */});\n             }\n        });\n\n        // 4. Provjeri koji je inicijalni view (scanner ili history).\n        console.log(\"Provjeravam inicijalni view (nakon osnovnih inicijalizacija)...\");\n        if (document.body.classList.contains('scanner-view')) {\n            console.log(\"Init: Scanner view - Pokreƒáem inicijalizaciju skenera (asinkrono) sa malim odmakom.\");\n            // Pokreni skener ASINKRONO sa kratkim odmakom da se DOM stigne stabilizirati i resursi osloboditi\n             setTimeout(() => {\n                 initializeScanner().catch(err => console.error(\"Inicijalizacija skenera pri prvom pokretanju FAILED:\", err));\n                 // Listener za promjenu vidljivosti taba se ve≈æe u initializeScanner, ali za svaki sluƒçaj\n                 if (!visibilityListenerAttached) {\n                     attachVisibilityListener();\n                 }\n             }, 100); // Poveƒáan delay na 100ms\n\n        } else {\n            console.log(\"Init: History view - Renderiram prikaz povijesti.\");\n            // Ako je history view, samo renderiraj. Skener se NE pokreƒáe.\n            renderHistoryView(currentlyViewedDate);\n        }\n\n         // 5. A≈æuriraj UI elemente koji ovise o trenutnoj sesiji (ukupno, broj raƒçuna, mala povijest, naziv, gumbi).\n         // Ovo se radi odmah, ne ƒçeka se fetchSheetData.\n        updateDisplay();\n        updateNameDisplay(); // Prikazi naziv sesije ako postoji\n        checkRemoveButtonVisibility(); // Prikazi Obri≈°i gumb ako ima povijesti ili naziva\n        checkOcistiButtonVisibility(); // Prikazi Spremi/Oƒçisti gumb ako ima povijesti\n        handleInfoDeleteMessageVisibility(); // A≈æuriraj info/delete poruku\n        updateDeactivatedIndicator(); // Prikazi status brojaƒça (kvaƒçicu)\n\n        console.log(\"DOMContentLoaded rutina zavr≈°ena.\");\n    }); // Kraj DOMContentLoaded\n\n    // Pomoƒána funkcija za logiranje stanja aplikacije pri uƒçitavanju\n    function logAppLoadedState(fetchError) {\n         let previousSessionDetails = null;\n         try {\n             // Prvo provjeri je li ostalo nesaƒçuvanog stanja od prethodnog pokretanja\n             const unsavedCount = localStorage.getItem(UNSAVED_COUNT_KEY);\n             const unsavedAmount = localStorage.getItem(UNSAVED_AMOUNT_KEY);\n             if (unsavedCount !== null && unsavedAmount !== null) {\n                 const count = parseInt(unsavedCount, 10);\n                 const amount = parseFloat(unsavedAmount);\n                 if (!isNaN(count) && !isNaN(amount) && count >= 0 && amount >= 0) { // Dodana provjera da amount >= 0\n                     console.log(\"Pronaƒëena nesaƒçuvana sesija za logiranje (iz localStorage):\");\n                     previousSessionDetails = { count: count, amount: amount.toFixed(2) };\n                     // Bri≈°i nakon ƒçitanja za log, da se ne logira vi≈°e puta\n                     localStorage.removeItem(UNSAVED_COUNT_KEY);\n                     localStorage.removeItem(UNSAVED_AMOUNT_KEY);\n                     console.log(\"Obrisano nesaƒçuvano stanje iz localStorage nakon ƒçitanja za log.\");\n                 } else {\n                     console.warn(\"Pronaƒëene nevalidne nesaƒçuvane vrednosti u localStorage, bri≈°em ih.\", unsavedCount, unsavedAmount);\n                     localStorage.removeItem(UNSAVED_COUNT_KEY);\n                     localStorage.removeItem(UNSAVED_AMOUNT_KEY);\n                 }\n             } else {\n                 console.log(\"Nema nesaƒçuvane sesije u localStorage za logovanje.\");\n             }\n         } catch (lsError) {\n             console.error(\"Gre≈°ka ƒçitanja/brisanja nesaƒçuvanog stanja iz localStorage za log:\", lsError);\n             // Ako se ovdje dogodi gre≈°ka, neƒáemo moƒái logirati prethodnu sesiju, ali log 'app_loaded' i dalje treba iƒái s error detaljima.\n         }\n\n         const appLoadedDetails = {\n             previousSession: previousSessionDetails,\n             fetchError: fetchError ? fetchError.toString() : null,\n             initialBrojac: brojac, // Uƒçitana vrijednost brojaƒça 1\n             initialBrojac2: brojac2, // Uƒçitana vrijednost brojaƒça 2 (iz localStorage ili default)\n             initialActive: isCounterDecrementActive, // Inicijalna aktivnost brojaƒça\n             initialView: document.body.classList.contains('scanner-view') ? 'scanner' : 'history'\n         };\n         const appLoadedEventData = { Event: 'app_loaded', Details: JSON.stringify(appLoadedDetails) };\n         sendLogData(appLoadedEventData);\n         console.log(\"'app_loaded' log pripremljen i poslan (asinkrono).\", appLoadedEventData);\n    }\n\n    console.log(\">>> KRAJ SKRIPTE <<<\"); // Oznaƒçava kraj JavaScript koda\n  </script>\n\n  <!-- Statcounter kod -->\n  <script type=\"text/javascript\"> var sc_project=12702047; var sc_invisible=1; var sc_security=\"e75d2592\"; var scJsHost = \"https://\"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + \"statcounter.com/counter/counter.js\"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>\n  <noscript><div class=\"statcounter\"><a title=\"Web Analytics\" href=\"https://statcounter.com/\" target=\"_blank\"><img class=\"statcounter\" src=\"https://c.statcounter.com/12702047/0/e75d2592/1/\" alt=\"Web Analytics\" referrerPolicy=\"no-referrer-when-downgrade\"></a></div></noscript>\n  <!-- Kraj Statcounter koda -->
  </body>
</html>
