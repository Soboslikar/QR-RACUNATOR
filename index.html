<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR RAČUNATOR</title>
  <!-- PWA Manifest Link -->
  <link rel="manifest" href="manifest.json">
  <meta name="google-site-verification" content="MiNsi-1k4TYmSbTNGPDs_lsgTyiVKmxEa4nkihpTB1s" />
  <meta property="og:title" content="QR RAČUNATOR" />
  <meta property="og:description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu."/>
  <meta name="description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu.">
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://soboslikar.github.io/QR-RACUNATOR/" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    /* CSS (Sve prethodno + NOVI STILOVI ZA PWA I MODAL) */
    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }
    body.scanner-view #history-page, body.scanner-view #ads-page { display: none; }
    body.history-view { background-color: white; }
    body.ads-view { background-color: #f0f2f5; }

    body.history-view #history-page, body.ads-view #ads-page {
        display: flex;
        flex-direction: column;
        padding: 0;
        min-height: calc(100vh - 1em);
        max-height: calc(100vh - 1em);
        box-sizing: border-box;
        overflow: hidden;
    }
    
    body.fullscreen-modal-open { overflow: hidden; }

    /* Sakrij SVE elemente skenera kad smo u history ili ads view */
    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator,
    body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay,
    body.history-view #manual-entry-modal-overlay,
    body.ads-view #header, body.ads-view #scan-instruction, body.ads-view #reader, body.ads-view #loaded-message, body.ads-view #duplicate-warning, body.ads-view #total-container, body.ads-view #session-name-container, body.ads-view #invoice-count, body.ads-view #history, body.ads-view #remove-from-list-btn, body.ads-view #history-toggle-btn, body.ads-view #share-button, body.ads-view #delete-warning, body.ads-view #running-text-container, body.ads-view #share-prompt-overlay, body.ads-view #counter-deactivated-indicator,
    body.ads-view #switch-camera-btn, body.ads-view #camera-selection-overlay,
    body.ads-view #manual-entry-modal-overlay
    {
        display: none !important;
    }

    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }
    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }
    
    #total-container { position: fixed; top: 23.5em; left: 50%; transform: translateX(-50%); z-index: 6; display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; }
    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    
    #action-buttons-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }
    #ads-button, #install-pwa-btn {
        width: 100%;
        box-sizing: border-box;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        padding: 0.6em 1.2em;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        animation: pulse-ads 1.5s ease-in-out infinite;
        display: none;
        white-space: nowrap;
    }
    #ads-button { background-color: #1e7e34; }
    #install-pwa-btn { background-color: #007bff; }

    #ads-button:active, #install-pwa-btn:active {
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        animation: none;
    }
    @keyframes pulse-ads {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }
    #ocisti-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    #ocisti-button.confirm-mode { background-color: yellow; color: black; }

    #session-name-container { position: fixed; top: 27.5em; left: 50%; transform: translateX(-50%); z-index: 5; display: flex; align-items: center; width: 95%; max-width: 400px; justify-content: space-between; min-height: 35px; text-align: center; margin-top: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; gap: 15px; }
    #session-name-wrapper { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: 5px; }
    #add-name-btn { padding: 0.4em 0.8em; font-size: 0.9em; background-color: #e0e0e0; color: black; display: block; flex-shrink: 0; font-weight: bold; white-space: nowrap; }
    #session-name-input { font-size: 1.2em; padding: 0.3em 0.5em; border: 1px solid #ccc; border-radius: 4px; width: 100%; display: none; box-sizing: border-box; flex-grow: 1; }
    #session-name-display { font-size: 1em; font-weight: bold; color: yellow; background-color: rgba(0, 0, 0, 0.5); padding: 0.3em 0.8em; border-radius: 5px; display: none; align-items: center; gap: 8px; flex-grow: 1; min-width: 50px; text-align: left; box-sizing: border-box; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #session-name-display .edit-icon { cursor: pointer; font-size: 0.8em; font-weight: normal; color: white; text-decoration: underline; flex-shrink: 0; }
    #manual-entry-btn { background-color: orange; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; line-height: 1.3; flex-shrink: 0; min-width: 90px; white-space: nowrap; margin-right: 5px; }
    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }
    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; animation: pulse 0.5s ease-in-out 3 alternate; position: fixed; top: 12.8em; left: 50%; transform: translateX(-50%); z-index: 5; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,4,8,0.2); }
    #delete-warning { font-weight: bold; display: none; text-align: center; position: fixed; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; z-index: 5; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }
    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }
    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }
    #history ul { list-style: none; padding: 0; margin: 0; }
    #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    #history li:last-child { border-bottom: none; }
    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    .red-btn { background: #ff0000; color: yellow; }
    .yellow-btn { background-color: yellow; color: black; }
    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }
    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }
    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }
    #share-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); animation: none; }
    #history-page, #ads-page { display: none; }

    #pwa-install-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 300; display: none; justify-content: center; align-items: center; }
    #pwa-install-modal-content { background-color: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 90%; width: 320px; text-align: center; }
    #pwa-install-modal-content h3 { margin-top: 0; color: #333; font-size: 1.3em; }
    #pwa-install-modal-content p { color: #555; line-height: 1.5; margin-bottom: 25px; }
    #pwa-install-modal-buttons { display: flex; flex-direction: column; gap: 10px; }
    #pwa-install-modal-buttons button { padding: 12px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #pwa-install-confirm-btn { background-color: #007bff; color: white; }
    #pwa-install-later-btn { background-color: #6c757d; color: white; }
    #pwa-install-never-btn { background: none; box-shadow: none; color: #888; text-decoration: underline; font-size: 0.9em; padding-top: 5px; }

    #history-sticky-header, #ads-sticky-header { position: sticky; top: 0; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    #history-sticky-header { background-color: white; }
    #ads-sticky-header { background-color: #f9f9f9; }

    #history-header, #ads-header { display: flex; align-items: center; justify-content: space-between; }
    #history-header h1, #ads-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }
    #back-to-scanner-btn, #back-to-scanner-from-ads-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }
    #back-to-scanner-btn:active, #back-to-scanner-from-ads-btn:active { background-color: darkgreen; }
    #history-content, #ads-content { flex-grow: 1; overflow-y: auto; padding: 1em; position: relative; }

    .ad-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .ad-title { font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 10px; }
    .ad-gallery-container { position: relative; margin-bottom: 15px; user-select: none; background-color: #e0e0e0; min-height: 200px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .ad-gallery-item { display: none; width: 100%; height: auto; max-height: 60vh; object-fit: contain; cursor: pointer; }
    .ad-gallery-item.is-iframe { height: 300px; }
    .ad-gallery-item.active { display: block; }
    .ad-gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.5); color: white; border: none; font-size: 1.8em; font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 5px; z-index: 2; line-height: 1; }
    .ad-gallery-nav.prev { left: 5px; }
    .ad-gallery-nav.next { right: 5px; }
    .ad-gallery-counter { position: absolute; top: 8px; right: 8px; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 3px 8px; font-size: 0.8em; border-radius: 10px; z-index: 2; }
    .ad-text { font-size: 1em; margin-bottom: 15px; line-height: 1.4; }
    .ad-contact-container { margin-bottom: 15px; }
    .ad-contact-container a { color: #00008B; text-decoration: none; font-weight: bold; font-size: 1.1em; }
    .ad-web-link-container { text-align: center; }
    .ad-web-link { display: inline-block; background-color: #007bff; color: white; padding: 10px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; transition: background-color 0.2s; }
    .ad-web-link:hover { background-color: #0056b3; }
    #ads-footer-promo { text-align: center; margin-top: 20px; padding: 15px; font-size: 1.1em; font-weight: bold; color: #333; background-color: #f0f0f0; border-radius: 5px; }
    .ad-share-btn { display: inline-block; background-color: #28a745; color: white; padding: 10px 20px; margin-top: 15px; border-radius: 5px; text-decoration: none; font-weight: bold; text-align: center; cursor: pointer; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .ad-share-btn:hover { background-color: #218838; }

    #fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 200; display: none; justify-content: center; align-items: center; flex-direction: column; }
    #fullscreen-content { max-width: 98%; max-height: 90%; width: 100%; }
    #fullscreen-content img, #fullscreen-content video { width: 100%; height: 100%; object-fit: contain; }
    #fullscreen-content iframe { width: 100%; height: 80vh; border: none; }
    #fullscreen-close { position: absolute; top: 15px; right: 20px; font-size: 2.5em; color: white; font-weight: bold; cursor: pointer; z-index: 202; line-height: 1; }
    .fullscreen-nav { position: fixed; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.4); color: white; border: none; font-size: 3em; font-weight: bold; cursor: pointer; padding: 10px; border-radius: 5px; z-index: 201; line-height: 1; }
    .fullscreen-nav.prev { left: 10px; }
    .fullscreen-nav.next { right: 10px; }
    #fullscreen-counter { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.6); color: white; padding: 5px 12px; font-size: 1em; border-radius: 15px; z-index: 201; }
    
    #scan-group-list, #all-days-list-rendered, #search-results ul, #search-results-all-days ul { list-style: none; padding: 0; margin: 0; }
     #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }
     #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }
     .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }
     .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
     .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }
     #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }
     #detail-scan-list { list-style: none; padding: 0; margin: 0; }
     #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}
     #detail-scan-list li:last-child { border-bottom: none; }
     #all-days-search-container { background-color: white; padding: 0.5em 0; margin-bottom: 0.2em; }
     #all-days-search-container input { flex-grow: 1; padding: 0.5em; min-width: 50px; font-size: 0.9em; }
     #all-days-search-container button { padding: 0.5em 0.6em; font-size: 0.9em; flex-shrink: 0; }
     #search-container { display: none; padding: 1em 0; margin-bottom: 1em; }
     #search-container > div:first-child { display: flex; gap: 10px; margin-bottom: 0.8em; }
     #search-summary-info-day { display: none; justify-content: space-between; align-items: center; padding: 0.6em 0; font-size: 1.1em; margin-top: 0.8em; border-top: 1px solid #eee; }
     #all-days-list-rendered li { background-color: #f0f0f0; border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 8px; }
     #all-days-list-rendered li:hover { background-color: #e0e0e0; }
     #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }
     #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }
     #all-days-summary-info, #search-summary-info-day { display: none; justify-content: space-between; align-items: center; font-size: 1.1em; }
     #history-date-info, #history-summary-info, #detail-summary-info { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
     #detail-header-info { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.5em; border-bottom: 1px solid #ccc; border-top: none; }
     #detail-summary-info { border-top: none; }
     #all-days-search-container { padding-bottom: 0.2em; border-bottom: 1px solid #eee; }
     #search-container { display: none; border-bottom: 1px solid #eee; }
     #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }
     #running-text-container span { display: inline-block; padding-left: 100%; font-size: 1.4em; font-weight: bold; color: yellow; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); animation: marquee 25s linear infinite; white-space: pre; }
     @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
     #share-prompt-overlay { position: absolute; top: 7em; left: 50%; transform: translateX(-50%); width: 60%; height: auto; background-color: rgba(0, 0, 0, 0.75); color: lightgreen; font-size: 1.3em; font-weight: bold; text-align: center; padding: 1.5em 1em; border-radius: 10px; z-index: 4; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.3); line-height: 1.4; align-items: center; justify-content: center; }
     #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
     #switch-camera-btn { position: fixed; top: 10px; right: 10px; z-index: 5; padding: 6px 8px; background-color: #007bff; color: white; border: none; border-radius: 50%; font-size: 1.4em; line-height: 1; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: none; }
     #switch-camera-btn:active { background-color: rgba(0, 0, 0, 0.7); }
     #camera-selection-overlay { position: fixed; top: 55px; right: 10px; background-color: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 6; padding: 5px 0; display: none; max-height: 150px; overflow-y: auto; min-width: 150px; }
     #camera-list { list-style: none; padding: 0; margin: 0; }
     #camera-list li { padding: 8px 12px; cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
     #camera-list li:hover { background-color: #f0f0f0; }
     #camera-list li.selected-camera { font-weight: bold; background-color: #e0e0e0; }
     #manual-entry-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
     #manual-entry-modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-width: 90%; width: 300px; text-align: center; }
     #manual-entry-modal-content input[type="text"] { width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
     #manual-entry-modal-content label { display: block; margin-bottom: 5px; font-weight: bold; text-align: left; }
     #manual-entry-modal-content div { margin-bottom: 15px; text-align: left; }
     #manual-entry-modal-content div:last-child { margin-bottom: 0; text-align: center; }
     #manual-entry-modal-content button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
     #manual-entry-modal-content button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
     #manual-entry-modal-content button#manual-add-btn { background-color: green; color: white; }
     #manual-entry-modal-content button#manual-cancel-btn { background-color: #dc3545; color: white; }
     #manual-entry-error { color: red; font-size: 0.9em; margin-top: 10px; display: none; }
     #import-file-input { display: none; }
     @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
     @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
  </style>
</head>
<body class="scanner-view">

  <!-- Ostatak HTML-a ostaje isti -->

<script>
    // *** GLOBALNE VARIJABLE I KONSTANTE ***
    // ... (sve postojeće varijable) ...
    const PWA_PROMPT_REJECTED_KEY = 'qrCalculatorPwaRejected';
    let deferredInstallPrompt = null;

    // DOM Elementi
    // ... (svi postojeći elementi) ...
    let installPwaBtn, pwaInstallModalOverlay, pwaInstallConfirmBtn, pwaInstallLaterBtn, pwaInstallNeverBtn;

    // ... (sve postojeće varijable) ...

    // SVE FUNKCIJE OD PRIJE, UKLJUČUJUĆI I ONE KOJE SU NEDOSTAJALE
    // (parseTime, normalizeDateForSearch, playSound, showTemporaryMessage, getISODateString, generateUUID, 
    // initializeUserTracking, sendLogData, saveFullHistoryToLocalStorage, loadFullHistoryFromLocalStorage, 
    // loadCountersState, saveBrojac, saveBrojac2, saveCounterActiveState, fetchSheetData, initializeCounters, 
    // checkOcistiButtonVisibility, updateDisplay, updateSmallHistoryList, checkRemoveButtonVisibility, 
    // handleInfoDeleteMessageVisibility, updateRunningText, updateRunningTextVisibility, checkSharePrompt, 
    // updateDeactivatedIndicator, resetRemoveMode, resetOcistiMode, startAddName, saveName, updateNameDisplay, 
    // startRemoveFromList, startOcistiConfirm, ocistiTrenutnoSkeniranje, handleScan, isElementOrParentHidden, 
    // startScannerWithCameraSelection, initializeScanner, stopScanner, toggleCameraSelection, switchCamera, 
    // showManualEntryModal, hideManualEntryModal, addManualEntry, cancelManualEntry, globalClickListener,
    // switchToScannerView, switchToHistoryView, switchToAdsView, generateSmartLink, renderAdsPage, 
    // handleAdsPageClick, changeGalleryMedia, openFullscreen, closeFullscreen, changeFullscreenMedia, 
    // updateFullscreenContent, clearDynamicHeaderContent, renderHistoryView, generirajHtmlZaSpremljenuGrupu, 
    // renderGroupDetailView, deleteScansForDay, renderAllDaysView, renderAllDaysList, executeAllDaysSearch, 
    // renderSessionSearchResults, executeSearch, startSearch, deleteSpecificSession, exportHistory, 
    // importHistory, handleVisibilityChange, attachVisibilityListener)

    // Ovdje zalijepite SVE funkcije iz prethodnih poruka, a ja ću samo napisati novu/izmijenjenu
    // da ne bude predugačko. Ključno je da su sve funkcije koje smo prije spominjali prisutne.

    function updateMainActionButtonsVisibility() {
        if (!adsButton || !installPwaBtn || !totalDiv) return;

        const showActionButtonsArea = ukupno <= 0 && povijest.length === 0;

        if (!showActionButtonsArea) {
            adsButton.style.display = 'none';
            installPwaBtn.style.display = 'none';
            totalDiv.style.display = 'block';
            return;
        }

        totalDiv.style.display = 'none';

        const showAds = adsConfiguration.enabled && adsConfiguration.adsList && adsConfiguration.adsList.length > 0;
        if (showAds) {
            adsButton.innerText = adsConfiguration.buttonText || "POGLEDAJ PONUDE";
            adsButton.style.display = 'block';
        } else {
            adsButton.style.display = 'none';
        }

        const canInstall = deferredInstallPrompt !== null;
        const userRejectedInstall = localStorage.getItem(PWA_PROMPT_REJECTED_KEY) === 'true';
        const isAppInstalled = window.matchMedia('(display-mode: standalone)').matches;
        const showInstall = canInstall && !userRejectedInstall && !isAppInstalled;

        if (showInstall) {
            installPwaBtn.style.display = 'block';
        } else {
            installPwaBtn.style.display = 'none';
        }

        if (!showAds && !showInstall) {
            totalDiv.style.display = 'block';
        }
    }

    function handleSharedLinkEntry() {
        const hash = window.location.hash;
        if (hash.includes('#ad=') && hash.includes('source=share')) {
            const existingUserID = localStorage.getItem(USER_ID_KEY);
            if (!existingUserID) {
                console.log("Detektiran PRVI POSJET preko podijeljenog linka.");
                setTimeout(() => {
                    sendLogData({ Event: 'new_user_from_share', Details: hash });
                }, 1000);
                setTimeout(() => {
                    if (document.body.classList.contains('ads-view')) {
                        const welcomeMsg = "Dobrodošli! Pogledajte ponudu, a zatim kliknite '< NA SKENER' da isprobate aplikaciju.";
                        showTemporaryMessage(loadedMsg, welcomeMsg, 5000);
                    }
                }, 1500);
            }
        }
    }

    function detectInAppBrowser() {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        if ((ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Instagram") > -1) || (ua.indexOf("WhatsApp") > -1) || (ua.indexOf("Viber") > -1)) {
            console.log("Detektiran In-App preglednik.");
            setTimeout(() => {
                sendLogData({ Event: 'IN_APP_BROWSER_SESSION', Details: ua.substring(0, 100) });
            }, 1000);
        }
    }

    function initializePWA() {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            console.log('`beforeinstallprompt` događaj uhvaćen.');
            updateMainActionButtonsVisibility();
        });

        installPwaBtn.addEventListener('click', () => {
            if (pwaInstallModalOverlay) pwaInstallModalOverlay.style.display = 'flex';
        });

        pwaInstallConfirmBtn.addEventListener('click', async () => {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                const { outcome } = await deferredInstallPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                if (outcome === 'accepted') {
                    sendLogData({ Event: 'APP_INSTALLED' });
                }
                deferredInstallPrompt = null;
            }
            if (pwaInstallModalOverlay) pwaInstallModalOverlay.style.display = 'none';
            updateMainActionButtonsVisibility();
        });

        pwaInstallLaterBtn.addEventListener('click', () => {
            if (pwaInstallModalOverlay) pwaInstallModalOverlay.style.display = 'none';
        });

        pwaInstallNeverBtn.addEventListener('click', () => {
            localStorage.setItem(PWA_PROMPT_REJECTED_KEY, 'true');
            if (pwaInstallModalOverlay) pwaInstallModalOverlay.style.display = 'none';
            updateMainActionButtonsVisibility();
            sendLogData({ Event: 'INSTALL_PROMPT_REJECTED' });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // ... (dohvaćanje DOM elemenata kao i prije) ...
        installPwaBtn = document.getElementById('install-pwa-btn');
        pwaInstallModalOverlay = document.getElementById('pwa-install-modal-overlay');
        pwaInstallConfirmBtn = document.getElementById('pwa-install-confirm-btn');
        pwaInstallLaterBtn = document.getElementById('pwa-install-later-btn');
        pwaInstallNeverBtn = document.getElementById('pwa-install-never-btn');
        
        handleSharedLinkEntry();
        detectInAppBrowser();
        initializePWA();

        // ... (svi vaši event listeneri) ...

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
            .then((registration) => {
                console.log('Service Worker registriran uspješno:', registration);
            })
            .catch((error) => {
                console.error('Greška pri registraciji Service Workera:', error);
            });
        }

        // ... (ostatak DOMContentLoaded logike) ...
    });
</script>

  <!-- Statcounter kod -->
  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- Kraj Statcounter koda -->

</body>
</html>
