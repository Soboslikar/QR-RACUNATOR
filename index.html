U redu, shvatio sam. Želiš da brzina "trčećeg teksta" bude konzistentna bez obzira na njegovu dužinu. To znači da duži tekst treba trajati duže da prođe, a kraći tekst kraće, kako bi se postigao isti vizualni efekt brzine kretanja.

Trenutno, brzina ovisi o fiksnom trajanju animacije (`animation: marquee 25s linear infinite;`). Fiksno trajanje s različitim dužinama teksta rezultira različitim brzinama.

Da bismo postigli konstantnu brzinu, moramo trajanje animacije (`animation-duration`) postaviti dinamički, ovisno o dužini teksta. To ćemo napraviti u JavaScriptu.

Evo koraka i modificiranog koda:

1.  **Dodat ćemo konstante** za definiranje brzine (npr. sekunde po karakteru) te minimalnog i maksimalnog trajanja animacije.
2.  **Modificirat ćemo funkciju `updateRunningText()`** koja postavlja tekst. U njoj ćemo izračunati odgovarajuće trajanje animacije na temelju dužine teksta i nove konstante za brzinu.
3.  **Primijenit ćemo izračunato trajanje** na `span` element unutar kontejnera `running-text-container`. Također ćemo osigurati da se animacija ponovno pokrene kada se tekst promijeni.
4.  **Prilagodit ćemo `updateRunningTextVisibility()`** da samo kontrolira vidljivost, oslanjajući se na `updateRunningText` za postavljanje i restartanje animacije s točnim trajanjem.

Evo modificiranog JavaScript koda. Preuzmi cijeli kod koji si mi poslao, i zamijeni cijeli `<script>` blok s ovim novim.

```javascript
  <script>
    // *** GLOBALNE VARIJABLE I KONSTANTE ***
    const MAX_HISTORY_ITEMS = 500;
    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';
    const COUNTER_KEY = 'qrCalculatorCounter';
    const COUNTER2_KEY = 'qrCalculatorCounter2';
    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';
    // AŽURIRAN URL S NOVIM KOJI SI POSLAO
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA/exec'; // <-- DODANO/IZMIJENJENO: Ispravljen URL (iz tvog koda)
    const CAMERA_ID_KEY = 'qrCalculatorSelectedCameraID'; // OSIGURANO DA JE GLOBALNO DEFINIRANO

    // NOVE KONSTANTE ZA BRZINU TRČEĆEG TEKSTA
    const SECONDS_PER_CHARACTER = 0.2; // Trajanje animacije po karakteru (podesi ovo za brže/sporije)
    const MIN_MARQUEE_DURATION = 5;    // Minimalno trajanje animacije u sekundama
    const MAX_MARQUEE_DURATION = 40;   // Maksimalno trajanje animacije u sekundama


    let ukupno = 0;
    let povijest = [];
    let removeConfirm = false;
    let ocistiConfirm = false;
    const removeBtnInitialText = 'Obriši iz liste';
    const ocistiBtnInitialText = 'SPREMI<br>I OČISTI';
    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';
    let html5QrCodeInstance = null;
    let isScannerActive = false;
    // DODANO: Varijabla za spremanje popisa dostupnih kamera
    let availableCameras = [];
    let visibilityListenerAttached = false;
    let currentSessionName = null;
    let removeNameConfirm = false;
    let currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
    let previousHistoryViewState = 'day-view';
    let lastSearchTerm = '';
    let brojac = 0;
    let brojac2 = 0;
    let tekstPoruka = "";
    let isCounterDecrementActive = true;

    // Ključevi za localStorage za UserID i nesačuvanu sesiju
    const USER_ID_KEY = 'qrCalculatorUserID';
    const FIRST_USE_KEY = 'qrCalculatorFirstUseTimestamp';
    const UNSAVED_COUNT_KEY = 'qrCalculatorUnsavedCount';
    const UNSAVED_AMOUNT_KEY = 'qrCalculatorUnsavedAmount';

    // Placeholderi za ID i prvi timestamp
    let currentUserID = null;
    let firstUseTimestamp = null;

    // DOM Elementi (Uključujući nove za Ručni unos i Import file input)
    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator;
    // NOVI DOM Elementi za kameru
    let switchCameraButton, cameraSelectionOverlay, cameraListUl;
    // NOVI DOM Elementi za Ručni unos
    let manualEntryBtn, manualEntryModalOverlay, manualAmountInput, manualTimeInput, manualAddBtn, manualCancelBtn, manualEntryErrorMsg;
    // NOVI DOM Element za Import file input
    let importFileInput;

    // --- VARIJABLE ZA KONTROLU ZVUKOVA, PORUKA I LOGOVA ---
    let errorSoundCooldown = false; // Flag za spriječavanje prebrzog ponavljanja error zvuka (0.5s cooldown)
    let ignoreErrorSoundUntil = 0; // Timestamp do kojeg ignoriramo error zvuk i poruku nakon uspješnog skena (2s delay)
    let messageTimeoutId = null; // ID timeouta za poruku "UČITANO" ili "DUPLIKAT"

    // NOVO: Cooldown za slanje duplicate logova (neovisno o zvuku/poruci, ali aktivira se kad bi se inače pustio zvuk/poruka)
    let ignoreDuplicateLogUntil = 0;
    const DUPLICATE_LOG_COOLDOWN = 5000; // Logiraj duplikat max jednom svakih 5 sekundi
    // -----------------------------------


    // *** POMOĆNE FUNKCIJE ***
    const parseTime = (timeStr) => { if (!timeStr || typeof timeStr !== 'string' || timeStr === '??:??' || timeStr.length !== 5 || timeStr[2] !== ':') return -1; const parts = timeStr.split(':'); const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return -1; return hours * 60 + minutes; };
function normalizeDateForSearch(input) {
    if (!input || typeof input !== 'string') {
        return null;
    }
    const term = input.trim();

    // Pokušaj parsirati kao ISO format YYYY-MM-DD
    const isoMatch = term.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (isoMatch) {
        const year = parseInt(isoMatch[1], 10);
        const month = parseInt(isoMatch[2], 10) - 1; // Mjeseci u JS-u su 0-indexed
        const day = parseInt(isoMatch[3], 10);
        const date = new Date(year, month, day);
        // Provjeri je li parsed date ispravan i odgovara unesenim dijelovima
        if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
             // Vrati u YYYY-MM-DD formatu koristeći postojeću helper funkciju ako je dostupna
             return getISODateString(date); // Koristi vašu postojeću funkciju
        }
    }

    // Pokušaj parsirati formate poput DD.MM.YYYY, D.M.YYYY, DD/MM/YYYY, D/M/YYYY, sa 2- or 4-znamenkastim godinama
    const dotSlashMatch = term.match(/^(\d{1,2})[.\/](\d{1,2})[.\/]((\d{4})|(\d{2}))$/);
    if (dotSlashMatch) {
        const day = parseInt(dotSlashMatch[1], 10);
        const month = parseInt(dotSlashMatch[2], 10) - 1; // Mjeseci u JS-u su 0-indexed
        let year = parseInt(dotSlashMatch[4] || dotSlashMatch[5], 10); // Uhvati 4-znamenkasti (group 4) ili 2-znamenkasti (group 5)

        // Obradi 2-znamenkastu godinu (npr. 25 postaje 2025)
        // Jednostavna pretpostavka: ako je godina < 100, dodaj 2000
        if (year < 100) {
             year += 2000;
        }

        const date = new Date(year, month, day);
         // Osnovna provjera valjanosti datuma (npr. 31.02.2023 nije validan datum)
         // Također provjeri da se kreirani datum podudara s unesenim dijelovima (zbog automatske korekcije od strane Date objekta)
        if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day && !isNaN(date.getTime())) {
             // Vrati u YYYY-MM-DD formatu koristeći postojeću helper funkciju
             return getISODateString(date); // Koristi vašu postojeću funkciju
        }
    }

    // Ako nijedan format nije prepoznat ili validan
    return null;
}

    // --- MODIFICIRANA playSound FUNKCIJA ZA COOLDOWN (SAMO ZA ERROR) ---
    function playSound(id) {
        // Posebno rukovanje za error zvuk zbog cool down logike
        if (id === 'error-sound') {
            if (errorSoundCooldown) {
                // console.log("Error sound on cooldown, skipping."); // KOMENTIRANO: Previše logova
                return; // Ne sviraj ako je na cooldownu
            }
            // Postavi cooldown prije sviranja zvuka
            errorSoundCooldown = true;
            setTimeout(() => {
                errorSoundCooldown = false;
                // console.log("Error sound cooldown ended."); // KOMENTIRANO: Previše logova
            }, 500); // 0.5 sekundi cooldown
        }

        const sound = document.getElementById(id);
        if (sound) {
            // Uvijeravamo se da je zvuk u potpunosti zaustavljen i resetiran prije ponovnog sviranja
            sound.pause();
            sound.currentTime = 0;
            // play() vraća Promise, handlamo potentialne greške (npr. autoplay policy)
            sound.play().catch(error => {
                // Ignoriraj specificne greške koje se javljaju zbog browser politika (npr. autoplay)
                // 'NotAllowedError' je čest ako korisnik nije još interagriao sa stranicom
                // 'AbortError' se može dogoditi ako je zvuk pauziran prije nego je počeo svirati
                if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') {
                    console.warn(`Zvuk "${id}" greška:`, error);
                }
            });
        } else {
            console.warn(`Audio element "${id}" nije pronađen.`);
        }
    }
    // -----------------------------------------------------------------

    function getISODateString(date) { if (!(date instanceof Date) || isNaN(date)) { console.error("getISODateString primio neispravan datum:", date); return null; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

    // --- MODIFICIRANA showTemporaryMessage FUNKCIJA ZA PRIKAZ PORUKA ---
    // Koristimo je za obje poruke (UČITANO i DUPLIKAT)
    function showTemporaryMessage(messageElement, messageText, duration = 1500) {
        if (!messageElement) return;

        // Clear any existing timeout before setting a new one specific to this message mechanism
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
            messageTimeoutId = null;
        }

        messageElement.innerText = messageText;
        messageElement.style.display = 'block';

        // Reset i pokretanje animacije
        messageElement.style.animation = 'none';
        // Koristimo requestAnimationFrame za osiguravanje reflowa prije restarta animacije
        requestAnimationFrame(() => {
             messageElement.offsetHeight; // Trigger reflow
             // Koristimo zoomFade animaciju samo za loadedMsg
             if (messageElement.id === 'loaded-message') {
                 messageElement.style.animation = 'zoomFade 1s ease-out';
             }
             // Za duplicateWarning, oslanjamo se samo na CSS animaciju (ako postoji) ili bez nje
             // NEMA forisranog JS restarta animacije ovdje
             if (messageElement.id === 'duplicate-warning') {
                 // Nema specifične JS animacije ovdje, oslanjamo se na CSS ako je definirana i uklonjenu gornju liniju
             }
        });


        // Store the timeout ID to hide the message
        messageTimeoutId = setTimeout(() => {
            // Provjeravamo da je element još uvijek onaj koji želimo sakriti
            // i da je tekst još uvijek isti (da ga druga poruka nije u međuvremenu pregazila)
            if (messageElement && messageElement.innerText === messageText) {
                messageElement.style.display = 'none';
                messageTimeoutId = null; // Clear ID after execution
            }
        }, duration);
    }
    // ------------------------------------------------------------------


    // Generisanje jednostavnog UUID-a
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Dobijanje ili kreiranje UserID i FirstUseTimestamp
    function initializeUserTracking() {
      currentUserID = localStorage.getItem(USER_ID_KEY);
      firstUseTimestamp = localStorage.getItem(FIRST_USE_KEY);

      if (!currentUserID) {
        console.log("Generiram novi UserID i FirstUseTimestamp.");
        currentUserID = generateUUID();
        firstUseTimestamp = new Date().toISOString();
        try {
          localStorage.setItem(USER_ID_KEY, currentUserID);
          localStorage.setItem(FIRST_USE_KEY, firstUseTimestamp);
        } catch (error) {
          console.error("Greška spremanja UserID/FirstUse u localStorage:", error);
          currentUserID = 'localStorage_error_' + generateUUID(); // Fallback ID
          firstUseTimestamp = new Date().toISOString();
        }
      }
      console.log("UserID:", currentUserID, "FirstUse:", firstUseTimestamp);
    }

    // Funkcija za slanje log podataka
    async function sendLogData(eventData) {
      // console.log("Pokušavam poslati log:", eventData.Event); // KOMENTIRANO: Previše logova
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) { // Dodana provjera i za stari URL
          console.warn("Logovanje onemogućeno: APPS_SCRIPT_URL nije postavljen ili je neispravan.");
          return;
      }
      const dataToSend = {
          ...eventData,
          UserID: currentUserID,
          FirstUseTimestamp: firstUseTimestamp,
          Timestamp: new Date().toISOString(),
          Counter1: brojac,
          Counter2: brojac2,
          Active: isCounterDecrementActive,
          UserAgent: navigator.userAgent
      };
      console.log(`Pokušavam poslati log '${dataToSend.Event}'...`); // Ostavljen ovaj log
      try {
          const response = await fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors', // Važno za Google Apps Script
              cache: 'no-cache',
              headers: {'Content-Type': 'application/json'}, // Iako no-cors, dobra praksa
              redirect: 'follow',
              body: JSON.stringify(dataToSend)
          });
          // Kod no-cors mode-a, response.ok i status su neupotrebljivi.
          // Provjeru uspjeha radi se u Apps Scriptu.
          console.log(`Log zahtev '${dataToSend.Event}' poslan (no-cors). Proverite Apps Script logove za potvrdu.`); // Ostavljen ovaj log
      } catch (error) {
          console.error(`Greška prilikom slanja loga '${dataToSend.Event}':`, error); // Ostavljen log greške
      }
    }


    // *** FUNKCIJE ZA LOKALNU POHRANU ***
    function saveFullHistoryToLocalStorage(fullHistory) { try { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(fullHistory)); console.log("Puna povijest spremljena."); } catch (error) { console.error("Greška spremanja:", error); alert("Greška: Nije moguće spremiti povijest."); } }
    function loadFullHistoryFromLocalStorage() { try { const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY); if (historyJson) { const loadedHistory = JSON.parse(historyJson); return loadedHistory.map(group => ({ timestamp: group.timestamp || Date.now(), lastQrTime: group.lastQrTime || '??:??', name: group.name || null, racuni: Array.isArray(group.racuni) ? group.racuni.map(item => ({ ...item, scanTimestamp: item.scanTimestamp || 0 })) : [] })); } return []; } catch (error) { console.error("Greška učitavanja:", error); return []; } }
    function loadCountersState() { const storedBrojac = localStorage.getItem(COUNTER_KEY); const storedBrojac2 = localStorage.getItem(COUNTER2_KEY); const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY); brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null; brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 0) : 0; isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true; if (isNaN(brojac)) brojac = null; if (isNaN(brojac2)) brojac2 = 0; console.log("Učitano stanje:", { brojac, brojac2, isCounterDecrementActive }); updateDeactivatedIndicator(); }
    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }
    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }
    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }

    // *** FUNKCIJE ZA DOHVAĆANJE PODATAKA IZ SHEETA ***
    async function fetchSheetData() { console.log("Pokušavam dohvatiti podatke iz Google Sheeta..."); if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) { // Dodana provjera i za stari URL
         console.warn("Dohvaćanje iz Sheeta onemogućeno: APPS_SCRIPT_URL nije postavljen ili je neispravan.");
         tekstPoruka = ""; // Clear text if URL is bad
         initializeCounters(); // Initialize counters even without sheet data
         updateRunningText(); // Update running text display (will be empty)
         return Promise.reject(new Error("URL za Sheet nije postavljen/ispravan"));
    } try { const response = await fetch(APPS_SCRIPT_URL); if (!response.ok) { throw new Error(`HTTP greška ${response.status}`); } const data = await response.json(); console.log("Podaci dohvaćeni:", data); let newPrag = data.pragBrojac !== undefined ? parseInt(data.pragBrojac, 10) : 0; if (isNaN(newPrag) || newPrag < 0) { newPrag = 0; } else if (newPrag > 500) { newPrag = 500; } brojac2 = newPrag; saveBrojac2(); tekstPoruka = data.trceciTekst || ""; initializeCounters(); updateRunningText(); return Promise.resolve(); } catch (error) { console.error("Greška pri dohvaćanju podataka iz Sheeta:", error); tekstPoruka = ""; initializeCounters(); updateRunningText(); return Promise.reject(error); } }

    // *** INICIJALIZACIJA BROJAČA ***
    function initializeCounters() { console.log("Inicijalizacija brojača..."); if (brojac === null) { console.log("Brojač 1 nije inicijaliziran, postavljanje na brojač 2."); brojac = brojac2; saveBrojac(); } else { console.log("Brojač 1 učitan s vrijednošću:", brojac); } checkSharePrompt(); updateRunningTextVisibility(); }

    // *** FUNKCIJE ZA AŽURIRANJE PRIKAZA ***
    function checkOcistiButtonVisibility() { if (!ocistiButton) return; ocistiButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if ((povijest.length === 0 && !currentSessionName) && ocistiConfirm) { resetOcistiMode(); } }
    function updateDisplay() { if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} €`; const count = povijest.length; if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAČUN' : 'RAČUNA'}`; if (document.body.classList.contains('scanner-view')) { updateSmallHistoryList(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); checkOcistiButtonVisibility(); updateNameDisplay(); } };
    function updateSmallHistoryList() { if (!historyList || !historyDiv) return; if (povijest.length > 0) { historyDiv.style.display = 'block'; historyList.innerHTML = ''; const recentHistory = povijest; recentHistory.forEach((item, index) => { const globalIndex = povijest.length - recentHistory.length + index; const listItem = document.createElement('li'); listItem.innerText = `${globalIndex + 1}. ${item.time} - ${item.amount.toFixed(2)} €`; historyList.appendChild(listItem); }); historyDiv.scrollTop = historyDiv.scrollHeight; } else { historyDiv.style.display = 'none'; } }
    function checkRemoveButtonVisibility() { if (!removeButton) return; removeButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if (povijest.length === 0 && !currentSessionName && (removeConfirm || removeNameConfirm)) resetRemoveMode(); }
    function handleInfoDeleteMessageVisibility() { const isScannerView = document.body.classList.contains('scanner-view'); if (!deleteWarningDiv || !isScannerView) { if(deleteWarningDiv) deleteWarningDiv.style.display = 'none'; return; } let shouldDisplay = false, textToShow = '', modeClass = ''; if (removeConfirm && povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; textToShow = `OBRIŠI ${lastItem.time} = ${lastItem.amount.toFixed(2)} €?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (removeNameConfirm && currentSessionName) { textToShow = `OBRIŠI NAZIV "${currentSessionName}"?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length > 0 && deleteWarningDiv.dataset.lastScanText) { textToShow = deleteWarningDiv.dataset.lastScanText; modeClass = 'info-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length === 0 && currentSessionName && deleteWarningDiv.dataset.lastNameText) { textToShow = deleteWarningDiv.dataset.lastNameText; modeClass = 'info-mode'; shouldDisplay = true; }

        if (shouldDisplay) {
             deleteWarningDiv.innerText = textToShow;
             deleteWarningDiv.className = `delete-warning ${modeClass}`;
             deleteWarningDiv.style.display = 'block';
        } else {
             deleteWarningDiv.style.display = 'none';
        }
    }

    // MODIFICIRANA updateRunningText funkcija za izračun i primjenu dinamičkog trajanja
    function updateRunningText() {
         if (runningTextSpan) {
             runningTextSpan.textContent = tekstPoruka;

             // Izračunaj i primijeni dinamičko trajanje animacije
             if (tekstPoruka && tekstPoruka.length > 0) {
                 const textLength = tekstPoruka.length;
                 let duration = textLength * SECONDS_PER_CHARACTER;

                 // Ograniči trajanje na minimalnu i maksimalnu vrijednost
                 duration = Math.max(MIN_MARQUEE_DURATION, Math.min(MAX_MARQUEE_DURATION, duration));
                 // Osiguraj da trajanje nije nula ili negativno
                 duration = Math.max(duration, 0.1);

                 // Zaustavi trenutnu animaciju, prisili reflow, pa primijeni novu
                 runningTextSpan.style.animation = 'none'; // Stop current animation
                 requestAnimationFrame(() => {
                     runningTextSpan.offsetHeight; // Prisili preglednik da prepozna promjenu (reset animacije)
                     runningTextSpan.style.animation = `marquee ${duration}s linear infinite`; // Postavi novu animaciju s izračunatim trajanjem
                 });

             } else {
                 // Ako nema teksta, zaustavi animaciju i sakrij je (visibility se hendla zasebno)
                 runningTextSpan.style.animation = 'none';
             }
         }
         // Ova funkcija sada samo kontrolira display: block/none na kontejneru
         updateRunningTextVisibility();
     }

    // MODIFICIRANA updateRunningTextVisibility: Dodana provjera za modal ručnog unosa
    function updateRunningTextVisibility() {
        const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex';
        const shouldShowText = tekstPoruka &&
                               (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') &&
                               !isManualEntryModalOpen && // NE prikazuj ako je modal otvoren
                               document.body.classList.contains('scanner-view');
        if (runningTextContainer) {
            // Ova funkcija sada samo mijenja display stil kontejnera
            // Logika za postavljanje i restartanje animacije s točnim trajanjem premještena je u updateRunningText
            runningTextContainer.style.display = shouldShowText ? 'block' : 'none';
        }
    }

    // MODIFICIRANA checkSharePrompt: Dodana provjera za modal ručnog unosa
    function checkSharePrompt() {
         const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex';
         const shouldShowPrompt = brojac === 0 && brojac2 > 0 &&
                                   !isManualEntryModalOpen && // NE prikazuj ako je modal otvoren
                                   document.body.classList.contains('scanner-view');
         if (sharePromptOverlay) {
             sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none';
             updateRunningTextVisibility(); // Ažuriraj i tekst koji trči
         }
    }

    // MODIFICIRANA updateDeactivatedIndicator: Dodana provjera za modal ručnog unosa
    function updateDeactivatedIndicator() {
         const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex';
         if (counterDeactivatedIndicator) {
             counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view') && !isManualEntryModalOpen) ? 'block' : 'none';
         }
    }


    // *** FUNKCIJE ZA RESETIRANJE STANJA GUMBA ***
    function resetRemoveMode() { if (!removeButton) return; removeButton.innerText = removeBtnInitialText; removeButton.classList.remove('yellow-btn'); removeButton.classList.add('red-btn'); removeConfirm = false; removeNameConfirm = false;
        if (deleteWarningDiv) {
            if (deleteWarningDiv.dataset.beforeConfirmText) {
                deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText;
                delete deleteWarningDiv.dataset.beforeConfirmText;
            } else if (deleteWarningDiv.dataset.beforeConfirmNameText) {
                 deleteWarningDiv.dataset.lastNameText = deleteWarningDiv.dataset.beforeConfirmNameText;
                 delete deleteWarningDiv.dataset.beforeConfirmNameText;
            } else if (povijest.length === 0 && !currentSessionName) {
                 delete deleteWarningDiv.dataset.lastScanText;
                 delete deleteWarningDiv.dataset.lastNameText;
            }
        }
        handleInfoDeleteMessageVisibility();
        checkRemoveButtonVisibility();
    }
    function resetOcistiMode() { if (!ocistiButton) return; ocistiButton.innerHTML = ocistiBtnInitialText; ocistiButton.classList.remove('confirm-mode'); ocistiConfirm = false; checkOcistiButtonVisibility(); }

    // *** FUNKCIJE ZA NAZIV SESIJE ***
    function startAddName() { if (!addNameBtn || !sessionNameInput || !sessionNameDisplay || !document.body.classList.contains('scanner-view')) return;
         // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }
        playSound('click-sound'); addNameBtn.style.display = 'none'; sessionNameDisplay.style.display = 'none'; sessionNameInput.style.display = 'block'; sessionNameInput.value = currentSessionName || ''; sessionNameInput.focus(); sessionNameInput.select(); }

    // Modificirana saveName funkcija
    function saveName() {
        if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return;

        // Provjeri je li input polje za ime trenutno prikazano. Ako nije, ova funkcija je pozvana greškom (npr. blur event kad polje nije ni bilo vidljivo)
        if (sessionNameInput.style.display === 'none') {
             // console.log("saveName called but input was not visible. Skipping save."); // KOMENTIRANO: Previše logova
             return;
        }

        const inputText = sessionNameInput.value.trim();

        if (inputText === "##--##") {
            showTemporaryMessage(loadedMsg, "RJEŠENO"); // Koristimo loadedMsg za ovu poruku
            isCounterDecrementActive = false;
            saveCounterActiveState();
            updateDeactivatedIndicator(); // Ažuriraj indikator
            sessionNameInput.value = '';
            sessionNameInput.style.display = 'none';
            updateNameDisplay(); // Sakrij input, prikaži gumb "DODAJ NAZIV"
            checkRemoveButtonVisibility();
            // Dodano: Ukloni "obriši naziv?" state ako je bio aktivan
            if(removeNameConfirm) resetRemoveMode();
             sendLogData({ Event: 'cheat_code_deactivate', Details: '##--##' });
            return;
        } else if (inputText === "##00##") {
            showTemporaryMessage(loadedMsg, "RESETIRANO"); // Koristimo loadedMsg za ovu poruku
            brojac = 0;
            brojac2 = 0;
            isCounterDecrementActive = true;
            saveBrojac();
            saveBrojac2();
            saveCounterActiveState();
            localStorage.removeItem(CAMERA_ID_KEY); // <<< RESETIRAJ KAMERU
            updateDeactivatedIndicator(); // Ažuriraj indikator
            sessionNameInput.value = '';
            sessionNameInput.style.display = 'none';
            updateNameDisplay(); // Sakrij input, prikaži gumb "DODAJ NAZIV"
            checkSharePrompt();
            updateRunningTextVisibility();
            checkRemoveButtonVisibility();
             // Dodano: Ukloni "obriši naziv?" state ako je bio aktivan
            if(removeNameConfirm) resetRemoveMode();
            // Nema potrebe za restartom skenera ovdje, on će se inicijalizirati sa zadanim ID-jem pri sljedećem prijelazu
             sendLogData({ Event: 'cheat_code_reset', Details: '##00##' });
            return;
        }
        const newName = inputText;
        const oldName = currentSessionName; // Spremi staro ime za logiranje
        currentSessionName = newName || null;

         if (deleteWarningDiv) {
             if (currentSessionName) {
                deleteWarningDiv.dataset.lastNameText = `NAZIV: "${currentSessionName}"`;
             } else {
                 delete deleteWarningDiv.dataset.lastNameText;
             }
         }

        // Logiranje promjene naziva SAMO AKO SE IME STVARNO PROMIJENILO (dodano, uklonjeno, ili promijenjen tekst)
         if (oldName !== currentSessionName) {
             sendLogData({ Event: 'session_name_changed', Details: currentSessionName || 'removed' });
         }


        sessionNameInput.style.display = 'none';
        updateNameDisplay();
        checkRemoveButtonVisibility();
        handleInfoDeleteMessageVisibility(); // Ažuriraj prikaz poruke
    }

    function updateNameDisplay() { if (!addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (currentSessionName) { sessionNameText.textContent = currentSessionName; sessionNameDisplay.style.display = 'flex'; addNameBtn.style.display = 'none'; } else { sessionNameDisplay.style.display = 'none'; addNameBtn.style.display = 'block'; } }

    // *** FUNKCIJE ZA UPRAVLJANJE TRENUTNOM SESIJOM SKENIRANJA ***
    function startRemoveFromList() { if (!removeButton || !document.body.classList.contains('scanner-view')) return;
         // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }
        if (removeNameConfirm) {
             playSound('remove-sound'); // Zvuk na potvrdu brisanja naziva (smeće.mp3)
             const oldName = currentSessionName; // Logiraj staro ime
             currentSessionName = null;
             if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastNameText; // Ukloni tekst naziva
             resetRemoveMode(); // Resetira removeConfirm i removeNameConfirm
             updateNameDisplay();
             checkRemoveButtonVisibility(); // Ponovno provjeri vidljivost nakon brisanja imena
              sendLogData({ Event: 'session_name_removed_confirmed', Details: oldName || 'N/A' }); // Logiranje brisanja naziva
             return;
         }
         if (removeConfirm) {
             if (povijest.length > 0) {
                 const removed = povijest.pop();
                 ukupno -= removed.amount;
                 playSound('remove-sound'); // Zvuk na potvrdu brisanja računa iz liste (smeće.mp3)

                  // Logiranje brisanja zadnjeg računa
                  const removedDetails = { amount: removed.amount, time: removed.time, isManual: removed.qrCode.startsWith('MANUAL_') };
                  sendLogData({ Event: 'last_invoice_removed_confirmed', Details: JSON.stringify(removedDetails) });


                 if (povijest.length === 0 && currentSessionName) {
                     // Posljednji račun obrisan, ostao samo naziv - prelazi u mode brisanja naziva
                     removeButton.innerHTML = 'Obriši<br>Naziv?';
                     removeButton.classList.remove('red-btn');
                     removeButton.classList.add('yellow-btn');
                     removeConfirm = false;
                     removeNameConfirm = true;
                     if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; }
                     handleInfoDeleteMessageVisibility();
                 } else {
                     // Ostalo još računa ili nije bilo naziva
                     if (povijest.length > 0) {
                         const lastItem = povijest[povijest.length - 1];
                         if (deleteWarningDiv) deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${lastItem.time} = ${lastItem.amount.toFixed(2)} €`;
                     } else {
                         if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText;
                     }
                     resetRemoveMode(); // Resetira removeConfirm i handleInfoDeleteMessageVisibility
                 }
             } else {
                 // Ako je povijest već bila prazna, a bio je u confirm modu (ne bi se trebalo dogoditi s provjerom na gumbu)
                 resetRemoveMode();
                 console.warn("Pokliknut Obriši gumb, ali nema računa ni naziva.");
             }
             updateDisplay();
             return;
         }

         // Prvi klik na "Obriši iz liste" ili "Obriši Naziv"
         if (povijest.length > 0) {
             playSound('click-sound'); // Zvuk na prvi klik za potvrdu brisanja sa liste
             removeButton.innerText = 'Potvrdi';
             removeButton.classList.remove('red-btn');
             removeButton.classList.add('yellow-btn');
             removeConfirm = true;
             removeNameConfirm = false; // Ensure this is false
             if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmText = deleteWarningDiv.dataset.lastScanText; // Spremi info tekst
             handleInfoDeleteMessageVisibility();
              sendLogData({ Event: 'last_invoice_remove_prompt' }); // Logiranje pokušaja brisanja zadnjeg računa
         } else if (currentSessionName) {
             playSound('click-sound'); // Zvuk na prvi klik za potvrdu brisanja naziva
             removeButton.innerHTML = 'Obriši<br>Naziv?';
             removeButton.classList.remove('red-btn');
             removeButton.classList.add('yellow-btn');
             removeConfirm = false; // Ensure this is false
             removeNameConfirm = true;
             if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; // Spremi info tekst naziva
             handleInfoDeleteMessageVisibility();
              sendLogData({ Event: 'session_name_remove_prompt' }); // Logiranje pokušaja brisanja naziva
         } else {
             // Ako je povijest prazna i nema naziva, gumb bi trebao biti skriven, ali za svaki slučaj
              resetRemoveMode();
              console.warn("Pokliknut Obriši gumb, ali nema računa ni naziva.");
         }
    }

    function startOcistiConfirm() {
        if (!ocistiButton || !document.body.classList.contains('scanner-view')) return;
         // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }
        if (!ocistiConfirm) {
            // Ovo je prvi klik - prelazak u mod potvrde
            ocistiButton.innerHTML = ocistiConfirmText;
            ocistiButton.classList.add('confirm-mode');
            ocistiConfirm = true;
            // playSound('click-sound'); // Zvuk prvog klika je uklonjen prema zahtjevu
             sendLogData({ Event: 'save_session_prompt' }); // Logiranje pokušaja spremanja
        } else {
            // Ovo je drugi klik - POTVRDA spremanja/čišćenja
            ocistiTrenutnoSkeniranje(); // Ova funkcija ne svira zvuk, samo sprema i resetira varijable
            resetOcistiMode(); // Resetira stanje gumba *PRIJE* zvuka
            playSound('clear-session-sound'); // Zvuk na POTVRDU spremanja/čišćenja (čišćenje.mp3) - sada je ovdje
        }
    }


    // Funkcija za spremanje sesije
    function ocistiTrenutnoSkeniranje() {
        if (povijest.length === 0 && !currentSessionName) {
             console.warn("Pokušaj spremanja prazne sesije.");
             return;
        }
        const vrijemeCiscenja = Date.now();
        const sortiraniRacuniZaSpremanje = [...povijest].sort((a, b) => { const timeA = parseTime(a.time); const timeB = parseTime(b.time); if (timeA === -1 && timeB !== -1) return -1; if (timeA !== -1 && timeB === -1) return 1; if (timeA === -1 && timeB === -1) return (a.scanTimestamp || 0) - (b.scanTimestamp || 0); return timeA - timeB; });
        let zadnjeValidnoVrijemeIzSortiraneListe = '??:??';
        for (let i = sortiraniRacuniZaSpremanje.length - 1; i >= 0; i--) { if (sortiraniRacuniZaSpremanje[i].time && sortiraniRacuniZaSpremanje[i].time !== '??:??') { zadnjeValidnoVrijemeIzSortiraneListe = sortiraniRacuniZaSpremanje[i].time; break; } }
        const novaGrupa = {
            timestamp: vrijemeCiscenja,
            lastQrTime: zadnjeValidnoVrijemeIzSortiraneListe,
            name: currentSessionName || null,
            racuni: sortiraniRacuniZaSpremanje
        };
        console.log("Spremam sesiju:", novaGrupa);
        let punaPovijest = loadFullHistoryFromLocalStorage();
        punaPovijest.push(novaGrupa);
        saveFullHistoryToLocalStorage(punaPovijest);
        const sessionTotalAmount = novaGrupa.racuni.reduce((sum, item) => sum + item.amount, 0);
        const sessionDetails = { sessionName: novaGrupa.name, invoiceCount: novaGrupa.racuni.length, totalAmount: sessionTotalAmount.toFixed(2), lastQrTime: novaGrupa.lastQrTime };
        const eventData = { Event: 'session_saved', Details: JSON.stringify(sessionDetails) };
        sendLogData(eventData);
        try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); console.log("Obrisano nesačuvano stanje nakon spremanja sesije."); } catch (lsError) { console.error("Greška brisanja nesačuvanog stanja u localStorage:", lsError); }
        povijest = [];
        ukupno = 0;
        currentSessionName = null;
        if (deleteWarningDiv) {
            delete deleteWarningDiv.dataset.lastScanText;
            delete deleteWarningDiv.dataset.beforeConfirmText;
            delete deleteWarningDiv.dataset.lastNameText;
            delete deleteWarningDiv.dataset.beforeConfirmNameText;
        }
        resetRemoveMode();
        // resetOcistiMode() se poziva U startOcistiConfirm() nakon ovog poziva
        updateDisplay();
        console.log("Trenutna sesija spremljena i očišćena.");
        // alert("Skeniranje spremljeno u povijest!"); // Možda zamijeniti sa showTemporaryMessage? Nije traženo.
    }


    // *** OBRADA SKENIRANOG QR KODA ***
    function handleScan(decodedText) {
        // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }
        if (removeNameConfirm) resetRemoveMode();
        if (removeConfirm) resetRemoveMode();
        if (ocistiConfirm) resetOcistiMode();

        // Sakrij duplicate warning ako je vidljiv. LoadedMsg se upravlja preko showTemporaryMessage
        if (duplicateWarning) duplicateWarning.style.display = 'none';


        try {
            const qrParts = decodedText.split('?');
            if (qrParts.length < 2) throw new Error("Invalid QR format");
            const params = new URLSearchParams(qrParts[1]);
            const iznosCentStr = params.get('izn');
            const datv = params.get('datv');
            if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) throw new Error("Invalid 'izn'");

            const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText);
            let isDuplicateInRecentSaved = false;
            const fullHistory = loadFullHistoryFromLocalStorage();
            // Provjera duplikata u zadnjih 30 dana (postojeća logika)
            if (fullHistory.length > 0) {
                const thirtyDaysAgoTimestamp = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const recentHistory = fullHistory.filter(grupa => grupa.timestamp >= thirtyDaysAgoTimestamp);
                isDuplicateInRecentSaved = recentHistory.some(grupa => grupa.racuni.some(item => item.qrCode === decodedText));
                // if(isDuplicateInRecentSaved) console.log("Duplikat pronađen u zadnjih 30 dana."); // KOMENTIRANO: Previše logova
            }


            if (isDuplicateInCurrent || isDuplicateInRecentSaved) {
                 console.warn("Duplikat pronađen:", decodedText);

                 // Provjeri je li prošla odgoda od zadnjeg uspješnog skena (2 sekunde) - OVO OSTAJE ZA ZVUK/PORUKU KORISNIKU
                 if (Date.now() >= ignoreErrorSoundUntil) {
                     // Ako je prošla odgoda, sviraj error (uz 0.5s cooldown) i prikaži poruku duplikata
                     playSound('error-sound');
                     showTemporaryMessage(duplicateWarning, "TAJ RAČUN JE URAČUNAT", 1500);

                     // NOVO: Provjeri je li prošao cooldown za logiranje duplikata
                     if (Date.now() >= ignoreDuplicateLogUntil) {
                         // Logiranje duplikata (BEZ DETALJA) - MODIFICIRANO
                         sendLogData({ Event: 'scan_duplicate' }); // <-- IZMJENA: Bez Details polja

                         // Postavi cooldown za logiranje duplikata (npr. 5 sekundi)
                         ignoreDuplicateLogUntil = Date.now() + DUPLICATE_LOG_COOLDOWN;
                         console.log(`Duplicate log sent. Next duplicate log ignored until ${new Date(ignoreDuplicateLogUntil).toLocaleTimeString()} (global cooldown).`);
                     } else {
                          // console.log("Duplicate log skipped due to global cooldown."); // KOMENTIRANO: Previše logova
                     }

                 } else {
                     // User notification (sound/message) is suppressed due to recent successful scan.
                     // No user feedback means no need to log it as a "notified duplicate".
                     // console.log(`Duplicate ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}). No log sent.`); // KOMENTIRANO: Previše logova
                 }


                 return; // Ne obrađuj duplikat
            }

            // --- OBRADA NOVOG, JEDINSTVENOG RAČUNA ---
            const iznosCenti = parseFloat(iznosCentStr);
            const iznosEura = iznosCenti / 100;
            let time = '??:??';
            if (datv && typeof datv === 'string') { let hourStr = null, minuteStr = null; const underscoreIndex = datv.indexOf('_'); const tIndex = datv.toUpperCase().indexOf('T'); if (underscoreIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (tIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (datv.length === 12) { hourStr = datv.substring(8, 10); minuteStr = datv.substring(10, 12); } if (hourStr && minuteStr) { const hour = parseInt(hourStr, 10); const minute = parseInt(minuteStr, 10); if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; else time = '??:??'; } else time = '??:??'; }

            if (instructionDiv) instructionDiv.style.display = 'none';
            const newItem = { amount: iznosEura, qrCode: decodedText, time: time, datv: datv || '', scanTimestamp: Date.now() };
            povijest.push(newItem); // Račun se dodaje PRVI
            ukupno += iznosEura;

            if (isCounterDecrementActive && brojac > 0) { brojac--; console.log("Brojač smanjen na:", brojac); saveBrojac(); checkSharePrompt(); } else { /* console.log("Brojač nije smanjen. Aktivno:", isCounterDecrementActive, "Vrijednost:", brojac); */ } // KOMENTIRANO: Previše logova

            try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Greška spremanja nesačuvanog stanja u localStorage:", lsError); }

            playSound('scan-sound'); // ZVUK ZA USPJEŠNO SKENIRANO (Učitano.mp3)

            // --- POSTAVI BLOKADU ZA ERROR ZVUK I PORUKU NAKON USPJEŠNOG SKENA ---
            ignoreErrorSoundUntil = Date.now() + 2000; // Blokiraj error zvuk i poruku sljedeće 2 sekunde
            // console.log(`Error sound and message blocked until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}`); // KOMENTIRANO: Previše logova
            // ------------------------------------------------------------------

            updateDisplay();
            showTemporaryMessage(loadedMsg, "UČITANO", 1000); // Prikaži poruku "UČITANO"
            if (deleteWarningDiv) { deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${newItem.time} = ${newItem.amount.toFixed(2)} €`; handleInfoDeleteMessageVisibility(); }

             // Logiraj uspješan sken - MODIFICIRANO
             const scanDetails = {
                 amount: newItem.amount,
                 time: newItem.time,
                 sessionInvoiceNumber: povijest.length // <-- Dodano: Broj računa po redu
             };
             sendLogData({ Event: 'scan_success', Details: JSON.stringify(scanDetails) }); // <-- IZMJENA


        } catch (error) {
            // --- OBRADA GREŠKE PARSIRANJA QR KODA (Nije duplikat, nije validan format) ---
            console.error("Greška obrade QR (parse error):", error, decodedText);

             // Provjeri je li prošla odgoda od zadnjeg uspješnog skena (2 sekunde)
             if (Date.now() >= ignoreErrorSoundUntil) {
                 // Ako je prošla odgoda, sviraj error (uz 0.5s cooldown)
                 playSound('error-sound');
                 // Prikazi custom poruku greške parsiranja koristeći loadedMsg
                 showTemporaryMessage(loadedMsg, "GREŠKA SKENIRANJA!", 1500); // Poruka za grešku parsiranja
             } else {
                 // console.log(`Parse error ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}).`); // KOMENTIRANO: Previše logova
             }

            // Sakrij poruke koje nisu relevantne za ovu grešku (showTemporaryMessage to već rješava)
            // if (loadedMsg) loadedMsg.style.display = 'none';
            // if (duplicateWarning) duplicateWarning.style.display = 'none';

             // Logiraj grešku skeniranja
            sendLogData({ Event: 'scan_parse_error', Details: { message: error.message, qrCodeStart: decodedText.substring(0, 50) + '...' } }); // Logiraj samo dio QR koda
        }
    }


    // *** FUNKCIJE ZA UPRAVLJANJE SKENEROM ***

    function isElementOrParentHidden(element) { if (!element) return true; while (element && element !== document.body) { if (window.getComputedStyle(element).display === 'none') return true; element = element.parentElement; } return false; }

    // NOVO: Izdvojena logika za odabir i start kamere nakon što su kamere dohvaćene
    // OVA FUNKCIJA TREBA BITI GLOBALNO DEFINIRANA (IZVAN DRUGIH FUNKCIJA)
    function startScannerWithCameraSelection(devices, qrConfig) {
        if (!devices || devices.length === 0) {
             if (readerDiv) readerDiv.innerHTML = '<div style="padding: 20px; color: red;">Nema dostupnih kamera na uređaju.</div>';
             console.warn("Nema dostupnih kamera za startanje skenera."); // Ostavljen ovaj log
             if (instructionDiv) instructionDiv.style.display = 'none';
             if (switchCameraButton) switchCameraButton.style.display = 'none';
             isScannerActive = false;
             html5QrCodeInstance = null; // Osiguraj da je instanca null
             return;
        }

        let selectedCameraId = null;
        const savedCameraId = localStorage.getItem(CAMERA_ID_KEY); // Koristi GLOBALNU konstantu CAMERA_ID_KEY

        // 1. Provjeri spremljenu kameru
        if (savedCameraId) {
            const cameraExists = devices.some(d => d.id === savedCameraId);
            if (cameraExists) {
                console.log("Koristim spremljenu kameru:", savedCameraId); // Ostavljen ovaj log
                selectedCameraId = savedCameraId;
            } else {
                console.warn("Spremljena kamera nije pronađena, brišem iz localStorage."); // Ostavljen ovaj log
                localStorage.removeItem(CAMERA_ID_KEY);
            }
        }

        // 2. Ako nema spremljene ILI spremljena ne postoji, koristi default logiku
        if (!selectedCameraId) {
            const rearCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('zadnja') || d.label.toLowerCase().includes('environment'));
            if (rearCamera) {
                console.log("Koristim pronađenu stražnju kameru:", rearCamera.id); // Ostavljen ovaj log
                selectedCameraId = rearCamera.id;
            } else {
                console.log("Nema stražnje kamere, koristim prvu dostupnu:", devices[0].id); // Ostavljen ovaj log
                selectedCameraId = devices[0].id;
            }
        }

        // Osiguraj da imamo *neki* ID ako ima kamera
        if (!selectedCameraId && devices.length > 0) {
             selectedCameraId = devices[0].id; // Fallback na prvu
             console.warn("Fallback na prvu kameru ID:", selectedCameraId); // Ostavljen ovaj log
        }

        // Ako i dalje nema odabranog ID-a (ne bi se smjelo dogoditi ako devices.length > 0 provjeda gore radi)
        if (!selectedCameraId) {
             console.error("Kritična greška: Nije bilo moguće odabrati kameru za start."); // Ostavljen kritičan log
             if (readerDiv) readerDiv.innerHTML = '<div style="padding: 20px; color: red;">Greška: Nije moguće odabrati kameru.</div>';
             if (instructionDiv) instructionDiv.style.display = 'none';
             if (switchCameraButton) switchCameraButton.style.display = 'none';
             isScannerActive = false;
             html5QrCodeInstance = null;
             return; // Izlaz iz funkcije
        }

        const finalCameraId = selectedCameraId;

        requestAnimationFrame(() => {
            // Dodatna provjera prije startanja
            if (!html5QrCodeInstance || isScannerActive || document.body.classList.contains('history-view')) {
                 // console.log("[startScannerWithCameraSelection][rAF] Odustajem od startanja (instance null, active, ili history view)."); // KOMENTIRANO: Previše logova
                 return;
            }
             if (isElementOrParentHidden(readerDiv)) {
                 if (readerDiv) readerDiv.innerHTML = '<div style="padding:20px; color: red;">Greška: Reader element je skriven.</div>';
                 console.error("[startScannerWithCameraSelection][rAF] Reader je skriven, ne mogu startati kameru."); // Ostavljen kritičan log
                 isScannerActive = false; // Osiguraj da nije aktivno
                 html5QrCodeInstance = null; // Nulliraj instancu
                 return; // Izlaz iz funkcije
             }

            console.log(`[startScannerWithCameraSelection][rAF] Pokušavam startati kameru: ${finalCameraId}`); // Ostavljen ovaj log
            html5QrCodeInstance.start(
                finalCameraId,
                qrConfig,
                handleScan,
                (errorMessage) => { /* Ignoriraj non-matched QR */ }
            ).then(() => {
                console.log(`>>> [startScannerWithCameraSelection][rAF] start() OK za kameru: ${finalCameraId}`); // Ostavljen ovaj log
                isScannerActive = true;
                // Spremi ID *uspješno pokrenute* kamere
                localStorage.setItem(CAMERA_ID_KEY, finalCameraId); // Koristi GLOBALNU konstantu CAMERA_ID_KEY
                console.log("Spremljen ID aktivne kamere u localStorage:", finalCameraId); // Ostavljen ovaj log

                // Pokaži gumb za promjenu tek kad je kamera uspješno startala I ima više od jedne dostupne
                if (switchCameraButton && availableCameras.length > 1) {
                     switchCameraButton.style.display = 'block';
                }

                // Prikaz upute i vezanje listenera nakon uspješnog starta i kratke pauze
                setTimeout(() => {
                    // console.log("[startScannerWithCameraSelection][rAF][then-delay] Prikazujem uputu i vežem listener."); // KOMENTIRANO: Previše logova
                    if (instructionDiv && document.body.classList.contains('scanner-view')) {
                        instructionDiv.style.display = 'block';
                    }
                    // Listener je dodan u DOMContentLoaded, ne treba ga ponovno dodavati ovdje
                    // if (!visibilityListenerAttached) {
                    //     attachVisibilityListener();
                    // }
                }, 50); // Kraća pauza
            }).catch(err => {
                console.error(`>>> [startScannerWithCameraSelection][rAF] start() FAILED za kameru ${finalCameraId}:`, err); // Ostavljen log greške
                isScannerActive = false; // Označi kao neaktivno
                html5QrCodeInstance = null; // Nulliraj instancu na grešku starta
                if (readerDiv) readerDiv.innerHTML = `<div style="padding: 20px; color: red;">Greška startanja kamere (${err.name || err.message || err}). Provjerite dozvole ili pokušajte odabrati drugu kameru.</div>`;
                if (instructionDiv) instructionDiv.style.display = 'none';
                // Pokaži gumb i ako faila, da mogu probati drugu (ako ih ima više)
                 if (switchCameraButton && availableCameras.length > 1) {
                     switchCameraButton.style.display = 'block';
                }
                // Ne brišemo spremljeni ID, možda idući put uspije ili se može odabrati druga

                // Logiranje greške starta kamere
                sendLogData({ Event: 'camera_start_failed', Details: { cameraId: finalCameraId, errorName: err.name, errorMessage: err.message } });
            });
        });
    }


    // Modificirana initializeScanner funkcija (POZIVA startScannerWithCameraSelection NAKON DOHVAĆANJA KAMERA)
    function initializeScanner() {
        if (document.body.classList.contains('history-view') || isScannerActive) {
             // console.log("[initializeScanner] Nema potrebe za pokretanjem (history view ili već aktivno)."); // KOMENTIRANO: Previše logova
             // Ako je već aktivan i u scanner view, samo provjeri prikaz gumba kamere
             if (isScannerActive && document.body.classList.contains('scanner-view')) {
                 if (switchCameraButton && availableCameras.length > 1) {
                      switchCameraButton.style.display = 'block';
                 }
             }
             return;
        }
        console.log("[initializeScanner] Pokrećem..."); // Ostavljen ovaj log
        if (readerDiv) readerDiv.innerHTML = ''; // Očisti prethodne poruke/video
        if (instructionDiv) instructionDiv.style.display = 'none'; // Sakrij uputu dok se ne pokrene
        if (switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb dok kamera ne radi
        if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay
        if (loadedMsg) loadedMsg.style.display = 'none'; // Sakrij poruke pri init skenera
        if (duplicateWarning) duplicateWarning.style.display = 'none'; // Sakrij duplicate warning pri init skenera
        // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             hideManualEntryModal(); // Sakrij bez zvuka otkazivanja
         }


        checkSharePrompt(); // Ažuriraj prikaz share prompta
        updateRunningTextVisibility(); // Ažuriraj prikaz teksta koji trči
        updateDeactivatedIndicator(); // Ažuriraj prikaz indikatora deaktivacije

        // Kreiraj novu instancu svaki put kad se pokreće
        html5QrCodeInstance = new Html5Qrcode("reader");
        const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Dohvati kamere SAMO jednom pri prvoj inicijalizaciji (ili ako lista nije napunjena)
         if (availableCameras.length === 0) {
             console.log("[initializeScanner] Dohvaćam popis kamera prvi put..."); // Ostavljen ovaj log
             Html5Qrcode.getCameras().then(devices => {
                 console.log("[initializeScanner] Dostupne kamere (inicijalno dohvatio):", devices); // Ostavljen ovaj log
                 availableCameras = devices; // <--- SPREMI POPIS KAMERA
                 startScannerWithCameraSelection(devices, qrConfig); // Proslijedi popis i pokreni skener
             }).catch(err => {
                 // Ova greška se događa ako getCameras() faila na početku
                 console.error("[initializeScanner] Greška dohvaćanja kamera (getCameras failed):", err); // Ostavljen log greške
                 isScannerActive = false;
                 availableCameras = []; // <--- Postavi na prazan niz ako getCameras faila
                 if (readerDiv) readerDiv.innerHTML = `<div style="padding: 20px; color: red;">Greška pristupa kamerama (${err.name || err.message || err}). Provjerite dozvole.</div>`;
                 if (instructionDiv) instructionDiv.style.display = 'none';
                 if (switchCameraButton) switchCameraButton.style.display = 'none'; // Nema kamera, nema gumba
                 html5QrCodeInstance = null;

                 // Logiranje greške getCameras
                 sendLogData({ Event: 'get_cameras_failed', Details: { errorName: err.name, errorMessage: err.message } });
             });
         } else {
             console.log("[initializeScanner] Koristim već dohvaćeni popis kamera:", availableCameras); // Ostavljen ovaj log
             startScannerWithCameraSelection(availableCameras, qrConfig); // Koristi postojeći popis i pokreni skener
         }
    };


    // Modificirana stopScanner funkcija
    function stopScanner() {
        console.log("stopScanner: Pokrenuto."); // Ostavljen ovaj log
        // Sakrij sve UI elemente skenera neovisno o tome je li skener aktivan
        if(runningTextContainer) runningTextContainer.style.display = 'none';
        if(sharePromptOverlay) sharePromptOverlay.style.display = 'none';
        if(counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';
        if(switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb kad se skener gasi
        if(cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij i overlay
        if(loadedMsg) loadedMsg.style.display = 'none'; // Sakrij poruke pri gašenju skenera
        if(duplicateWarning) duplicateWarning.style.display = 'none'; // Sakrij duplicate warning pri gašenju skenera
         if(manualEntryModalOverlay) manualEntryModalOverlay.style.display = 'none'; // Sakrij modal za ručni unos


        const instanceToStop = html5QrCodeInstance;
        if (instanceToStop && isScannerActive) {
            console.log("Zaustavljam skener (instance postoji i active je)..."); // Ostavljen ovaj log
            isScannerActive = false; // Postavi na false PRIJE poziva stop()
            if (instructionDiv) instructionDiv.style.display = 'none';

            // Postavi timeout za slučaj da stop() obećanje nikad ne prođe na nekim uređajima
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error("Timeout waiting for stop()")), 3000) // 3 sekunde timeout
            );

            return Promise.race([instanceToStop.stop(), timeoutPromise]).then(() => {
                console.log("Skener uspješno zaustavljen."); // Ostavljen ovaj log
            }).catch(err => {
                console.warn("Greška ili timeout pri zaustavljanju skenera:", err); // Ostavljen log upozorenja
                 // Logiranje greške stop skenera
                 sendLogData({ Event: 'camera_stop_failed', Details: { errorName: err.name, errorMessage: err.message } });
            }).finally(() => {
                 // console.log("stopScanner finally blok. Čistim DOM i instancu."); // KOMENTIRANO: Previše logova
                 if (readerDiv) readerDiv.innerHTML = ''; // Očisti prikaz svejedno
                 html5QrCodeInstance = null; // Nulliraj instancu nakon zaustavljanja ili timeouta
                 // console.log("stopScanner finally blok završen."); // KOMENTIRANO: Previše logova
            });
        } else {
             // console.log("Skener nije aktivan ili instanca ne postoji/već zaustavljena, nema potrebe za zaustavljanjem (stopScanner)."); // KOMENTIRANO: Previše logova
             isScannerActive = false; // Osiguraj da je false
             if (readerDiv) readerDiv.innerHTML = ''; // Očisti za svaki slučaj
             html5QrCodeInstance = null; // Osiguraj null
             // console.log("stopScanner završen bez akcije."); // KOMENTIRANO: Previše logova
             return Promise.resolve(); // Vrati resolved promise
        }
    };


    // *** NOVE FUNKCIJE za odabir kamere ***

    // Modificirana toggleCameraSelection funkcija
    function toggleCameraSelection() {
         playSound('click-sound');
         if (!cameraSelectionOverlay || !cameraListUl || !switchCameraButton) {
             console.error("Nedostaju elementi za odabir kamere."); // Ostavljen kritičan log
             return;
         }

         // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }

         // Koristi SPREMLJENI popis availableCameras (treba biti popunjen iz initializeScanner)
         if (!availableCameras || availableCameras.length <= 1) {
              console.warn("Nema dostupnih kamera za odabir ili samo jedna (koristi se spremljena lista)."); // Ostavljen log upozorenja
              showTemporaryMessage(loadedMsg, "Nema drugih kamera za odabir.", 1500); // Koristimo loadedMsg za ovu poruku
              cameraSelectionOverlay.style.display = 'none'; // Osiguraj da je skriven
              return;
         }

         // Ako je overlay vidljiv, sakrij ga
         if (cameraSelectionOverlay.style.display === 'block') {
             cameraSelectionOverlay.style.display = 'none';
             return;
         }

         // Inače, koristi spremljeni popis kamera i prikaži ih
         cameraListUl.innerHTML = ''; // Očisti prethodni popis
         const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY); // Koristi GLOBALNU konstantu

         availableCameras.forEach(device => {
             const listItem = document.createElement('li');
             listItem.textContent = device.label || `Kamera ${device.id.substring(0, 8)}...`; // Prikaz labela, fallback na ID
             listItem.dataset.cameraId = device.id;
             listItem.title = device.label || device.id; // Puni label u tooltipu

             // Opcionalno: Oznaci trenutno odabranu
             if (device.id === currentActiveCameraId) {
                 listItem.classList.add('selected-camera');
             }

             // Dodaj listener
             listItem.addEventListener('click', () => {
                 switchCamera(device.id, device.label);
             });
             cameraListUl.appendChild(listItem); // Append original, not clone
         });

         cameraSelectionOverlay.style.display = 'block'; // Pokaži overlay
    }

    function switchCamera(selectedCameraId, cameraLabel) {
        playSound('click-sound');
        console.log(`Odabrana kamera: ID=${selectedCameraId}, Label=${cameraLabel || 'N/A'}`); // Ostavljen ovaj log

        if (cameraSelectionOverlay) {
             cameraSelectionOverlay.style.display = 'none'; // Sakrij popis
        }

        const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY); // Koristi GLOBALNU konstantu
        if(selectedCameraId === currentActiveCameraId && isScannerActive) {
            console.log("Odabrana je već aktivna kamera, nema potrebe za restartom."); // Ostavljen ovaj log
             showTemporaryMessage(loadedMsg, `Kamera: ${cameraLabel || 'Već aktivna'}`, 1500); // Koristimo loadedMsg za ovu poruku
             // Logiranje odabira iste kamere
             sendLogData({ Event: 'camera_switch_selected_same', Details: { cameraId: selectedCameraId, label: cameraLabel } });
            return;
        }

        // Spremi novi odabir PRIJE restartanja
        localStorage.setItem(CAMERA_ID_KEY, selectedCameraId); // Koristi GLOBALNU konstantu
        sendLogData({ Event: 'camera_switch_attempt', Details: { cameraId: selectedCameraId, label: cameraLabel } }); // Log pokušaja

        // Restartaj skener
        showTemporaryMessage(loadedMsg, `Mijenjam na: ${cameraLabel || 'Kamera'}...`, 1000); // Koristimo loadedMsg za ovu poruku
        stopScanner().finally(() => {
             console.log("Nakon stopScanner, pozivam initializeScanner za novu kameru."); // Ostavljen ovaj log
             // initializeScanner() će sada automatski odabrati spremljeni ID
             initializeScanner(); // initializeScanner logira uspjeh/neuspjeh starta
        });
    }

    // *** FUNKCIJE ZA RUČNI UNOS ***

    function showManualEntryModal() {
        // Provjeri je li element gumba pronađen i je li aplikacija u skener prikazu
        if (!manualEntryBtn || !manualEntryModalOverlay || !manualAmountInput || !manualTimeInput || !manualEntryErrorMsg || !document.body.classList.contains('scanner-view')) {
            console.warn("Ne mogu prikazati modal za ručni unos (DOM elementi nedostaju ili nije scanner view)."); // Ostavljen log upozorenja
            return;
        }

        // Sakrij ostale privremene poruke i UI elemente koji se ne prikazuju s modalom
        if (loadedMsg) loadedMsg.style.display = 'none';
        if (duplicateWarning) duplicateWarning.style.display = 'none';
         // Sakrij overlay za odabir kamere ako je otvoren
        if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';

         // Sakrij Running Text, Share Prompt i Deactivated Indicator
         updateRunningTextVisibility(); // Ovo se pobrine za Running Text
         checkSharePrompt(); // Ovo se pobrine za Share Prompt
         updateDeactivatedIndicator(); // Ovo se pobrine za Deactivated Indicator


        playSound('click-sound'); // Zvuk pri otvaranju modala
        sendLogData({ Event: 'manual_entry_modal_opened' }); // Log otvaranja modala

        // Resetiraj inpute i grešku poruku u modalu
        manualAmountInput.value = '';
        manualTimeInput.value = '';
        manualEntryErrorMsg.innerText = '';
        manualEntryErrorMsg.style.display = 'none';

        // Postavi trenutno vrijeme kao default (opcionalno, korisno)
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        manualTimeInput.value = `${hours}:${minutes}`;


        manualEntryModalOverlay.style.display = 'flex'; // Prikazi modal (koristi flex za centriranje)
        manualAmountInput.focus(); // Fokusiraj na polje za iznos
    }

    function hideManualEntryModal() {
        if (!manualEntryModalOverlay) return;
        manualEntryModalOverlay.style.display = 'none'; // Sakrij modal
        // Očisti inpute i grešku poruku
        manualAmountInput.value = '';
        manualTimeInput.value = '';
         manualEntryErrorMsg.innerText = '';
         manualEntryErrorMsg.style.display = 'none';
         // Ne sviraj click sound ovdje, samo se sakriva

         // Osvježi prikaz UI elemenata koji su bili skriveni dok je modal bio otvoren
         updateRunningTextVisibility();
         checkSharePrompt();
         updateDeactivatedIndicator();
    }

    function addManualEntry() {
        if (!manualAmountInput || !manualTimeInput || !manualEntryErrorMsg) {
             console.error("Nedostaju elementi za dodavanje ručnog unosa."); // Ostavljen kritičan log
             return;
        }

        manualEntryErrorMsg.innerText = ''; // Očisti prethodnu grešku
        manualEntryErrorMsg.style.display = 'none';

        const amountStr = manualAmountInput.value.trim().replace(',', '.'); // Zamijeni zarez točkom
        const timeStr = manualTimeInput.value.trim();

        const parsedAmount = parseFloat(amountStr);

        if (isNaN(parsedAmount) || parsedAmount <= 0) {
            manualEntryErrorMsg.innerText = 'Molimo unesite ispravan iznos veći od 0.';
            manualEntryErrorMsg.style.display = 'block';
            manualAmountInput.focus(); // Vrati fokus na polje iznosa
            sendLogData({ Event: 'manual_entry_add_failed', Details: 'invalid_amount' });
            return; // Prekini funkciju ako iznos nije ispravan
        }

        let parsedTime = '??:??';
        // Validacija vremena - opcionalno polje, ako je uneseno, provjeri format
        if (timeStr) {
             const timeMatch = timeStr.match(/^([0-1]?\d|2[0-3]):([0-5]?\d)$/);
             if (timeMatch) {
                 const hour = parseInt(timeMatch[1], 10);
                 const minute = parseInt(timeMatch[2], 10);
                 parsedTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
             } else {
                  console.warn("Neispravan format vremena unesen (manual entry):", timeStr); // Ostavljen log upozorenja
                  // Možda prikaži upozorenje korisniku, ali ipak dodaj račun s '??:??'
                  manualEntryErrorMsg.innerText = 'Upozorenje: Vrijeme nije u formatu HH:MM. Dodano kao "??:??".';
                  manualEntryErrorMsg.style.display = 'block';
                  parsedTime = '??:??'; // Koristi default ako je format pogrešan ali polje nije prazno
             }
        }


        // Kreiranje objekta za ručni unos
        const newItem = {
            amount: parsedAmount,
            qrCode: `MANUAL_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`, // Jedinstveni ID
            time: parsedTime,
            datv: null, // Nema 'datv' za ručni unos
            scanTimestamp: Date.now() // Timestamp kad je račun *dodan* ručno
        };

        // Dodavanje u povijest (trenutna sesija)
        povijest.push(newItem); // Račun se dodaje PRVI
        ukupno += parsedAmount;

        // Smanjenje brojača ako je aktivno
         if (isCounterDecrementActive && brojac > 0) {
              brojac--;
              console.log("Brojač smanjen (ručni unos) na:", brojac); // Ostavljen ovaj log
              saveBrojac();
              checkSharePrompt(); // Ažuriraj share prompt ako je brojač došao do 0
         } else {
              // console.log("Brojač nije smanjen (ručni unos). Aktivno:", isCounterDecrementActive, "Vrijednost:", brojac); // KOMENTIRANO: Previše logova
         }

        // Spremanje nesačuvanog stanja
        try {
            localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length);
            localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno);
        } catch (lsError) {
            console.error("Greška spremanja nesačuvanog stanja (ručni unos) u localStorage:", lsError); // Ostavljen log greške
        }

        // Ažuriranje prikaza
        updateDisplay();

        // Prikaz poruke i zvuk
        showTemporaryMessage(loadedMsg, "RUČNO DODANO", 1000); // Koristi loadedMsg element za kratkotrajnu poruku
        playSound('scan-sound'); // Možeš koristiti isti zvuk kao za sken ili dodati novi 'manual-add-sound'

        // Ažuriraj info/delete poruku (posljednji dodani item)
        if (deleteWarningDiv) {
             deleteWarningDiv.dataset.lastScanText = `ZADNJI DODAN: ${newItem.time} = ${newItem.amount.toFixed(2)} €`;
             handleInfoDeleteMessageVisibility();
        }

        // Sakrij modal
        hideManualEntryModal();

         // Logiranje ručnog unosa - MODIFICIRANO
         const manualEntryDetails = {
             amount: parsedAmount,
             time: parsedTime,
             sessionInvoiceNumber: povijest.length, // <-- Dodano: Broj računa po redu
             isManual: true // <-- Dodano: Oznaka da je ručni unos
         };
         sendLogData({ Event: 'manual_entry_added', Details: JSON.stringify(manualEntryDetails) }); // <-- IZMJENA
    }

    function cancelManualEntry() {
         // Provjeri je li element modala pronađen
         if (!manualEntryModalOverlay) return;

         playSound('click-sound'); // Zvuk na otkazivanje
         hideManualEntryModal();
         // Logiranje otkazivanja
         sendLogData({ Event: 'manual_entry_cancelled' });
    }


    // *** FUNKCIJE ZA PROMJENU PRIKAZA (VIEW) ***
    // Modificirana switchToScannerView
    function switchToScannerView() {
        console.log("switchToScannerView: Pokrenuto."); // Ostavljen ovaj log
        if (document.body.classList.contains('scanner-view')) {
            // console.log("switchToScannerView: Već u scanner view."); // KOMENTIRANO: Previše logova
            // Ako je već aktivan i u scanner view, samo provjeri i pokreni skener ako nije aktivan
            if (!isScannerActive) {
                console.log("switchToScannerView: Skener nije aktivan, inicijaliziram..."); // Ostavljen ovaj log
                 // initializeScanner će automatski provjeriti history view i isScannerActive
                initializeScanner();
            } else {
                // console.log("switchToScannerView: Skener je već aktivan. Ažuriram UI."); // KOMENTIRANO: Previše logova
                checkSharePrompt();
                updateRunningTextVisibility();
                updateDeactivatedIndicator();
                // Pokaži gumb ako ima više od jedne kamere (koristi spremljeni popis)
                if (switchCameraButton && availableCameras.length > 1) {
                   switchCameraButton.style.display = 'block';
                }
            }
            // Uvijek attachaj listener kad se prelazi u scanner view, ako već nije
            if (!visibilityListenerAttached) {
                 attachVisibilityListener();
            }
            return;
        }

        // Resetiraj confirmation gumbe iz history view-a
        const clearBtn = document.getElementById('clear-history-btn'); if (clearBtn && clearBtn.dataset.confirming === 'true') { clearBtn.innerText = "IZBRIŠI SVU POVIJEST"; clearBtn.classList.remove('confirm-mode'); clearBtn.dataset.confirming = 'false'; }
        const deleteSessionBtn = document.getElementById('delete-session-btn'); if (deleteSessionBtn && deleteSessionBtn.dataset.confirming === 'true') { deleteSessionBtn.innerText = "IZBRIŠI OVAJ SKEN"; deleteSessionBtn.classList.remove('confirm-mode'); deleteSessionBtn.dataset.confirming = 'false'; }
        const clearDayBtn = document.getElementById('clear-day-btn'); if (clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = "IZBRIŠI OVAJ DAN"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; }
        if (historyDynamicHeaderContentDiv) historyDynamicHeaderContentDiv.innerHTML = ''; // Očisti header povijesti
         if (document.getElementById('search-container')) document.getElementById('search-container').style.display = 'none'; // Sakrij search container
         if (document.getElementById('all-days-search-container')) document.getElementById('all-days-search-container').style.display = 'none'; // Sakrij all days search
        // Sakrij export/import gumbe ako postoje u history view (Više ih ne generira renderAllDaysView, ali ostavljamo logiku ako ih tamo ipak bude)
        if(document.getElementById('export-history-btn')) document.getElementById('export-history-btn').style.display = 'none';
        if(document.getElementById('import-history-btn')) document.getElementById('import-history-btn').style.display = 'none';
        // import-file-input se sada skriva globalnim CSS-om u history-view


        document.body.classList.remove('history-view');
        document.body.classList.add('scanner-view');
        document.body.style.backgroundColor = '#f4f4f4';

        currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
        previousHistoryViewState = 'day-view'; // Resetiraj stanje prikaza povijesti

        updateDisplay(); // Ažuriraj prikaz (ukupno, broj računa itd.)

        // Pokreni inicijalizaciju skenera NAKON promjene view-a
        // Koristimo requestAnimationFrame kako bi se DOM stigao ažurirati prije nego krenemo sa startanjem kamere
        requestAnimationFrame(initializeScanner);

        // Attach visibility listener ako već nije
        if (!visibilityListenerAttached) {
             attachVisibilityListener();
        }

        // UI elementi specifični za skener će biti prikazani unutar initializeScanner ako je uspješan
        // Nema potrebe za setTimeoutom ovdje, initializeScanner hendla UI
        console.log("switchToScannerView: Završeno."); // Ostavljen ovaj log
    }

    // Modificirana switchToHistoryView
    function switchToHistoryView() {
        console.log("switchToHistoryView: Pokrenuto."); // Ostavljen ovaj log
        if (document.body.classList.contains('history-view')) {
            // console.log("switchToHistoryView: Već u history view, samo renderiram."); // KOMENTIRANO: Previše logova
            renderHistoryView(currentlyViewedDate); // Možda treba zadržati zadnji prikaz? Ovisi o želji. Trenutno vraća na današnji dan.
            return;
        }

        if (removeConfirm || removeNameConfirm) resetRemoveMode();
        if (ocistiConfirm) resetOcistiMode();
         // Sakrij modal za ručni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }


        console.log("switchToHistoryView: Zaustavljam skener..."); // Ostavljen ovaj log
        stopScanner().finally(() => {
            console.log("switchToHistoryView: Skener zaustavljen (ili nije bio aktivan). Mijenjam klase i renderiram."); // Ostavljen ovaj log
            document.body.classList.remove('scanner-view');
            document.body.classList.add('history-view');
            document.body.style.backgroundColor = 'white';

            // Sakrij elemente specifične za skener
            if (counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';
            if (switchCameraButton) switchCameraButton.style.display = 'none';
            if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';
            if (instructionDiv) instructionDiv.style.display = 'none';
            if (runningTextContainer) runningTextContainer.style.display = 'none';
            if (sharePromptOverlay) sharePromptOverlay.style.display = 'none';
            if(loadedMsg) loadedMsg.style.display = 'none'; // Sakrij poruke pri ulasku u povijest
            if(duplicateWarning) duplicateWarning.style.display = 'none'; // Sakrij duplicate warning pri ulasku u povijest
            // Manual Entry Modal Overlay se skriva pravilom u CSS-u za history-view body klasu


            // Uvijek renderiraj povijest za trenutni dan pri ulasku
            currentlyViewedDate = new Date();
            currentlyViewedDate.setHours(0, 0, 0, 0);
            previousHistoryViewState = 'day-view';

            renderHistoryView(currentlyViewedDate);
             console.log("switchToHistoryView: Renderiranje završeno."); // Ostavljen ovaj log
        });
    }


    // *** FUNKCIJE ZA RENDERIRANJE HISTORY VIEWA ***
    function clearDynamicHeaderContent() { if (historyDynamicHeaderContentDiv) { historyDynamicHeaderContentDiv.innerHTML = ''; } }
    function renderHistoryView(dateToShow = currentlyViewedDate) { console.log("renderHistoryView: Pokrenuto za datum:", dateToShow); previousHistoryViewState = 'day-view'; currentlyViewedDate = new Date(dateToShow); currentlyViewedDate.setHours(0,0,0,0); const punaPovijest = loadFullHistoryFromLocalStorage(); /* console.log("renderHistoryView: Učitana povijest iz localStorage:", punaPovijest); */ if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) { console.error("renderHistoryView: Kritični DOM elementi nedostaju!"); return; } clearDynamicHeaderContent(); const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: 'numeric' }; let imeDana = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDatuma); const startOfDay = new Date(currentlyViewedDate); const endOfDay = new Date(currentlyViewedDate); endOfDay.setHours(23, 59, 59, 999); const sesijeZaPrikazaniDan = punaPovijest.filter(grupa => { const grupaDate = new Date(grupa.timestamp); return grupaDate >= startOfDay && grupaDate <= endOfDay; }); sesijeZaPrikazaniDan.sort((a, b) => a.timestamp - b.timestamp); const brojRacunaOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); const dateInfoDiv = document.createElement('div'); dateInfoDiv.id = 'history-date-info'; const currentViewDateStr = getISODateString(currentlyViewedDate); const hasOtherDays = punaPovijest.some(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr && grupaDateStr !== currentViewDateStr; }); dateInfoDiv.innerHTML = `<span style="font-weight: bold;">${imeDana}, ${formatiraniDatum}</span> <button id="history-view-toggle-btn" style="background-color: yellow; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold;" ${!hasOtherDays ? 'disabled' : ''}>OSTALI DANI ></button>`; historyDynamicHeaderContentDiv.appendChild(dateInfoDiv); const historyViewToggleButton = dateInfoDiv.querySelector('#history-view-toggle-btn'); if (historyViewToggleButton) { const newHistoryViewToggleButton = historyViewToggleButton.cloneNode(true); historyViewToggleButton.parentNode.replaceChild(newHistoryViewToggleButton, historyViewToggleButton); if (!newHistoryViewToggleButton.disabled) { newHistoryViewToggleButton.addEventListener('click', () => { playSound('click-sound'); renderAllDaysView(); }); newHistoryViewToggleButton.style.cursor = 'pointer'; newHistoryViewToggleButton.style.opacity = '1'; } else { newHistoryViewToggleButton.style.cssText += ';cursor: not-allowed; opacity: 0.7;'; } } const summaryInfoDiv = document.createElement('div'); summaryInfoDiv.id = 'history-summary-info'; summaryInfoDiv.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${brojRacunaOvajDan}</span></span> <span style="font-weight: bold;">UKUPNO: ${ukupanIznosOvajDan.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(summaryInfoDiv); const uputaHtml = `<p id="history-select-group-text" style="text-align: center; color: black; font-weight: bold; font-style: normal; margin-bottom: 1em; margin-top: 0.5em; font-size: 0.9em;">IZABERI SKEN ILI <button id="start-search-btn" style="background:none; border:none; padding:0; color:blue; text-decoration:underline; cursor:pointer; font-size:inherit; font-weight:bold;">(TRAŽI)</button></p>`; let sesijeHtml = '<ul id="scan-group-list" style="list-style: none; padding: 0; margin: 0;">'; if (sesijeZaPrikazaniDan.length === 0) { sesijeHtml += '<li style="text-align:center; color: grey; border: none; cursor: default; padding: 1em 0;"><i>Nema spremljenih skenova za ovaj dan.</i></li>'; } else { sesijeZaPrikazaniDan.forEach((sesija, index) => { sesijeHtml += generirajHtmlZaSpremljenuGrupu(sesija, index + 1); }); } sesijeHtml += '</ul>'; historyContentDiv.innerHTML = uputaHtml + sesijeHtml; if (sesijeZaPrikazaniDan.length > 0) { const clearDayButton = document.createElement('button'); clearDayButton.id = 'clear-day-btn'; clearDayButton.className = 'red-btn'; clearDayButton.style.margin = '2em auto 1em auto'; clearDayButton.style.display = 'block'; clearDayButton.innerText = 'IZBRIŠI OVAJ DAN'; historyContentDiv.appendChild(clearDayButton); clearDayButton.dataset.confirming = 'false'; const newClearDayBtn = clearDayButton.cloneNode(true); clearDayButton.parentNode.replaceChild(newClearDayBtn, clearDayButton); newClearDayBtn.addEventListener('click', () => {
            if (newClearDayBtn.disabled) return;
            if (newClearDayBtn.dataset.confirming !== 'true') { // Check if NOT already confirming
                playSound('click-sound'); // Zvuk na prvi klik za potvrdu
                newClearDayBtn.innerText = "Potvrdi Brisanje Dana?";
                newClearDayBtn.classList.add('confirm-mode');
                newClearDayBtn.dataset.confirming = 'true'; // Postavi confirming na true
                 sendLogData({ Event: 'delete_day_prompt', Details: getISODateString(currentlyViewedDate) });
            } else {
                // Drugi klik - potvrda
                // Nema click sound ovdje, remove-sound će svirati ako brisanje uspije
                const dateToConfirmDelete = new Date(currentlyViewedDate);
                deleteScansForDay(dateToConfirmDelete); // deleteScansForDay sadrži playSound('remove-sound') na uspjeh i log
                // Stanje gumbš će se resetirati globalnim klik handlerom ili pri renderu
            }
        });
        const dayParentPageClickHandler = (e) => {
            const currentClearDayBtn = document.getElementById('clear-day-btn');
            // Resetiraj samo ako je u confirm modu i klik nije na gumb
            if (currentClearDayBtn && currentClearDayBtn.dataset.confirming === 'true' && !currentClearDayBtn.contains(e.target)) {
                currentClearDayBtn.innerText = "IZBRIŠI OVAJ DAN";
                currentClearDayBtn.classList.remove('confirm-mode');
                currentClearDayBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                 sendLogData({ Event: 'delete_day_cancelled_outside', Details: getISODateString(currentlyViewedDate) });
            }
        };
        // Prvo ukloni ako je bio dodan (prevencija dupliranja)
        historyPageDiv.removeEventListener('click', dayParentPageClickHandler, true);
        // Dodaj listener
        historyPageDiv.addEventListener('click', dayParentPageClickHandler, true);

        } const groupList = document.getElementById('scan-group-list'); if (groupList) { const newGroupList = groupList.cloneNode(true); groupList.parentNode.replaceChild(newGroupList, groupList); newGroupList.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); previousHistoryViewState = 'day-view'; renderGroupDetailView(selectedGroup); } else { console.error("Nije pronađena grupa:", timestamp); alert("Greška otvaranja detalja."); } } }); } const searchBtn = document.getElementById('start-search-btn'); if(searchBtn) { const newSearchBtn = searchBtn.cloneNode(true); searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn); newSearchBtn.addEventListener('click', startSearch); } console.log("renderHistoryView: Renderiranje završeno."); } // Ostavljen ovaj log
    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) { const vrijemeSpremanja = new Date(grupa.timestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class="session-name-history">${grupa.name} U ${vrijemeSpremanjaFormatirano}</span>` : `<span class="scan-time-history">SKEN U ${vrijemeSpremanjaFormatirano}</span>`; return `<li data-timestamp="${grupa.timestamp}" style="background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease;"><span style="flex-shrink: 0; display: inline-flex; align-items: center; min-width: 0; flex-grow: 1; overflow: hidden;"><span style="margin-right: 5px; flex-shrink: 0;">${redniBroj}.</span> ${prikazNaziva}</span><span class="scan-group-last-qr-time" style="flex-shrink: 0; margin-left: 15px;">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style="font-weight: bold; margin-left: auto; padding-left: 10px; flex-shrink: 0;">${ukupnoGrupa.toFixed(2)} €</span></span></li>`; }
    function renderGroupDetailView(groupData) { if (!historyContentDiv || !groupData || !groupData.racuni || !historyDynamicHeaderContentDiv) { console.error("Nedostaju podaci za detalje."); renderHistoryView(); return; } clearDynamicHeaderContent(); const sessionTimestamp = groupData.timestamp; const vrijemeSpremanja = new Date(sessionTimestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = groupData.racuni.reduce((sum, item) => sum + item.amount, 0); const brojRacunaSesije = groupData.racuni.length; const naslovDetalja = groupData.name ? groupData.name : `SKEN U ${vrijemeSpremanjaFormatirano}`; const detailHeaderDiv = document.createElement('div'); detailHeaderDiv.id = 'detail-header-info'; detailHeaderDiv.innerHTML = `<button id="back-to-group-list-btn" style="background-color: #6c757d; color: white; padding: 0.4em 0.8em; font-size: 0.9em; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">< Lista</button><h3 style="margin: 0; text-align: center; flex-grow: 1; font-size: 1.1em;">${naslovDetalja}</h3><span style="font-weight: bold; font-size: 1.1em; flex-shrink: 0; padding-left: 5px;">${ukupnoGrupa.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(detailHeaderDiv); const detailSummaryDiv = document.createElement('div'); detailSummaryDiv.id = 'detail-summary-info'; detailSummaryDiv.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${brojRacunaSesije}</span></span><span style="font-weight: bold;">UKUPNO: ${ukupnoGrupa.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(detailSummaryDiv); let detailListHtml = '<ul id="detail-scan-list">'; const racuniZaPrikaz = groupData.racuni; racuniZaPrikaz.forEach((racun, index) => { const vrijemeRacuna = racun.time !== '??:??' ? `${racun.time}` : 'Vrijeme?'; detailListHtml += `<li><span style="color: #333; min-width: 80px;">${index + 1}. ${vrijemeRacuna}</span><span style="font-weight: bold; margin-left: auto;">${racun.amount.toFixed(2)} €${racun.qrCode.startsWith('MANUAL_') ? ' (ručno)' : ''}</span></li>`; }); detailListHtml += `</ul>`; detailListHtml += `<button id="delete-session-btn" class="red-btn" data-timestamp="${sessionTimestamp}" style="margin: 2em auto 1em auto; display: block;">IZBRIŠI OVAJ SKEN</button>`; historyContentDiv.innerHTML = detailListHtml; const backBtn = document.getElementById('back-to-group-list-btn'); if (backBtn) { const newBackBtn = backBtn.cloneNode(true); backBtn.parentNode.replaceChild(newBackBtn, backBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); console.log("Vraćanje iz detalja, prethodno stanje:", previousHistoryViewState); switch (previousHistoryViewState) { case 'day-search-results': renderHistoryView(currentlyViewedDate); startSearch(); const searchInputDay = document.getElementById('search-input'); if(searchInputDay) searchInputDay.value = lastSearchTerm; executeSearch(); break; case 'all-days-search-results': renderAllDaysView(); const searchInputAll = document.getElementById('all-days-search-input'); if(searchInputAll) searchInputAll.value = lastSearchTerm; executeAllDaysSearch(); break; case 'day-view': default: renderHistoryView(currentlyViewedDate); break; } }); } const deleteSessionBtn = document.getElementById('delete-session-btn'); if(deleteSessionBtn) { deleteSessionBtn.dataset.confirming = 'false'; const newDeleteSessionBtn = deleteSessionBtn.cloneNode(true); deleteSessionBtn.parentNode.replaceChild(newDeleteSessionBtn, deleteSessionBtn); newDeleteSessionBtn.addEventListener('click', () => {
            if (newDeleteSessionBtn.disabled) return;
            if (newDeleteSessionBtn.dataset.confirming !== 'true') { // Check if NOT already confirming
                 playSound('click-sound'); // Zvuk na prvi klik za potvrdu
                 newDeleteSessionBtn.innerText = "Potvrdi brisanje?";
                 newDeleteSessionBtn.classList.add('confirm-mode');
                 newDeleteSessionBtn.dataset.confirming = 'true'; // Postavi confirming na true
                  sendLogData({ Event: 'delete_session_prompt', Details: groupData.timestamp });
             } else {
                 // Drugi klik - potvrda
                 // Nema click sound ovdje, remove-sound će svirati ako brisanje uspije
                 const timestampToDelete = newDeleteSessionBtn.dataset.timestamp;
                 deleteSpecificSession(timestampToDelete); // deleteSpecificSession sadrži playSound('remove-sound') na uspjeh i log
                 // Stanje gumbš će se resetirati globalnim klik handlerom ili pri renderu
             }
        });
        const detailClickHandler = (e) => {
            const currentDeleteBtn = document.getElementById('delete-session-btn');
            // Resetiraj samo ako je u confirm modu i klik nije na gumb
            if (currentDeleteBtn && currentDeleteBtn.dataset.confirming === 'true' && !currentDeleteBtn.contains(e.target)) {
                 currentDeleteBtn.innerText = "IZBRIŠI OVAJ SKEN";
                 currentDeleteBtn.classList.remove('confirm-mode');
                 currentDeleteBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                  sendLogData({ Event: 'delete_session_cancelled_outside', Details: groupData.timestamp });
             }
        };
        // Prvo ukloni ako je bio dodan (prevencija dupliranja)
        historyPageDiv.removeEventListener('click', detailClickHandler, true);
        // Dodaj listener
        historyPageDiv.addEventListener('click', detailClickHandler, true);

        } else { console.warn("Gumb #delete-session-btn nije pronađen."); } }
    function deleteScansForDay(dateToDelete) { // <-- Linija 1950 u originalnom kodu
        if (!(dateToDelete instanceof Date) || isNaN(dateToDelete)) { console.error("Pokušaj brisanja dana s neispravnim datumom."); alert("Greška: Nije moguće identificirati dan za brisanje."); return; } const dateToDeleteStr = getISODateString(dateToDelete); if (!dateToDeleteStr) return; console.log("Brisanje svih skenova za dan:", dateToDeleteStr); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const sessionsToDelete = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr === dateToDeleteStr; }); const filtriranaPovijest = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr !== dateToDeleteStr; }); const newLength = filtriranaPovijest.length; // <-- Ispravljeno: filtriranaPovijost -> filtriranaPovijest. Ovo je Linija 1955 u originalnom kodu
 console.log(`Originalna dužina: ${originalLength}, Nova dužina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); // ZVUK ZA BRISANJE DANA (smeće.mp3)
         alert(`Svi skenovi za ${dateToDelete.toLocaleDateString('hr-HR')} obrisani.`);
         // Logiranje uspješnog brisanja dana
         const dayDetails = { date: dateToDeleteStr, sessionCount: sessionsToDelete.length, totalCount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.length, 0), totalAmount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.reduce((gSum, r) => gSum + r.amount, 0), 0) };
         sendLogData({ Event: 'day_deleted_confirmed', Details: JSON.stringify(dayDetails) });
         renderAllDaysView();
     } else { console.warn("Nisu pronađeni skenovi za brisanje za dan:", dateToDeleteStr); alert("Greška: Nisu pronađeni skenovi za ovaj dan."); const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = "IZBRIŠI OVAJ DAN"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } } }
    function renderAllDaysView() { previousHistoryViewState = 'all-days-view'; const punaPovijest = loadFullHistoryFromLocalStorage(); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) return; clearDynamicHeaderContent(); const searchBarHtml = `<div id="all-days-search-container"><div style="display: flex; gap: 5px;"><input type="text" id="all-days-search-input" placeholder="UPIŠI ZA PRETRAGU..." style="flex-grow: 1; padding: 0.5em; font-size: 0.9em;"><button id="execute-all-days-search-btn" style="padding: 0.5em 0.6em; font-size: 0.9em;">Traži</button><button id="close-all-days-search-btn" style="padding: 0.5em 0.6em; background-color: #ccc; font-size: 0.9em;">Svi Dani</button></div></div><div id="all-days-summary-info" style="display: none;"></div>`; historyDynamicHeaderContentDiv.innerHTML = searchBarHtml; const resultsPlaceholderHtml = `<div id="search-results-all-days"><p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p></div>`; historyContentDiv.innerHTML = resultsPlaceholderHtml; const searchInput = document.getElementById('all-days-search-input'); const executeBtn = document.getElementById('execute-all-days-search-btn'); const closeBtn = document.getElementById('close-all-days-search-btn'); const searchResultsContainer = document.getElementById('search-results-all-days'); const allDaysSummaryContainer = document.getElementById('all-days-summary-info'); const sessionsByDate = punaPovijest.reduce((acc, session) => { const dateStr = getISODateString(new Date(session.timestamp)); if (!dateStr) return acc; if (!acc[dateStr]) { acc[dateStr] = { date: new Date(session.timestamp), sessions: [], totalAmount: 0, totalCount: 0 }; acc[dateStr].date.setHours(0, 0, 0, 0); } acc[dateStr].sessions.push(session); acc[dateStr].totalAmount += session.racuni.reduce((sum, item) => sum + item.amount, 0); acc[dateStr].totalCount += session.racuni.length; return acc; }, {}); const sortedDays = Object.values(sessionsByDate).sort((a, b) => b.date - a.date); if(searchInput && executeBtn && closeBtn && searchResultsContainer && allDaysSummaryContainer) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeAllDaysSearch(); }); const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', () => { executeAllDaysSearch(); }); const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); newSearchInput.value = ''; renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${totalCountAll}</span></span><span style="font-weight: bold;">UKUPNO: ${totalAmountAll.toFixed(2)} €</span>`; allDaysSummaryContainer.style.display = punaPovijest.length > 0 ? 'flex' : 'none'; }); } else { console.error("Nisu pronađeni svi elementi za pretragu u All Days View."); } if (punaPovijest.length > 0) { const backButtonHtml = `<button id="back-to-current-day-btn" style="background-color: #6c757d; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">< NATRAG</button>`; const clearAllButtonHtml = `<button id="clear-history-btn" class="red-btn" style="padding: 0.5em 1em; font-size: 1em;">IZBRIŠI SVU POVIJEST</button>`;
             // Dodavanje Export/Import gumba (Sada samo gumbe jer je input globalno)
             const exportImportButtonsHtml = `<div style="text-align: center; margin-top: 1em; margin-bottom: 1em;"><button id="export-history-btn" style="background-color: #007bff; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">Izvezi povijest</button><button id="import-history-btn" style="background-color: #28a745; color: white; padding: 0.5em 1em; font-size: 1em;">Uvezi povijest</button></div>`; // Removed input from here

             const buttonsHtml = `<div style="text-align: center; margin-top: 1.5em; margin-bottom: 1em;">${backButtonHtml}${clearAllButtonHtml}</div> ${exportImportButtonsHtml}`; // Combine buttons

             if (!document.getElementById('back-to-current-day-btn') || !document.getElementById('clear-history-btn') || !document.getElementById('export-history-btn')) { // Check if buttons are not already added
                 historyContentDiv.insertAdjacentHTML('beforeend', buttonsHtml);

                 // Dohvati referene na nove gumbe NAKON što su dodani
                 const exportBtn = document.getElementById('export-history-btn');
                 const importBtn = document.getElementById('import-history-btn');

                 if (exportBtn) {
                     const newExportBtn = exportBtn.cloneNode(true);
                     exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
                     newExportBtn.addEventListener('click', exportHistory);
                 } else { console.error("Export gumb nije pronađen nakon dodavanja."); }

                 if (importBtn) {
                      const newImportBtn = importBtn.cloneNode(true);
                      importBtn.parentNode.replaceChild(newImportBtn, importBtn);
                      newImportBtn.addEventListener('click', importHistory);
                 } else { console.error("Import gumb nije pronađen nakon dodavanja."); }
             }


            const backToDayBtn = document.getElementById('back-to-current-day-btn');
            if (backToDayBtn) { const newBackBtn = backToDayBtn.cloneNode(true); backToDayBtn.parentNode.replaceChild(newBackBtn, backToDayBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); renderHistoryView(currentlyViewedDate); }); }
            const clearAllBtn = document.getElementById('clear-history-btn');
            if (clearAllBtn) {
                if (punaPovijest.length === 0) { clearAllBtn.disabled = true; clearAllBtn.style.opacity = '0.6'; clearAllBtn.style.cursor = 'not-allowed'; } else { clearAllBtn.disabled = false; clearAllBtn.style.opacity = '1'; clearAllBtn.style.cursor = 'pointer'; }
                clearAllBtn.dataset.confirming = 'false'; const newClearAllBtn = clearAllBtn.cloneNode(true); clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn); newClearAllBtn.addEventListener('click', () => {
                    if (newClearAllBtn.disabled) return;
                    if (newClearAllBtn.dataset.confirming !== 'true') { // Check if NOT already confirming
                        playSound('click-sound'); // Zvuk na prvi klik za potvrdu
                        newClearAllBtn.innerText = "Potvrdi Brisanje SVEGA?";
                        newClearAllBtn.classList.add('confirm-mode');
                        newClearAllBtn.dataset.confirming = 'true'; // Postavi confirming na true
                         sendLogData({ Event: 'clear_all_prompt' });
                    } else {
                        // Drugi klik - potvrda
                        // Nema click sound ovdje, remove-sound će svirati ako brisanje uspije
                        localStorage.removeItem(HISTORY_STORAGE_KEY);
                        localStorage.removeItem(COUNTER_KEY);
                        localStorage.removeItem(COUNTER2_KEY);
                        localStorage.removeItem(COUNTER_ACTIVE_KEY);
                        localStorage.removeItem(USER_ID_KEY); // Resetiraj i usera
                        localStorage.removeItem(FIRST_USE_KEY); // Resetiraj i timestamp
                        localStorage.removeItem(UNSAVED_COUNT_KEY); // Briši nesačuvano
                        localStorage.removeItem(UNSAVED_AMOUNT_KEY); // Briši nesačuvano
                        localStorage.removeItem(CAMERA_ID_KEY); /* <<< DODANO BRISANJE KAMERE */
                        alert("Sva spremljena povijest i podaci brojača/kamere obrisani.");

                         // Logiranje brisanja svega
                         sendLogData({ Event: 'clear_all_confirmed' });

                        currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0,0,0,0);
                        loadCountersState(); // Brojači će biti null -> reset na 0
                        initializeUserTracking(); // User ID će biti novi
                        // Ponovno dohvati podatke iz Sheeta, ovo će ažurirati tekst poruke i brojač2
                        fetchSheetData().then(() => { renderAllDaysView(); }).catch(() => { renderAllDaysView(); });
                        playSound('remove-sound'); // ZVUK ZA BRISANJE CIJELE POVIJESTI (smeće.mp3)
                    }
                });
                const allDaysParentClickHandler = (e) => {
                    const currentClearAllBtn = document.getElementById('clear-history-btn');
                    // Resetiraj samo ako je u confirm modu i klik nije na gumb
                    if (currentClearAllBtn && currentClearAllBtn.dataset.confirming === 'true' && !currentClearAllBtn.contains(e.target)) {
                        currentClearAllBtn.innerText = "IZBRIŠI SVU POVIJEST";
                        currentClearAllBtn.classList.remove('confirm-mode');
                        currentClearAllBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                         sendLogData({ Event: 'clear_all_cancelled_outside' });
                    }
                };
                // Prvo ukloni ako je bio dodan (prevencija dupliranja)
                historyPageDiv.removeEventListener('click', allDaysParentClickHandler, true);
                // Dodaj listener
                historyPageDiv.addEventListener('click', allDaysParentClickHandler, true);

            }
        }
        if (punaPovijest.length > 0 && searchResultsContainer && allDaysSummaryContainer) { renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${totalCountAll}</span></span><span style="font-weight: bold;">UKUPNO: ${totalAmountAll.toFixed(2)} €</span>`; allDaysSummaryContainer.style.display = 'flex'; } else { if (allDaysSummaryContainer) allDaysSummaryContainer.style.display = 'none'; } }
    function renderAllDaysList(daysData, containerElement) { if (!containerElement) return; const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; let daysHtml = '<ul id="all-days-list-rendered" style="list-style: none; padding: 0; margin: 0;">'; if (daysData.length === 0) { if (containerElement.id === 'search-results-all-days' && document.getElementById('all-days-search-input')?.value.trim()) { daysHtml += '<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za traženi pojam.</i></li>'; } else { daysHtml += '<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema spremljene povijesti.</i></li>'; } } else { daysData.forEach(dayInfo => { let imeDana = dayInfo.date.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = dayInfo.date.toLocaleDateString('hr-HR', opcijeDatuma); const isoDate = getISODateString(dayInfo.date); daysHtml += `<li data-date-iso="${isoDate}" style="background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;"><span style="font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${imeDana}, ${formatiraniDatum}</span><div style="flex-shrink: 0; text-align: right;"><span style="font-size: 0.9em; color: #555; white-space: nowrap;">Računa: ${dayInfo.totalCount}</span><span style="font-weight: bold; margin-left: 15px; white-space: nowrap;">${dayInfo.totalAmount.toFixed(2)} €</span></div></li>`; }); } daysHtml += '</ul>'; containerElement.innerHTML = daysHtml; const listElement = containerElement.querySelector('ul'); if (listElement) { const newListElement = listElement.cloneNode(true); listElement.parentNode.replaceChild(newListElement, listElement); newListElement.addEventListener('click', (e) => { const clickedDayLi = e.target.closest('li[data-date-iso]'); if (clickedDayLi && clickedDayLi.dataset.dateIso) { const selectedDate = new Date(clickedDayLi.dataset.dateIso + 'T00:00:00'); playSound('click-sound'); currentlyViewedDate = selectedDate; renderHistoryView(selectedDate); } }); } }
    function executeAllDaysSearch() { const searchInput = document.getElementById('all-days-search-input'); const resultsContainer = document.getElementById('search-results-all-days'); const summaryContainer = document.getElementById('all-days-summary-info'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); /* console.log("--- executeAllDaysSearch ---"); console.log("Tražim pojam:", searchTerm); console.log("Normalizirani datum za pretragu:", normalizedSearchDate); */ resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm && !normalizedSearchDate) { resultsContainer.innerHTML = '<p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p>'; return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; const opcijeDana = { weekday: 'long' }; const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' }; const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' }; punaPovijest.forEach((grupa, index) => { const sessionDate = new Date(grupa.timestamp); /* console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); */ const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; /* console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); */ if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { /* console.log("    MATCH: Točan datum!"); */ match = true; } if (!match && searchTerm) { /* console.log("    Provjeravam kao tekst..."); */ if (formattedDateShort.includes(searchTerm)) { /* console.log("    MATCH: Kratki datum sadrži pojam."); */ match = true; } else if (formattedDateNumeric.includes(searchTerm)) { /* console.log("    MATCH: Numerički datum sadrži pojam."); */ match = true; } else if (dayName.includes(searchTerm)) { /* console.log(`    MATCH: Ime dana ('${dayName}') sadrži pojam ('${searchTerm}').`); */ match = true; } else if (sessionName && sessionName.includes(searchTerm)) { /* console.log("    MATCH: Naziv sesije sadrži pojam."); */ match = true; } else if (grupa.racuni.some(racun => racun.qrCode.toLowerCase().includes(searchTerm) || (racun.datv && racun.datv.toLowerCase().includes(searchTerm)))) { // Pretraživanje unutar QR koda ili DATV stringa
                     /* console.log("    MATCH: Sadržaj računa (QR/DATV) sadrži pojam."); */
                     match = true;
                 }
                 /* else { console.log("    Nema tekstualnog matcha."); } */ } if (match) { searchResults.push(grupa); } }); /* console.log("Ukupno pronađeno rezultata (Svi Dani):", searchResults.length); console.log("--- kraj executeAllDaysSearch ---"); */ renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); resultsContainer.style.display = 'block'; sendLogData({ Event: 'history_search_all_days', Details: { term: searchTerm, resultCount: searchResults.length } }); }
    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) { if (!containerElement || !summaryContainer) return; containerElement.innerHTML = ''; summaryContainer.innerHTML = ''; summaryContainer.style.display = 'none'; if (results.length === 0) { containerElement.innerHTML = '<p style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za traženi pojam.</i></p>'; return; } const brojRacunaRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); summaryContainer.innerHTML = `<span>RAČUNA: <span style="font-weight: bold;">${brojRacunaRezultati}</span></span><span style="font-weight: bold;">UKUPNO: ${ukupanIznosRezultati.toFixed(2)} €</span>`; summaryContainer.style.display = 'flex'; results.sort((a, b) => b.timestamp - a.timestamp); let resultsHtml = '<ul id="search-results-list" style="list-style: none; padding: 0; margin: 0;">'; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; results.forEach(grupa => { const vrijemeSpremanja = new Date(grupa.timestamp); const datumString = vrijemeSpremanja.toLocaleDateString('hr-HR', opcijeDatuma); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class="session-name-history">${grupa.name}</span>` : `<span class="scan-time-history">SKEN</span>`; resultsHtml += `<li data-timestamp="${grupa.timestamp}" style="border: 1px solid #eee; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; cursor: pointer;"><div style="font-weight: bold; margin-right: 8px; color: #666;">${datumString}</div><div style="flex-grow: 1; min-width: 100px; display: inline-flex; align-items: center;">${prikazNaziva} <span style="font-size:0.9em; color:#555; margin-left: 5px;">u ${vrijemeSpremanjaFormatirano}</span></div><div style="flex-shrink: 0; margin-left: auto; padding-left: 10px; text-align: right;"><span class="scan-group-last-qr-time">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style="font-weight: bold; margin-left: 10px;">${ukupnoGrupa.toFixed(2)} €</span></div></li>`; }); resultsHtml += '</ul>'; containerElement.innerHTML = resultsHtml; const resultsList = containerElement.querySelector('ul'); if (resultsList) { const newListElement = resultsList.cloneNode(true); resultsList.parentNode.replaceChild(newListElement, resultsList); newListElement.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const punaPovijest = loadFullHistoryFromLocalStorage(); const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); if (containerElement.id === 'search-results') { previousHistoryViewState = 'day-search-results'; lastSearchTerm = document.getElementById('search-input')?.value.trim() || ''; } else if (containerElement.id === 'search-results-all-days') { previousHistoryViewState = 'all-days-search-results'; lastSearchTerm = document.getElementById('all-days-search-input')?.value.trim() || ''; } currentlyViewedDate = new Date(selectedGroup.timestamp); currentlyViewedDate.setHours(0,0,0,0); renderGroupDetailView(selectedGroup); } else { console.error("Nije pronađena grupa iz rezultata pretrage:", timestamp); alert("Greška pri otvaranju detalja."); } } }); } }
    function executeSearch() { const searchInput = document.getElementById('search-input'); const resultsContainer = document.getElementById('search-results'); const summaryContainer = document.getElementById('search-summary-info-day'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); /* console.log("--- executeSearch (Sada pretražuje SVE DANE) ---"); console.log("Tražim pojam:", searchTerm); console.log("Normalizirani datum za pretragu:", normalizedSearchDate); */ resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm && !normalizedSearchDate) { resultsContainer.innerHTML = '<p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu (datum, dan, naziv, ili dio QR/DATV stringa).</i></p>'; return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; const opcijeDana = { weekday: 'long' }; const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' }; const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' }; punaPovijest.forEach((grupa, index) => { const sessionDate = new Date(grupa.timestamp); /* console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); */ const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; /* console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); */ if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { /* console.log("    MATCH: Točan datum!"); */ match = true; } if (!match && searchTerm) { /* console.log("    Provjeravam kao tekst..."); */ if (formattedDateShort.includes(searchTerm)) { /* console.log("    MATCH: Kratki datum sadrži pojam."); */ match = true; } else if (formattedDateNumeric.includes(searchTerm)) { /* console.log("    MATCH: Numerički datum sadrži pojam."); */ match = true; } else if (dayName.includes(searchTerm)) { /* console.log(`    MATCH: Ime dana ('${dayName}') sadrži pojam ('${searchTerm}').`); */ match = true; } else if (sessionName && sessionName.includes(searchTerm)) { /* console.log("    MATCH: Naziv sesije sadrži pojam."); */ match = true; } else if (grupa.racuni.some(racun => racun.qrCode.toLowerCase().includes(searchTerm) || (racun.datv && racun.datv.toLowerCase().includes(searchTerm)))) { // Pretraživanje unutar QR koda ili DATV stringa
                    /* console.log("    MATCH: Sadržaj računa (QR/DATV) sadrži pojam."); */
                    match = true;
                }
                /* else { console.log("    Nema tekstualnog matcha."); } */ } if (match) { searchResults.push(grupa); } }); /* console.log("Ukupno pronađeno rezultata (SVI DANI):", searchResults.length); console.log("--- kraj executeSearch (SVI DANI) ---"); */ renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn) clearDayBtn.style.display = 'none'; sendLogData({ Event: 'history_search_day_view', Details: { term: searchTerm, resultCount: searchResults.length } }); }
    function startSearch() { playSound('click-sound'); console.log("Pokretanje pretrage (sada pretražuje SVE)..."); if (!historyContentDiv || !historyDynamicHeaderContentDiv) return; const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn) clearDayBtn.style.display = 'none'; const dateInfoDiv = document.getElementById('history-date-info'); const summaryInfoDiv = document.getElementById('history-summary-info'); if (dateInfoDiv) dateInfoDiv.style.display = 'none'; if (summaryInfoDiv) summaryInfoDiv.style.display = 'none'; let searchContainer = document.getElementById('search-container'); if (!searchContainer) { searchContainer = document.createElement('div'); searchContainer.id = 'search-container'; searchContainer.innerHTML = `<div style="display: flex; gap: 10px; margin-bottom: 0.8em;"><input type="text" id="search-input" placeholder="Pretraži SVE (Datum, Dan, Naziv...)" style="flex-grow: 1; padding: 0.5em;"><button id="execute-search-btn" style="padding: 0.5em 1em;">Traži</button><button id="close-search-btn" style="padding: 0.5em 1em; background-color: #ccc;">Zatvori</button></div><div id="search-summary-info-day" style="display: none;"></div>`; historyDynamicHeaderContentDiv.appendChild(searchContainer); } searchContainer.style.display = 'block'; historyContentDiv.innerHTML = '<div id="search-results"><p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu.</i></p></div>'; const searchResultsDiv = document.getElementById('search-results'); if(searchResultsDiv) searchResultsDiv.style.display = 'block'; const searchInput = document.getElementById('search-input'); const executeBtn = document.getElementById('execute-search-btn'); const closeBtn = document.getElementById('close-search-btn'); const searchSummaryDay = document.getElementById('search-summary-info-day'); if (searchInput) { searchInput.value = ''; searchInput.focus(); } if (searchSummaryDay) { searchSummaryDay.style.display = 'none'; searchSummaryDay.innerHTML = ''; } if (executeBtn) { const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', executeSearch); } if (closeBtn) { const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); if (searchContainer) searchContainer.style.display = 'none'; renderHistoryView(currentlyViewedDate); }); } if (searchInput) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeSearch(); }); } }
    function deleteScansForDay(dateToDelete) { // <-- Linija 1950 u originalnom kodu
        if (!(dateToDelete instanceof Date) || isNaN(dateToDelete)) { console.error("Pokušaj brisanja dana s neispravnim datumom."); alert("Greška: Nije moguće identificirati dan za brisanje."); return; } const dateToDeleteStr = getISODateString(dateToDelete); if (!dateToDeleteStr) return; console.log("Brisanje svih skenova za dan:", dateToDeleteStr); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const sessionsToDelete = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr === dateToDeleteStr; }); const filtriranaPovijest = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr !== dateToDeleteStr; }); const newLength = filtriranaPovijost.length; // <-- Ispravljeno: filtriranaPovijost -> filtriranaPovijest. Ovo je Linija 1955 u originalnom kodu
 console.log(`Originalna dužina: ${originalLength}, Nova dužina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); // ZVUK ZA BRISANJE DANA (smeće.mp3)
         alert(`Svi skenovi za ${dateToDelete.toLocaleDateString('hr-HR')} obrisani.`);
         // Logiranje uspješnog brisanja dana
         const dayDetails = { date: dateToDeleteStr, sessionCount: sessionsToDelete.length, totalCount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.length, 0), totalAmount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.reduce((gSum, r) => gSum + r.amount, 0), 0) };
         sendLogData({ Event: 'day_deleted_confirmed', Details: JSON.stringify(dayDetails) });
         renderAllDaysView();
     } else { console.warn("Nisu pronađeni skenovi za brisanje za dan:", dateToDeleteStr); alert("Greška: Nisu pronađeni skenovi za ovaj dan."); const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = "IZBRIŠI OVAJ DAN"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } } }


     // *** FUNKCIJE ZA IZVOZ I UVOZ POVIJESTI ***

    function exportHistory() {
        playSound('click-sound');
        const punaPovijest = loadFullHistoryFromLocalStorage();
        // Dodaj trenutno nesačuvano stanje
        const unsavedData = (povijest.length > 0 || currentSessionName) ?
            { count: povijest.length, amount: ukupno, currentSession: povijest, currentName: currentSessionName || null }
            : null;

        if (punaPovijest.length === 0 && !unsavedData) { // Provjeri i nesačuvano stanje
            alert("Nema povijesti za izvoz.");
             sendLogData({ Event: 'history_exported', Details: 'no_data' }); // Logiranje izvoza (nema podataka)
            return;
        }

        try {
            const dataToExport = {
                 savedHistory: punaPovijest,
                 unsavedState: unsavedData,
                 exportTimestamp: new Date().toISOString(),
                 appVersion: '1.0.0' // Možeš dodati verziju aplikacije ako je pratiš
            };

            const historyJson = JSON.stringify(dataToExport, null, 2); // null, 2 za lijepo formatiranje
            const blob = new Blob([historyJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            a.download = `qr_racunator_povijest_${dateStr}.json`;
            document.body.appendChild(a); // Firefox zahtijeva da element bude u DOM-u
            a.click();

            document.body.removeChild(a); // Očisti nakon klika
            URL.revokeObjectURL(url); // Oslobodi memoriju

            alert("Povijest je izvezena kao JSON datoteka.");
             // Logiranje izvoza
             const exportDetails = { savedItemCount: punaPovijest.length, unsavedItemCount: unsavedData ? unsavedData.count : 0 };
             sendLogData({ Event: 'history_exported', Details: JSON.stringify(exportDetails) });

        } catch (error) {
            console.error("Greška pri izvozu povijesti:", error); // Ostavljen log greške
            alert("Greška pri izvozu povijesti.");
             // Logiranje greške pri izvoza
            sendLogData({ Event: 'history_export_failed', Details: error.message });
        }
    }

    function importHistory() {
        playSound('click-sound');
        const fileInput = document.getElementById('import-file-input');
        if (!fileInput) {
            console.error("Input za datoteku za uvoz nije pronađen."); // Ostavljen kritičan log
            alert("Greška pri pokretanju uvoza.");
            return;
        }

        // Klikni na skriveni input da otvori dijalog za odabir datoteke
        fileInput.click();

        // Dodaj listener za promjenu (kad korisnik odabere datoteku)
        // Koristimo "once: true" da se listener automatski ukloni nakon prvog okidanja
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                console.log("Nije odabrana datoteka za uvoz."); // Ostavljen ovaj log
                fileInput.value = ''; // Resetiraj input da omogući ponovni odabir iste datoteke
                 sendLogData({ Event: 'history_import_cancelled', Details: 'no_file_selected' });
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const rawData = e.target.result;
                    const importedData = JSON.parse(rawData);

                    // Poboljšana validacija za format v2 (s savedHistory i unsavedState)
                     let historyToImport = null;
                     let unsavedToImport = null;

                     if (Array.isArray(importedData)) {
                         // Format v1 (samo niz sesija)
                         historyToImport = importedData;
                         console.log("Uvezen format v1."); // Ostavljen ovaj log
                     } else if (typeof importedData === 'object' && importedData !== null && Array.isArray(importedData.savedHistory)) {
                         // Format v2 (sa savedHistory i opcionalno unsavedState)
                          historyToImport = importedData.savedHistory;
                          unsavedToImport = importedData.unsavedState;
                          console.log("Uvezen format v2."); // Ostavljen ovaj log
                     } else {
                          throw new Error("Neispravan format datoteke. Očekuje se niz sesija ili objekt s 'savedHistory'.");
                     }

                    // Validacija strukture uvezenih sesija
                    if (!historyToImport.every(group =>
                         typeof group === 'object' && group !== null &&
                         Array.isArray(group.racuni) &&
                         group.racuni.every(racun =>
                             typeof racun === 'object' && racun !== null &&
                             typeof racun.amount === 'number' && typeof racun.qrCode === 'string'
                             // Ne moramo strogo validirati 'time', 'datv', 'scanTimestamp'
                         )
                    )) {
                         throw new Error("Neispravna struktura podataka unutar spremljene povijesti.");
                    }

                    // Validacija uvezene nesačuvane sesije (ako postoji)
                     if (unsavedToImport) {
                         if (typeof unsavedToImport !== 'object' || unsavedToImport === null ||
                              typeof unsavedToImport.count !== 'number' || typeof unsavedToImport.amount !== 'number' || !Array.isArray(unsavedToImport.currentSession) ||
                              (unsavedToImport.currentName !== null && typeof unsavedToImport.currentName !== 'string' && typeof unsavedToImport.currentName !== 'undefined') || // Dodana provjera za undefined
                              !unsavedToImport.currentSession.every(racun =>
                                   typeof racun === 'object' && racun !== null &&
                                   typeof racun.amount === 'number' && typeof racun.qrCode === 'string'
                              )
                         ) {
                              console.warn("Uvezeni podaci sadrže neispravno formatirano nesačuvano stanje. Ignoriram nesačuvano stanje."); // Ostavljen log upozorenja
                              unsavedToImport = null; // Ignoriraj neispravno nesačuvano stanje
                         }
                     }


                    const confirmMessage = `Pronađeno ${historyToImport.length} spremljenih sesija ${unsavedToImport && unsavedToImport.count > 0 ? ` i nesačuvano stanje (${unsavedToImport.count} računa)` : ''} u datoteci.\n\nŽelite li PREPISATI vašu trenutnu povijest i nesačuvano stanje ovim podacima?\n(Trenutna povijest i nesačuvano stanje će biti trajno izbrisani!)`;
                    if (confirm(confirmMessage)) {
                        // Brišemo sve lokalne podatke da bi uvoz bio čist
                        localStorage.removeItem(HISTORY_STORAGE_KEY);
                        localStorage.removeItem(COUNTER_KEY);
                        localStorage.removeItem(COUNTER2_KEY);
                        localStorage.removeItem(COUNTER_ACTIVE_KEY);
                        localStorage.removeItem(USER_ID_KEY); // Resetiraj i usera
                        localStorage.removeItem(FIRST_USE_KEY); // Resetiraj i timestamp
                        localStorage.removeItem(UNSAVED_COUNT_KEY); // Briši nesačuvano
                        localStorage.removeItem(UNSAVED_AMOUNT_KEY); // Briši nesačuvano
                        localStorage.removeItem(CAMERA_ID_KEY); /* <<< Briši spremljenu kameru */


                        saveFullHistoryToLocalStorage(historyToImport); // Spremi uvezenu povijest

                        // Učitaj uvezeno nesačuvano stanje
                         if (unsavedToImport && unsavedToImport.currentSession && unsavedToImport.currentSession.length > 0) { // Učitaj samo ako postoji i ima računa
                             povijest = unsavedToImport.currentSession;
                             ukupno = unsavedToImport.amount;
                             currentSessionName = unsavedToImport.currentName || null; // Osiguraj da je null ako je undefined u JSON-u
                             // Spremi uvezeno nesačuvano stanje u localStorage (kao da je upravo skenirano)
                             try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Greška spremanja uvezenog nesačivanog stanja u localStorage:", lsError); } // Ostavljen log greške
                             console.log(`Uvezeno nesačuvano stanje: ${povijest.length} računa, ${ukupno.toFixed(2)} €, Naziv: ${currentSessionName || 'N/A'}`); // Ostavljen ovaj log
                         } else {
                             // Ako nema nesačuvanog stanata u datoteci ili je prazno, resetiraj trenutnu sesiju
                             povijest = [];
                             ukupno = 0;
                             currentSessionName = null;
                              console.log("Nema nesačuvanog stanja u uvezenoj datoteci, trenutna sesija je prazna."); // Ostavljen ovaj log
                              try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); } catch(lsError) { console.error("Greška brisanja starog nesačuvanog stanja nakon uvoza:", lsError); } // Ostavljen log greške
                         }


                        // Resetiraj UI elemente vezane za trenutnu sesiju
                        if (deleteWarningDiv) {
                             delete deleteWarningDiv.dataset.lastScanText;
                             delete deleteWarningDiv.dataset.beforeConfirmText;
                             delete deleteWarningDiv.dataset.lastNameText;
                             delete deleteWarningDiv.dataset.beforeConfirmNameText;
                        }
                         resetRemoveMode(); // Resetiraj Obriši gumb modove
                         resetOcistiMode(); // Resetiraj Očisti gumb mod


                        loadCountersState(); // Učitaj brojače (bit će resetirani na 0 ako ih je brisanje obrisalo)
                        initializeUserTracking(); // Reinicijaliziraj usera (dobit će novi ID ako je obrisan)
                        updateDisplay(); // Ažuriraj prikaz trenutne sesije

                        alert("Povijest uspješno uvezena i lokalni podaci resetirani.");

                         // Logiranje uspješnog uvoza (prepisivanja)
                         const importDetails = { savedItemCount: historyToImport.length, unsavedItemCount: unsavedToImport ? unsavedToImport.count : 0, mode: 'overwrite' };
                         sendLogData({ Event: 'history_imported', Details: JSON.stringify(importDetails) });

                        // Nakon uvoza, prikaži all days view s novim podacima
                         // Moramo pričekati da se fetchSheetData završi jer ono utječe na prikaz AllDaysView-a
                         fetchSheetData().then(() => {
                             renderAllDaysView(); // Renderiraj All Days View nakon dohvaćanja Sheeta
                         }).catch(() => {
                              renderAllDaysView(); // Renderiraj All Days View čak i ako fetch Sheet-a ne uspije
                         });


                    } else {
                        alert("Uvoz otkazan.");
                        // Logiranje otkazanog uvoza
                        sendLogData({ Event: 'history_import_cancelled', Details: 'user_cancelled' });
                    }

                } catch (error) {
                    console.error("Greška pri obradi datoteke za uvoz:", error); // Ostavljen log greške
                    alert(`Greška pri uvozu povijesti: ${error.message}`);
                     // Logiranje greške pri uvoza
                    sendLogData({ Event: 'history_import_failed', Details: error.message });
                } finally {
                    fileInput.value = ''; // Resetiraj input da omogući ponovni odabir iste datoteke
                }
            };
            reader.readAsText(file); // Čitaj datoteku kao tekst
        }, { once: true }); // Listener se automatski uklanja nakon prvog okidanja
    }


    // *** EVENT LISTENERI ***
    // Modificirana handleVisibilityChange
     function handleVisibilityChange() {
        if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) {
             console.log("Aplikacija postala vidljiva u Scanner View."); // Ostavljen ovaj log
            // U initializeScanner() se vrši provjera je li već aktivan
            initializeScanner();
        } else if (document.visibilityState === 'hidden') {
             console.log("Aplikacija postala nevidljiva, zaustavljam skener."); // Ostavljen ovaj log
            stopScanner(); // Zaustavi skener kad tab nije vidljiv
        }
    };

    function attachVisibilityListener() {
        if (visibilityListenerAttached) return;
        document.addEventListener("visibilitychange", handleVisibilityChange);
        visibilityListenerAttached = true;
        console.log("Visibility listener dodan."); // Ostavljen ovaj log
    }

    // Modificirana globalClickListener da zatvori overlay i resetira gumbe
    function globalClickListener(event) {
        // Zatvori popis kamera ako se klikne izvan njega i izvan gumba za promjenu kamere
        if (cameraSelectionOverlay && cameraSelectionOverlay.style.display === 'block') {
             const isClickInsideOverlay = cameraSelectionOverlay.contains(event.target);
             const isClickOnSwitchButton = switchCameraButton && switchCameraButton.contains(event.target);
             if (!isClickInsideOverlay && !isClickOnSwitchButton) {
                 cameraSelectionOverlay.style.display = 'none';
             }
        }

        // Zatvori Manual Entry modal ako se klikne na overlay (ali ne na content)
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             const manualEntryModalContent = document.getElementById('manual-entry-modal-content');
             const isClickInsideManualModal = manualEntryModalContent && manualEntryModalContent.contains(event.target);
             const isClickOnManualEntryBtn = manualEntryBtn && manualEntryBtn.contains(event.target); // Allow clicking the toggle button
             // Također dozvoli klik na inpute i gumbe unutar modala
             const isClickInsideModalContent = manualEntryModalContent && manualEntryModalContent.contains(event.target);

             if (!isClickInsideModalContent && !isClickOnManualEntryBtn) {
                 cancelManualEntry(); // Koristi cancel za zvuk i log
             }
         }


        // Ostatak logike za resetiranje gumba
        const isClickOnRemoveButton = removeButton && removeButton.contains(event.target);
        const isClickOnOcistiButton = ocistiButton && ocistiButton.contains(event.target);
        const isClickOnNameInput = sessionNameInput && sessionNameInput.contains(event.target);
        const isClickOnAddNameBtn = addNameBtn && addNameBtn.contains(event.target);
        const isClickOnEditIcon = event.target.classList.contains('edit-icon');
        const isClickOnDeleteWarning = deleteWarningDiv && deleteWarningDiv.style.display !== 'none' && deleteWarningDiv.contains(event.target);
        const isClickOnHistoryDeleteButton = event.target.closest('#clear-day-btn, #delete-session-btn, #clear-history-btn'); // Selektiraj sve gumbe za brisanje u povijesti
        const isClickOnHistoryButton = historyToggleButton && historyToggleButton.contains(event.target); // History toggle button
        const isClickOnShareButton = shareButton && shareButton.contains(event.target); // Share button


        // Reset Remove button (skener view) if in confirm mode and clicked outside its area
        if ((removeConfirm || removeNameConfirm) && !isClickOnRemoveButton && !isClickOnDeleteWarning) {
            resetRemoveMode();
        }

        // Reset Ocisti button if in confirm mode and clicked outside
        if (ocistiConfirm && !isClickOnOcistiButton) {
            resetOcistiMode();
        }

        // Save name if input is visible and clicked outside name area (input, add/edit button)
         const isClickInsideNameArea = isClickOnNameInput || isClickOnAddNameBtn || isClickOnEditIcon;
        if (sessionNameInput && sessionNameInput.style.display === 'block' && !isClickInsideNameArea) {
            saveName(); // Pozovi saveName na blur ako je input bio aktivan
        }

        // Reset History Delete Buttons if in confirm mode and clicked outside *any* of them
        if (!isClickOnHistoryDeleteButton && !isClickOnHistoryButton && !isClickOnShareButton && !isClickInsideNameArea) { // Also don't reset if clicking history, share buttons or name area
             const clearDayBtn = document.getElementById('clear-day-btn');
             if (clearDayBtn && clearDayBtn.dataset.confirming === 'true') {
                  clearDayBtn.innerText = "IZBRIŠI OVAJ DAN";
                  clearDayBtn.classList.remove('confirm-mode');
                  clearDayBtn.dataset.confirming = 'false';
                  // console.log("Resetirao clearDayBtn iz global click (outside)"); // KOMENTIRANO: Previše logova
                   sendLogData({ Event: 'delete_day_cancelled_outside', Details: getISODateString(currentlyViewedDate) });
             }
              const deleteSessionBtn = document.getElementById('delete-session-btn');
              if (deleteSessionBtn && deleteSessionBtn.dataset.confirming === 'true') {
                   deleteSessionBtn.innerText = "IZBRIŠI OVAJ SKEN";
                   deleteSessionBtn.classList.remove('confirm-mode');
                   deleteSessionBtn.dataset.confirming = 'false';
                   // console.log("Resetirao deleteSessionBtn iz global click (outside)"); // KOMENTIRANO: Previše logova
                   // Log cancellation, session ID is hard to get here reliably
              }
              const clearAllBtn = document.getElementById('clear-history-btn');
              if (clearAllBtn && clearAllBtn.dataset.confirming === 'true') {
                   clearAllBtn.innerText = "IZBRIŠI SVU POVIJEST";
                   clearAllBtn.classList.remove('confirm-mode');
                   clearAllBtn.dataset.confirming = 'false';
                   // console.log("Resetirao clearAllBtn iz global click (outside)"); // KOMENTIRANO: Previše logova
                    sendLogData({ Event: 'clear_all_cancelled_outside' });
              }
        }
    }


    // *** INICIJALIZACIJA APLIKACIJE ***
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM spreman..."); // Ostavljen ovaj log
        // Dohvati SVE DOM elemente
        totalDiv = document.getElementById('total');
        totalContainer = document.getElementById('total-container');
        ocistiButton = document.getElementById('ocisti-button');
        invoiceCountDiv = document.getElementById('invoice-count');
        historyList = document.getElementById('historyList');
        removeButton = document.getElementById('remove-from-list-btn');
        duplicateWarning = document.getElementById('duplicate-warning');
        loadedMsg = document.getElementById('loaded-message');
        instructionDiv = document.getElementById('scan-instruction');
        deleteWarningDiv = document.getElementById('delete-warning');
        shareButton = document.getElementById('share-button');
        readerDiv = document.getElementById('reader');
        historyToggleButton = document.getElementById('history-toggle-btn');
        historyDiv = document.getElementById('history');
        historyPageDiv = document.getElementById('history-page');
        backToScannerButton = document.getElementById('back-to-scanner-btn');
        historyContentDiv = document.getElementById('history-content');
        sessionNameContainer = document.getElementById('session-name-container');
        addNameBtn = document.getElementById('add-name-btn');
        sessionNameInput = document.getElementById('session-name-input');
        sessionNameDisplay = document.getElementById('session-name-display');
        sessionNameText = document.getElementById('session-name-text');
        historyStickyHeaderDiv = document.getElementById('history-sticky-header');
        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');
        runningTextContainer = document.getElementById('running-text-container');
        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;
        sharePromptOverlay = document.getElementById('share-prompt-overlay');
        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');
        switchCameraButton = document.getElementById('switch-camera-btn');
        cameraSelectionOverlay = document.getElementById('camera-selection-overlay');
        cameraListUl = document.getElementById('camera-list');
        // DOHVATI ELEMENTE ZA RUČNI UNOS
        manualEntryBtn = document.getElementById('manual-entry-btn');
        manualEntryModalOverlay = document.getElementById('manual-entry-modal-overlay');
        manualAmountInput = document.getElementById('manual-amount-input');
        manualTimeInput = document.getElementById('manual-time-input');
        manualAddBtn = document.getElementById('manual-add-btn');
        manualCancelBtn = document.getElementById('manual-cancel-btn');
        manualEntryErrorMsg = document.getElementById('manual-entry-error');
        // Import file input je potreban globally za importHistory() funkciju
        importFileInput = document.getElementById('import-file-input');


        // Provjera osnovnih elemenata (uključujući nove)
        if (!readerDiv || !historyPageDiv || !historyContentDiv || !backToScannerButton || !historyToggleButton || !sessionNameContainer || !historyStickyHeaderDiv || !historyDynamicHeaderContentDiv || !runningTextContainer || !runningTextSpan || !sharePromptOverlay || !counterDeactivatedIndicator || !loadedMsg || !duplicateWarning || !switchCameraButton || !cameraSelectionOverlay || !cameraListUl || !manualEntryBtn || !manualEntryModalOverlay || !manualAmountInput || !manualTimeInput || !manualAddBtn || !manualCancelBtn || !manualEntryErrorMsg || !importFileInput) {
            console.error("GREŠKA: Nedostaju kritični DOM elementi! Provjerite konzolu za detalje."); // Ostavljen kritičan log
             // Ispiši koji elementi nedostaju
            const missing = [];
            if (!readerDiv) missing.push('#reader');
            if (!historyPageDiv) missing.push('#history-page');
            if (!historyContentDiv) missing.push('#history-content');
            if (!backToScannerButton) missing.push('#back-to-scanner-btn');
            if (!historyToggleButton) missing.push('#history-toggle-btn');
            if (!sessionNameContainer) missing.push('#session-name-container');
            if (!historyStickyHeaderDiv) missing.push('#history-sticky-header');
            if (!historyDynamicHeaderContentDiv) missing.push('#history-dynamic-header-content');
            if (!runningTextContainer) missing.push('#running-text-container');
            if (!runningTextSpan) missing.push('#running-text-container span'); // Check the span too
            if (!sharePromptOverlay) missing.push('#share-prompt-overlay');
            if (!counterDeactivatedIndicator) missing.push('#counter-deactivated-indicator');
            if (!loadedMsg) missing.push('#loaded-message');
            if (!duplicateWarning) missing.push('#duplicate-warning');
            if (!switchCameraButton) missing.push('#switch-camera-btn');
            if (!cameraSelectionOverlay) missing.push('#camera-selection-overlay');
            if (!cameraListUl) missing.push('#camera-list');
            if (!manualEntryBtn) missing.push('#manual-entry-btn'); // Provjera novog gumba
            if (!manualEntryModalOverlay) missing.push('#manual-entry-modal-overlay'); // Provjera modala
            if (!manualAmountInput) missing.push('#manual-amount-input');
            if (!manualTimeInput) missing.push('#manual-time-input');
            if (!manualAddBtn) missing.push('#manual-add-btn');
            if (!manualCancelBtn) missing.push('#manual-cancel-btn');
            if (!manualEntryErrorMsg) missing.push('#manual-entry-error');
            if (!importFileInput) missing.push('#import-file-input'); // Provjera import inputa

            console.error("Nedostaju elementi:", missing.join(', ')); // Ostavljen kritičan log

            document.body.innerHTML = '<div style="padding: 20px; color: red; font-weight: bold;">Greška pri učitavanju aplikacije. Nedostaju ključni elementi. Osvježite stranicu ili provjerite konzolu za detalje.</div>';
             sendLogData({ Event: 'critical_dom_missing', Details: missing.join(', ')}); // Log kritične greške (neće poslati ako URL ne radi, ali dobro je imati u kodu)
            return; // Zaustavi daljnju inicijalizaciju
        }


        // Globalni listener i listeneri za standardne gumbe (Povijest, Share, itd.)
        document.body.addEventListener('click', globalClickListener, true);

        // Listener za gumb POVIJEST
        if (historyToggleButton) {
             // Using cloneNode(true) and replaceChild to ensure fresh listeners are attached
             const newHistoryToggleButton = historyToggleButton.cloneNode(true);
             historyToggleButton.parentNode.replaceChild(newHistoryToggleButton, historyToggleButton);
             historyToggleButton = newHistoryToggleButton; // Update the variable reference
             historyToggleButton.addEventListener('click', () => { console.log("Klik na 'POVIJEST' gumb detektiran."); playSound('click-sound'); switchToHistoryView(); }); // Ostavljen ovaj log
        } else { console.error("DOM spreman, ali #history-toggle-btn nije pronađen!"); } // Ostavljen kritičan log

        // Listener za gumb < NA SKENER
        if (backToScannerButton) { backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); }); }

        // Listener za SHARE gumb
        if (navigator.share && typeof navigator.share === 'function') {
            if (shareButton) {
                shareButton.style.display = 'block';
                 // Using cloneNode(true) and replaceChild
                 const newShareButton = shareButton.cloneNode(true);
                 shareButton.parentNode.replaceChild(newShareButton, shareButton);
                 shareButton = newShareButton; // Update reference
                shareButton.addEventListener('click', async () => {
                    if (removeConfirm || removeNameConfirm) resetRemoveMode();
                    if (ocistiConfirm) resetOcistiMode();
                    // Sakrij modal za ručni unos ako je otvoren prije dijeljenja
                    if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
                        hideManualEntryModal(); // Sakrij bez zvuka otkazivanja
                    }
                    const shareData = {
                        title: 'QR SKENER-RAČUNATOR',
                        text: 'Skenira i zbraja račune bez instaliranja. Isprobaj!',
                        url: 'https://soboslikar.github.io/QR-RACUNATOR/'
                    };
                    try {
                        await navigator.share(shareData);
                        console.log('Share dijalog zatvoren (vjerojatno uspješno)...'); // Ostavljen ovaj log
                         sendLogData({ Event: 'share_success' }); // Log success
                    } catch (err) {
                        console.error('Greška dijeljenja:', err); // Ostavljen log greške
                        if (err.name === 'AbortError') {
                            console.log('Korisnik odustao od dijeljenja.'); // Ostavljen ovaj log
                             sendLogData({ Event: 'share_cancelled' }); // Log cancellation
                        } else {
                             console.log('Došlo je do druge greške pri dijeljenju.'); // Ostavljen ovaj log
                             showTemporaryMessage(loadedMsg, "Dijeljenje neuspješno.", 1500);
                              sendLogData({ Event: 'share_failed', Details: err.message }); // Log error
                        }
                    } finally {
                         // <-- DODANO/IZMIJENJENO: Resetiranje brojača i UI-ja nakon pokušaja dijeljenja (uspjeh ili neuspjeh)
                         console.log("Share attempt finished. Checking counter state for reset.");
                        if (brojac === 0 && brojac2 > 0) { // Resetiraj samo ako je brojač došao do 0 i prag je veći od 0
                            brojac = brojac2; // Postavi brojač1 na vrijednost brojača2
                            saveBrojac(); // Spremi novu vrijednost brojača1
                            console.log("Brojač resetiran na prag:", brojac);
                            // Logiranje automatskog reseta brojača nakon dijeljenja
                             sendLogData({ Event: 'share_counter_reset', Details: brojac });
                        } else {
                             console.log("Brojač nije resetiran. Stanje: brojac=" + brojac + ", brojac2=" + brojac2);
                        }
                         checkSharePrompt(); // Ponovno provjeri state (sakrit će prompt ako je brojač > 0)
                         updateRunningTextVisibility(); // Update running text visibility
                         updateDeactivatedIndicator(); // Update indicator visibility
                         console.log("UI updated after share attempt.");
                    }
                });
            }
        } else {
             console.log("navigator.share API nije podržan ili dostupan."); // Ostavljen ovaj log
             if (shareButton) shareButton.style.display = 'none';
             sendLogData({ Event: 'share_api_not_supported' }); // Log nedostatka podrške
        }


        // Listener za UNOS IMENA (Enter/Escape) i blur
        if(sessionNameInput) {
            sessionNameInput.addEventListener('keydown', (e) => {
                // Provjeri da input nije skriven (tj. da je aktivan za unos)
                 if (sessionNameInput.style.display === 'none') return;

                if (e.key === 'Enter') {
                    e.preventDefault(); saveName();
                } else if (e.key === 'Escape') {
                    e.preventDefault(); // Spriječi defaultnu Escape akciju
                    // Resetiraj input i sakrij ga
                    sessionNameInput.value = currentSessionName || '';
                    sessionNameInput.style.display = 'none';
                    updateNameDisplay();
                    // Ako je brisanje naziva bilo aktivno, resetiraj i taj mod
                    if(removeNameConfirm) resetRemoveMode();
                     // Logiranje otkazivanja unosa naziva
                    sendLogData({ Event: 'session_name_input_cancelled_escape' });
                }
            });
             // Listener za blur sa inputa za ime
            sessionNameInput.addEventListener('blur', saveName); // Veži blur listener na input polje
        } else { console.error("DOM spreman, ali #session-name-input nije pronađen!"); } // Ostavljen kritičan log


        // Listener za gumb za promjenu kamere
        if (switchCameraButton) {
             // Using cloneNode(true) and replaceChild
             const newSwitchCameraButton = switchCameraButton.cloneNode(true);
             switchCameraButton.parentNode.replaceChild(newSwitchCameraButton, switchCameraButton);
             switchCameraButton = newSwitchCameraButton; // Update reference
            switchCameraButton.addEventListener('click', toggleCameraSelection);
        } else { console.error("DOM spreman, ali #switch-camera-btn nije pronađen!"); } // Ostavljen kritičan log

        // --- NOVI LISTENER za RUČNI UNOS gumb ---
        if (manualEntryBtn) {
            // Na klik uvijek prikaži modal za ručni unos
            manualEntryBtn.addEventListener('click', showManualEntryModal);
        } else { console.error("DOM spreman, ali #manual-entry-btn nije pronađen!"); } // Ostavljen kritičan log


        // --- NOVI LISTENERI za modal ručnog unosa ---
        if (manualAddBtn) {
            manualAddBtn.addEventListener('click', addManualEntry);
        } else { console.error("DOM spreman, ali #manual-add-btn nije pronađen!"); } // Ostavljen kritičan log

        if (manualCancelBtn) {
             manualCancelBtn.addEventListener('click', cancelManualEntry);
        } else { console.error("DOM spreman, ali #manual-cancel-btn nije pronađen!"); } // Ostavljen kritičan log

        if (manualEntryModalOverlay) {
            // Omogući Enter tipku unutar modala za "Dodaj račun" i Escape za "Odustani"
            const handleManualEntryKeydown = (e) => {
                // Provjeri da modal NIJE skriven, inače ignore
                if (manualEntryModalOverlay.style.display === 'none') return;

                if (e.key === 'Enter') {
                     // Provjeri je li fokus na amount inputu ili time inputu
                     if (document.activeElement === manualAmountInput || document.activeElement === manualTimeInput) {
                          e.preventDefault(); // Spriječi defaultnu Enter akciju (npr. submit forme)
                          addManualEntry(); // Pokušaj dodati račun
                     }
                     // Ako fokus nije na input polju, ne radi ništa na Enter (možda je na gumbu, pa gumb hendla klik)
                } else if (e.key === 'Escape') {
                     e.preventDefault(); // Spriječi defaultnu Escape akciju
                     cancelManualEntry(); // Odustani
                }
            };
            // Dodaj listener na sam modal overlay (bolje nego content, pokriva više)
            manualEntryModalOverlay.addEventListener('keydown', handleManualEntryKeydown);

        } else { console.error("DOM spreman, ali #manual-entry-modal-overlay nije pronađen!"); } // Ostavljen kritičan log

        // --- Listener za input datoteku kod uvoza (povezan unutar importHistory) ---
        // Referenca na importFileInput je već dohvatio na početku DOMContentLoaded
        // Event listener je unutar importHistory funkcije


        // --- REDOSLIJED INICIJALIZACIJE ---
        // 1. Učitaj lokalno stanje brojača
        loadCountersState();
        // 2. Inicijalizuj UserID i FirstUseTimestamp
        initializeUserTracking();
        // 3. Napravi inicijalni update prikaza (ukupno, broj računa, ime sesije)
        // Povijest (mala lista) će se ažurirati unutar updateDisplay ako je scanner-view
        updateDisplay();
        // 4. Provjeri view i pokreni inicijalizaciju skenera ILI rendiranje povijesti
        console.log("Provjeravam inicijalni view..."); // Ostavljen ovaj log
        if (document.body.classList.contains('scanner-view')) {
            console.log("Init: Scanner view - Pokrećem inicijalizaciju skenera..."); // Ostavljen ovaj log
             // initializeScanner sada dohvaća i sprema popis kamera, te starta skener.
             // Također postavlja isScannerActive i prikazuje gumb kamere ako treba.
            initializeScanner();
            // Visibility listener attachaj čim kreneš u scanner view
            attachVisibilityListener();
        } else {
            console.log("Init: History view - Renderiram povijest."); // Ostavljen ovaj log
            renderHistoryView(currentlyViewedDate);
            // Nema potrebe za visibility listenerom u history view
        }
        // 5. Pokreni dohvaćanje podataka iz Sheeta u pozadini
        // Callback dohvaćanja podataka ažurira UI elemente koji ovise o podacima iz Sheeta
        fetchSheetData().then(() => {
            console.log("Sheet podaci dohvaćeni. Pripremam 'app_loaded' log."); // Ostavljen ovaj log

            // Logiraj uspješno učitavanje (bez info o nesačuvanom) - MODIFICIRANO
            const appLoadedDetails = { status: 'ok', fetchSuccess: true }; // Jednostavni status
            const appLoadedEventData = { Event: 'app_loaded', Details: JSON.stringify(appLoadedDetails) };
            sendLogData(appLoadedEventData); // <-- IZMJENA

            // Ažuriraj UI koji ovisi o sheet podacima
            updateRunningText(); // Ovo sada pokreće dinamičku animaciju
            checkSharePrompt();
            updateDeactivatedIndicator(); // Ažuriraj indikator nakon učitavanja stanja aktivacije

             // Ako si u history view, ponovno renderiraj da uključi potencijalno nove podatke (tekst)
             if (document.body.classList.contains('history-view')) {
                 console.log("Ažuriram prikaz povijesti nakon dohvaćanja podataka."); // Ostavljen ovaj log
                 renderHistoryView(currentlyViewedDate);
             } else {
                 // console.log("Ažuriram UI skenera nakon dohvaćanja podataka."); // KOMENTIRANO: Previše logova
                 // UI specifičan za skener (poput gumba kamere) se ažurira u initializeScanner
             }
            console.log("Inicijalizacija (pozadinska obrada) završena."); // Ostavljen ovaj log
        }).catch(error => {
             console.error("Greška tijekom pozadinskog dohvaćanja podataka:", error); // Ostavljen log greške
             // Logiraj grešku pri učitavanju (bez info o nesačuvanom) - MODIFICIRANO
             const appLoadedErrorEventData = { Event: 'app_loaded', Details: JSON.stringify({ status: 'error', fetchError: error.toString() }) };
             sendLogData(appLoadedErrorEventData); // <-- IZMJENA

             console.log("Inicijalizacija završena (s greškom pozadinskog dohvaćanja)."); // Ostavljen ovaj log
             // I dalje ažuriraj UI koji ne ovisi o sheet podacima ili koristi default/spremljene vrijednosti
             updateRunningText(); // Postavit će se na prazno, animacija će stati
             checkSharePrompt(); // Prompt će se možda pokazati ako brojač1=0 i brojač2=0
             updateDeactivatedIndicator(); // Ovisno o localStorage stanju
             if (document.body.classList.contains('history-view')) { renderHistoryView(currentlyViewedDate); }
             // Skener UI će biti ažuriran unutar initializeScanner ako je bio aktivan
        });
        console.log("Osnovna inicijalizacija završena (dohvaćanje ide u pozadini)."); // Ostavljen ovaj log
    }); // Kraj DOMContentLoaded
    console.log(">>> KRAJ SKRIPTE <<<"); // Ostavljen ovaj log
  </script>

  <!-- Statcounter kod -->
  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- Kraj Statcounter koda -->

</body>
</html>
