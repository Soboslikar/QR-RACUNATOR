[
  {
    "type": "html",
    "content": "<!DOCTYPE html>\n<html lang=\"hr\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n  <title>QR RAČUNATOR</title>\n  <meta property=\"og:title\" content=\"QR RAČUNATOR\" />\n  <meta property=\"og:description\" content=\"Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu.\"/>\n  <meta name=\"description\" content=\"Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih računa i automatsko zbrajanje iznosa. Uključuje povijest i pretragu.\">\n  <meta property=\"og:type\" content=\"website\" />\n  <meta property=\"og:url\" content=\"https://soboslikar.github.io/QR-RACUNATOR/\" />\n  <script src=\"https://unpkg.com/html5-qrcode\" type=\"text/javascript\"></script>\n  <style>\n    /* CSS (Iz prethodne verzije + širi gumb + STICKY HEADER + ODABIR KAMERE) */\n    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }\n    body.scanner-view #history-page { display: none; }\n    body.history-view { background-color: white; }\n    /* Osigurava da history-page zauzima cijelu visinu i omogućava flex layout */\n    body.history-view #history-page {\n        display: flex;\n        flex-direction: column;\n        padding: 0; /* Uklonjen padding da sticky header ide do ruba */\n        min-height: calc(100vh - 1em); /* Oduzima body padding */\n        max-height: calc(100vh - 1em); /* Oduzima body padding */\n        box-sizing: border-box;\n        overflow: hidden; /* Sprječava dvostruki scrollbar */\n    }\n    /* DODANO: Sakrij nove elemente kamere u history view */\n    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator,\n    body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay {\n        display: none !important;\n    }\n    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }\n    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }\n    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }\n    #total-container { position: fixed; top: 23.5em; left: 49%; transform: translateX(-50%); z-index: 5; /* Povećan z-index */ display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; }\n    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }\n    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }\n    #ocisti-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }\n    #ocisti-button.confirm-mode { background-color: yellow; color: black; }\n    #session-name-container { position: fixed; top: 27em; left: 50%; transform: translateX(-50%); z-index: 5; /* Povećan z-index */ display: flex; justify-content: center; align-items: center; min-height: 35px; width: 250px; text-align: center; margin-top: 10px; }\n    #add-name-btn { padding: 0.4em 0.8em; font-size: 0.9em; background-color: #e0e0e0; color: black; display: block; }\n    #session-name-input { font-size: 1.5em; padding: 0.3em 0.5em; border: 1px solid #ccc; border-radius: 3px; width: 220px; display: none; }\n    #session-name-display { font-size: 1.1em; font-weight: bold; color: yellow; background-color: rgba(0, 0, 0, 0.5); padding: 0.3em 0.8em; border-radius: 5px; display: none; align-items: center; gap: 8px; }\n    #session-name-display .edit-icon { cursor: pointer; font-size: 0.8em; font-weight: normal; color: white; text-decoration: underline; }\n    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }\n    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; animation: pulse 0.5s ease-in-out 3 alternate; position: fixed; top: 12.8em; left: 50%; transform: translateX(-50%); z-index: 5; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }\n    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }\n    #delete-warning { font-weight: bold; display: none; text-align: center; position: fixed; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; z-index: 5; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }\n    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }\n    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }\n    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }\n    #history ul { list-style: none; padding: 0; margin: 0; }\n    #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }\n    #history li:last-child { border-bottom: none; }\n    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }\n    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }\n    .red-btn { background: #ff0000; color: yellow; }\n    .yellow-btn { background-color: yellow; color: black; }\n    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }\n    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }\n    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }\n    #share-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); animation: none; }\n    #history-page { display: none; } /* Početno sakriveno */\n\n    /* --- STICKY HEADER STYLES --- */\n    #history-sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }\n    #history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5em; }\n    /* --- END STICKY HEADER STYLES --- */\n\n    #history-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }\n    #back-to-scanner-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }\n    #back-to-scanner-btn:active { background-color: darkgreen; }\n\n    /* history-content sada treba zauzeti ostatak prostora i skrolati */\n    #history-content { flex-grow: 1; overflow-y: auto; padding: 1em; position: relative; }\n\n     /* Stilovi za liste unutar history-content ostaju isti */\n     #scan-group-list, #all-days-list-rendered, #search-results ul, #search-results-all-days ul { list-style: none; padding: 0; margin: 0; }\n     #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }\n     #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }\n     .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }\n     .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }\n     .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }\n     #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }\n     #detail-scan-list { list-style: none; padding: 0; margin: 0; }\n     #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}\n     #detail-scan-list li:last-child { border-bottom: none; }\n\n     /* Pretraga SVI DANI - sada unutar sticky headera */\n     #all-days-search-container { background-color: white; padding: 0.5em 0; margin-bottom: 0.2em; }\n     #all-days-search-container input { flex-grow: 1; padding: 0.5em; min-width: 50px; font-size: 0.9em; }\n     #all-days-search-container button { padding: 0.5em 0.6em; font-size: 0.9em; flex-shrink: 0; }\n\n     /* Pretraga JEDAN DAN - sada unutar sticky headera */\n      #search-container { display: none; padding: 1em 0; margin-bottom: 1em; }\n      #search-container > div:first-child { display: flex; gap: 10px; margin-bottom: 0.8em; }\n      #search-summary-info-day { display: none; justify-content: space-between; align-items: center; padding: 0.6em 0; font-size: 1.1em; margin-top: 0.8em; border-top: 1px solid #eee; }\n      #search-results { /* Ovaj div OSTAJE u #history-content */ }\n\n     /* Stilovi za prikaz dana/sesija u listi ostaju isti */\n     #all-days-list-rendered li { background-color: #f0f0f0; border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 8px; }\n     #all-days-list-rendered li:hover { background-color: #e0e0e0; }\n\n     /* Sažetak i info elementi - unutar sticky headera */\n     #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }\n    /* Uklanjanje gornje linije za prvi element u dynamic headeru */\n     #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }\n\n     /* Specifični stilovi koji overrideaju gornje */\n     #all-days-summary-info, #search-summary-info-day { display: none; justify-content: space-between; align-items: center; font-size: 1.1em; }\n     #history-date-info, #history-summary-info, #detail-summary-info { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }\n     #detail-header-info { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.5em; border-bottom: 1px solid #ccc; border-top: none; }\n     #detail-summary-info { border-top: none; }\n     #all-days-search-container { padding-bottom: 0.2em; border-bottom: 1px solid #eee; }\n     #search-container { display: none; border-bottom: 1px solid #eee; }\n\n    /* --- NOVI STILOVI --- */\n    #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }\n    #running-text-container span { display: inline-block; padding-left: 100%; font-size: 1.4em; font-weight: bold; color: yellow; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); animation: marquee 8s linear infinite; white-space: pre; /* <<< DODANA OVA LINIJA */}\n    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }\n\n    #share-prompt-overlay {\n        position: absolute;\n        top: 7em;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 60%;\n        height: auto;\n        background-color: rgba(0, 0, 0, 0.75);\n        color: lightgreen;\n        font-size: 1.3em;\n        font-weight: bold;\n        text-align: center;\n        padding: 1.5em 1em;\n        border-radius: 10px;\n        z-index: 4;\n        display: none;\n        box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n        line-height: 1.4;\n        align-items: center;\n        justify-content: center;\n    }\n    /* IZMJENA: Uklonjena pozadina kvačice */\n    #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }\n\n    /* NOVI Stil za gumb za promjenu kamere */\n    #switch-camera-btn {\n        position: fixed; /* Zaljepljen za ekran */\n        top: 10px;       /* Udaljenost od vrha */\n        right: 10px;     /* Udaljenost od desnog ruba */\n        z-index: 5;      /* Iznad #reader, ali ispod nekih poruka možda */\n        padding: 6px 8px; /* Malo veći padding */\n        background-color: rgba(0, 0, 0, 0.5); /* Poluprozirna pozadina */\n        color: white;\n        border: none;\n        border-radius: 50%; /* Okrugli gumb */\n        font-size: 1.4em;  /* Veličina ikonice */\n        line-height: 1;    /* Da ikonica bude centrirana */\n        cursor: pointer;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n        display: none; /* Početno skriven, JS ga prikazuje */\n    }\n    #switch-camera-btn:active {\n        background-color: rgba(0, 0, 0, 0.7);\n    }\n\n    /* NOVI Stil za overlay s popisom kamera */\n    #camera-selection-overlay {\n        position: fixed; /* Zaljepljen za ekran */\n        top: 55px;       /* Ispod gumba (prilagodi ako treba) */\n        right: 10px;\n        background-color: white;\n        border: 1px solid #ccc;\n        border-radius: 5px;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n        z-index: 6;      /* Iznad gumba */\n        padding: 5px 0; /* Gore/dolje padding */\n        display: none;   /* Početno skriven */\n        max-height: 150px; /* Ograničenje visine ako ima puno kamera */\n        overflow-y: auto; /* Scroll ako treba */\n        min-width: 150px; /* Minimalna širina */\n    }\n    #camera-list {\n        list-style: none;\n        padding: 0;\n        margin: 0;\n    }\n    #camera-list li {\n        padding: 8px 12px;\n        cursor: pointer;\n        font-size: 0.9em;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n    }\n    #camera-list li:hover {\n        background-color: #f0f0f0;\n    }\n    #camera-list li.selected-camera { /* Opcionalno: za označavanje trenutne */\n        font-weight: bold;\n        background-color: #e0e0e0;\n    }\n\n    /* --- KRAJ NOVIH STILOVA --- */\n\n    @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }\n    @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }\n    @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }\n  </style>\n</head>\n<body class=\"scanner-view\">\n\n  <div id=\"counter-deactivated-indicator\" style=\"display: none;\">✔</div>\n  <div id=\"header\">QR RAČUNATOR</div>\n  <div id=\"scan-instruction\">Pozicioniraj qr kod unutar kvadrata kamere</div>\n  <div id=\"running-text-container\" style=\"display: none;\"><span></span></div>\n  <div id=\"share-prompt-overlay\" style=\"display: none;\">KLIKNI ZELENI GUMB<br>I PODIJELI RAČUNATOR<br>PORUKA ĆE NESTATI</div>\n\n  <div id=\"reader\"></div>\n\n  <!-- NOVI ELEMENTI za odabir kamere -->\n  <button id=\"switch-camera-btn\" style=\"display: none;\">🔄</button>\n  <div id=\"camera-selection-overlay\" style=\"display: none;\">\n      <ul id=\"camera-list\"></ul>\n  </div>\n  <!-- KRAJ NOVIH ELEMENATA -->\n\n  <div id=\"loaded-message\" style=\"display: none;\">UČITANO</div>\n  <div id=\"duplicate-warning\" style=\"display: none;\">TAJ RAČUN JE URAČUNAT</div>\n  <div id=\"total-container\"> <div id=\"total\">UKUPNO: 0.00 €</div> <button id=\"ocisti-button\" onclick=\"startOcistiConfirm()\" style=\"display: none;\">SPREMI<br>I OČISTI</button> </div>\n  <div id=\"session-name-container\"> <button id=\"add-name-btn\" onclick=\"startAddName()\">DODAJ NAZIV</button> <input type=\"text\" id=\"session-name-input\" placeholder=\"Unesi naziv sesije...\" maxlength=\"30\"> <span id=\"session-name-display\"> <span id=\"session-name-text\"></span> <span class=\"edit-icon\" onclick=\"startAddName()\">Uredi</span> </span> </div>\n  <div id=\"invoice-count\">0 RAČUNA</div>\n  <div id=\"history\" style=\"display: none;\"> <ul id=\"historyList\"></ul> </div>\n  <button class=\"red-btn\" id=\"remove-from-list-btn\" onclick=\"startRemoveFromList()\" style=\"display:none;\">Obriši iz liste</button>\n  <button id=\"history-toggle-btn\">POVIJEST</button>\n  <button id=\"share-button\" style=\"display: none;\">DIJELI RAČUNATOR</button>\n  <div id=\"delete-warning\" style=\"display: none;\"></div>\n\n  <div id=\"history-page\">\n      <div id=\"history-sticky-header\">\n          <div id=\"history-header\"> <button id=\"back-to-scanner-btn\">< NA SKENER</button> <h1>POVIJEST</h1> </div>\n          <div id=\"history-dynamic-header-content\"></div>\n      </div>\n      <div id=\"history-content\"></div>\n  </div>\n\n  <audio id=\"scan-sound\" src=\"https://actions.google.com/sounds/v1/cartoon/pop.ogg\" preload=\"auto\"></audio>\n  <audio id=\"click-sound\" src=\"https://cdn.jsdelivr.net/gh/himalayasingh/music-player-1@master/music/2.mp3\" preload=\"auto\"></audio>\n  <audio id=\"remove-sound\" src=\"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg\" preload=\"auto\"></audio>\n\n  <script>\n    // *** GLOBALNE VARIJABLE I KONSTANTE ***\n    const MAX_HISTORY_ITEMS = 500;\n    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';\n    const COUNTER_KEY = 'qrCalculatorCounter';\n    const COUNTER2_KEY = 'qrCalculatorCounter2';\n    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';\n    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IAj5E96SF2Jh2bGMMqcnA/exec';\n    const CAMERA_ID_KEY = 'qrCalculatorSelectedCameraID'; // NOVI KLJUČ\n\n    let ukupno = 0;\n    let povijest = [];\n    let removeConfirm = false;\n    let ocistiConfirm = false;\n    const removeBtnInitialText = 'Obriši iz liste';\n    const ocistiBtnInitialText = 'SPREMI<br>I OČISTI';\n    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';\n    let html5QrCodeInstance = null;\n    let isScannerActive = false;\n    let visibilityListenerAttached = false;\n    let currentSessionName = null;\n    let removeNameConfirm = false;\n    let currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);\n    let previousHistoryViewState = 'day-view';\n    let lastSearchTerm = '';\n    let brojac = 0;\n    let brojac2 = 0;\n    let tekstPoruka = \"\";\n    let isCounterDecrementActive = true;\n\n    // Ključevi za localStorage za UserID i nesačuvanu sesiju\n    const USER_ID_KEY = 'qrCalculatorUserID';\n    const FIRST_USE_KEY = 'qrCalculatorFirstUseTimestamp';\n    const UNSAVED_COUNT_KEY = 'qrCalculatorUnsavedCount';\n    const UNSAVED_AMOUNT_KEY = 'qrCalculatorUnsavedAmount';\n\n    // Placeholderi za ID i prvi timestamp\n    let currentUserID = null;\n    let firstUseTimestamp = null;\n\n    // DOM Elementi\n    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator;\n    // NOVI DOM Elementi za kameru\n    let switchCameraButton, cameraSelectionOverlay, cameraListUl;\n\n    // *** POMOĆNE FUNKCIJE ***\n    const parseTime = (timeStr) => { if (!timeStr || typeof timeStr !== 'string' || timeStr === '??:??' || timeStr.length !== 5 || timeStr[2] !== ':') return -1; const parts = timeStr.split(':'); const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return -1; return hours * 60 + minutes; };\n    function playSound(id) { const sound = document.getElementById(id); if (sound) { sound.pause(); sound.currentTime = 0; sound.play().catch(error => { if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') console.warn(`Zvuk \\\"${id}\\\" greška:`, error); }); } else console.warn(`Audio element \\\"${id}\\\" nije pronađen.`); }\n    function getISODateString(date) { if (!(date instanceof Date) || isNaN(date)) { console.error(\"getISODateString primio neispravan datum:\", date); return null; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }\n      function normalizeDateForSearch(dateString) {\n        if (!dateString || typeof dateString !== 'string') return null;\n        let cleanedString = dateString.trim().replace(/[.\\s]$/, '');\n        cleanedString = cleanedString.replace(/\\s/g, '');\n        const parts = cleanedString.split(/[.\\/-]/);\n        if (parts.length === 3) {\n            let [d, m, y] = parts.map(part => parseInt(part.trim(), 10));\n            if (isNaN(d) || isNaN(m) || isNaN(y) || d < 1 || d > 31 || m < 1 || m > 12 || y < 0) { return cleanedString.toLowerCase(); }\n            if (y >= 0 && y <= 99) { const currentYear = new Date().getFullYear(); const currentCentury = Math.floor(currentYear / 100) * 100; const yearWithCentury = currentCentury + y; y = yearWithCentury; if (y < 1970 || y > currentYear + 50) { return cleanedString.toLowerCase(); } } else if (y < 1970 || y > new Date().getFullYear() + 50) { return cleanedString.toLowerCase(); }\n             const finalYear = y; const finalMonth = String(m).padStart(2, '0'); const finalDay = String(d).padStart(2, '0'); const isoDate = `${finalYear}-${finalMonth}-${finalDay}`; return isoDate;\n        }\n        return cleanedString.toLowerCase();\n    }\n    function showTemporaryMessage(messageText, duration = 1500) { if (!loadedMsg) return; loadedMsg.innerText = messageText; loadedMsg.style.display = 'block'; loadedMsg.style.animation = 'none'; loadedMsg.offsetHeight; loadedMsg.style.animation = 'zoomFade 1s ease-out'; setTimeout(() => { if (loadedMsg && loadedMsg.innerText === messageText) { loadedMsg.style.display = 'none'; } }, duration); }\n\n    // Generisanje jednostavnog UUID-a\n    function generateUUID() {\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n      });\n    }\n\n    // Dobijanje ili kreiranje UserID i FirstUseTimestamp\n    function initializeUserTracking() {\n      currentUserID = localStorage.getItem(USER_ID_KEY);\n      firstUseTimestamp = localStorage.getItem(FIRST_USE_KEY);\n\n      if (!currentUserID) {\n        console.log(\"Generiram novi UserID i FirstUseTimestamp.\");\n        currentUserID = generateUUID();\n        firstUseTimestamp = new Date().toISOString();\n        try {\n          localStorage.setItem(USER_ID_KEY, currentUserID);\n          localStorage.setItem(FIRST_USE_KEY, firstUseTimestamp);\n        } catch (error) {\n          console.error(\"Greška spremanja UserID/FirstUse u localStorage:\", error);\n          currentUserID = 'localStorage_error_' + generateUUID(); // Fallback ID\n          firstUseTimestamp = new Date().toISOString();\n        }\n      }\n      console.log(\"UserID:\", currentUserID, \"FirstUse:\", firstUseTimestamp);\n    }\n\n    // Funkcija za slanje log podataka\n    async function sendLogData(eventData) {\n      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE')) {\n          console.warn(\"Logovanje onemogućeno: APPS_SCRIPT_URL nije postavljen.\");\n          return;\n      }\n      const dataToSend = {\n          ...eventData,\n          UserID: currentUserID,\n          FirstUseTimestamp: firstUseTimestamp,\n          Timestamp: new Date().toISOString(),\n          Counter1: brojac,\n          Counter2: brojac2,\n          Active: isCounterDecrementActive,\n          UserAgent: navigator.userAgent\n      };\n      console.log(`Pokušavam poslati log '${dataToSend.Event}':`, dataToSend);\n      try {\n          const response = await fetch(APPS_SCRIPT_URL, {\n              method: 'POST',\n              mode: 'no-cors',\n              cache: 'no-cache',\n              headers: {},\n              redirect: 'follow',\n              body: JSON.stringify(dataToSend)\n          });\n          console.log(`Log zahtev '${dataToSend.Event}' poslan (no-cors). Proverite Apps Script logove za potvrdu.`);\n      } catch (error) {\n          console.error(`Greška prilikom slanja loga '${dataToSend.Event}':`, error);\n      }\n    }\n\n    // *** FUNKCIJE ZA LOKALNU POHRANU ***\n    function saveFullHistoryToLocalStorage(fullHistory) { try { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(fullHistory)); console.log(\"Puna povijest spremljena.\"); } catch (error) { console.error(\"Greška spremanja:\", error); alert(\"Greška: Nije moguće spremiti povijest.\"); } }\n    function loadFullHistoryFromLocalStorage() { try { const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY); if (historyJson) { const loadedHistory = JSON.parse(historyJson); return loadedHistory.map(group => ({ timestamp: group.timestamp || Date.now(), lastQrTime: group.lastQrTime || '??:??', name: group.name || null, racuni: Array.isArray(group.racuni) ? group.racuni.map(item => ({ ...item, scanTimestamp: item.scanTimestamp || 0 })) : [] })); } return []; } catch (error) { console.error(\"Greška učitavanja:\", error); return []; } }\n    function loadCountersState() { const storedBrojac = localStorage.getItem(COUNTER_KEY); const storedBrojac2 = localStorage.getItem(COUNTER2_KEY); const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY); brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null; brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 10) : 0; isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true; if (isNaN(brojac)) brojac = null; if (isNaN(brojac2)) brojac2 = 0; console.log(\"Učitano stanje:\", { brojac, brojac2, isCounterDecrementActive }); updateDeactivatedIndicator(); }\n    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }\n    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }\n    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }\n\n    // *** FUNKCIJE ZA DOHVAĆANJE PODATAKA IZ SHEETA ***\n    async function fetchSheetData() { console.log(\"Pokušavam dohvatiti podatke iz Google Sheeta...\"); if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE')) { console.warn(\"URL Google Apps Scripta nije postavljen!\"); tekstPoruka = \"\"; initializeCounters(); updateRunningText(); return Promise.reject(new Error(\"URL nije postavljen\")); } try { const response = await fetch(APPS_SCRIPT_URL); if (!response.ok) { throw new Error(`HTTP greška ${response.status}`); } const data = await response.json(); console.log(\"Podaci dohvaćeni:\", data); let newPrag = data.pragBrojac !== undefined ? parseInt(data.pragBrojac, 10) : 0; if (isNaN(newPrag) || newPrag < 0) { newPrag = 0; } else if (newPrag > 500) { newPrag = 500; } brojac2 = newPrag; saveBrojac2(); tekstPoruka = data.trceciTekst || \"\"; initializeCounters(); updateRunningText(); return Promise.resolve(); } catch (error) { console.error(\"Greška pri dohvaćanju podataka iz Sheeta:\", error); tekstPoruka = \"\"; initializeCounters(); updateRunningText(); return Promise.reject(error); } }\n\n    // *** INICIJALIZACIJA BROJAČA ***\n    function initializeCounters() { console.log(\"Inicijalizacija brojača...\"); if (brojac === null) { console.log(\"Brojač 1 nije inicijaliziran, postavljanje na brojač 2.\"); brojac = brojac2; saveBrojac(); } else { console.log(\"Brojač 1 učitan s vrijednošću:\", brojac); } checkSharePrompt(); updateRunningTextVisibility(); }\n\n    // *** FUNKCIJE ZA AŽURIRANJE PRIKAZA ***\n    function checkOcistiButtonVisibility() { if (!ocistiButton) return; ocistiButton.style.display = (povijest.length > 0 && ukupno > 0) ? 'block' : 'none'; if ((povijest.length === 0 || ukupno <= 0) && ocistiConfirm) { resetOcistiMode(); } }\n    function updateDisplay() { if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} €`; const count = povijest.length; if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAČUN' : 'RAČUNA'}`; if (document.body.classList.contains('scanner-view')) { updateSmallHistoryList(); checkRemoveButtonVisibility(); handleInfoDeleteMessageVisibility(); checkOcistiButtonVisibility(); updateNameDisplay(); } };\n    function updateSmallHistoryList() { if (!historyList || !historyDiv) return; if (povijest.length > 0) { historyDiv.style.display = 'block'; historyList.innerHTML = ''; const recentHistory = povijest; recentHistory.forEach((item, index) => { const globalIndex = povijest.length - recentHistory.length + index; const listItem = document.createElement('li'); listItem.innerText = `${globalIndex + 1}. ${item.time} - ${item.amount.toFixed(2)} €`; historyList.appendChild(listItem); }); historyDiv.scrollTop = historyDiv.scrollHeight; } else { historyDiv.style.display = 'none'; } }\n    function checkRemoveButtonVisibility() { if (!removeButton) return; removeButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none'; if (povijest.length === 0 && !currentSessionName && (removeConfirm || removeNameConfirm)) resetRemoveMode(); }\n    function handleInfoDeleteMessageVisibility() { const isScannerView = document.body.classList.contains('scanner-view'); if (!deleteWarningDiv || !isScannerView) { if(deleteWarningDiv) deleteWarningDiv.style.display = 'none'; return; } let shouldDisplay = false, textToShow = '', modeClass = ''; if (removeConfirm && povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; textToShow = `OBRIŠI ${lastItem.time} = ${lastItem.amount.toFixed(2)} €?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (removeNameConfirm && currentSessionName) { textToShow = `OBRIŠI NAZIV \\\"${currentSessionName}\\\"?`; modeClass = 'delete-mode'; shouldDisplay = true; } else if (!removeConfirm && !removeNameConfirm && povijest.length > 0 && deleteWarningDiv.dataset.lastScanText) { textToShow = deleteWarningDiv.dataset.lastScanText; modeClass = 'info-mode'; shouldDisplay = true; } if (shouldDisplay) { deleteWarningDiv.innerText = textToShow; deleteWarningDiv.className = `delete-warning ${modeClass}`; deleteWarningDiv.style.display = 'block'; } else { deleteWarningDiv.style.display = 'none'; } }\n    function updateRunningText() { if (runningTextSpan) { runningTextSpan.textContent = tekstPoruka; } updateRunningTextVisibility(); }\n    function updateRunningTextVisibility() { const shouldShowText = tekstPoruka && (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') && document.body.classList.contains('scanner-view'); if (runningTextContainer) { runningTextContainer.style.display = shouldShowText ? 'block' : 'none'; if (shouldShowText && runningTextSpan) { runningTextSpan.style.animation = 'none'; runningTextSpan.offsetHeight; runningTextSpan.style.animation = ''; } } }\n    function checkSharePrompt() { const shouldShowPrompt = brojac === 0 && brojac2 > 0 && document.body.classList.contains('scanner-view'); if (sharePromptOverlay) { sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none'; updateRunningTextVisibility(); } }\n    function updateDeactivatedIndicator() { if (counterDeactivatedIndicator) { counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view')) ? 'block' : 'none'; } }\n\n    // *** FUNKCIJE ZA RESETIRANJE STANJA GUMBA ***\n    function resetRemoveMode() { if (!removeButton) return; removeButton.innerText = removeBtnInitialText; removeButton.classList.remove('yellow-btn'); removeButton.classList.add('red-btn'); removeConfirm = false; removeNameConfirm = false; if (deleteWarningDiv && deleteWarningDiv.dataset.beforeConfirmText) { deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText; delete deleteWarningDiv.dataset.beforeConfirmText; } else if (deleteWarningDiv && povijest.length === 0) { delete deleteWarningDiv.dataset.lastScanText; } handleInfoDeleteMessageVisibility(); checkRemoveButtonVisibility(); }\n    function resetOcistiMode() { if (!ocistiButton) return; ocistiButton.innerHTML = ocistiBtnInitialText; ocistiButton.classList.remove('confirm-mode'); ocistiConfirm = false; checkOcistiButtonVisibility(); }\n\n    // *** FUNKCIJE ZA NAZIV SESIJE ***\n    function startAddName() { if (!addNameBtn || !sessionNameInput || !sessionNameDisplay) return; playSound('click-sound'); addNameBtn.style.display = 'none'; sessionNameDisplay.style.display = 'none'; sessionNameInput.style.display = 'block'; sessionNameInput.value = currentSessionName || ''; sessionNameInput.focus(); sessionNameInput.select(); }\n\n    // Modificirana saveName funkcija\n    function saveName() {\n        if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return;\n        const inputText = sessionNameInput.value.trim();\n\n        if (inputText === \"##--##\") {\n            showTemporaryMessage(\"RJEŠENO\");\n            isCounterDecrementActive = false;\n            saveCounterActiveState();\n            updateDeactivatedIndicator();\n            sessionNameInput.value = '';\n            sessionNameInput.style.display = 'none';\n            updateNameDisplay();\n            checkRemoveButtonVisibility();\n            return;\n        } else if (inputText === \"##00##\") {\n            showTemporaryMessage(\"RESETIRANO\");\n            brojac = 0;\n            brojac2 = 0;\n            isCounterDecrementActive = true;\n            saveBrojac();\n            saveBrojac2();\n            saveCounterActiveState();\n            localStorage.removeItem(CAMERA_ID_KEY); // <<< RESETIRAJ KAMERU\n            updateDeactivatedIndicator();\n            sessionNameInput.value = '';\n            sessionNameInput.style.display = 'none';\n            updateNameDisplay();\n            checkSharePrompt();\n            updateRunningTextVisibility();\n            checkRemoveButtonVisibility();\n            // Opcionalno: restartaj skener da primijeni default kameru\n            if (document.body.classList.contains('scanner-view') && isScannerActive) {\n                console.log(\"Resetirano ##00##, restartam skener...\");\n                stopScanner().finally(initializeScanner);\n            }\n            return;\n        }\n        const newName = inputText;\n        currentSessionName = newName || null;\n        sessionNameInput.style.display = 'none';\n        updateNameDisplay();\n        checkRemoveButtonVisibility();\n    }\n\n    function updateNameDisplay() { if (!addNameBtn || !sessionNameDisplay || !sessionNameText) return; if (currentSessionName) { sessionNameText.textContent = currentSessionName; sessionNameDisplay.style.display = 'flex'; addNameBtn.style.display = 'none'; } else { sessionNameDisplay.style.display = 'none'; addNameBtn.style.display = 'block'; } }\n\n    // *** FUNKCIJE ZA UPRAVLJANJE TRENUTNOM SESIJOM SKENIRANJA ***\n    function startRemoveFromList() { if (!removeButton || !document.body.classList.contains('scanner-view')) return; if (removeNameConfirm) { playSound('remove-sound'); currentSessionName = null; resetRemoveMode(); updateNameDisplay(); return; } if (removeConfirm) { if (povijest.length > 0) { const removed = povijest.pop(); ukupno -= removed.amount; playSound('remove-sound'); if (povijest.length === 0 && currentSessionName) { removeButton.innerHTML = 'Obriši<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; handleInfoDeleteMessageVisibility(); } else { if (povijest.length > 0) { const lastItem = povijest[povijest.length - 1]; if (deleteWarningDiv) deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${lastItem.time} = ${lastItem.amount.toFixed(2)} €`; } else { if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText; } resetRemoveMode(); } } else { resetRemoveMode(); } updateDisplay(); return; } if (povijest.length > 0) { removeButton.innerText = 'Potvrdi'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = true; removeNameConfirm = false; playSound('click-sound'); if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmText = deleteWarningDiv.dataset.lastScanText; if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText; handleInfoDeleteMessageVisibility(); } else if (currentSessionName) { removeButton.innerHTML = 'Obriši<br>Naziv?'; removeButton.classList.remove('red-btn'); removeButton.classList.add('yellow-btn'); removeConfirm = false; removeNameConfirm = true; playSound('click-sound'); handleInfoDeleteMessageVisibility(); } }\n    function startOcistiConfirm() { if (!ocistiButton || !document.body.classList.contains('scanner-view')) return; if (!ocistiConfirm) { ocistiButton.innerHTML = ocistiConfirmText; ocistiButton.classList.add('confirm-mode'); ocistiConfirm = true; playSound('click-sound'); } else { ocistiTrenutnoSkeniranje(); resetOcistiMode(); } }\n\n    // Funkcija za spremanje sesije\n    function ocistiTrenutnoSkeniranje() {\n        if (povijest.length === 0 && !currentSessionName) return;\n        const vrijemeCiscenja = Date.now();\n        const sortiraniRacuniZaSpremanje = [...povijest].sort((a, b) => { const timeA = parseTime(a.time); const timeB = parseTime(b.time); if (timeA === -1 && timeB !== -1) return -1; if (timeA !== -1 && timeB === -1) return 1; if (timeA === -1 && timeB === -1) return (a.scanTimestamp || 0) - (b.scanTimestamp || 0); return timeA - timeB; });\n        let zadnjeValidnoVrijemeIzSortiraneListe = '??:??';\n        for (let i = sortiraniRacuniZaSpremanje.length - 1; i >= 0; i--) { if (sortiraniRacuniZaSpremanje[i].time && sortiraniRacuniZaSpremanje[i].time !== '??:??') { zadnjeValidnoVrijemeIzSortiraneListe = sortiraniRacuniZaSpremanje[i].time; break; } }\n        const novaGrupa = {\n            timestamp: vrijemeCiscenja,\n            lastQrTime: zadnjeValidnoVrijemeIzSortiraneListe,\n            name: currentSessionName || null,\n            racuni: sortiraniRacuniZaSpremanje\n        };\n        console.log(\"Spremam sesiju:\", novaGrupa);\n        let punaPovijest = loadFullHistoryFromLocalStorage();\n        punaPovijest.push(novaGrupa);\n        saveFullHistoryToLocalStorage(punaPovijest);\n        const sessionTotalAmount = novaGrupa.racuni.reduce((sum, item) => sum + item.amount, 0);\n        const sessionDetails = { sessionName: novaGrupa.name, invoiceCount: novaGrupa.racuni.length, totalAmount: sessionTotalAmount.toFixed(2), lastQrTime: novaGrupa.lastQrTime };\n        const eventData = { Event: 'session_saved', Details: JSON.stringify(sessionDetails) };\n        sendLogData(eventData);\n        try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); console.log(\"Obrisano nesačuvano stanje nakon spremanja sesije.\"); } catch (lsError) { console.error(\"Greška brisanja nesačuvanog stanja iz localStorage:\", lsError); }\n        povijest = [];\n        ukupno = 0;\n        currentSessionName = null;\n        if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; delete deleteWarningDiv.dataset.beforeConfirmText; }\n        resetRemoveMode();\n        resetOcistiMode();\n        updateDisplay();\n        console.log(\"Trenutna sesija spremljena i očišćena.\");\n        alert(\"Skeniranje spremljeno u povijest!\");\n    }\n\n    // *** OBRADA SKENIRANOG QR KODA ***\n    function handleScan(decodedText) {\n        if (removeNameConfirm) resetRemoveMode();\n        if (removeConfirm) resetRemoveMode();\n        if (ocistiConfirm) resetOcistiMode();\n        if (loadedMsg) loadedMsg.style.display = 'none';\n        if (duplicateWarning) duplicateWarning.style.display = 'none';\n\n        try {\n            const qrParts = decodedText.split('?');\n            if (qrParts.length < 2) throw new Error(\"Invalid QR format\");\n            const params = new URLSearchParams(qrParts[1]);\n            const iznosCentStr = params.get('izn');\n            const datv = params.get('datv');\n            if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) throw new Error(\"Invalid 'izn'\");\n\n            const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText);\n            let isDuplicateInRecentSaved = false;\n            const fullHistory = loadFullHistoryFromLocalStorage();\n            if (fullHistory.length > 0) { const thirtyDaysAgoTimestamp = Date.now() - (30 * 24 * 60 * 60 * 1000); const recentHistory = fullHistory.filter(grupa => grupa.timestamp >= thirtyDaysAgoTimestamp); isDuplicateInRecentSaved = recentHistory.some(grupa => grupa.racuni.some(item => item.qrCode === decodedText)); if(isDuplicateInRecentSaved) console.log(\"Duplikat pronađen u zadnjih 30 dana.\"); }\n\n            if (isDuplicateInCurrent || isDuplicateInRecentSaved) { console.warn(\"Duplikat pronađen:\", decodedText); if (duplicateWarning) { duplicateWarning.style.display = 'block'; duplicateWarning.style.animation = 'none'; duplicateWarning.offsetHeight; duplicateWarning.style.animation = 'pulse 0.5s ease-in-out 3 alternate'; setTimeout(() => { if (duplicateWarning) duplicateWarning.style.display = 'none'; }, 1500); } return; }\n\n            const iznosCenti = parseFloat(iznosCentStr);\n            const iznosEura = iznosCenti / 100;\n            let time = '??:??';\n            if (datv && typeof datv === 'string') { let hourStr = null, minuteStr = null; const underscoreIndex = datv.indexOf('_'); const tIndex = datv.toUpperCase().indexOf('T'); if (underscoreIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (tIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (datv.length === 12) { hourStr = datv.substring(8, 10); minuteStr = datv.substring(10, 12); } if (hourStr && minuteStr) { const hour = parseInt(hourStr, 10); const minute = parseInt(minuteStr, 10); if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; else time = '??:??'; } else time = '??:??'; }\n\n            if (instructionDiv) instructionDiv.style.display = 'none';\n            const newItem = { amount: iznosEura, qrCode: decodedText, time: time, datv: datv || '', scanTimestamp: Date.now() };\n            povijest.push(newItem);\n            ukupno += iznosEura;\n\n            if (isCounterDecrementActive && brojac > 0) { brojac--; console.log(\"Brojač smanjen na:\", brojac); saveBrojac(); checkSharePrompt(); } else { console.log(\"Brojač nije smanjen. Aktivno:\", isCounterDecrementActive, \"Vrijednost:\", brojac); }\n\n            try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error(\"Greška spremanja nesačuvanog stanja u localStorage:\", lsError); }\n\n            playSound('scan-sound');\n            updateDisplay();\n            showTemporaryMessage(\"UČITANO\", 1000);\n            if (deleteWarningDiv) { deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${newItem.time} = ${newItem.amount.toFixed(2)} €`; handleInfoDeleteMessageVisibility(); }\n        } catch (error) {\n            console.error(\"Greška obrade QR:\", error, decodedText);\n            if (loadedMsg) loadedMsg.style.display = 'none';\n            if (duplicateWarning) duplicateWarning.style.display = 'none';\n        }\n    }\n\n    // *** FUNKCIJE ZA UPRAVLJANJE SKENEROM ***\n\n    function isElementOrParentHidden(element) { if (!element) return true; while (element && element !== document.body) { if (window.getComputedStyle(element).display === 'none') return true; element = element.parentElement; } return false; }\n\n    // Modificirana initializeScanner funkcija\n    function initializeScanner() {\n        // *** IZMJENA: Kreiraj novu instancu SVAKI put ***\n        console.log(\"[InitializeScanner] Kreiram NOVU Html5Qrcode instancu.\");\n        html5QrCodeInstance = new Html5Qrcode(\"reader\");\n        // *** KRAJ IZMJENE ***\n\n        if (document.body.classList.contains('history-view') || isScannerActive) {\n             // Dodajemo provjeru: Ako smo u history view, apsolutno odustani.\n            // Ako je scannerActive, to bi značilo da je prethodni start uspio i još nije stopiran.\n            // U normalnom toku (npr. visibility change), ovo ne bi trebalo biti true jer stopScanner() postavlja isScannerActive = false.\n            // Ako se ovo dogodi, vjerojatno je bug u logici pozivanja.\n            console.warn(\"[InitializeScanner] Odustajem - History view ILI isScannerActive=true (Neočekivano?)\");\n            return;\n        }\n        console.log(\"[InitializeScanner] Pokrećem...\");\n        if (readerDiv) readerDiv.innerHTML = ''; // Očisti prethodne poruke/video\n        if (instructionDiv) instructionDiv.style.display = 'none'; // Sakrij uputu dok se ne pokrene\n        if (switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb dok kamera ne radi\n        if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay\n\n        checkSharePrompt();\n        updateRunningTextVisibility();\n        updateDeactivatedIndicator();\n\n        // html5QrCodeInstance je već kreiran na početku funkcije\n        const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };\n\n        Html5Qrcode.getCameras().then(devices => {\n            if (!devices || devices.length === 0) {\n                throw new Error(\"Nema kamera.\");\n            }\n            console.log(\"Dostupne kamere:\", devices);\n\n            let selectedCameraId = null;\n            const savedCameraId = localStorage.getItem(CAMERA_ID_KEY);\n\n            // 1. Provjeri spremljenu kameru\n            if (savedCameraId) {\n                const cameraExists = devices.some(d => d.id === savedCameraId);\n                if (cameraExists) {\n                    console.log(\"Koristim spremljenu kameru:\", savedCameraId);\n                    selectedCameraId = savedCameraId;\n                } else {\n                    console.warn(\"Spremljena kamera nije pronađena, brišem iz localStorage.\");\n                    localStorage.removeItem(CAMERA_ID_KEY);\n                }\n            }\n\n            // 2. Ako nema spremljene ILI spremljena ne postoji, koristi default logiku\n            if (!selectedCameraId) {\n                const rearCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('zadnja') || d.label.toLowerCase().includes('environment'));\n                if (rearCamera) {\n                    console.log(\"Koristim pronađenu stražnju kameru:\", rearCamera.id);\n                    selectedCameraId = rearCamera.id;\n                } else {\n                    // >>> POBOLJŠANJE ZA IPHONE: Ako nema 'back', a ima više kamera, probaj zadnju\n                    if (devices.length > 1 && navigator.userAgent.includes(\"iPhone\")) {\n                         console.log(\"iPhone detektiran, nema 'back' kamere, pokušavam zadnju s liste:\", devices[devices.length - 1].id);\n                         selectedCameraId = devices[devices.length - 1].id;\n                    } else {\n                        console.log(\"Nema stražnje kamere (ili nije iPhone s više kamera), koristim prvu dostupnu:\", devices[0].id);\n                        selectedCameraId = devices[0].id;\n                    }\n                    // <<< KRAJ POBOLJŠANJA\n                }\n            }\n\n            // Osiguraj da imamo *neki* ID\n            if (!selectedCameraId && devices.length > 0) {\n                 selectedCameraId = devices[0].id; // Fallback na prvu ako sve propadne\n            } else if (!selectedCameraId && devices.length === 0) { // Provjeri da li uopće ima kamera\n                 throw new Error(\"Nije bilo moguće odabrati kameru (nema dostupnih).\");\n            }\n\n            const finalCameraId = selectedCameraId; // Spremi finalni ID u lokalnu varijablu za closure\n\n            requestAnimationFrame(() => {\n                if (!html5QrCodeInstance || isScannerActive || document.body.classList.contains('history-view')) {\n                     console.log(\"[InitializeScanner][rAF] Odustajem (instance null, active, ili history view).\");\n                     return;\n                }\n                if (isElementOrParentHidden(readerDiv)) {\n                    if (readerDiv) readerDiv.innerHTML = '<div style=\\\"padding:20px; color: red;\\\">Greška: Reader skriven.</div>';\n                    console.error(\"[InitializeScanner][rAF] Reader je skriven.\");\n                    return;\n                }\n\n                console.log(`[InitializeScanner][rAF] Pokušavam startati kameru: ${finalCameraId}`);\n                // Koristi html5QrCodeInstance kreiran na početku ove funkcije\n                html5QrCodeInstance.start(\n                    finalCameraId,\n                    qrConfig,\n                    handleScan,\n                    (errorMessage) => { /* Ignoriraj non-matched QR */ }\n                ).then(() => {\n                    console.log(`>>> [InitializeScanner][rAF] start() OK za kameru: ${finalCameraId}`);\n                    isScannerActive = true;\n                    // Spremi ID *uspješno pokrenute* kamere\n                    localStorage.setItem(CAMERA_ID_KEY, finalCameraId);\n                    console.log(\"Spremljen ID aktivne kamere u localStorage:\", finalCameraId);\n\n                    // Pokaži gumb za promjenu tek kad je kamera uspješno startala\n                    if (switchCameraButton && devices.length > 1) { // Pokaži samo ako ima više kamera\n                         switchCameraButton.style.display = 'block';\n                    }\n\n                    setTimeout(() => {\n                        console.log(\"[InitializeScanner][rAF][then-delay] Prikazujem uputu i vežem listener.\");\n                        if (instructionDiv && document.body.classList.contains('scanner-view')) {\n                            instructionDiv.style.display = 'block';\n                        }\n                        if (!visibilityListenerAttached) {\n                            attachVisibilityListener();\n                        }\n                    }, 100);\n                }).catch(err => {\n                    console.error(`>>> [InitializeScanner][rAF] start() FAILED za kameru ${finalCameraId}:`, err);\n                    isScannerActive = false; // Osiguraj da je false\n                    // Ne nulliraj html5QrCodeInstance ovdje, nova instanca se kreira na idućem pozivu\n                    if (readerDiv) readerDiv.innerHTML = `<div style=\\\"padding: 20px; color: red;\\\">Greška startanja kamere (${err.name || err}). Pokušajte odabrati drugu.</div>`;\n                    if (instructionDiv) instructionDiv.style.display = 'none';\n                     if (switchCameraButton && devices.length > 1) { // Pokaži gumb i ako faila, da mogu probati drugu\n                         switchCameraButton.style.display = 'block';\n                    }\n                    // Ako start faila, možda obrisati spremljeni ID da proba default idući put?\n                     // localStorage.removeItem(CAMERA_ID_KEY);\n                });\n            });\n        }).catch(err => {\n            console.error(\"Greška dohvaćanja kamera ili inicijalizacije:\", err);\n            isScannerActive = false;\n             // Ne nulliraj html5QrCodeInstance ovdje\n            if (readerDiv) readerDiv.innerHTML = `<div style=\\\"padding: 20px; color: red;\\\">Greška pristupa kamerama (${err.name || err}). Provjerite dozvole.</div>`;\n            if (instructionDiv) instructionDiv.style.display = 'none';\n            if (switchCameraButton) switchCameraButton.style.display = 'none'; // Nema kamera, nema gumba\n        });\n    };\n\n    // Modificirana stopScanner funkcija\n    function stopScanner() {\n        if(runningTextContainer) runningTextContainer.style.display = 'none';\n        if(sharePromptOverlay) sharePromptOverlay.style.display = 'none';\n        if(counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';\n        if(switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb kad se skener gasi\n        if(cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij i overlay\n\n        const instanceToStop = html5QrCodeInstance;\n        // Provjeri postoji li instanca i je li aktivna (ili je barem bila prije ovog poziva)\n        if (instanceToStop && isScannerActive) {\n            console.log(\"Zaustavljam skener...\");\n            isScannerActive = false; // Postavi na false ODMAH\n            if (instructionDiv) instructionDiv.style.display = 'none';\n\n            // Vrati promise iz stop() metode\n            return instanceToStop.stop().then(() => {\n                console.log(\"Skener uspješno zaustavljen (iz stop().then).\");\n                 if (readerDiv) readerDiv.innerHTML = ''; // Očisti prikaz nakon uspješnog stop\n                 // html5QrCodeInstance = null; // Ne nulliraj ovdje, nova se kreira u initializeScanner\n            }).catch(err => {\n                console.warn(\"Greška pri zaustavljanju skenera (iz stop().catch):\", err);\n                // Greška se može dogoditi ako je skener već bio zaustavljen ili u nekom čudnom stanju\n                // Svejedno očisti prikaz i smatraj neaktivnim\n                if (readerDiv) readerDiv.innerHTML = '';\n                isScannerActive = false; // Osiguraj da je false\n                 // html5QrCodeInstance = null;\n            });\n        } else {\n             console.log(\"Skener nije aktivan ili instanca ne postoji, nema potrebe za zaustavljanjem.\");\n             isScannerActive = false; // Osiguraj da je false\n             if (readerDiv) readerDiv.innerHTML = ''; // Očisti za svaki slučaj\n             // html5QrCodeInstance = null;\n             return Promise.resolve(); // Vrati resolved promise jer nema što raditi\n        }\n    };\n\n    // *** NOVE FUNKCIJE za odabir kamere ***\n\n    function toggleCameraSelection() {\n         playSound('click-sound');\n         if (!cameraSelectionOverlay || !cameraListUl || !switchCameraButton) return;\n\n         // Ako je overlay vidljiv, sakrij ga\n         if (cameraSelectionOverlay.style.display === 'block') {\n             cameraSelectionOverlay.style.display = 'none';\n             return;\n         }\n\n         // Inače, dohvati kamere i prikaži ih\n         Html5Qrcode.getCameras().then(devices => {\n             if (!devices || devices.length === 0) {\n                 showTemporaryMessage(\"Nema dostupnih kamera.\", 1500);\n                 return;\n             }\n\n             cameraListUl.innerHTML = ''; // Očisti prethodni popis\n             const currentSavedCameraId = localStorage.getItem(CAMERA_ID_KEY); // Dohvati zadnje SPREMLJENI ID\n\n             devices.forEach(device => {\n                 const listItem = document.createElement('li');\n                 // Prikaz labela može biti dug, koristi textContent\n                 listItem.textContent = device.label || `Kamera ${device.id.substring(0, 8)}...`;\n                 listItem.dataset.cameraId = device.id;\n                 listItem.title = device.label || device.id; // Puni label u tooltipu\n\n                 // Opcionalno: Oznaci trenutno SPREMLJENU (ne nužno aktivnu)\n                 if (device.id === currentSavedCameraId) {\n                     listItem.classList.add('selected-camera');\n                 }\n\n                 // Kloniraj node da se ukloni stari listener ako postoji\n                 const newListItem = listItem.cloneNode(true);\n                 newListItem.addEventListener('click', () => {\n                     switchCamera(device.id, device.label);\n                 });\n                 cameraListUl.appendChild(newListItem);\n             });\n\n             cameraSelectionOverlay.style.display = 'block'; // Pokaži overlay\n\n         }).catch(err => {\n             console.error(\"Greška dohvaćanja kamera za popis:\", err);\n             showTemporaryMessage(\"Greška pri listanju kamera.\", 1500);\n             cameraSelectionOverlay.style.display = 'none'; // Sakrij ako je greška\n         });\n    }\n\n    function switchCamera(selectedCameraId, cameraLabel) {\n        playSound('click-sound');\n        console.log(`Odabrana kamera: ID=${selectedCameraId}, Label=${cameraLabel || 'N/A'}`);\n\n        if (cameraSelectionOverlay) {\n             cameraSelectionOverlay.style.display = 'none'; // Sakrij popis\n        }\n\n        // *** IZMJENA: Uklonjena provjera da li je ista kamera već aktivna ***\n        // const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY);\n        // if(selectedCameraId === currentActiveCameraId && isScannerActive) {\n        //     console.log(\"Odabrana je već aktivna kamera, nema potrebe za restartom.\");\n        //     return;\n        // }\n        // *** KRAJ IZMJENE ***\n\n        // Spremi novi odabir ODMAH, initializeScanner će ga koristiti\n        localStorage.setItem(CAMERA_ID_KEY, selectedCameraId);\n\n        // Restartaj skener\n        showTemporaryMessage(`Mijenjam na: ${cameraLabel || 'Kamera'}...`, 1000);\n        stopScanner().finally(() => { // Koristi finally da se pokrene i ako stop() ima grešku\n             console.log(\"Nakon stopScanner, pozivam initializeScanner za novu kameru.\");\n             // Čekaj kratko prije inicijalizacije da se resursi sigurno oslobode?\n             // Možda nije potrebno zbog kreiranja nove instance.\n             // setTimeout(initializeScanner, 50);\n             initializeScanner(); // Ponovno inicijaliziraj (koristit će novi spremljeni ID i kreirati novu instancu)\n        });\n    }\n\n    // *** FUNKCIJE ZA PROMJENU PRIKAZA (VIEW) ***\n    // Modificirana switchToScannerView\n    function switchToScannerView() {\n        console.log(\"switchToScannerView: Pokrenuto.\");\n        if (document.body.classList.contains('scanner-view')) {\n            console.log(\"switchToScannerView: Već u scanner view.\");\n            if (!isScannerActive) {\n                console.log(\"switchToScannerView: Skener nije aktivan, inicijaliziram...\");\n                initializeScanner();\n            } else {\n                 console.log(\"switchToScannerView: Skener je već aktivan, samo ažuriram UI.\");\n                 checkSharePrompt();\n                 updateRunningTextVisibility();\n                 updateDeactivatedIndicator();\n                 // Pokaži gumb ako treba\n                 Html5Qrcode.getCameras().then(devices => {\n                     if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                        switchCameraButton.style.display = 'block';\n                     }\n                 }).catch(()=>{/* ignore error */});\n            }\n            return;\n        }\n\n        // Resetiraj confirmation gumbe iz history view-a\n        const clearBtn = document.getElementById('clear-history-btn'); if (clearBtn && clearBtn.dataset.confirming === 'true') { clearBtn.innerText = \"IZBRIŠI SVU POVIJEST\"; clearBtn.classList.remove('confirm-mode'); clearBtn.dataset.confirming = 'false'; }\n        const deleteSessionBtn = document.getElementById('delete-session-btn'); if (deleteSessionBtn && deleteSessionBtn.dataset.confirming === 'true') { deleteSessionBtn.innerText = \"IZBRIŠI OVAJ SKEN\"; deleteSessionBtn.classList.remove('confirm-mode'); deleteSessionBtn.dataset.confirming = 'false'; }\n        const clearDayBtn = document.getElementById('clear-day-btn'); if (clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = \"IZBRIŠI OVAJ DAN\"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; }\n        if (historyDynamicHeaderContentDiv) historyDynamicHeaderContentDiv.innerHTML = ''; // Očisti header povijesti\n\n        document.body.classList.remove('history-view');\n        document.body.classList.add('scanner-view');\n        document.body.style.backgroundColor = '#f4f4f4';\n\n        currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);\n        previousHistoryViewState = 'day-view';\n\n        updateDisplay(); // Ažuriraj prikaz (ukupno, broj računa itd.)\n\n        // Pokreni inicijalizaciju skenera NAKON promjene view-a\n        requestAnimationFrame(initializeScanner);\n\n        // Attach visibility listener ako već nije\n        if (!visibilityListenerAttached) {\n             attachVisibilityListener();\n        }\n\n        // Ažuriraj UI elemente specifične za skener nakon kratke pauze\n        setTimeout(() => {\n            checkSharePrompt();\n            updateRunningTextVisibility();\n            updateDeactivatedIndicator();\n             // Pokaži gumb ako treba - provjera opet za svaki slučaj\n             Html5Qrcode.getCameras().then(devices => {\n                 if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                    switchCameraButton.style.display = 'block';\n                 }\n             }).catch(()=>{});\n        }, 50);\n\n        console.log(\"switchToScannerView: Završeno.\");\n    }\n\n    // Modificirana switchToHistoryView\n    function switchToHistoryView() {\n        console.log(\"switchToHistoryView: Pokrenuto.\");\n        if (document.body.classList.contains('history-view')) {\n            console.log(\"switchToHistoryView: Već u history view, samo renderiram.\");\n            renderHistoryView(currentlyViewedDate);\n            return;\n        }\n\n        if (removeConfirm || removeNameConfirm) resetRemoveMode();\n        if (ocistiConfirm) resetOcistiMode();\n\n        console.log(\"switchToHistoryView: Zaustavljam skener...\");\n        stopScanner().finally(() => {\n            console.log(\"switchToHistoryView: Skener zaustavljen (ili nije bio aktivan). Mijenjam klase i renderiram.\");\n            document.body.classList.remove('scanner-view');\n            document.body.classList.add('history-view');\n            document.body.style.backgroundColor = 'white';\n\n            // Sakrij elemente specifične za skener\n            if (counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';\n            if (switchCameraButton) switchCameraButton.style.display = 'none';\n            if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';\n            if (instructionDiv) instructionDiv.style.display = 'none';\n            if (runningTextContainer) runningTextContainer.style.display = 'none';\n            if (sharePromptOverlay) sharePromptOverlay.style.display = 'none';\n\n            renderHistoryView(currentlyViewedDate); // Renderiraj prikaz povijesti\n        });\n    }\n\n    // *** FUNKCIJE ZA RENDERIRANJE HISTORY VIEWA ***\n    // (Ove funkcije ostaju uglavnom nepromijenjene - samo brisanje localStorage kamere)\n    function clearDynamicHeaderContent() { if (historyDynamicHeaderContentDiv) { historyDynamicHeaderContentDiv.innerHTML = ''; } }\n    function renderHistoryView(dateToShow = currentlyViewedDate) { console.log(\"renderHistoryView: Pokrenuto za datum:\", dateToShow); previousHistoryViewState = 'day-view'; currentlyViewedDate = new Date(dateToShow); currentlyViewedDate.setHours(0,0,0,0); const punaPovijest = loadFullHistoryFromLocalStorage(); console.log(\"renderHistoryView: Učitana povijest iz localStorage:\", punaPovijest); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) { console.error(\"renderHistoryView: Kritični DOM elementi nedostaju!\"); return; } clearDynamicHeaderContent(); const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: 'numeric' }; let imeDana = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDatuma); const startOfDay = new Date(currentlyViewedDate); const endOfDay = new Date(currentlyViewedDate); endOfDay.setHours(23, 59, 59, 999); const sesijeZaPrikazaniDan = punaPovijest.filter(grupa => { const grupaDate = new Date(grupa.timestamp); return grupaDate >= startOfDay && grupaDate <= endOfDay; }); sesijeZaPrikazaniDan.sort((a, b) => a.timestamp - b.timestamp); const brojRacunaOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); const dateInfoDiv = document.createElement('div'); dateInfoDiv.id = 'history-date-info'; const currentViewDateStr = getISODateString(currentlyViewedDate); const hasOtherDays = punaPovijest.some(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr && grupaDateStr !== currentViewDateStr; }); dateInfoDiv.innerHTML = `<span style=\\\"font-weight: bold;\\\">${imeDana}, ${formatiraniDatum}</span> <button id=\\\"history-view-toggle-btn\\\" style=\\\"background-color: yellow; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold;\\\" ${!hasOtherDays ? 'disabled' : ''}>OSTALI DANI ></button>`; historyDynamicHeaderContentDiv.appendChild(dateInfoDiv); const historyViewToggleButton = dateInfoDiv.querySelector('#history-view-toggle-btn'); if (historyViewToggleButton) { const newHistoryViewToggleButton = historyViewToggleButton.cloneNode(true); historyViewToggleButton.parentNode.replaceChild(newHistoryViewToggleButton, historyViewToggleButton); if (!newHistoryViewToggleButton.disabled) { newHistoryViewToggleButton.addEventListener('click', () => { playSound('click-sound'); renderAllDaysView(); }); newHistoryViewToggleButton.style.cursor = 'pointer'; newHistoryViewToggleButton.style.opacity = '1'; } else { newHistoryViewToggleButton.style.cssText += ';cursor: not-allowed; opacity: 0.7;'; } } const summaryInfoDiv = document.createElement('div'); summaryInfoDiv.id = 'history-summary-info'; summaryInfoDiv.innerHTML = `<span>RAČUNA: <span style=\\\"font-weight: bold;\\\">${brojRacunaOvajDan}</span></span> <span style=\\\"font-weight: bold;\\\">UKUPNO: ${ukupanIznosOvajDan.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(summaryInfoDiv); const uputaHtml = `<p id=\\\"history-select-group-text\\\" style=\\\"text-align: center; color: black; font-weight: bold; font-style: normal; margin-bottom: 1em; margin-top: 0.5em; font-size: 0.9em;\\\">IZABERI SKEN ILI <button id=\\\"start-search-btn\\\" style=\\\"background:none; border:none; padding:0; color:blue; text-decoration:underline; cursor:pointer; font-size:inherit; font-weight:bold;\\\">(TRAŽI)</button></p>`; let sesijeHtml = '<ul id=\\\"scan-group-list\\\" style=\\\"list-style: none; padding: 0; margin: 0;\\\">'; if (sesijeZaPrikazaniDan.length === 0) { sesijeHtml += '<li style=\\\"text-align:center; color: grey; border: none; cursor: default; padding: 1em 0;\\\"><i>Nema spremljenih skenova za ovaj dan.</i></li>'; } else { sesijeZaPrikazaniDan.forEach((sesija, index) => { sesijeHtml += generirajHtmlZaSpremljenuGrupu(sesija, index + 1); }); } sesijeHtml += '</ul>'; historyContentDiv.innerHTML = uputaHtml + sesijeHtml; if (sesijeZaPrikazaniDan.length > 0) { const clearDayButton = document.createElement('button'); clearDayButton.id = 'clear-day-btn'; clearDayButton.className = 'red-btn'; clearDayButton.style.margin = '2em auto 1em auto'; clearDayButton.style.display = 'block'; clearDayButton.innerText = 'IZBRIŠI OVAJ DAN'; historyContentDiv.appendChild(clearDayButton); clearDayButton.dataset.confirming = 'false'; const newClearDayBtn = clearDayButton.cloneNode(true); clearDayButton.parentNode.replaceChild(newClearDayBtn, clearDayButton); newClearDayBtn.addEventListener('click', () => { if (newClearDayBtn.disabled) return; playSound('click-sound'); if (newClearDayBtn.dataset.confirming === 'false') { newClearDayBtn.innerText = \\\"Potvrdi Brisanje Dana?\\\"; newClearDayBtn.classList.add('confirm-mode'); newClearDayBtn.dataset.confirming = 'true'; } else { deleteScansForDay(currentlyViewedDate); } }); const dayParentPageClickHandler = (e) => { const currentClearDayBtn = document.getElementById('clear-day-btn'); if (currentClearDayBtn && currentClearDayBtn.dataset.confirming === 'true' && !currentClearDayBtn.contains(e.target)) { currentClearDayBtn.innerText = \\\"IZBRIŠI OVAJ DAN\\\"; currentClearDayBtn.classList.remove('confirm-mode'); currentClearDayBtn.dataset.confirming = 'false'; } }; historyPageDiv.removeEventListener('click', dayParentPageClickHandler, true); historyPageDiv.addEventListener('click', dayParentPageClickHandler, true); } const groupList = document.getElementById('scan-group-list'); if (groupList) { const newGroupList = groupList.cloneNode(true); groupList.parentNode.replaceChild(newGroupList, groupList); newGroupList.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); previousHistoryViewState = 'day-view'; renderGroupDetailView(selectedGroup); } else { console.error(\\\"Nije pronađena grupa:\\\", timestamp); alert(\\\"Greška otvaranja detalja.\\\"); } } }); } const searchBtn = document.getElementById('start-search-btn'); if(searchBtn) { const newSearchBtn = searchBtn.cloneNode(true); searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn); newSearchBtn.addEventListener('click', startSearch); } console.log(\"renderHistoryView: Renderiranje završeno.\"); }\n    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) { const vrijemeSpremanja = new Date(grupa.timestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class=\\\"session-name-history\\\">${grupa.name} U ${vrijemeSpremanjaFormatirano}</span>` : `<span class=\\\"scan-time-history\\\">SKEN U ${vrijemeSpremanjaFormatirano}</span>`; return `<li data-timestamp=\\\"${grupa.timestamp}\\\" style=\\\"background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease;\\\"><span style=\\\"flex-shrink: 0; display: inline-flex; align-items: center; min-width: 0; flex-grow: 1; overflow: hidden;\\\"><span style=\\\"margin-right: 5px; flex-shrink: 0;\\\">${redniBroj}.</span> ${prikazNaziva}</span><span class=\\\"scan-group-last-qr-time\\\" style=\\\"flex-shrink: 0; margin-left: 15px;\\\">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style=\\\"font-weight: bold; margin-left: auto; padding-left: 10px; flex-shrink: 0;\\\">${ukupnoGrupa.toFixed(2)} €</span></li>`; }\n    function renderGroupDetailView(groupData) { if (!historyContentDiv || !groupData || !groupData.racuni || !historyDynamicHeaderContentDiv) { console.error(\"Nedostaju podaci za detalje.\"); renderHistoryView(); return; } clearDynamicHeaderContent(); const sessionTimestamp = groupData.timestamp; const vrijemeSpremanja = new Date(sessionTimestamp); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = groupData.racuni.reduce((sum, item) => sum + item.amount, 0); const brojRacunaSesije = groupData.racuni.length; const naslovDetalja = groupData.name ? groupData.name : `SKEN U ${vrijemeSpremanjaFormatirano}`; const detailHeaderDiv = document.createElement('div'); detailHeaderDiv.id = 'detail-header-info'; detailHeaderDiv.innerHTML = `<button id=\\\"back-to-group-list-btn\\\" style=\\\"background-color: #6c757d; color: white; padding: 0.4em 0.8em; font-size: 0.9em; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;\\\">< Lista</button><h3 style=\\\"margin: 0; text-align: center; flex-grow: 1; font-size: 1.1em;\\\">${naslovDetalja}</h3><span style=\\\"font-weight: bold; font-size: 1.1em; flex-shrink: 0; padding-left: 5px;\\\">${ukupnoGrupa.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(detailHeaderDiv); const detailSummaryDiv = document.createElement('div'); detailSummaryDiv.id = 'detail-summary-info'; detailSummaryDiv.innerHTML = `<span>RAČUNA: <span style=\\\"font-weight: bold;\\\">${brojRacunaSesije}</span></span><span style=\\\"font-weight: bold;\\\">UKUPNO: ${ukupnoGrupa.toFixed(2)} €</span>`; historyDynamicHeaderContentDiv.appendChild(detailSummaryDiv); let detailListHtml = '<ul id=\\\"detail-scan-list\\\">'; const racuniZaPrikaz = groupData.racuni; racuniZaPrikaz.forEach((racun, index) => { const vrijemeRacuna = racun.time !== '??:??' ? `${racun.time}` : 'Vrijeme?'; detailListHtml += `<li><span style=\\\"color: #333; min-width: 80px;\\\">${index + 1}. ${vrijemeRacuna}</span><span style=\\\"font-weight: bold; margin-left: auto;\\\">${racun.amount.toFixed(2)} €</span></li>`; }); detailListHtml += `</ul>`; detailListHtml += `<button id=\\\"delete-session-btn\\\" class=\\\"red-btn\\\" data-timestamp=\\\"${sessionTimestamp}\\\" style=\\\"margin: 2em auto 1em auto; display: block;\\\">IZBRIŠI OVAJ SKEN</button>`; historyContentDiv.innerHTML = detailListHtml; const backBtn = document.getElementById('back-to-group-list-btn'); if (backBtn) { const newBackBtn = backBtn.cloneNode(true); backBtn.parentNode.replaceChild(newBackBtn, backBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); console.log(\"Vraćanje iz detalja, prethodno stanje:\", previousHistoryViewState); switch (previousHistoryViewState) { case 'day-search-results': renderHistoryView(currentlyViewedDate); startSearch(); const searchInputDay = document.getElementById('search-input'); if(searchInputDay) searchInputDay.value = lastSearchTerm; executeSearch(); break; case 'all-days-search-results': renderAllDaysView(); const searchInputAll = document.getElementById('all-days-search-input'); if(searchInputAll) searchInputAll.value = lastSearchTerm; executeAllDaysSearch(); break; case 'day-view': default: renderHistoryView(currentlyViewedDate); break; } }); } const deleteSessionBtn = document.getElementById('delete-session-btn'); if(deleteSessionBtn) { deleteSessionBtn.dataset.confirming = 'false'; const newDeleteSessionBtn = deleteSessionBtn.cloneNode(true); deleteSessionBtn.parentNode.replaceChild(newDeleteSessionBtn, deleteSessionBtn); newDeleteSessionBtn.addEventListener('click', () => { playSound('click-sound'); if (newDeleteSessionBtn.dataset.confirming === 'false') { newDeleteSessionBtn.innerText = \\\"Potvrdi brisanje?\\\"; newDeleteSessionBtn.classList.add('confirm-mode'); newDeleteSessionBtn.dataset.confirming = 'true'; } else { const timestampToDelete = newDeleteSessionBtn.dataset.timestamp; deleteSpecificSession(timestampToDelete); } }); const detailClickHandler = (e) => { const currentDeleteBtn = document.getElementById('delete-session-btn'); if (currentDeleteBtn && currentDeleteBtn.dataset.confirming === 'true' && !currentDeleteBtn.contains(e.target)) { currentDeleteBtn.innerText = \\\"IZBRIŠI OVAJ SKEN\\\"; currentDeleteBtn.classList.remove('confirm-mode'); currentDeleteBtn.dataset.confirming = 'false'; historyPageDiv.removeEventListener('click', detailClickHandler, true); } }; historyPageDiv.removeEventListener('click', detailClickHandler, true); historyPageDiv.addEventListener('click', detailClickHandler, true); } else { console.warn(\"Gumb #delete-session-btn nije pronađen.\"); } }\n    function deleteSpecificSession(timestampString) { if (!timestampString) { console.error(\"Pokušaj brisanja bez timestampa.\"); alert(\"Greška: Nije moguće identificirati sken.\"); return; } const timestampToDelete = Number(timestampString); if (isNaN(timestampToDelete)) { console.error(\"Nevažeći timestamp za brisanje:\", timestampString); alert(\"Greška: Nevažeći identifikator skena.\"); const deleteBtn = document.getElementById('delete-session-btn'); if(deleteBtn && deleteBtn.dataset.confirming === 'true') { deleteBtn.innerText = \\\"IZBRIŠI OVAJ SKEN\\\"; deleteBtn.classList.remove('confirm-mode'); deleteBtn.dataset.confirming = 'false'; } return; } console.log(\"Brisanje sesije s timestampom:\", timestampToDelete); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const filtriranaPovijest = punaPovijest.filter(grupa => { if (typeof grupa.timestamp !== 'number' || isNaN(grupa.timestamp)) { return true; } return grupa.timestamp !== timestampToDelete; }); const newLength = filtriranaPovijest.length; console.log(`Originalna dužina: ${originalLength}, Nova dužina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); alert(\"Sken obrisan iz povijesti.\"); renderHistoryView(currentlyViewedDate); } else { console.warn(\"Sesija za brisanje nije pronađena:\", timestampToDelete); alert(\"Greška: Sken nije pronađen.\"); const deleteBtn = document.getElementById('delete-session-btn'); if(deleteBtn && deleteBtn.dataset.confirming === 'true') { deleteBtn.innerText = \\\"IZBRIŠI OVAJ SKEN\\\"; deleteBtn.classList.remove('confirm-mode'); deleteBtn.dataset.confirming = 'false'; } } }\n    function renderAllDaysView() { previousHistoryViewState = 'all-days-view'; const punaPovijest = loadFullHistoryFromLocalStorage(); if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) return; clearDynamicHeaderContent(); const searchBarHtml = `<div id=\\\"all-days-search-container\\\"><div style=\\\"display: flex; gap: 5px;\\\"><input type=\\\"text\\\" id=\\\"all-days-search-input\\\" placeholder=\\\"UPIŠI ZA PRETRAGU...\\\" style=\\\"flex-grow: 1; padding: 0.5em; font-size: 0.9em;\\\"><button id=\\\"execute-all-days-search-btn\\\" style=\\\"padding: 0.5em 0.6em; font-size: 0.9em;\\\">Traži</button><button id=\\\"close-all-days-search-btn\\\" style=\\\"padding: 0.5em 0.6em; background-color: #ccc; font-size: 0.9em;\\\">Svi Dani</button></div></div><div id=\\\"all-days-summary-info\\\" style=\\\"display: none;\\\"></div>`; historyDynamicHeaderContentDiv.innerHTML = searchBarHtml; const resultsPlaceholderHtml = `<div id=\\\"search-results-all-days\\\"><p style=\\\"text-align:center; color: grey; padding: 1em 0;\\\"><i>Unesite pojam za pretragu ili kliknite \\\"Svi Dani\\\" za prikaz liste.</i></p></div>`; historyContentDiv.innerHTML = resultsPlaceholderHtml; const searchInput = document.getElementById('all-days-search-input'); const executeBtn = document.getElementById('execute-all-days-search-btn'); const closeBtn = document.getElementById('close-all-days-search-btn'); const searchResultsContainer = document.getElementById('search-results-all-days'); const allDaysSummaryContainer = document.getElementById('all-days-summary-info'); const sessionsByDate = punaPovijest.reduce((acc, session) => { const dateStr = getISODateString(new Date(session.timestamp)); if (!dateStr) return acc; if (!acc[dateStr]) { acc[dateStr] = { date: new Date(session.timestamp), sessions: [], totalAmount: 0, totalCount: 0 }; acc[dateStr].date.setHours(0, 0, 0, 0); } acc[dateStr].sessions.push(session); acc[dateStr].totalAmount += session.racuni.reduce((sum, item) => sum + item.amount, 0); acc[dateStr].totalCount += session.racuni.length; return acc; }, {}); const sortedDays = Object.values(sessionsByDate).sort((a, b) => b.date - a.date); if(searchInput && executeBtn && closeBtn && searchResultsContainer && allDaysSummaryContainer) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeAllDaysSearch(); }); const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', () => { executeAllDaysSearch(); }); const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); newSearchInput.value = ''; renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAČUNA: <span style=\\\"font-weight: bold;\\\">${totalCountAll}</span></span><span style=\\\"font-weight: bold;\\\">UKUPNO: ${totalAmountAll.toFixed(2)} €</span>`; allDaysSummaryContainer.style.display = punaPovijest.length > 0 ? 'flex' : 'none'; }); } else { console.error(\"Nisu pronađeni svi elementi za pretragu u All Days View.\"); } if (punaPovijest.length > 0) { const backButtonHtml = `<button id=\\\"back-to-current-day-btn\\\" style=\\\"background-color: #6c757d; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;\\\">< NATRAG</button>`; const clearAllButtonHtml = `<button id=\\\"clear-history-btn\\\" class=\\\"red-btn\\\" style=\\\"padding: 0.5em 1em; font-size: 1em;\\\">IZBRIŠI SVU POVIJEST</button>`; const buttonsHtml = `<div style=\\\"text-align: center; margin-top: 1.5em; margin-bottom: 1em;\\\">${backButtonHtml}${clearAllButtonHtml}</div>`; if (!document.getElementById('back-to-current-day-btn') && !document.getElementById('clear-history-btn')) { historyContentDiv.insertAdjacentHTML('beforeend', buttonsHtml); } const backToDayBtn = document.getElementById('back-to-current-day-btn'); if (backToDayBtn) { const newBackBtn = backToDayBtn.cloneNode(true); backToDayBtn.parentNode.replaceChild(newBackBtn, backToDayBtn); newBackBtn.addEventListener('click', () => { playSound('click-sound'); renderHistoryView(currentlyViewedDate); }); } const clearAllBtn = document.getElementById('clear-history-btn'); if (clearAllBtn) { if (punaPovijest.length === 0) { clearAllBtn.disabled = true; clearAllBtn.style.opacity = '0.6'; clearAllBtn.style.cursor = 'not-allowed'; } else { clearAllBtn.disabled = false; clearAllBtn.style.opacity = '1'; clearAllBtn.style.cursor = 'pointer'; } clearAllBtn.dataset.confirming = 'false'; const newClearAllBtn = clearAllBtn.cloneNode(true); clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn); newClearAllBtn.addEventListener('click', () => { if (newClearAllBtn.disabled) return; playSound('click-sound'); if (newClearAllBtn.dataset.confirming === 'false') { newClearAllBtn.innerText = \\\"Potvrdi Brisanje SVEGA?\\\"; newClearAllBtn.classList.add('confirm-mode'); newClearAllBtn.dataset.confirming = 'true'; } else { localStorage.removeItem(HISTORY_STORAGE_KEY); localStorage.removeItem(COUNTER_KEY); localStorage.removeItem(COUNTER2_KEY); localStorage.removeItem(COUNTER_ACTIVE_KEY); localStorage.removeItem(USER_ID_KEY); localStorage.removeItem(FIRST_USE_KEY); localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); localStorage.removeItem(CAMERA_ID_KEY); /* <<< DODANO BRISANJE KAMERE */ alert(\\\"Sva spremljena povijest i podaci brojača/kamere obrisani.\\\"); currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0,0,0,0); loadCountersState(); initializeUserTracking(); fetchSheetData().then(() => { renderAllDaysView(); }).catch(() => { renderAllDaysView(); }); } }); const allDaysParentClickHandler = (e) => { const currentClearAllBtn = document.getElementById('clear-history-btn'); if (currentClearAllBtn && currentClearAllBtn.dataset.confirming === 'true' && !currentClearAllBtn.contains(e.target)) { currentClearAllBtn.innerText = \\\"IZBRIŠI SVU POVIJEST\\\"; currentClearAllBtn.classList.remove('confirm-mode'); currentClearAllBtn.dataset.confirming = 'false'; } }; historyPageDiv.removeEventListener('click', allDaysParentClickHandler, true); historyPageDiv.addEventListener('click', allDaysParentClickHandler, true); } } if (punaPovijest.length > 0 && searchResultsContainer && allDaysSummaryContainer) { renderAllDaysList(sortedDays, searchResultsContainer); const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); allDaysSummaryContainer.innerHTML = `<span>RAČUNA: <span style=\\\"font-weight: bold;\\\">${totalCountAll}</span></span><span style=\\\"font-weight: bold;\\\">UKUPNO: ${totalAmountAll.toFixed(2)} €</span>`; allDaysSummaryContainer.style.display = 'flex'; } else { if (allDaysSummaryContainer) allDaysSummaryContainer.style.display = 'none'; } }\n    function renderAllDaysList(daysData, containerElement) { if (!containerElement) return; const opcijeDana = { weekday: 'long' }; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; let daysHtml = '<ul id=\\\"all-days-list-rendered\\\" style=\\\"list-style: none; padding: 0; margin: 0;\\\">'; if (daysData.length === 0) { if (containerElement.id === 'search-results-all-days' && document.getElementById('all-days-search-input')?.value.trim()) { daysHtml += '<li style=\\\"text-align:center; color: grey; padding: 1em 0;\\\"><i>Nema rezultata za traženi pojam.</i></li>'; } else { daysHtml += '<li style=\\\"text-align:center; color: grey; padding: 1em 0;\\\"><i>Nema spremljene povijesti.</i></li>'; } } else { daysData.forEach(dayInfo => { let imeDana = dayInfo.date.toLocaleDateString('hr-HR', opcijeDana); imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); const formatiraniDatum = dayInfo.date.toLocaleDateString('hr-HR', opcijeDatuma); const isoDate = getISODateString(dayInfo.date); daysHtml += `<li data-date-iso=\\\"${isoDate}\\\" style=\\\"background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;\\\"><span style=\\\"font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;\\\">${imeDana}, ${formatiraniDatum}</span><div style=\\\"flex-shrink: 0; text-align: right;\\\"><span style=\\\"font-size: 0.9em; color: #555; white-space: nowrap;\\\">Računa: ${dayInfo.totalCount}</span><span style=\\\"font-weight: bold; margin-left: 15px; white-space: nowrap;\\\">${dayInfo.totalAmount.toFixed(2)} €</span></div></li>`; }); } daysHtml += '</ul>'; containerElement.innerHTML = daysHtml; const listElement = containerElement.querySelector('ul'); if (listElement) { const newListElement = listElement.cloneNode(true); listElement.parentNode.replaceChild(newListElement, listElement); newListElement.addEventListener('click', (e) => { const clickedDayLi = e.target.closest('li[data-date-iso]'); if (clickedDayLi && clickedDayLi.dataset.dateIso) { const selectedDate = new Date(clickedDayLi.dataset.dateIso + 'T00:00:00'); playSound('click-sound'); currentlyViewedDate = selectedDate; renderHistoryView(selectedDate); } }); } }\n    function executeAllDaysSearch() { const searchInput = document.getElementById('all-days-search-input'); const resultsContainer = document.getElementById('search-results-all-days'); const summaryContainer = document.getElementById('all-days-summary-info'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); console.log(\"--- executeAllDaysSearch ---\"); console.log(\"Tražim pojam:\", searchTerm); console.log(\"Normalizirani datum za pretragu:\", normalizedSearchDate); resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm) { return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; const opcijeDana = { weekday: 'long' }; const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' }; const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' }; punaPovijest.forEach((grupa, index) => { const sessionDate = new Date(grupa.timestamp); console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { console.log(\"    MATCH: Točan datum!\"); match = true; } if (!match) { console.log(\"    Provjeravam kao tekst...\"); if (formattedDateShort.includes(searchTerm)) { console.log(\"    MATCH: Kratki datum sadrži pojam.\"); match = true; } else if (formattedDateNumeric.includes(searchTerm)) { console.log(\"    MATCH: Numerički datum sadrži pojam.\"); match = true; } else if (dayName.includes(searchTerm)) { console.log(`    MATCH: Ime dana ('${dayName}') sadrži pojam ('${searchTerm}').`); match = true; } else if (sessionName && sessionName.includes(searchTerm)) { console.log(\"    MATCH: Naziv sesije sadrži pojam.\"); match = true; } else { console.log(\"    Nema tekstualnog matcha.\"); } } if (match) { searchResults.push(grupa); } }); console.log(\"Ukupno pronađeno rezultata (Svi Dani):\", searchResults.length); renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); resultsContainer.style.display = 'block'; console.log(\"--- kraj executeAllDaysSearch ---\"); }\n    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) { if (!containerElement || !summaryContainer) return; containerElement.innerHTML = ''; summaryContainer.innerHTML = ''; summaryContainer.style.display = 'none'; if (results.length === 0) { containerElement.innerHTML = '<p style=\\\"text-align:center; color: grey; padding: 1em 0;\\\"><i>Nema rezultata za traženi pojam.</i></p>'; return; } const brojRacunaRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.length, 0); const ukupanIznosRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0); summaryContainer.innerHTML = `<span>RAČUNA: <span style=\\\"font-weight: bold;\\\">${brojRacunaRezultati}</span></span><span style=\\\"font-weight: bold;\\\">UKUPNO: ${ukupanIznosRezultati.toFixed(2)} €</span>`; summaryContainer.style.display = 'flex'; results.sort((a, b) => b.timestamp - a.timestamp); let resultsHtml = '<ul id=\\\"search-results-list\\\" style=\\\"list-style: none; padding: 0; margin: 0;\\\">'; const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' }; results.forEach(grupa => { const vrijemeSpremanja = new Date(grupa.timestamp); const datumString = vrijemeSpremanja.toLocaleDateString('hr-HR', opcijeDatuma); const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0'); const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0'); const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`; const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0); const zadnjeVrijeme = grupa.lastQrTime || '??:??'; const prikazNaziva = grupa.name ? `<span class=\\\"session-name-history\\\">${grupa.name}</span>` : `<span class=\\\"scan-time-history\\\">SKEN</span>`; resultsHtml += `<li data-timestamp=\\\"${grupa.timestamp}\\\" style=\\\"border: 1px solid #eee; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; cursor: pointer;\\\"><div style=\\\"font-weight: bold; margin-right: 8px; color: #666;\\\">${datumString}</div><div style=\\\"flex-grow: 1; min-width: 100px; display: inline-flex; align-items: center;\\\">${prikazNaziva} <span style=\\\"font-size:0.9em; color:#555; margin-left: 5px;\\\">u ${vrijemeSpremanjaFormatirano}</span></div><div style=\\\"flex-shrink: 0; margin-left: auto; padding-left: 10px; text-align: right;\\\"><span class=\\\"scan-group-last-qr-time\\\">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style=\\\"font-weight: bold; margin-left: 10px;\\\">${ukupnoGrupa.toFixed(2)} €</span></div></li>`; }); resultsHtml += '</ul>'; containerElement.innerHTML = resultsHtml; const resultsList = containerElement.querySelector('ul'); if (resultsList) { const newResultsList = resultsList.cloneNode(true); resultsList.parentNode.replaceChild(newResultsList, resultsList); newResultsList.addEventListener('click', (e) => { const clickedLi = e.target.closest('li[data-timestamp]'); if (clickedLi && clickedLi.dataset.timestamp) { const timestamp = clickedLi.dataset.timestamp; const punaPovijest = loadFullHistoryFromLocalStorage(); const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); if (selectedGroup) { playSound('click-sound'); if (containerElement.id === 'search-results') { previousHistoryViewState = 'day-search-results'; lastSearchTerm = document.getElementById('search-input')?.value.trim() || ''; } else if (containerElement.id === 'search-results-all-days') { previousHistoryViewState = 'all-days-search-results'; lastSearchTerm = document.getElementById('all-days-search-input')?.value.trim() || ''; } currentlyViewedDate = new Date(selectedGroup.timestamp); currentlyViewedDate.setHours(0,0,0,0); renderGroupDetailView(selectedGroup); } else { console.error(\\\"Nije pronađena grupa iz rezultata pretrage:\\\", timestamp); alert(\\\"Greška pri otvaranju detalja.\\\"); } } }); } }\n    function executeSearch() { const searchInput = document.getElementById('search-input'); const resultsContainer = document.getElementById('search-results'); const summaryContainer = document.getElementById('search-summary-info-day'); if (!searchInput || !resultsContainer || !summaryContainer) return; const searchTerm = searchInput.value.trim().toLowerCase(); lastSearchTerm = searchInput.value.trim(); const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim()); console.log(\"--- executeSearch (Sada pretražuje SVE DANE) ---\"); console.log(\"Tražim pojam:\", searchTerm); console.log(\"Normalizirani datum za pretragu:\", normalizedSearchDate); resultsContainer.innerHTML = ''; summaryContainer.style.display = 'none'; summaryContainer.innerHTML = ''; if (!searchTerm) { resultsContainer.innerHTML = '<p style=\\\"text-align:center; color: grey;\\\"><i>Unesite pojam za pretragu (datum, dan, naziv).</i></p>'; return; } const punaPovijest = loadFullHistoryFromLocalStorage(); const searchResults = []; const opcijeDana = { weekday: 'long' }; const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' }; const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' }; punaPovijest.forEach((grupa, index) => { const sessionDate = new Date(grupa.timestamp); console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort); const normalizedSessionDate = getISODateString(sessionDate); let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase(); const sessionName = grupa.name ? grupa.name.toLowerCase() : ''; let match = false; console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) { console.log(\"    MATCH: Točan datum!\"); match = true; } if (!match) { console.log(\"    Provjeravam kao tekst...\"); if (formattedDateShort.includes(searchTerm)) { console.log(\"    MATCH: Kratki datum sadrži pojam.\"); match = true; } else if (formattedDateNumeric.includes(searchTerm)) { console.log(\"    MATCH: Numerički datum sadrži pojam.\"); match = true; } else if (dayName.includes(searchTerm)) { console.log(`    MATCH: Ime dana ('${dayName}') sadrži pojam ('${searchTerm}').`); match = true; } else if (sessionName && sessionName.includes(searchTerm)) { console.log(\"    MATCH: Naziv sesije sadrži pojam.\"); match = true; } else { console.log(\"    Nema tekstualnog matcha.\"); } } if (match) { searchResults.push(grupa); } }); console.log(\"Ukupno pronađeno rezultata (SVI DANI):\", searchResults.length); renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer); const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; console.log(\"--- kraj executeSearch (SVI DANI) ---\"); }\n    function startSearch() { playSound('click-sound'); console.log(\"Pokretanje pretrage (sada pretražuje SVE)...\"); if (!historyContentDiv || !historyDynamicHeaderContentDiv) return; const originalList = document.getElementById('scan-group-list'); if(originalList) originalList.style.display = 'none'; const originalInstruction = document.getElementById('history-select-group-text'); if(originalInstruction) originalInstruction.style.display = 'none'; const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn) clearDayBtn.style.display = 'none'; const dateInfoDiv = document.getElementById('history-date-info'); const summaryInfoDiv = document.getElementById('history-summary-info'); if (dateInfoDiv) dateInfoDiv.style.display = 'none'; if (summaryInfoDiv) summaryInfoDiv.style.display = 'none'; let searchContainer = document.getElementById('search-container'); if (!searchContainer) { searchContainer = document.createElement('div'); searchContainer.id = 'search-container'; searchContainer.innerHTML = `<div style=\\\"display: flex; gap: 10px; margin-bottom: 0.8em;\\\"><input type=\\\"text\\\" id=\\\"search-input\\\" placeholder=\\\"Pretraži SVE (Datum, Dan, Naziv)...\\\" style=\\\"flex-grow: 1; padding: 0.5em;\\\"><button id=\\\"execute-search-btn\\\" style=\\\"padding: 0.5em 1em;\\\">Traži</button><button id=\\\"close-search-btn\\\" style=\\\"padding: 0.5em 1em; background-color: #ccc;\\\">Zatvori</button></div><div id=\\\"search-summary-info-day\\\" style=\\\"display: none;\\\"></div>`; historyDynamicHeaderContentDiv.appendChild(searchContainer); } searchContainer.style.display = 'block'; historyContentDiv.innerHTML = '<div id=\\\"search-results\\\"><p style=\\\"text-align:center; color: grey;\\\"><i>Unesite pojam za pretragu.</i></p></div>'; const searchResultsDiv = document.getElementById('search-results'); if(searchResultsDiv) searchResultsDiv.style.display = 'block'; const searchInput = document.getElementById('search-input'); const executeBtn = document.getElementById('execute-search-btn'); const closeBtn = document.getElementById('close-search-btn'); const searchSummaryDay = document.getElementById('search-summary-info-day'); if (searchInput) { searchInput.value = ''; searchInput.focus(); } if (searchSummaryDay) { searchSummaryDay.style.display = 'none'; searchSummaryDay.innerHTML = ''; } if (executeBtn) { const newExecuteBtn = executeBtn.cloneNode(true); executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn); newExecuteBtn.addEventListener('click', executeSearch); } if (closeBtn) { const newCloseBtn = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn); newCloseBtn.addEventListener('click', () => { playSound('click-sound'); if (searchContainer) searchContainer.style.display = 'none'; renderHistoryView(currentlyViewedDate); }); } if (searchInput) { const newSearchInput = searchInput.cloneNode(true); searchInput.parentNode.replaceChild(newSearchInput, searchInput); newSearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') executeSearch(); }); } }\n    function deleteScansForDay(dateToDelete) { if (!(dateToDelete instanceof Date) || isNaN(dateToDelete)) { console.error(\"Pokušaj brisanja dana s neispravnim datumom.\"); alert(\"Greška: Nije moguće identificirati dan za brisanje.\"); return; } const dateToDeleteStr = getISODateString(dateToDelete); if (!dateToDeleteStr) return; console.log(\"Brisanje svih skenova za dan:\", dateToDeleteStr); let punaPovijest = loadFullHistoryFromLocalStorage(); const originalLength = punaPovijest.length; const filtriranaPovijest = punaPovijest.filter(grupa => { const grupaDateStr = getISODateString(new Date(grupa.timestamp)); return grupaDateStr !== dateToDeleteStr; }); const newLength = filtriranaPovijest.length; console.log(`Originalna dužina: ${originalLength}, Nova dužina: ${newLength}`); if (newLength < originalLength) { saveFullHistoryToLocalStorage(filtriranaPovijest); playSound('remove-sound'); alert(`Svi skenovi za ${dateToDelete.toLocaleDateString('hr-HR')} obrisani.`); renderAllDaysView(); } else { console.warn(\"Nisu pronađeni skenovi za brisanje za dan:\", dateToDeleteStr); alert(\"Greška: Nisu pronađeni skenovi za ovaj dan.\"); const clearDayBtn = document.getElementById('clear-day-btn'); if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') { clearDayBtn.innerText = \\\"IZBRIŠI OVAJ DAN\\\"; clearDayBtn.classList.remove('confirm-mode'); clearDayBtn.dataset.confirming = 'false'; } } }\n\n    // *** EVENT LISTENERI ***\n    // Modificirana handleVisibilityChange\n     function handleVisibilityChange() {\n        if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) {\n             console.log(\"Aplikacija postala vidljiva u Scanner View.\");\n            if (!isScannerActive) {\n                console.log(\"Vidljivo & ScannerView: Skener nije aktivan, pozivam initializeScanner.\");\n                 initializeScanner(); // Pokušaj inicijalizirati ako nije aktivan\n            } else {\n                 console.log(\"Vidljivo & ScannerView: Skener je već (ili bi trebao biti) aktivan. Ažuriram UI.\");\n                 // Ne treba ponovo inicijalizirati, samo UI update\n                 checkSharePrompt();\n                 updateRunningTextVisibility();\n                 updateDeactivatedIndicator();\n                 // Pokaži gumb ako treba\n                 Html5Qrcode.getCameras().then(devices => {\n                     if (switchCameraButton && isScannerActive && devices && devices.length > 1) {\n                        switchCameraButton.style.display = 'block';\n                     }\n                 }).catch(()=>{/* ignore error */});\n            }\n        } else if (document.visibilityState === 'hidden') {\n             console.log(\"Aplikacija postala nevidljiva, zaustavljam skener.\");\n            stopScanner(); // Zaustavi skener kad tab nije vidljiv\n        }\n    };\n\n    function attachVisibilityListener() {\n        if (visibilityListenerAttached) return;\n        document.addEventListener(\"visibilitychange\", handleVisibilityChange);\n        visibilityListenerAttached = true;\n        console.log(\"Visibility listener dodan.\");\n    }\n\n    // Modificirana globalClickListener da zatvori overlay\n    function globalClickListener(event) {\n        // Zatvori popis kamera ako se klikne izvan njega i izvan gumba za promjenu kamere\n        if (cameraSelectionOverlay && cameraSelectionOverlay.style.display === 'block') {\n             const isClickInsideOverlay = cameraSelectionOverlay.contains(event.target);\n             const isClickOnSwitchButton = switchCameraButton && switchCameraButton.contains(event.target);\n             if (!isClickInsideOverlay && !isClickOnSwitchButton) {\n                 cameraSelectionOverlay.style.display = 'none';\n             }\n        }\n\n        // Ostatak logike za resetiranje gumba\n        const isClickOnRemoveButton = removeButton && removeButton.contains(event.target); const isClickOnDeleteWarning = deleteWarningDiv && deleteWarningDiv.style.display !== 'none' && deleteWarningDiv.contains(event.target); if ((removeConfirm || removeNameConfirm) && !isClickOnRemoveButton && !isClickOnDeleteWarning) { resetRemoveMode(); }\n        const isClickOnOcistiButton = ocistiButton && ocistiButton.contains(event.target); if (ocistiConfirm && !isClickOnOcistiButton) { resetOcistiMode(); }\n        const isClickOnNameInput = sessionNameInput && sessionNameInput.contains(event.target); const isClickOnAddNameBtn = addNameBtn && addNameBtn.contains(event.target); const isClickOnEditIcon = event.target.classList.contains('edit-icon'); if (sessionNameInput && sessionNameInput.style.display === 'block' && !isClickOnNameInput && !isClickOnAddNameBtn && !isClickOnEditIcon) { saveName(); }\n    }\n\n    // *** INICIJALIZACIJA APLIKACIJE ***\n    document.addEventListener('DOMContentLoaded', () => {\n        console.log(\"DOM spreman...\");\n        // Dohvati SVE DOM elemente\n        totalDiv = document.getElementById('total');\n        totalContainer = document.getElementById('total-container');\n        ocistiButton = document.getElementById('ocisti-button');\n        invoiceCountDiv = document.getElementById('invoice-count');\n        historyList = document.getElementById('historyList');\n        removeButton = document.getElementById('remove-from-list-btn');\n        duplicateWarning = document.getElementById('duplicate-warning');\n        loadedMsg = document.getElementById('loaded-message');\n        instructionDiv = document.getElementById('scan-instruction');\n        deleteWarningDiv = document.getElementById('delete-warning');\n        shareButton = document.getElementById('share-button');\n        readerDiv = document.getElementById('reader');\n        historyToggleButton = document.getElementById('history-toggle-btn');\n        historyDiv = document.getElementById('history');\n        historyPageDiv = document.getElementById('history-page');\n        backToScannerButton = document.getElementById('back-to-scanner-btn');\n        historyContentDiv = document.getElementById('history-content');\n        sessionNameContainer = document.getElementById('session-name-container');\n        addNameBtn = document.getElementById('add-name-btn');\n        sessionNameInput = document.getElementById('session-name-input');\n        sessionNameDisplay = document.getElementById('session-name-display');\n        sessionNameText = document.getElementById('session-name-text');\n        historyStickyHeaderDiv = document.getElementById('history-sticky-header');\n        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');\n        runningTextContainer = document.getElementById('running-text-container');\n        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;\n        sharePromptOverlay = document.getElementById('share-prompt-overlay');\n        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');\n        // NOVI ELEMENTI\n        switchCameraButton = document.getElementById('switch-camera-btn');\n        cameraSelectionOverlay = document.getElementById('camera-selection-overlay');\n        cameraListUl = document.getElementById('camera-list');\n\n        // Provjera osnovnih elemenata (uključujući nove)\n        if (!readerDiv || !historyPageDiv || !historyContentDiv || !backToScannerButton || !historyToggleButton || !sessionNameContainer || !historyStickyHeaderDiv || !historyDynamicHeaderContentDiv || !runningTextContainer || !sharePromptOverlay || !counterDeactivatedIndicator || !loadedMsg || !switchCameraButton || !cameraSelectionOverlay || !cameraListUl ) {\n            console.error(\"GREŠKA: Nedostaju DOM elementi!\");\n            document.body.innerHTML = '<div style=\\\"padding: 20px; color: red; font-weight: bold;\\\">Greška učitavanja. Osvježite.</div>';\n            return;\n        }\n\n        // Globalni listener i listeneri za gumbe\n        document.body.addEventListener('click', globalClickListener, true);\n\n        // Listener za gumb POVIJEST\n        if (historyToggleButton) {\n             const newHistoryToggleButton = historyToggleButton.cloneNode(true);\n             historyToggleButton.parentNode.replaceChild(newHistoryToggleButton, historyToggleButton);\n             historyToggleButton = newHistoryToggleButton;\n             historyToggleButton.addEventListener('click', () => { console.log(\"Klik na 'POVIJEST' gumb detektiran.\"); playSound('click-sound'); switchToHistoryView(); });\n        } else { console.error(\"DOM spreman, ali #history-toggle-btn nije pronađen!\"); }\n\n        // Listener za gumb < NA SKENER\n        if (backToScannerButton) { backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); }); }\n\n        // Listener za SHARE gumb\n        if (navigator.share) { if (shareButton) { shareButton.style.display = 'block'; shareButton.addEventListener('click', async () => { if (removeConfirm || removeNameConfirm) resetRemoveMode(); if (ocistiConfirm) resetOcistiMode(); const shareData = { title: 'QR SKENER-RAČUNATOR', text: 'Skenira i zbraja račune bez instaliranja', url: 'https://soboslikar.github.io/QR-RACUNATOR/' }; try { await navigator.share(shareData); console.log('Share dijalog zatvoren...'); if (brojac === 0 && brojac2 > 0) { brojac = brojac2; saveBrojac(); checkSharePrompt(); console.log(\"Brojač resetiran na\", brojac, \"nakon zatvaranja share dijaloga.\"); } } catch (err) { console.error('Greška dijeljenja:', err); if (err.name === 'AbortError') { console.log('Korisnik odustao od dijeljenja (AbortError). Brojač NIJE resetiran.'); } else { console.log('Došlo je do druge greške pri dijeljenju. Brojač NIJE resetiran.'); } } }); } } else { if (shareButton) shareButton.style.display = 'none'; }\n\n        // Listener za UNOS IMENA (Enter/Escape)\n        if(sessionNameInput) { sessionNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); saveName(); } else if (e.key === 'Escape') { sessionNameInput.value = currentSessionName || ''; sessionNameInput.style.display = 'none'; updateNameDisplay(); } }); }\n\n        // *** NOVI LISTENER za gumb za promjenu kamere ***\n        if (switchCameraButton) {\n            switchCameraButton.addEventListener('click', toggleCameraSelection);\n        }\n\n        // --- REDOSLIJED INICIJALIZACIJE ---\n        // 1. Učitaj lokalno stanje brojača\n        loadCountersState();\n        // 2. Inicijalizuj UserID i FirstUseTimestamp\n        initializeUserTracking();\n        // 3. Napravi inicijalni update prikaza\n        updateDisplay();\n        // 4. Provjeri view i pokreni inicijalizaciju\n        console.log(\"Provjeravam inicijalni view (prije dohvaćanja)...\");\n        if (document.body.classList.contains('scanner-view')) {\n            console.log(\"Init: Scanner view - Pokrećem inicijalizaciju skenera...\");\n            initializeScanner();\n            attachVisibilityListener();\n        } else {\n            console.log(\"Init: History view...\");\n            renderHistoryView(currentlyViewedDate);\n        }\n        // 5. Pokreni dohvaćanje podataka iz Sheeta u pozadini i ONDA pošalji log\n        fetchSheetData().then(() => {\n            console.log(\"Sheet podaci dohvaćeni. Pripremam 'app_loaded' log.\");\n            let previousSessionDetails = null;\n            try { const unsavedCount = localStorage.getItem(UNSAVED_COUNT_KEY); const unsavedAmount = localStorage.getItem(UNSAVED_AMOUNT_KEY); if (unsavedCount !== null && unsavedAmount !== null) { const count = parseInt(unsavedCount, 10); const amount = parseFloat(unsavedAmount); if (!isNaN(count) && !isNaN(amount) && count >= 0) { console.log(\"Pronađena nesačuvana sesija:\", count, amount); previousSessionDetails = { count: count, amount: amount }; localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); console.log(\"Obrisano nesačuvano stanje nakon čitanja za log.\"); } else { console.warn(\"Pronađene nevalidne nesačuvane vrednosti, brišem ih.\", unsavedCount, unsavedAmount); localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); } } else { console.log(\"Nema nesačuvane sesije za logovanje.\"); } } catch (lsError) { console.error(\"Greška čitanja/brisanja nesačuvanog stanja iz localStorage:\", lsError); }\n            const appLoadedDetails = { previousSession: previousSessionDetails }; const appLoadedEventData = { Event: 'app_loaded', Details: JSON.stringify(appLoadedDetails) }; sendLogData(appLoadedEventData);\n            if (document.body.classList.contains('history-view')) { console.log(\"Ažuriram prikaz povijesti nakon dohvaćanja podataka.\"); renderHistoryView(currentlyViewedDate); } else { console.log(\"Ažuriram UI skenera nakon dohvaćanja podataka.\"); updateDisplay(); checkSharePrompt(); updateRunningTextVisibility(); updateDeactivatedIndicator(); /* Pokaži gumb ako treba */ Html5Qrcode.getCameras().then(devices => { if (switchCameraButton && isScannerActive && devices && devices.length > 1) { switchCameraButton.style.display = 'block'; } }).catch(()=>{}); }\n            console.log(\"Inicijalizacija (pozadinska obrada) završena.\");\n        }).catch(error => {\n             console.error(\"Greška tijekom pozadinskog dohvaćanja podataka:\", error);\n             let previousSessionDetailsOnError = null;\n             try { const unsavedCount = localStorage.getItem(UNSAVED_COUNT_KEY); const unsavedAmount = localStorage.getItem(UNSAVED_AMOUNT_KEY); if (unsavedCount !== null && unsavedAmount !== null) { const count = parseInt(unsavedCount, 10); const amount = parseFloat(unsavedAmount); if (!isNaN(count) && !isNaN(amount) && count >= 0) { previousSessionDetailsOnError = { count: count, amount: amount }; localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); } else { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); } } } catch (lsError) { /* Ignoriši */ }\n             const appLoadedErrorEventData = { Event: 'app_loaded', Details: JSON.stringify({ previousSession: previousSessionDetailsOnError, fetchError: error.toString() }) }; sendLogData(appLoadedErrorEventData);\n             console.log(\"Inicijalizacija završena (s greškom pozadinskog dohvaćanja).\");\n             if (document.body.classList.contains('history-view')) { renderHistoryView(currentlyViewedDate); } else { updateDisplay(); checkSharePrompt(); updateRunningTextVisibility(); updateDeactivatedIndicator(); /* Pokaži gumb ako treba */ Html5Qrcode.getCameras().then(devices => { if (switchCameraButton && isScannerActive && devices && devices.length > 1) { switchCameraButton.style.display = 'block'; } }).catch(()=>{}); }\n        });\n        console.log(\"Osnovna inicijalizacija završena (dohvaćanje ide u pozadini).\");\n    }); // Kraj DOMContentLoaded\n    console.log(\">>> KRAJ SKRIPTE <<<\");\n  </script>\n\n  <!-- Statcounter kod -->\n  <script type=\"text/javascript\"> var sc_project=12702047; var sc_invisible=1; var sc_security=\"e75d2592\"; var scJsHost = \"https://\"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + \"statcounter.com/counter/counter.js\"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>\n  <noscript><div class=\"statcounter\"><a title=\"Web Analytics\" href=\"https://statcounter.com/\" target=\"_blank\"><img class=\"statcounter\" src=\"https://c.statcounter.com/12702047/0/e75d2592/1/\" alt=\"Web Analytics\" referrerPolicy=\"no-referrer-when-downgrade\"></a></div></noscript>\n  <!-- Kraj Statcounter koda -->\n\n</body>\n</html>"
  }
]

