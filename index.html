<script>
    // *** GLOBALNE VARIJABLE I KONSTANTE ***
    const MAX_HISTORY_ITEMS = 500;
    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';
    // NOVO: Ključevi za localStorage za brojače i stanje
    const COUNTER_KEY = 'qrCalculatorCounter';
    const COUNTER2_KEY = 'qrCalculatorCounter2';
    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';
    const APPS_SCRIPT_URL = 'URL_TVOJE_WEB_APLIKACIJE'; // <-- !!! OVDJE STAVI URL OBJAVLJENE SKRIPTE !!!

    let ukupno = 0;
    let povijest = [];
    let removeConfirm = false;
    let ocistiConfirm = false;
    const removeBtnInitialText = 'Obriši iz liste';
    const ocistiBtnInitialText = 'SPREMI<br>I OČISTI';
    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';
    let html5QrCodeInstance = null;
    let isScannerActive = false;
    let currentCameraId = null;
    let visibilityListenerAttached = false;
    let currentSessionName = null;
    let removeNameConfirm = false;
    let currentlyViewedDate = new Date();
    currentlyViewedDate.setHours(0, 0, 0, 0);
    let previousHistoryViewState = 'day-view';
    let lastSearchTerm = '';

    // NOVO: Varijable za brojače i tekst
    let brojac = 0;
    let brojac2 = 0;
    let tekstPoruka = ""; // Dohvaćeni tekst iz Sheeta
    let isCounterDecrementActive = true; // Zastavica za aktivnost brojača

    // DOM Elementi (dodajemo nove)
    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator; // NOVO: zadnja 4 elementa

    // *** POMOĆNE FUNKCIJE ***
    const parseTime = (timeStr) => { /* ... (ista kao prije) ... */ };
    function playSound(id) { /* ... (ista kao prije) ... */ };
    function getISODateString(date) { /* ... (ista kao prije) ... */ };
    function normalizeDateForSearch(dateString) { /* ... (ista kao prije) ... */ };

    // NOVO: Funkcija za prikazivanje privremenih poruka
    function showTemporaryMessage(messageText, duration = 1500) {
        if (!loadedMsg) return;
        loadedMsg.innerText = messageText;
        loadedMsg.style.display = 'block';
        loadedMsg.style.animation = 'none';
        loadedMsg.offsetHeight; // Trigger reflow
        loadedMsg.style.animation = 'zoomFade 1s ease-out'; // Koristimo postojeću animaciju
        setTimeout(() => {
            if (loadedMsg) loadedMsg.style.display = 'none';
        }, duration);
    }

    // *** FUNKCIJE ZA LOKALNU POHRANU ***
    function saveFullHistoryToLocalStorage(fullHistory) { /* ... (ista kao prije) ... */ };
    function loadFullHistoryFromLocalStorage() { /* ... (ista kao prije) ... */ };

    // NOVO: Učitavanje/Spremanje stanja brojača
    function loadCountersState() {
        const storedBrojac = localStorage.getItem(COUNTER_KEY);
        const storedBrojac2 = localStorage.getItem(COUNTER2_KEY);
        const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY);

        brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null; // null označava da nije inicijaliziran
        brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 10) : 0; // Default 0 ako nema
        isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true; // Default true

        // Osiguraj da su brojevi validni
        if (isNaN(brojac)) brojac = null;
        if (isNaN(brojac2)) brojac2 = 0;

        console.log("Učitano stanje:", { brojac, brojac2, isCounterDecrementActive });
        updateDeactivatedIndicator(); // Ažuriraj kvačicu
    }

    // NOVO: Spremanje pojedinačnih vrijednosti
    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }
    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }
    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }

    // *** FUNKCIJE ZA DOHVAĆANJE PODATAKA IZ SHEETA ***
    // NOVO: Funkcija za dohvaćanje
    async function fetchSheetData() {
        console.log("Pokušavam dohvatiti podatke iz Google Sheeta...");
        if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'URL_TVOJE_WEB_APLIKACIJE') {
            console.warn("URL Google Apps Scripta nije postavljen!");
            tekstPoruka = "Greška: URL nije postavljen."; // Poruka za testiranje
            initializeCounters(); // Nastavi s lokalnim ili default vrijednostima
            updateRunningText(); // Ažuriraj prikaz teksta
            return;
        }
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) {
                throw new Error(`HTTP greška ${response.status}`);
            }
            const data = await response.json();
            console.log("Podaci dohvaćeni:", data);

            // Ažuriraj brojac2
            let newPrag = data.pragBrojac !== undefined ? parseInt(data.pragBrojac, 10) : 100; // Koristi default 100 iz skripte ako fali
            if (isNaN(newPrag) || newPrag < 0) { // Dozvoljavamo 0 kao validnu vrijednost nakon reseta
               newPrag = 0; // Postavi na 0 ako je nevalidan ili negativan
            } else if (newPrag > 500) {
                newPrag = 500; // Ograniči na max 500
            }
            brojac2 = newPrag;
            saveBrojac2(); // Spremi novu vrijednost

            // Ažuriraj tekst poruke
            tekstPoruka = data.trceciTekst || ""; // Koristi prazan string ako nema teksta

            initializeCounters(); // Inicijaliziraj brojač 1 na temelju novog brojača 2 (ako treba)
            updateRunningText(); // Ažuriraj prikaz teksta

        } catch (error) {
            console.error("Greška pri dohvaćanju podataka iz Sheeta:", error);
            tekstPoruka = ""; // Nema teksta u slučaju greške (zahtjev 6)
            initializeCounters(); // Koristi postojeće vrijednosti
            updateRunningText(); // Ažuriraj prikaz teksta (bit će sakriven)
        }
    }

    // NOVO: Funkcija za inicijalizaciju brojača 1
    function initializeCounters() {
        console.log("Inicijalizacija brojača...");
        // Provjera "prvog pokretanja" (ili ako je brojac resetiran na null/ne postoji)
        if (brojac === null) {
             console.log("Brojač 1 nije inicijaliziran, postavljanje na brojač 2.");
             brojac = brojac2;
             saveBrojac(); // Spremi inicijaliziranu vrijednost
        } else {
             console.log("Brojač 1 već ima vrijednost:", brojac);
        }
        // Provjeri treba li odmah prikazati poruku (npr. ako je učitano stanje brojac=0, brojac2>0)
        checkSharePrompt();
        updateRunningTextVisibility(); // Pozovi i ovo radi sigurnosti
    }

    // *** FUNKCIJE ZA AŽURIRANJE PRIKAZA ***
    function checkOcistiButtonVisibility() { /* ... (ista kao prije) ... */ };
    function updateDisplay() {
        if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} €`;
        const count = povijest.length;
        if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAČUN' : 'RAČUNA'}`;
        if (document.body.classList.contains('scanner-view')) {
            updateSmallHistoryList();
            checkRemoveButtonVisibility();
            handleInfoDeleteMessageVisibility();
            checkOcistiButtonVisibility();
            updateNameDisplay();
            // NOVO: Ažuriranje prikaza brojača (opcionalno, možeš dodati elemente za prikaz)
             // console.log(`Stanje brojača: ${brojac} / ${brojac2} (Aktivno: ${isCounterDecrementActive})`);
        }
    };
    function updateSmallHistoryList() { /* ... (ista kao prije) ... */ };
    function checkRemoveButtonVisibility() { /* ... (ista kao prije) ... */ };
    function handleInfoDeleteMessageVisibility() { /* ... (ista kao prije) ... */ };

    // NOVO: Funkcije za kontrolu prikaza trčećeg teksta i poruke
    function updateRunningText() {
        if (runningTextSpan) {
            runningTextSpan.textContent = tekstPoruka;
        }
        updateRunningTextVisibility();
    }

    function updateRunningTextVisibility() {
        const shouldShowText = tekstPoruka && (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') && document.body.classList.contains('scanner-view');
        if (runningTextContainer) {
            runningTextContainer.style.display = shouldShowText ? 'block' : 'none';
             // Restart animacije ako se tekst promijeni ili ponovno prikaže
             if (shouldShowText && runningTextSpan) {
                 runningTextSpan.style.animation = 'none';
                 runningTextSpan.offsetHeight; /* Trigger reflow */
                 runningTextSpan.style.animation = ''; // Vrati default iz CSS-a
             }
        }
    }

    function checkSharePrompt() {
        const shouldShowPrompt = brojac === 0 && brojac2 > 0 && document.body.classList.contains('scanner-view');
        if (sharePromptOverlay) {
            sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none';
            // Pozovi ažuriranje trčećeg teksta jer njegovo stanje ovisi o ovome
            updateRunningTextVisibility();
        }
    }

    // NOVO: Funkcija za ažuriranje indikatora deaktivacije
    function updateDeactivatedIndicator() {
        if (counterDeactivatedIndicator) {
            counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view')) ? 'block' : 'none';
        }
    }

    // *** FUNKCIJE ZA RESETIRANJE STANJA GUMBA ***
    function resetRemoveMode() { /* ... (ista kao prije) ... */ };
    function resetOcistiMode() { /* ... (ista kao prije) ... */ };

    // *** FUNKCIJE ZA NAZIV SESIJE ***
    function startAddName() { /* ... (ista kao prije) ... */ };

    // IZMJENA: Funkcija saveName - dodana provjera šifri
    function saveName() {
        if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return;

        const inputText = sessionNameInput.value.trim();

        // Provjera šifri
        if (inputText === "##--##") {
            showTemporaryMessage("RJEŠENO");
            isCounterDecrementActive = false;
            saveCounterActiveState();
            updateDeactivatedIndicator(); // Pokaži kvačicu
            sessionNameInput.value = ''; // Očisti input
            sessionNameInput.style.display = 'none';
            updateNameDisplay(); // Vrati prikaz gumba "DODAJ NAZIV" ako nema naziva
            return; // Prekini izvršavanje
        } else if (inputText === "##00##") {
            showTemporaryMessage("RESETIRANO");
            brojac = 0;
            brojac2 = 0; // Resetiraj oba
            isCounterDecrementActive = true; // Ponovno aktiviraj brojač
            saveBrojac();
            saveBrojac2();
            saveCounterActiveState();
            updateDeactivatedIndicator(); // Sakrij kvačicu
            sessionNameInput.value = ''; // Očisti input
            sessionNameInput.style.display = 'none';
            updateNameDisplay(); // Vrati prikaz gumba
            checkSharePrompt(); // Provjeri treba li prikazati poruku
            updateRunningTextVisibility(); // Ažuriraj trčeći tekst
            return; // Prekini izvršavanje
        }

        // Ako nije šifra, nastavi normalno
        const newName = inputText; // Već smo trimovali
        currentSessionName = newName || null;
        sessionNameInput.style.display = 'none';
        updateNameDisplay();
        checkRemoveButtonVisibility();
    }

    function updateNameDisplay() { /* ... (ista kao prije) ... */ };

    // *** FUNKCIJE ZA UPRAVLJANJE TRENUTNOM SESIJOM SKENIRANJA ***
    function startRemoveFromList() { /* ... (ista kao prije) ... */ };
    function startOcistiConfirm() { /* ... (ista kao prije) ... */ };
    function ocistiTrenutnoSkeniranje() { /* ... (ista kao prije) ... */ };

    // *** OBRADA SKENIRANOG QR KODA ***
    // IZMJENA: handleScan - dodano smanjivanje brojača
    function handleScan(decodedText) {
        // Reset modova (isto kao prije)
        if (removeNameConfirm) resetRemoveMode();
        if (removeConfirm) resetRemoveMode();
        if (ocistiConfirm) resetOcistiMode();

        // Sakrij poruke (isto kao prije)
        if (loadedMsg) loadedMsg.style.display = 'none';
        if (duplicateWarning) duplicateWarning.style.display = 'none';

        try {
            // Parsiranje QR koda (isto kao prije)
            const qrParts = decodedText.split('?');
            if (qrParts.length < 2) throw new Error("Invalid QR format");
            const params = new URLSearchParams(qrParts[1]);
            const iznosCentStr = params.get('izn');
            const datv = params.get('datv');
            if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) throw new Error("Invalid 'izn'");

            // Provjera duplikata (isto kao prije)
            const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText);
            let isDuplicateInRecentSaved = false;
            // ... (logika za provjeru zadnjih 30 dana - ista kao prije) ...
            if (isDuplicateInCurrent || isDuplicateInRecentSaved) {
                // ... (prikaz upozorenja o duplikatu - isto kao prije) ...
                return;
            }

            // Obrada iznosa i vremena (isto kao prije)
            const iznosCenti = parseFloat(iznosCentStr);
            const iznosEura = iznosCenti / 100;
            let time = '??:??';
            // ... (logika za parsiranje vremena - ista kao prije) ...

            // Sakrij instrukciju (isto kao prije)
            if (instructionDiv) instructionDiv.style.display = 'none';

            // Dodavanje u povijest sesije (isto kao prije)
            const newItem = { amount: iznosEura, qrCode: decodedText, time: time, datv: datv || '', scanTimestamp: Date.now() };
            povijest.push(newItem);
            ukupno += iznosEura;

            // NOVO: Smanjivanje brojača
            if (isCounterDecrementActive && brojac > 0) {
                brojac--;
                console.log("Brojač smanjen na:", brojac);
                saveBrojac(); // Spremi novo stanje
                checkSharePrompt(); // Provjeri treba li prikazati poruku
                // Nema potrebe zvati updateRunningTextVisibility() jer ga checkSharePrompt() zove
            } else {
                console.log("Brojač nije smanjen. Aktivno:", isCounterDecrementActive, "Vrijednost:", brojac);
            }

            // Zvuk, update prikaza, poruka "UČITANO" (isto kao prije)
            playSound('scan-sound');
            updateDisplay();
            showTemporaryMessage("UČITANO", 1000); // Koristi novu funkciju

            // Update info poruke (isto kao prije)
            if (deleteWarningDiv) {
                deleteWarningDiv.dataset.lastScanText = `ZADNJI RAČUN: ${newItem.time} = ${newItem.amount.toFixed(2)} €`;
                handleInfoDeleteMessageVisibility();
            }

        } catch (error) {
            console.error("Greška obrade QR:", error, decodedText);
            // Reset poruka (isto kao prije)
            if (loadedMsg) loadedMsg.style.display = 'none';
            if (duplicateWarning) duplicateWarning.style.display = 'none';
        }
    } // Kraj handleScan

    // *** FUNKCIJE ZA UPRAVLJANJE SKENEROM ***
    function isElementOrParentHidden(element) { /* ... (ista kao prije) ... */ };
    // IZMJENA: initializeScanner - dodaj updateRunningTextVisibility i checkSharePrompt
    function initializeScanner() {
        if (document.body.classList.contains('history-view') || isScannerActive) return;
        console.log("[InitializeScanner] Pokrećem...");
        if (readerDiv) readerDiv.innerHTML = '';
        if (instructionDiv) instructionDiv.style.display = 'none';

        // NOVO: Pozovi provjere pri inicijalizaciji skenera
        checkSharePrompt();
        updateRunningTextVisibility();
        updateDeactivatedIndicator();

        html5QrCodeInstance = new Html5Qrcode("reader");
        // ... (ostatak koda za pokretanje kamere - isti kao prije) ...
    };
    // IZMJENA: stopScanner - sakrij elemente vezane za skener view
    function stopScanner() {
        // NOVO: Sakrij elemente specifične za Scanner View
        if(runningTextContainer) runningTextContainer.style.display = 'none';
        if(sharePromptOverlay) sharePromptOverlay.style.display = 'none';
        if(counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';

        const instanceToStop = html5QrCodeInstance;
        // ... (ostatak koda za zaustavljanje kamere - isti kao prije) ...
    };

    // *** FUNKCIJE ZA PROMJENU PRIKAZA (VIEW) ***
    // IZMJENA: switchToScannerView - dodaj updateRunningTextVisibility i checkSharePrompt
    function switchToScannerView() {
        if (document.body.classList.contains('scanner-view')) {
            if (!isScannerActive) initializeScanner();
             // NOVO: Osiguraj ispravan prikaz pri povratku
             checkSharePrompt();
             updateRunningTextVisibility();
             updateDeactivatedIndicator();
            return;
        }
        // ... (reset gumba za brisanje povijesti - isto kao prije) ...
        if (historyDynamicHeaderContentDiv) historyDynamicHeaderContentDiv.innerHTML = ''; // Čišćenje headera povijesti
        document.body.classList.remove('history-view');
        document.body.classList.add('scanner-view');
        document.body.style.backgroundColor = '#f4f4f4';
        currentlyViewedDate = new Date(); // Reset datuma pri povratku
        currentlyViewedDate.setHours(0, 0, 0, 0);
        previousHistoryViewState = 'day-view'; // Reset stanja povijesti
        updateDisplay();
        requestAnimationFrame(initializeScanner); // Pokreni skener
         // NOVO: Osiguraj ispravan prikaz odmah nakon promjene klase
         setTimeout(() => {
             checkSharePrompt();
             updateRunningTextVisibility();
             updateDeactivatedIndicator();
         }, 0);
    }

    // IZMJENA: switchToHistoryView - sakrij elemente Scanner View-a
    function switchToHistoryView() {
        if (document.body.classList.contains('history-view')) {
            renderHistoryView(currentlyViewedDate);
            return;
        }
        // Reset stanja skenera (isto kao prije)
        if (removeConfirm || removeNameConfirm) resetRemoveMode();
        if (ocistiConfirm) resetOcistiMode();

        stopScanner().finally(() => {
            document.body.classList.remove('scanner-view');
            document.body.classList.add('history-view');
            document.body.style.backgroundColor = 'white';
            // NOVO: Eksplicitno sakrij i indikator
            if (counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';
            renderHistoryView(currentlyViewedDate);
        });
    }

    // *** FUNKCIJE ZA RENDERIRANJE HISTORY VIEWA ***
    // Nema potrebe za izmjenama unutar ovih funkcija (renderHistoryView, generirajHtmlZaSpremljenuGrupu, itd.)
    // One samo prikazuju spremljene podatke.
    function clearDynamicHeaderContent() { /* ... (ista kao prije) ... */ };
    function renderHistoryView(dateToShow = currentlyViewedDate) { /* ... (ista kao prije) ... */ };
    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) { /* ... (ista kao prije) ... */ };
    function renderGroupDetailView(groupData) { /* ... (ista kao prije) ... */ };
    function deleteSpecificSession(timestampString) { /* ... (ista kao prije) ... */ };
    function renderAllDaysView() { /* ... (ista kao prije) ... */ };
    function renderAllDaysList(daysData, containerElement) { /* ... (ista kao prije) ... */ };
    function executeAllDaysSearch() { /* ... (ista kao prije) ... */ };
    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) { /* ... (ista kao prije) ... */ };
    function startSearch() { /* ... (ista kao prije) ... */ };
    function executeSearch() { /* ... (ista kao prije) ... */ };
    function deleteScansForDay(dateToDelete) { /* ... (ista kao prije) ... */ };

    // *** EVENT LISTENERI ***
    function handleVisibilityChange() { /* ... (ista kao prije, ali pazi da initializeScanner pozove update prikaza) ... */
        if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) {
            if (!isScannerActive) {
                 initializeScanner(); // initializeScanner će pozvati checkSharePrompt/updateRunningTextVisibility
            } else {
                 // Ako je skener već bio aktivan, samo osvježimo prikaz
                 checkSharePrompt();
                 updateRunningTextVisibility();
                 updateDeactivatedIndicator();
            }
        } else if (document.visibilityState === 'hidden') {
            stopScanner();
        }
    };
    function attachVisibilityListener() { /* ... (ista kao prije) ... */ };
    function globalClickListener(event) { /* ... (ista kao prije) ... */ };

    // *** INICIJALIZACIJA APLIKACIJE ***
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM spreman...");

        // Dohvati sve DOM elemente (uključujući nove)
        totalDiv = document.getElementById('total');
        totalContainer = document.getElementById('total-container');
        ocistiButton = document.getElementById('ocisti-button');
        invoiceCountDiv = document.getElementById('invoice-count');
        historyList = document.getElementById('historyList');
        removeButton = document.getElementById('remove-from-list-btn');
        duplicateWarning = document.getElementById('duplicate-warning');
        loadedMsg = document.getElementById('loaded-message'); // Koristi se za showTemporaryMessage
        instructionDiv = document.getElementById('scan-instruction');
        deleteWarningDiv = document.getElementById('delete-warning');
        shareButton = document.getElementById('share-button');
        readerDiv = document.getElementById('reader');
        historyToggleButton = document.getElementById('history-toggle-btn');
        historyDiv = document.getElementById('history');
        historyPageDiv = document.getElementById('history-page');
        backToScannerButton = document.getElementById('back-to-scanner-btn');
        historyContentDiv = document.getElementById('history-content');
        sessionNameContainer = document.getElementById('session-name-container');
        addNameBtn = document.getElementById('add-name-btn');
        sessionNameInput = document.getElementById('session-name-input');
        sessionNameDisplay = document.getElementById('session-name-display');
        sessionNameText = document.getElementById('session-name-text');
        historyStickyHeaderDiv = document.getElementById('history-sticky-header');
        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');
        // NOVO: dohvati nove elemente
        runningTextContainer = document.getElementById('running-text-container');
        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;
        sharePromptOverlay = document.getElementById('share-prompt-overlay');
        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');


        // Provjera osnovnih elemenata (isto kao prije)
        if (!readerDiv || !historyPageDiv || !historyContentDiv || !backToScannerButton || !historyToggleButton || !sessionNameContainer || !historyStickyHeaderDiv || !historyDynamicHeaderContentDiv || !runningTextContainer || !sharePromptOverlay || !counterDeactivatedIndicator) {
             console.error("GREŠKA: Nedostaju DOM elementi!");
             document.body.innerHTML = '<div style="padding: 20px; color: red; font-weight: bold;">Greška učitavanja. Osvježite.</div>';
             return;
        }

        // Globalni listener (isto kao prije)
        document.body.addEventListener('click', globalClickListener, true);

        // Listeneri za gumbe (isto kao prije)
        if (historyToggleButton) { historyToggleButton.addEventListener('click', () => { playSound('click-sound'); switchToHistoryView(); }); }
        if (backToScannerButton) { backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); }); }

        // IZMJENA: Listener za Share gumb
        if (navigator.share) {
            if (shareButton) {
                shareButton.style.display = 'block'; // Pokaži gumb ako je share podržan
                shareButton.addEventListener('click', async () => {
                    // Reset modova (isto kao prije)
                    if (removeConfirm || removeNameConfirm) resetRemoveMode();
                    if (ocistiConfirm) resetOcistiMode();

                    const shareData = {
                        title: 'QR SKENER-KALKULATOR',
                        text: 'Skenira i zbraja račune...',
                        url: window.location.href
                    };

                    try {
                        await navigator.share(shareData);
                        console.log('Sadržaj uspješno podijeljen (ili je korisnik zatvorio dijalog).');
                        // NOVO: Resetiraj brojač NAKON što se share dijalog zatvori
                        if (brojac === 0 && brojac2 > 0) {
                            brojac = brojac2;
                            saveBrojac();
                            checkSharePrompt(); // Sakrij poruku
                            // updateRunningTextVisibility() će biti pozvan unutar checkSharePrompt
                            console.log("Brojač resetiran na", brojac, "nakon dijeljenja.");
                        }
                    } catch (err) {
                        console.error('Greška dijeljenja:', err);
                        // NOVO: Resetiraj brojač i ako dođe do greške (npr. AbortError)
                        if (err.name === 'AbortError') {
                             console.log('Korisnik odustao od dijeljenja.');
                             if (brojac === 0 && brojac2 > 0) {
                                 brojac = brojac2;
                                 saveBrojac();
                                 checkSharePrompt(); // Sakrij poruku
                                 console.log("Brojač resetiran na", brojac, "nakon odustajanja od dijeljenja.");
                             }
                        }
                         // Za ostale greške nećemo resetirati brojač
                    }
                });
            }
        } else {
            if (shareButton) shareButton.style.display = 'none'; // Sakrij gumb ako share nije podržan
        }

        // Listener za unos imena (isto kao prije)
        if(sessionNameInput) {
            sessionNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); saveName(); }
                else if (e.key === 'Escape') {
                    sessionNameInput.value = currentSessionName || ''; // Vrati staru vrijednost
                    sessionNameInput.style.display = 'none';
                    updateNameDisplay();
                }
            });
        }

        // NOVO: Učitaj stanje brojača prije dohvaćanja podataka
        loadCountersState();

        // NOVO: Pokreni dohvaćanje podataka iz Sheeta
        fetchSheetData(); // Ova funkcija će pozvati initializeCounters i updateRunningText

        console.log("Provjeravam inicijalni view...");
        if (document.body.classList.contains('scanner-view')) {
            console.log("Init: Scanner view...");
            initializeScanner(); // Ova funkcija će pokrenuti kameru i ažurirati prikaz
            attachVisibilityListener();
        } else {
            console.log("Init: History view...");
            switchToHistoryView(); // Prebaci na povijest
        }

        console.log("Init: update displaya...");
        updateDisplay(); // Osnovni update (ukupno, broj računa)

        console.log("Inicijalizacija završena.");
    }); // Kraj DOMContentLoaded

    console.log(">>> KRAJ SKRIPTE <<<"); // DEBUG LOG

</script>
