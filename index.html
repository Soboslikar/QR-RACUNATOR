
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR RAƒåUNATOR</title>
  <meta name="google-site-verification" content="MiNsi-1k4TYmSbTNGPDs_lsgTyiVKmxEa4nkihpTB1s" />
  <meta property="og:title" content="QR RAƒåUNATOR" />
  <meta property="og:description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih raƒçuna i automatsko zbrajanje iznosa. Ukljuƒçuje povijest i pretragu."/>
  <meta name="description" content="Web aplikacija za skeniranje QR kodova s Hrvatskih fiskalnih raƒçuna i automatsko zbrajanje iznosa. Ukljuƒçuje povijest i pretragu.">
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://soboslikar.github.io/QR-RACUNATOR/" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    /* CSS (Iz prethodne verzije + ≈°iri gumb + STICKY HEADER + ODABIR KAMERE + RUƒåNI UNOS) */
    body { font-family: sans-serif; margin: 0; padding: 0.5em; background: #f4f4f4; overflow-x: hidden; min-height: 100vh; }
    body.scanner-view #history-page { display: none; }
    body.history-view { background-color: white; }
    /* Osigurava da history-page zauzima cijelu visinu i omoguƒáava flex layout */
    body.history-view #history-page {
        display: flex;
        flex-direction: column;
        padding: 0; /* Uklonjen padding da sticky header ide do ruba */
        min-height: calc(100vh - 1em); /* Oduzima body padding */
        max-height: calc(100vh - 1em); /* Oduzima body padding */
        box-sizing: border-box;
        overflow: hidden; /* Sprjeƒçava dvostruki scrollbar */
    }
    /* DODANO: Sakrij nove elemente kamere i ruƒçnog unosa, te skener UI elemente u history view */
    body.history-view #header, body.history-view #scan-instruction, body.history-view #reader, body.history-view #loaded-message, body.history-view #duplicate-warning, body.history-view #total-container, body.history-view #session-name-container, body.history-view #invoice-count, body.history-view #history, body.history-view #remove-from-list-btn, body.history-view #history-toggle-btn, body.history-view #share-button, body.history-view #delete-warning, body.history-view #running-text-container, body.history-view #share-prompt-overlay, body.history-view #counter-deactivated-indicator,
    body.history-view #switch-camera-btn, body.history-view #camera-selection-overlay,
    body.history-view #manual-entry-modal-overlay /* Sakrij cijeli modal overlay */
    {
        display: none !important;
    }
    #header { text-align: center; color: yellow; font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; position: absolute; width: 100%; left: 0; top: 1em; z-index: 3; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
    #scan-instruction { position: absolute; top: 2.8em; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; color: white; font-size: 1em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); pointer-events: none; display: block; }
    #reader { width: 100%; max-width: 400px; margin: auto; height: 55vh; position: relative; border: 1px solid #ccc; background: #e0e0e0; }
    #total-container { position: fixed; top: 23.5em; left: 49%; transform: translateX(-50%); z-index: 5; /* Poveƒáan z-index */ display: flex; align-items: center; gap: 10px; background-color: rgba(0, 0, 0, 0.5); padding: 0.2em 0.5em; border-radius: 5px; }
    #total { font-size: 1.6em !important; font-weight: bold; color: yellow; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    #ocisti-button { padding: 0; width: 120px; height: 60px; font-size: 0.9em; font-weight: bold; background: #ff0000; color: yellow; display: none; line-height: 1.3; text-align: center; border-radius: 5px; margin-left: 20px; }
    #ocisti-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    #ocisti-button.confirm-mode { background-color: yellow; color: black; }

    /* MODIFIED session-name-container for flexbox layout */
    #session-name-container {
        position: fixed;
        top: 27.5em;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5; /* Poveƒáan z-index */

        display: flex; /* Use flexbox */
        align-items: center; /* Align items vertically */
        /* PRO≈†IRENO: Neka kontejner zauzme vi≈°e mjesta da se gumbi ne gu≈ævaju */
        width: 95%; /* Poveƒáana maksimalna ≈°irina */
        max-width: 400px; /* Ograniƒçi ≈°irinu na veƒáim ekranima da ne bude pre≈°iroko */
        justify-content: space-between; /* Rasporedi elemente s razmakom */
        min-height: 35px;
        text-align: center; /* Centriranje sadr≈æaja unutar kontejnera (mo≈æda manje bitno sad s space-between) */
        margin-top: 10px;
         background-color: rgba(0, 0, 0, 0.5); /* Consistent with total */
         padding: 0.2em 0.5em;
         border-radius: 5px;
         gap: 15px; /* Poveƒáan razmak izmeƒëu naziva i gumba za ruƒçni unos */
    }

    /* New style for the wrapper holding name elements - <-- DODANO/IZMIJENJENO: margin-left */
    #session-name-wrapper {
        display: flex; /* Inner flex for name elements */
        align-items: center;
        gap: 8px; /* Space between name elements */
        flex-shrink: 1; /* Allow wrapper to shrink */
        min-width: 0; /* Prevent overflow */
         flex-grow: 1; /* Allow wrapper to grow */
          overflow: hidden; /* Skriva tekst ako je predug */
          text-overflow: ellipsis; /* Dodaje toƒçkice */
          white-space: nowrap; /* Spreƒçava prelamanje teksta */
        margin-left: 5px; /* <-- DODANO/IZMIJENJENO: Pomakni wrapere s nazivom malo desno za 5px */
    }

    /* Existing styles for name elements - adjust if needed for flex */
    #add-name-btn {
        padding: 0.4em 0.8em;
        font-size: 0.9em;
        background-color: #e0e0e0;
        color: black;
        display: block;
        flex-shrink: 0; /* Prevent shrinking */
        font-weight: bold; /* DODANO: Bold slova */
        white-space: nowrap; /* Sprijeƒçi prelamanje teksta u gumbu */
    }

     /* session-name-input styles - A≈ΩURIRANO ZA VEƒÜA SLOVA I UKLONJEN MAX-WIDTH */
     #session-name-input {
         font-size: 1.2em; /* Poveƒáana veliƒçina fonta */
         padding: 0.3em 0.5em;
         border: 1px solid #ccc;
         border-radius: 4px;
         /* max-width: 150px; REMOVED */
         width: 100%; /* Neka zauzme sav dostupan prostor unutar wrappera */
         display: none;
         box-sizing: border-box;
          flex-grow: 1;
     }

    #session-name-display {
        font-size: 1em;
        font-weight: bold;
        color: yellow;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 0.3em 0.8em;
        border-radius: 5px;
        display: none; /* Managed by JS */
        align-items: center;
        gap: 8px;
         flex-grow: 1;
         min-width: 50px;
         text-align: left;
         box-sizing: border-box;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
    }

     /* Keep edit-icon styles */
     #session-name-display .edit-icon {
         cursor: pointer;
         font-size: 0.8em;
         font-weight: normal;
         color: white;
         text-decoration: underline;
         flex-shrink: 0;
     }

    /* NEW STYLE for the Manual Entry button - <-- DODANO/IZMIJENJENO: margin-right */
    #manual-entry-btn {
        background-color: orange; /* Keep orange background */
        color: black; /* PROMIJENJENO: Crna slova */
        padding: 0.4em 0.8em;
        font-size: 0.9em;
        font-weight: bold; /* Keep bold */
        border: none;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        text-align: center;
        line-height: 1.3;
        flex-shrink: 0; /* Prevent shrinking */
         min-width: 90px; /* Minimalna ≈°irina da tekst stane */
        white-space: nowrap; /* Sprijeƒçi prelamanje teksta u gumbu */
        margin-right: 5px; /* <-- DODANO/IZMIJENJENO: Pomakni gumb ruƒçnog unosa malo lijevo za 5px */
    }


    #invoice-count { font-size: 1.4em; color: black; padding: 0.1em 0.4em; position: fixed; bottom: 170px; right: 50px; z-index: 2; text-align: right; font-weight: bold; }
    #duplicate-warning { font-weight: bold; color: red; background-color: rgba(255, 255, 255, 0.8); padding: 0.3em 0.8em; border-radius: 5px; border: 1px solid red; text-align: center; animation: pulse 0.5s ease-in-out 3 alternate; position: fixed; top: 12.8em; left: 50%; transform: translateX(-50%); z-index: 5; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #loaded-message { font-weight: bold; color: green; display: none; text-align: center; font-size: 2em; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); animation: zoomFade 1s ease-out; z-index: 10; background-color: rgba(255, 255, 255, 0.85); padding: 0.8em 2em; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,4,8,0.2); }
    #delete-warning { font-weight: bold; display: none; text-align: center; position: fixed; top: 21.5em; left: 50%; transform: translateX(-50%); padding: 0.3em 0.6em; border-radius: 3px; z-index: 5; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; }
    #delete-warning.delete-mode { color: black; background-color: rgba(255, 255, 0, 0.8); }
    #delete-warning.info-mode { color: white; background-color: rgba(0, 0, 0, 0.6); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
    #history { max-height: 180px; overflow-y: auto; margin: 0; padding: 1em; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 150px; position: fixed; bottom: 10px; left: 10px; z-index: 1; display: block; }
    #history ul { list-style: none; padding: 0; margin: 0; }
    #history li { padding: 0.5em 0; border-bottom: 1px solid #eee; white-space: pre; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    #history li:last-child { border-bottom: none; }
    button { padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; color: black; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
    .red-btn { background: #ff0000; color: yellow; }
    .yellow-btn { background-color: yellow; color: black; }
    #remove-from-list-btn { position: fixed; bottom: 130px; right: 50px; z-index: 3; }
    #history-toggle-btn { position: fixed; bottom: 80px; right: 50px; z-index: 3; background-color: white; color: blue; font-weight: bold; }
    #share-button { position: fixed; bottom: 30px; right: 15px; z-index: 3; background-color: green; color: white; padding: 0.5em 1em; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; animation: pulse-share 1.5s ease-in-out infinite; }
    #share-button:active { box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); animation: none; }
    #history-page { display: none; } /* Poƒçetno sakriveno */

    /* --- STICKY HEADER STYLES --- */
    #history-sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; padding: 0.5em 1em; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    #history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5em; }
    /* --- END STICKY HEADER STYLES --- */

    #history-header h1 { margin: 0; text-align: center; flex-grow: 1; font-size: 1.3em; }
    #back-to-scanner-btn { background-color: green; color: white; border: none; font-weight: bold; margin: 0; padding: 0.4em 0.8em; font-size: 0.9em; cursor: pointer; }
    #back-to-scanner-btn:active { background-color: darkgreen; }

    /* history-content sada treba zauzeti ostatak prostora i skrolati */
    #history-content { flex-grow: 1; overflow-y: auto; padding: 1em; position: relative; }

     /* Stilovi za liste unutar history-content ostaju isti */
     #scan-group-list, #all-days-list-rendered, #search-results ul, #search-results-all-days ul { list-style: none; padding: 0; margin: 0; }
     #scan-group-list li, #all-days-list-rendered li, #search-results li, #search-results-all-days li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease; }
     #scan-group-list li:hover, #all-days-list-rendered li:hover, #search-results li:hover, #search-results-all-days li:hover { background-color: #efefef; }
     .scan-group-last-qr-time { font-size: 0.8em; color: #777; margin-left: 15px; flex-shrink: 0; }
     .session-name-history { font-size: 1em; color: #00008B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
     .scan-time-history { font-size: 1em; color: #333; white-space: nowrap; margin-left: 5px; }
     #clear-history-btn.confirm-mode, #delete-session-btn.confirm-mode, #clear-day-btn.confirm-mode { background-color: yellow; color: black; }
     #detail-scan-list { list-style: none; padding: 0; margin: 0; }
     #detail-scan-list li {display: flex; justify-content: space-between; align-items: center; padding: 0.6em 0.2em; border-bottom: 1px solid #eee; font-size: 1.05em;}
     #detail-scan-list li:last-child { border-bottom: none; }

     /* Pretraga SVI DANI - sada unutar sticky headera */
     #all-days-search-container { background-color: white; padding: 0.5em 0; margin-bottom: 0.2em; }
     #all-days-search-container input { flex-grow: 1; padding: 0.5em; min-width: 50px; font-size: 0.9em; }
     #all-days-search-container button { padding: 0.5em 0.6em; font-size: 0.9em; flex-shrink: 0; }

     /* Pretraga JEDAN DAN - sada unutar sticky headera */
      #search-container { display: none; padding: 1em 0; margin-bottom: 1em; }
      #search-container > div:first-child { display: flex; gap: 10px; margin-bottom: 0.8em; }
      #search-summary-info-day { display: none; justify-content: space-between; align-items: center; padding: 0.6em 0; font-size: 1.1em; margin-top: 0.8em; border-top: 1px solid #eee; }
      #search-results { /* Ovaj div OSTAJE u #history-content */ }

     /* Stilovi za prikaz dana/sesija u listi ostaju isti */
     #all-days-list-rendered li { background-color: #f0f0f0; border: 1px solid #ccc; padding: 12px 15px; margin-bottom: 8px; }
     #all-days-list-rendered li:hover { background-color: #e0e0e0; }

     /* Sa≈æetak i info elementi - unutar sticky headera */
     #all-days-summary-info, #history-date-info, #history-summary-info, #detail-header-info, #detail-summary-info, #search-summary-info-day, #all-days-search-container { padding: 0.6em 0; margin-bottom: 0.5em; border-top: 1px solid #eee; }
    /* Uklanjanje gornje linije za prvi element u dynamic headeru */
     #history-dynamic-header-content > *:first-child { border-top: none; padding-top: 0; }

     /* Specifiƒçni stilovi koji overrideaju gornje */
     #all-days-summary-info, #search-summary-info-day { display: none; justify-content: space-between; align-items: center; font-size: 1.1em; }
     #history-date-info, #history-summary-info, #detail-summary-info { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
     #detail-header-info { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.5em; border-bottom: 1px solid #ccc; border-top: none; }
     #detail-summary-info { border-top: none; }
     #all-days-search-container { padding-bottom: 0.2em; border-bottom: 1px solid #eee; }
     #search-container { display: none; border-bottom: 1px solid #eee; }

    /* --- NOVI STILOVI --- */
    #running-text-container { position: absolute; top: 4.8em; left: 0; width: 100%; overflow: hidden; white-space: nowrap; z-index: 2; pointer-events: none; display: none; }
    #running-text-container span {
      display: inline-block;
      padding-left: 100%; /* Ovo ostaje da se tekst pomiƒçe preko cijelog ekrana */
      font-size: 1.4em;
      font-weight: bold;
      color: yellow;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
      /* animation: marquee 25s linear infinite;  <-- IZBRI≈†I OVU LINIJU - TRAJANJE SE SADA POSTAVLJA U JS-U */
      white-space: pre; /* <<< DODANA OVA LINIJA */
    }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    #share-prompt-overlay {
        position: absolute;
        top: 7em;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: auto;
        background-color: rgba(0, 0, 0, 0.75);
        color: lightgreen;
        font-size: 1.3em;
        font-weight: bold;
        text-align: center;
        padding: 1.5em 1em;
        border-radius: 10px;
        z-index: 4;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        line-height: 1.4;
        align-items: center;
        justify-content: center;
    }
    /* IZMJENA: Uklonjena pozadina kvaƒçice */
    #counter-deactivated-indicator { position: fixed; top: 10px; left: 10px; font-size: 1em; color: limegreen; background-color: transparent; z-index: 5; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

    /* NOVI Stil za gumb za promjenu kamere */
    #switch-camera-btn {
        position: fixed; /* Zaljepljen za ekran */
        top: 10px;       /* Udaljenost od vrha */
        right: 10px;     /* Udaljenost od desnog ruba */
        z-index: 5;      /* Iznad #reader, ali ispod nekih poruka mo≈æda */
        padding: 6px 8px; /* Malo veƒái padding */
        background-color: rgba(0, 0, 0, 0.5); /* Poluprozirna pozadina */
        color: white;
        border: none;
        border-radius: 50%; /* Okrugli gumb */
        font-size: 1.4em;  /* Veliƒçina ikonice */
        line-height: 1;    /* Da ikonica bude centrirana */
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        display: none; /* Poƒçetno skriven, JS ga prikazuje */
    }
    #switch-camera-btn:active {
        background-color: rgba(0, 0, 0, 0.7);
    }

    /* NOVI Stil za overlay s popisom kamera */
    #camera-selection-overlay {
        position: fixed; /* Zaljepljen za ekran */
        top: 55px;       /* Ispod gumba (prilagodi ako treba) */
        right: 10px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 6;      /* Iznad gumba */
        padding: 5px 0; /* Gore/dolje padding */
        display: none;   /* Poƒçetno skriven */
        max-height: 150px; /* Ograniƒçenje visine ako ima puno kamera */
        overflow-y: auto; /* Scroll ako treba */
        min-width: 150px; /* Minimalna ≈°irina */
    }
    #camera-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #camera-list li {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #camera-list li:hover {
        background-color: #f0f0f0;
    }
    #camera-list li.selected-camera { /* Opcionalno: za oznaƒçavanje trenutne */
        font-weight: bold;
        background-color: #e0e0e0;
    }

    /* --- MANUAL ENTRY MODAL CSS --- */
    #manual-entry-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 100; /* Visok z-index da bude iznad svega */
        display: none; /* Sakrij po defaultu */
        justify-content: center;
        align-items: center;
    }

    #manual-entry-modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        max-width: 90%;
        width: 300px;
        text-align: center;
    }

    #manual-entry-modal-content input[type="text"] {
         width: calc(100% - 20px); /* Adjust width calculation */
         padding: 8px;
         border: 1px solid #ccc;
         border-radius: 4px;
         font-size: 1em;
         box-sizing: border-box; /* Ensure padding is included in width */
    }

    #manual-entry-modal-content label {
         display: block;
         margin-bottom: 5px;
         font-weight: bold;
         text-align: left; /* Align labels to the left */
    }


    #manual-entry-modal-content div {
        margin-bottom: 15px;
        text-align: left; /* Align input containers to the left */
    }

    #manual-entry-modal-content div:last-child {
         margin-bottom: 0; /* No bottom margin for the button container */
         text-align: center; /* Center buttons */
    }


    #manual-entry-modal-content button {
         padding: 10px 15px;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         font-weight: bold;
         font-size: 1em;
         box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
     #manual-entry-modal-content button:active {
         box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
     }

    #manual-entry-modal-content button#manual-add-btn {
        background-color: green;
        color: white;
    }

    #manual-entry-modal-content button#manual-cancel-btn {
        background-color: #dc3545;
        color: white;
    }

    #manual-entry-error {
        color: red;
        font-size: 0.9em;
        margin-top: 10px;
        display: none;
    }
    /* --- END MANUAL ENTRY MODAL CSS --- */

    /* Ensure the import file input is hidden by default */
    #import-file-input {
        display: none;
    }


    /* Uklanjamo JS animaciju za duplicate-warning i oslanjamo se samo na CSS ako postoji */
    /* @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } } */
    /* Animacija za loaded-message ostaje ista */
    @keyframes zoomFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    @keyframes pulse-share { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }

    /* Removed pulse-error keyframes as they are not used by manual-entry-btn anymore */

  </style>
</head>
<body class="scanner-view">

  <div id="counter-deactivated-indicator" style="display: none;">‚úî</div>
  <div id="header">QR Skener-Kalkulator</div>
  <div id="scan-instruction">Pozicioniraj qr kod unutar kvadrata kamere</div>
  <div id="running-text-container" style="display: none;"><span></span></div>
  <div id="share-prompt-overlay" style="display: none;">KLIKNI ZELENI GUMB<br>I PODIJELI RAƒåUNATOR<br>PORUKA ƒÜE NESTATI</div>

  <div id="reader"></div>

  <!-- NOVI ELEMENTI za odabir kamere -->
  <button id="switch-camera-btn" style="display: none;">üîÑ</button>
  <div id="camera-selection-overlay" style="display: none;">
      <ul id="camera-list"></ul>
  </div>
  <!-- KRAJ NOVIH ELEMENATA -->

  <!-- Poruke UƒåITANO i DUPLIKAT - koristimo iste DOM elemente -->
  <div id="loaded-message" style="display: none;">UƒåITANO</div>
  <div id="duplicate-warning" style="display: none;">TAJ RAƒåUN JE URAƒåUNAT</div>
  <!-- Kraj poruka -->

  <div id="total-container"> <div id="total">UKUPNO: 0.00 ‚Ç¨</div> <button id="ocisti-button" onclick="startOcistiConfirm()" style="display: none;">SPREMI<br>I OƒåISTI</button> </div>

  <!-- MODIFIED session-name-container -->
  <div id="session-name-container">
      <!-- Wrapper za elemente naziva sesije -->
      <div id="session-name-wrapper">
          <button id="add-name-btn" onclick="startAddName()">DODAJ NAZIV</button>
          <input type="text" id="session-name-input" placeholder="Unesi naziv sesije..." maxlength="30">
          <span id="session-name-display">
              <span id="session-name-text"></span>
              <span class="edit-icon" onclick="startAddName()">Uredi</span>
          </span>
      </div>
      <!-- NOVI GUMB: Ruƒçni unos -->
      <button id="manual-entry-btn">SAM UPI≈†I RAƒå:</button>
  </div>
  <!-- END MODIFIED session-name-container -->


  <div id="invoice-count">0 RAƒåUNA</div>
  <div id="history" style="display: none;"> <ul id="historyList"></ul> </div>
  <button class="red-btn" id="remove-from-list-btn" onclick="startRemoveFromList()" style="display:none;">Obri≈°i iz liste</button>
  <button id="history-toggle-btn">POVIJEST</button>
  <button id="share-button" style="display: none;">DIJELI RAƒåUNATOR</button>
  <div id="delete-warning" style="display: none;"></div>

  <div id="history-page">
      <div id="history-sticky-header">
          <div id="history-header"> <button id="back-to-scanner-btn">< NA SKENER</button> <h1>POVIJEST</h1> </div>
          <div id="history-dynamic-header-content"></div>
      </div>
      <div id="history-content"></div>
  </div>

  <!-- Manual Entry Modal -->
  <div id="manual-entry-modal-overlay" style="display: none;">
      <div id="manual-entry-modal-content">
          <h3 style="margin-top: 0; color: #333;">Ruƒçni unos raƒçuna</h3>
          <div style="margin-bottom: 15px;">
              <label for="manual-amount-input">Iznos (‚Ç¨):</label>
              <input type="text" id="manual-amount-input" placeholder="npr. 15,99 ili 25.00">
          </div>
          <div style="margin-bottom: 20px;">
              <label for="manual-time-input">Vrijeme (HH:MM - opcionalno):</label>
              <input type="text" id="manual-time-input" placeholder="npr. 14:35" pattern="^([0-1]?\d|2[0-3]):([0-5]?\d)$">
          </div>
          <div style="display: flex; justify-content: space-around; gap: 10px;">
              <button id="manual-add-btn">Dodaj raƒçun</button>
              <button id="manual-cancel-btn">Odustani</button>
          </div>
           <p id="manual-entry-error" style="color: red; font-size: 0.9em; margin-top: 10px; display: none;"></p>
      </div>
  </div>
  <!-- End Manual Entry Modal -->

  <!-- Element za odabir datoteke kod uvoza (skriven) -->
  <input type="file" id="import-file-input" accept=".json">
  <!-- Kraj elementa za uvoz -->


  <!-- A≈ΩURIRANI AUDIO TAGOVI S VA≈†IM DATOTEKAMA S GITHUBa -->
  <audio id="scan-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/Uƒçitano.mp3" preload="auto"></audio>
  <audio id="click-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/click8.mp3" preload="auto"></audio>
  <audio id="remove-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/smeƒçe.mp3" preload="auto"></audio>
  <audio id="error-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/error.mp3" preload="auto"></audio>
  <!-- ISPRAVLJENA PUTANJA ZA ƒåi≈°ƒáenje.mp3 -->
  <audio id="clear-session-sound" src="https://raw.githubusercontent.com/Soboslikar/QR-RACUNATOR/main/ƒåi≈°ƒçenje.mp3" preload="auto"></audio>


  <script>
    // *** GLOBALNE VARIJABLE I KONSTANTE ***
    const MAX_HISTORY_ITEMS = 500;
    const HISTORY_STORAGE_KEY = 'qrCalculatorHistory';
    const COUNTER_KEY = 'qrCalculatorCounter';
    const COUNTER2_KEY = 'qrCalculatorCounter2';
    const COUNTER_ACTIVE_KEY = 'qrCalculatorCounterActive';
    // A≈ΩURIRAN URL S NOVIM KOJI SI POSLAO
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCM5SreGB0O-YjGW_xzyxtiYeV9fhn0jyN5vFEYjfBBd5IAj5E96SF2Jh2bGMMqcnA/exec'; // <-- DODANO/IZMIJENJENO: Ispravljen URL
    const CAMERA_ID_KEY = 'qrCalculatorSelectedCameraID'; // OSIGURANO DA JE GLOBALNO DEFINIRANO

    let ukupno = 0;
    let povijest = [];
    let removeConfirm = false;
    let ocistiConfirm = false;
    const removeBtnInitialText = 'Obri≈°i iz liste';
    const ocistiBtnInitialText = 'SPREMI<br>I OƒåISTI';
    const ocistiConfirmText = 'POTVRDI<br>SPREMANJE?';
    let html5QrCodeInstance = null;
    let isScannerActive = false;
    // DODANO: Varijabla za spremanje popisa dostupnih kamera
    let availableCameras = [];
    let visibilityListenerAttached = false;
    let currentSessionName = null;
    let removeNameConfirm = false;
    let currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0, 0, 0, 0);
    let previousHistoryViewState = 'day-view';
    let lastSearchTerm = '';
    let brojac = 0;
    let brojac2 = 0;
    let tekstPoruka = "";
    let isCounterDecrementActive = true;

    // Kljuƒçevi za localStorage za UserID i nesaƒçuvano sesiju
    const USER_ID_KEY = 'qrCalculatorUserID';
    const FIRST_USE_KEY = 'qrCalculatorFirstUseTimestamp';
    const UNSAVED_COUNT_KEY = 'qrCalculatorUnsavedCount';
    const UNSAVED_AMOUNT_KEY = 'qrCalculatorUnsavedAmount';

    // Placeholderi za ID i prvi timestamp
    let currentUserID = null;
    let firstUseTimestamp = null;

    // DOM Elementi (Ukljuƒçujuƒái nove za Ruƒçni unos i Import file input) - Deklarirani globalno, vrijednosti dobivaju u DOMContentLoaded
    let totalDiv, totalContainer, ocistiButton, invoiceCountDiv, historyList, removeButton, duplicateWarning, loadedMsg, instructionDiv, deleteWarningDiv, shareButton, readerDiv, historyToggleButton, historyDiv, historyPageDiv, backToScannerButton, historyContentDiv, sessionNameContainer, addNameBtn, sessionNameInput, sessionNameDisplay, sessionNameText, historyStickyHeaderDiv, historyDynamicHeaderContentDiv, runningTextContainer, runningTextSpan, sharePromptOverlay, counterDeactivatedIndicator;
    // NOVI DOM Elementi za kameru
    let switchCameraButton, cameraSelectionOverlay, cameraListUl;
    // NOVI DOM Elementi za Ruƒçni unos
    let manualEntryBtn, manualEntryModalOverlay, manualAmountInput, manualTimeInput, manualAddBtn, manualCancelBtn, manualEntryErrorMsg;
    // NOVI DOM Element za Import file input
    let importFileInput;

    // --- VARIJABLE ZA KONTROLU ZVUKOVA, PORUKA I LOGOVA ---
    let errorSoundCooldown = false; // Flag za sprijeƒçavanje prebrzog ponavljanja error zvuka (0.5s cooldown)
    let ignoreErrorSoundUntil = 0; // Timestamp do kojeg ignoriramo error zvuk i poruku nakon uspje≈°nog skena (2s delay)
    let messageTimeoutId = null; // ID timeouta za poruku "UƒåITANO" ili "DUPLIKAT"

    // NOVO: Cooldown za slanje duplicate logova (neovisno o zvuku/poruci, ali aktivira se kad bi se inaƒçe pustio zvuk/poruka)
    let ignoreDuplicateLogUntil = 0;
    const DUPLICATE_LOG_COOLDOWN = 5000; // Logiraj duplikat max jednom svakih 5 sekundi
    // -----------------------------------

    // *** POMOƒÜNE I UI FUNKCIJE (PREMJE≈†TENE GORE) ***

    // Funkcija za reprodukciju zvukova
    function playSound(id) {
        // Posebno rukovanje za error zvuk zbog cool down logike
        if (id === 'error-sound') {
            if (errorSoundCooldown) {
                // console.log("Error sound on cooldown, skipping."); // KOMENTIRANO: Previ≈°e logova
                return; // Ne sviraj ako je na cooldownu
            }
            // Postavi cooldown prije sviranja zvuka
            errorSoundCooldown = true;
            setTimeout(() => {
                errorSoundCooldown = false;
                // console.log("Error sound cooldown ended."); // KOMENTIRANO: Previ≈°e logova
            }, 500); // 0.5 sekundi cooldown
        }

        const sound = document.getElementById(id);
        if (sound) {
            // Uvijeravamo se da je zvuk u potpunosti zaustavljen i resetiran prije ponovnog sviranja
            sound.pause();
            sound.currentTime = 0;
            // play() vraƒáa Promise, handlamo potentialne gre≈°ke (npr. autoplay policy)
            sound.play().catch(error => {
                // Ignoriraj specificne gre≈°ke koje se javljaju zbog browser politika (npr. autoplay)
                // 'NotAllowedError' je ƒçest ako korisnik nije jo≈° interagriao sa stranicom
                // 'AbortError' se mo≈æe dogoditi ako je zvuk pauziran prije nego je poƒçeo svirati
                if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') {
                    console.warn(`Zvuk "${id}" gre≈°ka:`, error);
                }
            });
        } else {
            console.warn(`Audio element "${id}" nije pronaƒëen.`);
        }
    }

    // Funkcija za prikaz privremenih poruka
    function showTemporaryMessage(messageElement, messageText, duration = 1500) {
        if (!messageElement) return;

        // Clear any existing timeout before setting a new one specific to this message mechanism
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
            messageTimeoutId = null;
        }

        messageElement.innerText = messageText;
        messageElement.style.display = 'block';

        // Reset i pokretanje animacije
        messageElement.style.animation = 'none';
        // Koristimo requestAnimationFrame za osiguravanje reflowa prije restarta animacije
        requestAnimationFrame(() => {
             messageElement.offsetHeight; // Trigger reflow
             // Koristimo zoomFade animaciju samo za loadedMsg
             if (messageElement.id === 'loaded-message') {
                 messageElement.style.animation = 'zoomFade 1s ease-out';
             }
             // Za duplicateWarning, oslanjamo se samo na CSS animaciju (ako postoji) ili bez nje
             // NEMA forisranog JS restarta animacije ovdje
             if (messageElement.id === 'duplicate-warning') {
                 // Nema specifiƒçne JS animacije ovdje, oslanjamo se na CSS ako je definirana i uklonjenu gornju liniju
             }
        });


        // Store the timeout ID to hide the message
        messageTimeoutId = setTimeout(() => {
            // Provjeravamo da je element jo≈° uvijek onaj koji ≈æelimo sakriti
            // i da je tekst jo≈° uvijek isti (da ga druga poruka nije u meƒëuvremenu pregazila)
            if (messageElement && messageElement.innerText === messageText) {
                messageElement.style.display = 'none';
                messageTimeoutId = null; // Clear ID after execution
            }
        }, duration);
    }

    // Funkcija za a≈æuriranje prikaza indikatora deaktiviranog brojaƒça
    function updateDeactivatedIndicator() {
         const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex';
         if (counterDeactivatedIndicator) {
             counterDeactivatedIndicator.style.display = (!isCounterDecrementActive && document.body.classList.contains('scanner-view') && !isManualEntryModalOpen) ? 'block' : 'none';
         }
    }

    // Funkcija za provjeru i prikaz share prompta
    function checkSharePrompt() {
         const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex';
         const shouldShowPrompt = brojac === 0 && brojac2 > 0 &&
                                   !isManualEntryModalOpen && // NE prikazuj ako je modal otvoren
                                   document.body.classList.contains('scanner-view');
         if (sharePromptOverlay) {
             sharePromptOverlay.style.display = shouldShowPrompt ? 'flex' : 'none';
             updateRunningTextVisibility(); // A≈æuriraj i tekst koji trƒçi (jer share prompt utjeƒçe na njegovu vidljivost)
         }
    }

    // Funkcija za a≈æuriranje vidljivosti trƒçeƒáeg teksta
    function updateRunningTextVisibility() {
         // console.log("updateRunningTextVisibility: Pokrenuto."); // KOMENTIRANO: Previ≈°e logova
         const isManualEntryModalOpen = manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex';
         const shouldShowText = tekstPoruka && // Prikazuj samo ako ima teksta
                                (!sharePromptOverlay || sharePromptOverlay.style.display === 'none') && // I ako share prompt nije vidljiv
                                !isManualEntryModalOpen && // I ako modal za ruƒçni unos nije otvoren
                                document.body.classList.contains('scanner-view'); // I ako smo u prikazu skenera
         // console.log(`updateRunningTextVisibility: shouldShowText = ${shouldShowText} (Tekst: ${!!tekstPoruka}, SharePrompt hidden: ${!sharePromptOverlay || sharePromptOverlay.style.display === 'none'}, ManualModal open: ${isManualEntryModalOpen}, ScannerView: ${document.body.classList.contains('scanner-view')})`); // KOMENTIRANO: Previ≈°e logova

         if (runningTextContainer) {
             const currentDisplay = runningTextContainer.style.display;
             const newDisplay = shouldShowText ? 'block' : 'none';

             // Mijenjaj display samo ako je potrebno
             if (currentDisplay !== newDisplay) {
                 runningTextContainer.style.display = newDisplay;
                 // console.log(`updateRunningTextVisibility: Promijenjen display kontejnera na: ${newDisplay}`); // KOMENTIRANO: Previ≈°e logova
             } else {
                  // console.log("updateRunningTextVisibility: Display kontejnera nije promijenjen."); // KOMENTIRANO: Previ≈°e logova
             }

             // Uklonjen: Kod za forsiranje ponovnog pokretanja animacije.
             // Animacija i njeno trajanje se sada postavljaju samo u updateRunningText().
         } else {
              console.error("updateRunningTextVisibility: Nedostaje DOM element #running-text-container."); // Ostavljen kritiƒçan log
         }
     }


    // Funkcija za a≈æuriranje trƒçeƒáeg teksta i izraƒçun trajanja animacije
    function updateRunningText() {
         // console.log("updateRunningText: Pokrenuto."); // KOMENTIRANO: Previ≈°e logova

         if (!runningTextSpan || !runningTextContainer) {
              console.error("updateRunningText: Nedostaju DOM elementi."); // Ostavljen kritiƒçan log
              return;
         }

         const text = tekstPoruka;

         // Uvijek resetiraj animaciju prije potencijalnog skrivanja ili promjene teksta/trajanja
         runningTextSpan.style.animation = 'none';
         runningTextSpan.style.transform = 'none'; // Resetiraj transformaciju za svaki sluƒçaj prije mjerenja

         if (!text) {
              // Ako nema teksta, osiguraj da je sve skriveno i zaustavi animaciju
              runningTextSpan.textContent = ''; // Oƒçisti tekstualni sadr≈æaj
              updateRunningTextVisibility(); // Sakrij kontejner (hendlano ovom funkcijom)
              return; // Izaƒëi, animacija nije potrebna
         }

         // Postavi tekstualni sadr≈æaj
         runningTextSpan.textContent = text;

         // Privremeno prika≈æi kontejner i span za mjerenje, ako nisu veƒá vidljivi
         // Ovo je potrebno kako bi offsetWidth vratio ispravnu vrijednost
         const initialContainerDisplay = runningTextContainer.style.display;
         const initialSpanDisplay = runningTextSpan.style.display;
         const wasHidden = runningTextContainer.style.display === 'none' || runningTextSpan.style.display === 'none';

         if (wasHidden) {
             // Da bi offsetWidth ispravno radio s padding-left: 100%, kontejner mora biti vidljiv.
             // Takoƒëer se pobrini da span unutra ima display koji omoguƒáava mjerenje ≈°irine (inline-block je u CSS-u, ali provjeravamo).
             const tempDisplay = runningTextContainer.style.display === 'none' ? 'block' : runningTextContainer.style.display; // Ako je bio 'none', postavi ga na 'block' privremeno
             runningTextContainer.style.display = tempDisplay;
             // Osiguraj da span ima display koji omoguƒáava offsetWidth (inline-block je iz CSS-a)
             runningTextSpan.style.display = 'inline-block'; // Ovo bi veƒá trebalo biti iz CSS-a, ali za svaki sluƒçaj
             // console.log("updateRunningText: Privremeno prikazujem za mjerenje."); // KOMENTIRANO: Previ≈°e logova
         }

         // Za forsiranje ponovnog iscrtavanja (reflow) preglednika
         // Ovo osigurava da je preglednik izraƒçunao novu ≈°irinu elementa nakon postavljanja teksta
         runningTextSpan.offsetHeight;


         // Izmjeri ≈°irinu span elementa *ukljuƒçujuƒái* padding-left: 100%.
         // Ova vrijednost *je* ukupna udaljenost koju animacija s translateX(-100%) pokriva.
         // (≈†irina elementa = ≈°irina teksta + padding-left + padding-right + borderi...)
         // S padding-left: 100% i bez drugih paddinga/bordera, ≈°irina elementa je
         // pribli≈æno ≈°irina tekstualnog sadr≈æaja + ≈°irina viewporta.
         const totalScrollDistance = runningTextSpan.offsetWidth;
         // console.log(`updateRunningText: Izmjerena ukupna ≈°irina (uklj. padding): ${totalScrollDistance}px`); // KOMENTIRANO: Previ≈°e logova


         // Vrati poƒçetno stanje prikaza kontejnera *prije* pozivanja updateRunningTextVisibility.
         // Ovo je kljuƒçno ako kontejner treba ostati skriven prema stanju aplikacije
         // nakon mjerenja. updateRunningTextVisibility ƒáe tada postaviti konaƒçno stanje prikaza.
         if (wasHidden) {
             runningTextContainer.style.display = initialContainerDisplay;
             runningTextSpan.style.display = initialSpanDisplay; // Vrati i display spana za svaki sluƒçaj, iako updateRunningTextVisibility kontrolira samo kontejner
             // console.log("updateRunningText: Vraƒáam poƒçetni prikaz nakon mjerenja."); // KOMENTIRANO: Previ≈°e logova
         }


         // ODREDI ≈ΩELJENU BRZINU U PIKSELIMA PO SEKUNDI
         const desiredSpeedPxPerSec = 40; // Prilagodi ovu vrijednost da tekst ide br≈æe ili sporije
         // console.log("updateRunningText: ≈Ωeljena brzina:", desiredSpeedPxPerSec, "px/s"); // KOMENTIRANO: Previ≈°e logova


         if (totalScrollDistance <= 0 || desiredSpeedPxPerSec <= 0) {
             console.warn("updateRunningText: Ukupna ≈°irina ili ≈æeljena brzina su nula/negativne, ne mogu izraƒçunati trajanje animacije."); // Ostavljen log upozorenja
             runningTextSpan.style.animation = 'none'; // Osiguraj da nema animacije
             updateRunningTextVisibility(); // A≈æuriraj prikaz kontejnera
             return;
         }

         // Izraƒçunaj trajanje animacije (u sekundama)
         // Trajanje = Ukupna udaljenost / Brzina
         const durationSeconds = totalScrollDistance / desiredSpeedPxPerSec;
         // console.log(`updateRunningText: Izraƒçunato trajanje animacije: ${durationSeconds.toFixed(2)}s`); // KOMENTIRANO: Previ≈°e logova


         // Ponovno primijeni animation svojstvo s izraƒçunatim trajanjem
         // Osiguraj da se animacija restartira. Resetirali smo je na 'none' na poƒçetku.
         // Sada je ponovno postavljamo. requestAnimationFrame mo≈æe pomoƒái osigurati reflow.
         runningTextSpan.style.animation = 'none'; // Ponovno resetiraj
         runningTextSpan.offsetHeight; // Forsiraj reflow
         runningTextSpan.style.animation = `marquee ${durationSeconds}s linear infinite`;


         // A≈æuriraj vidljivost kontejnera na temelju stanja aplikacije (tekst postoji, nije otvoren modal, nije vidljiv share prompt, itd.)
         updateRunningTextVisibility();
         // console.log("updateRunningText: Zavr≈°eno, pozvana updateRunningTextVisibility."); // KOMENTIRANO: Previ≈°e logova
    }


    // Pomoƒána funkcija za provjeru je li element ili roditelj skriven
     function isElementOrParentHidden(element) {
        if (!element) return true;
        // Uklonjeno provjeru element !== document.body jer body rijetko ima display: none,
        // a parentElement bi na kraju do≈°ao do body-a ili html-a ako ide skroz gore.
        while (element) {
            // Provjeri computedStyle kako bi se uzelo u obzir CSS pravila, a ne samo inline style
            if (window.getComputedStyle(element).display === 'none') {
                return true;
            }
            element = element.parentElement;
        }
        return false;
     }

     // Funkcija za dohvaƒáanje ISO stringa datuma
     function getISODateString(date) {
        if (!(date instanceof Date) || isNaN(date)) {
             console.error("getISODateString primio neispravan datum:", date); // Ostavljen kritiƒçan log
             return null;
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
     }

     // Funkcija za normalizaciju datuma za pretragu
    function normalizeDateForSearch(input) {
        if (!input || typeof input !== 'string') {
            return null;
        }
        const term = input.trim();

        // Poku≈°aj parsirati kao ISO format YYYY-MM-DD
        const isoMatch = term.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (isoMatch) {
            const year = parseInt(isoMatch[1], 10);
            const month = parseInt(isoMatch[2], 10) - 1; // Mjeseci u JS-u su 0-indexed
            const day = parseInt(isoMatch[3], 10);
            const date = new Date(year, month, day);
            // Provjeri je li parsed date ispravan i odgovara unesenim dijelovima
            if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                 // Vrati u YYYY-MM-DD formatu koristeƒái postojeƒáu helper funkciju ako je dostupna
                 return getISODateString(date); // Koristi va≈°u postojeƒáu funkciju
            }
        }

        // Poku≈°aj parsirati formate poput DD.MM.YYYY, D.M.YYYY, DD/MM/YYYY, D/M/YYYY, sa 2- or 4-znamenkastim godinama
        const dotSlashMatch = term.match(/^(\d{1,2})[.\/](\d{1,2})[.\/]((\d{4})|(\d{2}))$/);
        if (dotSlashMatch) {
            const day = parseInt(dotSlashMatch[1], 10);
            const month = parseInt(dotSlashMatch[2], 10) - 1; // Mjeseci u JS-u su 0-indexed
            let year = parseInt(dotSlashMatch[4] || dotSlashMatch[5], 10); // Uhvati 4-znamenkasti (group 4) ili 2-znamenkasti (group 5)

            // Obradi 2-znamenkastu godinu (npr. 25 postaje 2025)
            // Jednostavna pretpostavka: ako je godina < 100, dodaj 2000
            if (year < 100) {
                 year += 2000;
            }

            const date = new Date(year, month, day);
             // Osnovna provjera valjanosti datuma (npr. 31.02.2023 nije validan datum)
             // Takoƒëer provjeri da se kreirani datum podudara s unesenim dijelovima (zbog automatske korekcije od strane Date objekta)
            if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day && !isNaN(date.getTime())) {
                 // Vrati u YYYY-MM-DD formatu koristeƒái postojeƒáu helper funkciju
                 return getISODateString(date); // Koristi va≈°u postojeƒáu funkciju
            }
        }

        // Ako nijedan format nije prepoznat ili validan
        return null;
    }

    // Funkcija za parsiranje vremena iz stringa
    const parseTime = (timeStr) => {
         if (!timeStr || typeof timeStr !== 'string' || timeStr === '??:??' || timeStr.length !== 5 || timeStr[2] !== ':') return -1;
         const parts = timeStr.split(':');
         const hours = parseInt(parts[0], 10);
         const minutes = parseInt(parts[1], 10);
         if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return -1;
         return hours * 60 + minutes;
     };

    // Generisanje jednostavnog UUID-a
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Dobijanje ili kreiranje UserID i FirstUseTimestamp
    function initializeUserTracking() {
      currentUserID = localStorage.getItem(USER_ID_KEY);
      firstUseTimestamp = localStorage.getItem(FIRST_USE_KEY);

      if (!currentUserID) {
        console.log("Generiram novi UserID i FirstUseTimestamp.");
        currentUserID = generateUUID();
        firstUseTimestamp = new Date().toISOString();
        try {
          localStorage.setItem(USER_ID_KEY, currentUserID);
          localStorage.setItem(FIRST_USE_KEY, firstUseTimestamp);
        } catch (error) {
          console.error("Gre≈°ka spremanja UserID/FirstUse u localStorage:", error);
          currentUserID = 'localStorage_error_' + generateUUID(); // Fallback ID
          firstUseTimestamp = new Date().toISOString();
        }
      }
      console.log("UserID:", currentUserID, "FirstUse:", firstUseTimestamp);
    }


    // Funkcija za slanje log podataka
    async function sendLogData(eventData) {
      // console.log("Poku≈°avam poslati log:", eventData.Event); // KOMENTIRANO: Previ≈°e logova
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('URL_TVOJE_WEB_APLIKACIJE') || APPS_SCRIPT_URL.includes('AKfycbwCM5SreGB0O-YjGW_xzyxtYeV9fhn0jyN5vFEYjfBBd5IA5E96SF2Jh2bGMMcnA')) { // Dodana provjera i za stari URL
          console.warn("Logovanje onemoguƒáeno: APPS_SCRIPT_URL nije postavljen ili je neispravan.");
          return;
      }
      const dataToSend = {
          ...eventData,
          UserID: currentUserID,
          FirstUseTimestamp: firstUseTimestamp,
          Timestamp: new Date().toISOString(),
          Counter1: brojac,
          Counter2: brojac2,
          Active: isCounterDecrementActive,
          UserAgent: navigator.userAgent
      };
      console.log(`Poku≈°avam poslati log '${dataToSend.Event}'...`); // Ostavljen ovaj log
      try {
          const response = await fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors', // Va≈æno za Google Apps Script
              cache: 'no-cache',
              headers: {'Content-Type': 'application/json'}, // Iako no-cors, dobra praksa
              redirect: 'follow',
              body: JSON.stringify(dataToSend)
          });
          // Kod no-cors mode-a, response.ok i status su neupotrebljivi.
          // Provjeru uspjeha radi se u Apps Scriptu.
          console.log(`Log zahtev '${dataToSend.Event}' poslan (no-cors). Proverite Apps Script logove za potvrdu.`); // Ostavljen ovaj log
      } catch (error) {
          console.error(`Gre≈°ka prilikom slanja loga '${dataToSend.Event}':`, error); // Ostavljen log gre≈°ke
      }
    }

    // Funkcija za uƒçitavanje stanja brojaƒça iz lokalne pohrane
    function loadCountersState() {
        const storedBrojac = localStorage.getItem(COUNTER_KEY);
        const storedBrojac2 = localStorage.getItem(COUNTER2_KEY);
        const storedActive = localStorage.getItem(COUNTER_ACTIVE_KEY);
        brojac = storedBrojac !== null ? parseInt(storedBrojac, 10) : null;
        brojac2 = storedBrojac2 !== null ? parseInt(storedBrojac2, 0) : 0;
        isCounterDecrementActive = storedActive !== null ? (storedActive === 'true') : true;
        if (isNaN(brojac)) brojac = null;
        if (isNaN(brojac2)) brojac2 = 0;
        console.log("Uƒçitano stanje:", { brojac, brojac2, isCounterDecrementActive });
        // Uklonjen poziv updateDeactivatedIndicator() odavde, poziva se nakon ≈°to su DOM elementi dohvaƒáeni
    }
    // Funkcija za spremanje brojaƒça 1
    function saveBrojac() { localStorage.setItem(COUNTER_KEY, brojac); }
    // Funkcija za spremanje brojaƒça 2 (praga)
    function saveBrojac2() { localStorage.setItem(COUNTER2_KEY, brojac2); }
    // Funkcija za spremanje stanja aktivacije brojaƒça
    function saveCounterActiveState() { localStorage.setItem(COUNTER_ACTIVE_KEY, isCounterDecrementActive); }


    // Funkcija za provjeru vidljivosti gumba "SPREMI I OƒåISTI"
    function checkOcistiButtonVisibility() {
         if (!ocistiButton) return;
         ocistiButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none';
         if ((povijest.length === 0 && !currentSessionName) && ocistiConfirm) {
              resetOcistiMode(); // Resetiraj mod ako je sve prazno
         }
    }
    // Funkcija za a≈æuriranje prikaza ukupnog iznosa, broja raƒçuna i male povijesti
    function updateDisplay() {
         if (totalDiv) totalDiv.innerText = `UKUPNO: ${ukupno.toFixed(2)} ‚Ç¨`;
         const count = povijest.length;
         if (invoiceCountDiv) invoiceCountDiv.innerText = `${count} ${count === 1 ? 'RAƒåUN' : 'RAƒåUNA'}`;

         // A≈æuriraj samo malu povijest ako smo u scanner view
         if (document.body.classList.contains('scanner-view')) {
              updateSmallHistoryList();
              checkRemoveButtonVisibility(); // Provjeri vidljivost Remove gumba
              handleInfoDeleteMessageVisibility(); // A≈æuriraj info/delete poruku
              checkOcistiButtonVisibility(); // Provjeri vidljivost Ocisti gumba
              updateNameDisplay(); // A≈æuriraj prikaz naziva sesije
         }
         // U history viewu se prikaz povijesti renderira zasebnim funkcijama
    };

     // Funkcija za a≈æuriranje prikaza male povijesti u scanner viewu
    function updateSmallHistoryList() {
         if (!historyList || !historyDiv) return; // Check if elements exist

         if (povijest.length > 0) {
              historyDiv.style.display = 'block';
              historyList.innerHTML = ''; // Clear current list

              // Prikazi samo zadnjih nekoliko stavki ako ih ima puno, ili sve ako ih je malo
              // const startIndex = Math.max(0, povijest.length - 5); // Prikazi zadnjih 5
              // const recentHistory = povijest.slice(startIndex);
              const recentHistory = povijest; // Prikazi sve u maloj listi

              recentHistory.forEach((item, index) => {
                   const globalIndex = povijest.length - recentHistory.length + index; // Indeks u ukupnoj listi
                   const listItem = document.createElement('li');
                   // Ukloni QR code iz prikaza male liste, dodaj (ruƒçno) ako je manualni unos
                   const itemText = `${globalIndex + 1}. ${item.time} - ${item.amount.toFixed(2)} ‚Ç¨${item.qrCode.startsWith('MANUAL_') ? ' (ruƒçno)' : ''}`;
                   listItem.innerText = itemText;
                   // Opcionalno: dodaj title atribut za full text (ako se previ≈°e skrati)
                   // listItem.title = itemText;
                   historyList.appendChild(listItem);
              });

              // Scrollaj na dno liste ako ima scrollbar
              historyDiv.scrollTop = historyDiv.scrollHeight;

         } else {
              historyDiv.style.display = 'none'; // Sakrij listu ako je prazna
         }
    }

     // Funkcija za provjeru vidljivosti gumba "Obri≈°i iz liste"
     function checkRemoveButtonVisibility() {
         if (!removeButton) return;
         // Prikazi gumb ako ima raƒçuna U TRENUTNOJ SESIJI ili ako ima NAZIV SESIJE
         removeButton.style.display = (povijest.length > 0 || currentSessionName) ? 'block' : 'none';

         // Ako je povijest prazna i nema naziva, a gumb je u confirm modu, resetiraj ga
         if ((povijest.length === 0 && !currentSessionName) && (removeConfirm || removeNameConfirm)) {
              resetRemoveMode();
         }
     }

     // Funkcija za upravljanje prikazom info/delete poruke
     function handleInfoDeleteMessageVisibility() {
         const isScannerView = document.body.classList.contains('scanner-view');
         if (!deleteWarningDiv || !isScannerView) {
              if(deleteWarningDiv) deleteWarningDiv.style.display = 'none'; // Ensure hidden outside scanner view
              return;
         }

         let shouldDisplay = false;
         let textToShow = '';
         let modeClass = '';

         if (removeConfirm && povijest.length > 0) {
              // Mod potvrde brisanja zadnjeg raƒçuna
              const lastItem = povijest[povijest.length - 1];
              textToShow = `OBRI≈†I ${lastItem.time} = ${lastItem.amount.toFixed(2)} ‚Ç¨?`;
              modeClass = 'delete-mode';
              shouldDisplay = true;
         } else if (removeNameConfirm && currentSessionName) {
              // Mod potvrde brisanja naziva
              textToShow = `OBRI≈†I NAZIV "${currentSessionName}"?`;
              modeClass = 'delete-mode';
              shouldDisplay = true;
         } else if (!removeConfirm && !removeNameConfirm) {
              // Info mod (ni≈°ta za potvrditi brisanje)
              if (povijest.length > 0 && deleteWarningDiv.dataset.lastScanText) {
                   // Prikazi info o zadnjem skenu/ruƒçno dodanom raƒçunu
                   textToShow = deleteWarningDiv.dataset.lastScanText;
                   modeClass = 'info-mode';
                   shouldDisplay = true;
              } else if (povijest.length === 0 && currentSessionName && deleteWarningDiv.dataset.lastNameText) {
                  // Prikazi info o nazivu sesije ako nema raƒçuna
                  textToShow = deleteWarningDiv.dataset.lastNameText;
                  modeClass = 'info-mode';
                  shouldDisplay = true;
              }
               // Ako nema ni raƒçuna ni naziva, shouldDisplay ostaje false
         }


         if (shouldDisplay) {
              deleteWarningDiv.innerText = textToShow;
              deleteWarningDiv.className = `delete-warning ${modeClass}`; // Apply correct class
              deleteWarningDiv.style.display = 'block';
         } else {
              deleteWarningDiv.style.display = 'none';
         }
     }


    // *** FUNKCIJE ZA RESETIRANJE STANJA GUMBA (PREMJE≈†TENE GORE) ***
    function resetRemoveMode() {
        if (!removeButton) return; // Check if button exists

        removeButton.innerText = removeBtnInitialText;
        removeButton.classList.remove('yellow-btn');
        removeButton.classList.add('red-btn');
        removeConfirm = false;
        removeNameConfirm = false;

        // Vrati info tekst o zadnjem raƒçunu/nazivu nakon ≈°to se resetira confirm mode
        if (deleteWarningDiv) {
            if (deleteWarningDiv.dataset.beforeConfirmText) {
                deleteWarningDiv.dataset.lastScanText = deleteWarningDiv.dataset.beforeConfirmText;
                delete deleteWarningDiv.dataset.beforeConfirmText; // Ukloni privremeni spremljeni tekst
            } else if (deleteWarningDiv.dataset.beforeConfirmNameText) {
                 deleteWarningDiv.dataset.lastNameText = deleteWarningDiv.dataset.beforeConfirmNameText;
                 delete deleteWarningDiv.dataset.beforeConfirmNameText; // Ukloni privremeni spremljeni tekst naziva
            } else if (povijest.length === 0 && !currentSessionName) {
                 // Ako je sve prazno, osiguraj da nema ni info teksta
                 delete deleteWarningDiv.dataset.lastScanText;
                 delete deleteWarningDiv.dataset.lastNameText;
            }
        }
        handleInfoDeleteMessageVisibility(); // A≈æuriraj prikaz poruke odmah
        checkRemoveButtonVisibility(); // Ponovno provjeri vidljivost gumba
    }

    function resetOcistiMode() {
        if (!ocistiButton) return; // Check if button exists

        ocistiButton.innerHTML = ocistiBtnInitialText; // Restore initial text (SPREMI<br>I OƒåISTI)
        ocistiButton.classList.remove('confirm-mode');
        ocistiConfirm = false;

        checkOcistiButtonVisibility(); // Ponovno provjeri vidljivost gumba
    }

    // *** FUNKCIJE ZA NAZIV SESIJE (PREMJE≈†TENE GORE) ***
    function startAddName() {
        if (!addNameBtn || !sessionNameInput || !sessionNameDisplay || !document.body.classList.contains('scanner-view')) return;

         // Sakrij modal za ruƒçni unos ako je otvoren prije otvaranja name inputa
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }

        playSound('click-sound');
        addNameBtn.style.display = 'none';
        sessionNameDisplay.style.display = 'none'; // Sakrij display element
        sessionNameInput.style.display = 'block'; // Prikazi input polje
        sessionNameInput.value = currentSessionName || ''; // Postavi trenutni naziv (ili prazan string)
        sessionNameInput.focus(); // Fokusiraj input
        sessionNameInput.select(); // Selektiraj sav tekst unutar inputa radi lak≈°eg brisanja/izmjene
    }

    function saveName() {
        if (!sessionNameInput || !addNameBtn || !sessionNameDisplay || !sessionNameText) return;

        // Provjeri je li input polje za ime trenutno prikazano. Ako nije, ova funkcija je pozvana gre≈°kom (npr. blur event kad polje nije ni bilo vidljivo)
        if (sessionNameInput.style.display === 'none') {
             // console.log("saveName called but input was not visible. Skipping save."); // KOMENTIRANO: Previ≈°e logova
             return;
        }

        const inputText = sessionNameInput.value.trim();

        // Provjera cheat kodova
        if (inputText === "##--##") {
            showTemporaryMessage(loadedMsg, "RJE≈†ENO"); // Koristimo loadedMsg za ovu poruku
            isCounterDecrementActive = false;
            saveCounterActiveState();
            updateDeactivatedIndicator(); // A≈æuriraj indikator
            // Resetiraj input i sakrij ga
            sessionNameInput.value = '';
            sessionNameInput.style.display = 'none';
            // A≈æuriraj prikaz naziva sesije (sada prazno/gumb)
            updateNameDisplay();
            checkRemoveButtonVisibility(); // Provjeri vidljivost remove gumba (ako je bio samo naziv)
            // Dodano: Ukloni "obri≈°i naziv?" state ako je bio aktivan
            if(removeNameConfirm) resetRemoveMode();
             sendLogData({ Event: 'cheat_code_deactivate', Details: '##--##' });
            return;
        } else if (inputText === "##00##") {
            showTemporaryMessage(loadedMsg, "RESETIRANO"); // Koristimo loadedMsg za ovu poruku
            brojac = 0;
            brojac2 = 0;
            isCounterDecrementActive = true;
            saveBrojac();
            saveBrojac2();
            saveCounterActiveState();
            localStorage.removeItem(CAMERA_ID_KEY); // <<< RESETIRAJ KAMERU
            updateDeactivatedIndicator(); // A≈æuriraj indikator
             // Resetiraj input i sakrij ga
            sessionNameInput.value = '';
            sessionNameInput.style.display = 'none';
            // A≈æuriraj prikaz naziva sesije (sada prazno/gumb)
            updateNameDisplay();
            checkSharePrompt(); // Ponovno provjeri state (mo≈æda se prika≈æe prompt)
            updateRunningTextVisibility(); // A≈æuriraj vidljivost teksta koji trƒçi
            checkRemoveButtonVisibility(); // Provjeri vidljivost remove gumba (ako je bio samo naziv)
             // Dodano: Ukloni "obri≈°i naziv?" state ako je bio aktivan
            if(removeNameConfirm) resetRemoveMode();
            // Nema potrebe za restartom skenera ovdje, on ƒáe se inicijalizirati sa zadanim ID-jem pri sljedeƒáem prijelazu
             sendLogData({ Event: 'cheat_code_reset', Details: '##00##' });
            return;
        }


        const newName = inputText;
        const oldName = currentSessionName; // Spremi staro ime za logiranje
        currentSessionName = newName || null; // Ako je input prazan, postavi na null

         // A≈æuriraj dataset na deleteWarningDiv ako postoji
         if (deleteWarningDiv) {
             if (currentSessionName) {
                deleteWarningDiv.dataset.lastNameText = `NAZIV: "${currentSessionName}"`;
             } else {
                 delete deleteWarningDiv.dataset.lastNameText; // Ukloni ako nema naziva
             }
         }

        // Logiranje promjene naziva SAMO AKO SE IME STVARNO PROMIJENILO (dodano, uklonjeno, ili promijenjen tekst)
         if (oldName !== currentSessionName) {
             sendLogData({ Event: 'session_name_changed', Details: currentSessionName || 'removed' });
         }

        sessionNameInput.style.display = 'none'; // Sakrij input polje
        updateNameDisplay(); // A≈æuriraj prikaz
        checkRemoveButtonVisibility(); // Ponovno provjeri vidljivost gumba Remove (mo≈æda je dodan/uklonjen naziv)
        handleInfoDeleteMessageVisibility(); // A≈æuriraj prikaz info/delete poruke
    }

    function updateNameDisplay() {
        if (!addNameBtn || !sessionNameDisplay || !sessionNameText) return; // Check if elements exist

        if (currentSessionName) {
            sessionNameText.textContent = currentSessionName; // Postavi tekst
            sessionNameDisplay.style.display = 'flex'; // Prikazi display element
            addNameBtn.style.display = 'none'; // Sakrij gumb za dodavanje
        } else {
            sessionNameDisplay.style.display = 'none'; // Sakrij display element
            addNameBtn.style.display = 'block'; // Prikazi gumb za dodavanje
        }
    }

    // *** FUNKCIJE ZA UPRAVLJANJE TRENUTNOM SESIJOM SKENIRANJA (PREMJE≈†TENE GORE) ***
    function startRemoveFromList() {
         if (!removeButton || !document.body.classList.contains('scanner-view')) return; // Samo u scanner view

         // Sakrij modal za ruƒçni unos ako je otvoren prije interakcije s gumbom
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }

         if (removeNameConfirm) {
             // Potvrda brisanja NAZIVA SESIJE
             playSound('remove-sound'); // Zvuk na potvrdu brisanja naziva (smeƒáe.mp3)
             const oldName = currentSessionName; // Logiraj staro ime
             currentSessionName = null; // Bri≈°i naziv
             if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastNameText; // Ukloni tekst naziva iz info poruke
             resetRemoveMode(); // Resetira removeConfirm i removeNameConfirm
             updateNameDisplay(); // A≈æuriraj prikaz naziva (prikazat ƒáe gumb 'Dodaj Naziv')
             checkRemoveButtonVisibility(); // Ponovno provjeri vidljivost gumba nakon brisanja imena (mo≈æda ƒáe se sakriti ako vi≈°e nema ni raƒçuna)
              sendLogData({ Event: 'session_name_removed_confirmed', Details: oldName || 'N/A' }); // Logiranje brisanja naziva
             return;
         }

         if (removeConfirm) {
             // Potvrda brisanja ZADNJEG RAƒåUNA
             if (povijest.length > 0) {
                 const removed = povijest.pop(); // Ukloni zadnji raƒçun iz povijesti
                 ukupno -= removed.amount; // Oduzmi iz ukupnog iznosa
                 playSound('remove-sound'); // Zvuk na potvrdu brisanja raƒçuna iz liste (smeƒáe.mp3)

                  // Logiranje brisanja zadnjeg raƒçuna
                  const removedDetails = { amount: removed.amount, time: removed.time, isManual: removed.qrCode.startsWith('MANUAL_') };
                  sendLogData({ Event: 'last_invoice_removed_confirmed', Details: JSON.stringify(removedDetails) });


                 if (povijest.length === 0 && currentSessionName) {
                     // Posljednji raƒçun obrisan, ostao samo naziv - prebaci u mode brisanja naziva
                     removeButton.innerHTML = 'Obri≈°i<br>Naziv?'; // Promijeni tekst gumba
                     removeButton.classList.remove('red-btn');
                     removeButton.classList.add('yellow-btn');
                     removeConfirm = false; // Vi≈°e nismo u modu brisanja raƒçuna
                     removeNameConfirm = true; // Sada smo u modu brisanja naziva
                     if (deleteWarningDiv) { delete deleteWarningDiv.dataset.lastScanText; deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; } // Spremi info tekst prije promjene na confirm message
                     handleInfoDeleteMessageVisibility(); // A≈æuriraj prikaz poruke
                 } else {
                     // Ostalo je jo≈° raƒçuna ili nije ni bilo naziva - ostaje u modu brisanja raƒçuna ili se resetira
                     if (povijest.length > 0) {
                         const lastItem = povijest[povijest.length - 1];
                         if (deleteWarningDiv) deleteWarningDiv.dataset.lastScanText = `ZADNJI RAƒåUN: ${lastItem.time} = ${lastItem.amount.toFixed(2)} ‚Ç¨`;
                     } else {
                         // Povijest je sada prazna
                         if (deleteWarningDiv) delete deleteWarningDiv.dataset.lastScanText;
                     }
                     resetRemoveMode(); // Resetira removeConfirm i handleInfoDeleteMessageVisibility
                 }
             } else {
                 // Ako je povijest veƒá bila prazna, a bio je u confirm modu (ne bi se trebalo dogoditi s provjerom na gumbu)
                 resetRemoveMode();
                 console.warn("Pokliknut Obri≈°i gumb, ali nema raƒçuna ni naziva."); // Ostavljen log upozorenja
             }
             updateDisplay(); // A≈æuriraj prikaz (ukupno, broj raƒçuna, mala povijest)
             return; // Zavr≈°i funkciju nakon potvrde
         }

         // Prvi klik na "Obri≈°i iz liste" ili "Obri≈°i Naziv?"
         if (povijest.length > 0) {
             // Ima raƒçuna - preƒëi u mod potvrde brisanja zadnjeg raƒçuna
             playSound('click-sound'); // Zvuk na prvi klik za potvrdu brisanja sa liste
             removeButton.innerText = 'Potvrdi'; // Promijeni tekst gumba
             removeButton.classList.remove('red-btn');
             removeButton.classList.add('yellow-btn');
             removeConfirm = true; // Postavi removeConfirm na true
             removeNameConfirm = false; // Osiguraj da removeNameConfirm bude false
             if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmText = deleteWarningDiv.dataset.lastScanText; // Spremi info tekst prije promjene na confirm message
             handleInfoDeleteMessageVisibility(); // A≈æuriraj prikaz poruke
              sendLogData({ Event: 'last_invoice_remove_prompt' }); // Logiranje poku≈°aja brisanja zadnjeg raƒçuna
         } else if (currentSessionName) {
             // Nema raƒçuna, ali ima naziv - preƒëi u mod potvrde brisanja naziva
             playSound('click-sound'); // Zvuk na prvi klik za potvrdu brisanja naziva
             removeButton.innerHTML = 'Obri≈°i<br>Naziv?'; // Promijeni tekst gumba
             removeButton.classList.remove('red-btn');
             removeButton.classList.add('yellow-btn');
             removeConfirm = false; // Osiguraj da removeConfirm bude false
             removeNameConfirm = true; // Postavi removeNameConfirm na true
             if (deleteWarningDiv) deleteWarningDiv.dataset.beforeConfirmNameText = deleteWarningDiv.innerText; // Spremi info tekst naziva prije promjene na confirm message
             handleInfoDeleteMessageVisibility(); // A≈æuriraj prikaz poruke
              sendLogData({ Event: 'session_name_remove_prompt' }); // Logiranje poku≈°aja brisanja naziva
         } else {
             // Ako je povijest prazna i nema naziva, gumb bi trebao biti skriven (provjera u checkRemoveButtonVisibility),
             // ali za svaki sluƒçaj, ako je nekako kliknut, resetiraj mod.
              resetRemoveMode();
              console.warn("Pokliknut Obri≈°i gumb, ali nema raƒçuna ni naziva (gumb bi trebao biti skriven)."); // Ostavljen log upozorenja
         }
    }


    function startOcistiConfirm() {
        if (!ocistiButton || !document.body.classList.contains('scanner-view')) return; // Samo u scanner view

         // Sakrij modal za ruƒçni unos ako je otvoren prije interakcije s gumbom
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }

        if (!ocistiConfirm) {
            // Ovo je prvi klik - prelazak u mod potvrde
            ocistiButton.innerHTML = ocistiConfirmText;
            ocistiButton.classList.add('confirm-mode');
            ocistiConfirm = true;
            // playSound('click-sound'); // Zvuk prvog klika je uklonjen prema zahtjevu
             sendLogData({ Event: 'save_session_prompt' }); // Logiranje poku≈°aja spremanja
        } else {
            // Ovo je drugi klik - POTVRDA spremanja/ƒçi≈°ƒáenja
            ocistiTrenutnoSkeniranje(); // Ova funkcija ne svira zvuk, samo sprema i resetira varijable
            resetOcistiMode(); // Resetira stanje gumb≈° *PRIJE* zvuka
            playSound('clear-session-sound'); // ZVUK NA POTVRDU SPREMANJA/ƒåI≈†ƒÜENJA (ƒçi≈°ƒáenje.mp3) - sada je ovdje
        }
    }

    // Funkcija za spremanje trenutne sesije u povijest i ƒçi≈°ƒáenje
    function ocistiTrenutnoSkeniranje() {
        if (povijest.length === 0 && !currentSessionName) {
             console.warn("Poku≈°aj spremanja prazne sesije."); // Ostavljen log upozorenja
             return;
        }

        const vrijemeCiscenja = Date.now(); // Timestamp spremanja grupe
        // Sortiraj raƒçune po vremenu skena (ili po vremenu ruƒçnog unosa) da budu kronolo≈°ki unutar sesije
        const sortiraniRacuniZaSpremanje = [...povijest].sort((a, b) => {
             // Prvo usporedi po vremenu ako su validna, inaƒçe po scanTimestamp
             const timeA = parseTime(a.time);
             const timeB = parseTime(b.time);

             if (timeA !== -1 && timeB !== -1) {
                 return timeA - timeB;
             }
             if (timeA === -1 && timeB !== -1) return -1; // a ide prije b ako a nema vrijeme, a b ima
             if (timeA !== -1 && timeB === -1) return 1; // b ide prije a ako b nema vrijeme, a a ima

             // Ako oba nemaju validno vrijeme, sortiraj po scanTimestamp (vrijeme dodavanja)
             return (a.scanTimestamp || 0) - (b.scanTimestamp || 0);
         });


        // Pronaƒëi zadnje validno vrijeme iz sortirane liste za lastQrTime grupe
        let zadnjeValidnoVrijemeIzSortiraneListe = '??:??';
        for (let i = sortiraniRacuniZaSpremanje.length - 1; i >= 0; i--) {
             if (sortiraniRacuniZaSpremanje[i].time && sortiraniRacuniZaSpremanje[i].time !== '??:??') {
                  zadnjeValidnoVrijemeIzSortiraneListe = sortiraniRacuniZaSpremanje[i].time;
                  break; // Na≈°li smo zadnje validno vrijeme, mo≈æemo prekinuti petlju
             }
        }

        const novaGrupa = {
            timestamp: vrijemeCiscenja, // Vrijeme kada je sesija spremljena
            lastQrTime: zadnjeValidnoVrijemeIzSortiraneListe, // Zadnje validno vrijeme s raƒçuna unutar sesije
            name: currentSessionName || null, // Naziv sesije (ako postoji)
            racuni: sortiraniRacuniZaSpremanje // Sortirani popis raƒçuna
        };

        console.log("Spremam sesiju:", novaGrupa); // Ostavljen ovaj log

        let punaPovijest = loadFullHistoryFromLocalStorage(); // Uƒçitaj postojeƒáu povijest
        punaPovijest.push(novaGrupa); // Dodaj novu grupu
        saveFullHistoryToLocalStorage(punaPovijest); // Spremi cijelu povijest

        // Logiranje spremanja sesije
        const sessionTotalAmount = novaGrupa.racuni.reduce((sum, item) => sum + item.amount, 0);
        const sessionDetails = { sessionName: novaGrupa.name, invoiceCount: novaGrupa.racuni.length, totalAmount: sessionTotalAmount.toFixed(2), lastQrTime: novaGrupa.lastQrTime };
        const eventData = { Event: 'session_saved', Details: JSON.stringify(sessionDetails) };
        sendLogData(eventData);

        // Bri≈°i nesaƒçuvano stanje iz localStorage nakon spremanja
        try {
             localStorage.removeItem(UNSAVED_COUNT_KEY);
             localStorage.removeItem(UNSAVED_AMOUNT_KEY);
             console.log("Obrisano nesaƒçuvano stanje nakon spremanja sesije."); // Ostavljen ovaj log
        } catch (lsError) {
             console.error("Gre≈°ka brisanja nesaƒçuvanog stanja u localStorage:", lsError); // Ostavljen log gre≈°ke
        }


        // Resetiraj trenutno stanje skeniranja
        povijest = [];
        ukupno = 0;
        currentSessionName = null;

        // Resetiraj UI elemente vezane za trenutnu sesiju
        if (deleteWarningDiv) {
             delete deleteWarningDiv.dataset.lastScanText;
             delete deleteWarningDiv.dataset.beforeConfirmText;
             delete deleteWarningDiv.dataset.lastNameText;
             delete deleteWarningDiv.dataset.beforeConfirmNameText;
        }
        resetRemoveMode(); // Resetira Obri≈°i gumb modove i info poruku
        // resetOcistiMode() se poziva U startOcistiConfirm() nakon ovog poziva

        updateDisplay(); // A≈æuriraj prikaz (ukupno, broj raƒçuna, mala povijest)

        console.log("Trenutna sesija spremljena i oƒçi≈°ƒáena."); // Ostavljen ovaj log
        // alert("Skeniranje spremljeno u povijest!"); // Mo≈æda zamijeniti sa showTemporaryMessage? Nije tra≈æeno.
    }

    // *** OBRADA SKENIRANOG QR KODA (PREMJE≈†TENO GORE) ***
    function handleScan(decodedText) {
        // Sakrij modal za ruƒçni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }
        // Resetiraj confirm modove ako se skenira (prekid akcije brisanja/spremanja)
        if (removeNameConfirm) resetRemoveMode();
        if (removeConfirm) resetRemoveMode();
        if (ocistiConfirm) resetOcistiMode();

        // Sakrij duplicate warning ako je vidljiv. LoadedMsg se upravlja preko showTemporaryMessage
        if (duplicateWarning) duplicateWarning.style.display = 'none';


        try {
            const qrParts = decodedText.split('?');
            if (qrParts.length < 2) throw new Error("Invalid QR format");
            const params = new URLSearchParams(qrParts[1]);
            const iznosCentStr = params.get('izn');
            const datv = params.get('datv');
            if (!iznosCentStr || isNaN(parseFloat(iznosCentStr))) throw new Error("Invalid 'izn'");

            const isDuplicateInCurrent = povijest.some(item => item.qrCode === decodedText);
            let isDuplicateInRecentSaved = false;
            const fullHistory = loadFullHistoryFromLocalStorage();
            // Provjera duplikata u zadnjih 30 dana (postojeƒáa logika)
            if (fullHistory.length > 0) {
                const thirtyDaysAgoTimestamp = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const recentHistory = fullHistory.filter(grupa => grupa.timestamp >= thirtyDaysAgoTimestamp);
                isDuplicateInRecentSaved = recentHistory.some(grupa => grupa.racuni.some(item => item.qrCode === decodedText));
                // if(isDuplicateInRecentSaved) console.log("Duplikat pronaƒëen u zadnjih 30 dana."); // KOMENTIRANO: Previ≈°e logova
            }


            if (isDuplicateInCurrent || isDuplicateInRecentSaved) {
                 console.warn("Duplikat pronaƒëen:", decodedText);

                 // Provjeri je li pro≈°la odgoda od zadnjeg uspje≈°nog skena (2 sekunde) - OVO OSTAJE ZA ZVUK/PORUKU KORISNIKU
                 if (Date.now() >= ignoreErrorSoundUntil) {
                     // Ako je pro≈°la odgoda, sviraj error (uz 0.5s cooldown) i prika≈æi poruku duplikata
                     playSound('error-sound');
                     showTemporaryMessage(duplicateWarning, "TAJ RAƒåUN JE URAƒåUNAT", 1500);

                     // NOVO: Provjeri je li pro≈°ao cooldown za logiranje duplikata
                     if (Date.now() >= ignoreDuplicateLogUntil) {
                         // Logiranje duplikata (BEZ DETALJA) - MODIFICIRANO
                         sendLogData({ Event: 'scan_duplicate' }); // <-- IZMJENA: Bez Details polja

                         // Postavi cooldown za logiranje duplikata (npr. 5 sekundi)
                         ignoreDuplicateLogUntil = Date.now() + DUPLICATE_LOG_COOLDOWN;
                         console.log(`Duplicate log sent. Next duplicate log ignored until ${new Date(ignoreDuplicateLogUntil).toLocaleTimeString()} (global cooldown).`);
                     } else {
                          // console.log("Duplicate log skipped due to global cooldown."); // KOMENTIRANO: Previ≈°e logova
                     }

                 } else {
                     // User notification (sound/message) is suppressed due to recent successful scan.
                     // No user feedback means no need to log it as a "notified duplicate".
                     // console.log(`Duplicate ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}).`); // KOMENTIRANO: Previ≈°e logova
                 }


                 return; // Ne obraƒëuj duplikat
            }

            // --- OBRADA NOVOG, JEDINSTVENOG RAƒåUNA ---
            const iznosCenti = parseFloat(iznosCentStr);
            const iznosEura = iznosCenti / 100;
            let time = '??:??';
            if (datv && typeof datv === 'string') { let hourStr = null, minuteStr = null; const underscoreIndex = datv.indexOf('_'); const tIndex = datv.toUpperCase().indexOf('T'); if (underscoreIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (tIndex === 8 && datv.length >= 13) { hourStr = datv.substring(9, 11); minuteStr = datv.substring(11, 13); } else if (datv.length === 12) { hourStr = datv.substring(8, 10); minuteStr = datv.substring(10, 12); } if (hourStr && minuteStr) { const hour = parseInt(hourStr, 10); const minute = parseInt(minuteStr, 10); if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`; else time = '??:??'; } else time = '??:??'; }

            if (instructionDiv) instructionDiv.style.display = 'none';
            const newItem = { amount: iznosEura, qrCode: decodedText, time: time, datv: datv || '', scanTimestamp: Date.now() };
            povijest.push(newItem); // Raƒçun se dodaje PRVI
            ukupno += iznosEura;

            if (isCounterDecrementActive && brojac > 0) { brojac--; console.log("Brojaƒç smanjen na:", brojac); saveBrojac(); checkSharePrompt(); } else { /* console.log("Brojaƒç nije smanjen. Aktivno:", isCounterDecrementActive, "Vrijednost:", brojac); */ } // KOMENTIRANO: Previ≈°e logova

            try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Gre≈°ka spremanja nesaƒçuvanog stanja u localStorage:", lsError); }

            playSound('scan-sound'); // ZVUK ZA USPJE≈†NO SKENIRANO (Uƒçitano.mp3)

            // --- POSTAVI BLOKADU ZA ERROR ZVUK I PORUKU NAKON USPJE≈†NOG SKENA ---
            ignoreErrorSoundUntil = Date.now() + 2000; // Blokiraj error zvuk i poruku sljedeƒáe 2 sekunde
            // console.log(`Error sound and message blocked until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}`); // KOMENTIRANO: Previ≈°e logova
            // ------------------------------------------------------------------

            updateDisplay();
            showTemporaryMessage(loadedMsg, "UƒåITANO", 1000); // Prika≈æi poruku "UƒåITANO"
            if (deleteWarningDiv) { deleteWarningDiv.dataset.lastScanText = `ZADNJI RAƒåUN: ${newItem.time} = ${newItem.amount.toFixed(2)} ‚Ç¨`; handleInfoDeleteMessageVisibility(); }

             // Logiraj uspje≈°an sken - MODIFICIRANO
             const scanDetails = {
                 amount: newItem.amount,
                 time: newItem.time,
                 sessionInvoiceNumber: povijest.length // <-- Dodano: Broj raƒçuna po redu
             };
             sendLogData({ Event: 'scan_success', Details: JSON.stringify(scanDetails) }); // <-- IZMJENA


        } catch (error) {
            // --- OBRADA GRE≈†KE PARSIRANJA QR KODA (Nije duplikat, nije validan format) ---
            console.error("Gre≈°ka obrade QR (parse error):", error, decodedText);

             // Provjeri je li pro≈°la odgoda od zadnjeg uspje≈°nog skena (2 sekunde)
             if (Date.now() >= ignoreErrorSoundUntil) {
                 // Ako je pro≈°la odgoda, sviraj error (uz 0.5s cooldown)
                 playSound('error-sound');
                 // Prikazi custom poruku gre≈°ke parsiranja koristeƒái loadedMsg
                 showTemporaryMessage(loadedMsg, "GRE≈†KA SKENIRANJA!", 1500); // Poruka za gre≈°ku parsiranja
             } else {
                 // console.log(`Parse error ignored temporarily due to recent successful scan (until ${new Date(ignoreErrorSoundUntil).toLocaleTimeString()}).`); // KOMENTIRANO: Previ≈°e logova
             }

            // Sakrij poruke koje nisu relevantne za ovu gre≈°ku (showTemporaryMessage to veƒá rje≈°ava)
            // if (loadedMsg) loadedMsg.style.display = 'none';
            // if (duplicateWarning) duplicateWarning.style.display = 'none';

             // Logiraj gre≈°ku skeniranja
            sendLogData({ Event: 'scan_parse_error', Details: { message: error.message, qrCodeStart: decodedText.substring(0, 50) + '...' } }); // Logiraj samo dio QR koda
        }
    }


    // *** FUNKCIJE ZA RUƒåNI UNOS (PREMJE≈†TENE GORE) ***

    function showManualEntryModal() {
        // Provjeri je li element gumba pronaƒëen i je li aplikacija u skener prikazu
        if (!manualEntryBtn || !manualEntryModalOverlay || !manualAmountInput || !manualTimeInput || !manualEntryErrorMsg || !document.body.classList.contains('scanner-view')) {
            console.warn("Ne mogu prikazati modal za ruƒçni unos (DOM elementi nedostaju ili nije scanner view)."); // Ostavljen log upozorenja
            return;
        }

        // Sakrij ostale privremene poruke i UI elemente koji se ne prikazuju s modalom
        if (loadedMsg) loadedMsg.style.display = 'none';
        if (duplicateWarning) duplicateWarning.style.display = 'none';
         // Sakrij overlay za odabir kamere ako je otvoren
        if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none';

         // Sakrij Running Text, Share Prompt i Deactivated Indicator
         updateRunningTextVisibility(); // Ovo se pobrine za Running Text
         checkSharePrompt(); // Ovo se pobrine za Share Prompt
         updateDeactivatedIndicator(); // Ovo se pobrine za Deactivated Indicator


        playSound('click-sound'); // Zvuk pri otvaranju modala
        sendLogData({ Event: 'manual_entry_modal_opened' }); // Log otvaranja modala

        // Resetiraj inpute i gre≈°ku poruku u modalu
        manualAmountInput.value = '';
        manualTimeInput.value = '';
        manualEntryErrorMsg.innerText = '';
        manualEntryErrorMsg.style.display = 'none';

        // Postavi trenutno vrijeme kao default (opcionalno, korisno)
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        manualTimeInput.value = `${hours}:${minutes}`;


        manualEntryModalOverlay.style.display = 'flex'; // Prikazi modal (koristi flex za centriranje)
        manualAmountInput.focus(); // Fokusiraj na polje za iznos
    }

    function hideManualEntryModal() {
        if (!manualEntryModalOverlay) return;
        manualEntryModalOverlay.style.display = 'none'; // Sakrij modal
        // Oƒçisti inpute i gre≈°ku poruku
        manualAmountInput.value = '';
        manualTimeInput.value = '';
         manualEntryErrorMsg.innerText = '';
         manualEntryErrorMsg.style.display = 'none';
         // Ne sviraj click sound ovdje, samo se sakriva

         // Osvje≈æi prikaz UI elemenata koji su bili skriveni dok je modal bio otvoren
         updateRunningTextVisibility();
         checkSharePrompt();
         updateDeactivatedIndicator();
    }

    function addManualEntry() {
        if (!manualAmountInput || !manualTimeInput || !manualEntryErrorMsg) {
             console.error("Nedostaju elementi za dodavanje ruƒçnog unosa."); // Ostavljen kritiƒçan log
             return;
        }

        manualEntryErrorMsg.innerText = ''; // Oƒçisti prethodnu gre≈°ku
        manualEntryErrorMsg.style.display = 'none';

        const amountStr = manualAmountInput.value.trim().replace(',', '.'); // Zamijeni zarez toƒçkom
        const timeStr = manualTimeInput.value.trim();

        const parsedAmount = parseFloat(amountStr);

        if (isNaN(parsedAmount) || parsedAmount <= 0) {
            manualEntryErrorMsg.innerText = 'Molimo unesite ispravan iznos veƒái od 0.';
            manualEntryErrorMsg.style.display = 'block';
            manualAmountInput.focus(); // Vrati fokus na polje iznosa
            sendLogData({ Event: 'manual_entry_add_failed', Details: 'invalid_amount' });
            return; // Prekini funkciju ako iznos nije ispravan
        }

        let parsedTime = '??:??';
        // Validacija vremena - opcionalno polje, ako je uneseno, provjeri format
        if (timeStr) {
             const timeMatch = timeStr.match(/^([0-1]?\d|2[0-3]):([0-5]?\d)$/);
             if (timeMatch) {
                 const hour = parseInt(timeMatch[1], 10);
                 const minute = parseInt(timeMatch[2], 10);
                 parsedTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
             } else {
                  console.warn("Neispravan format vremena unesen (manual entry):", timeStr); // Ostavljen log upozorenja
                  // Mo≈æda prika≈æi upozorenje korisniku, ali ipak dodaj raƒçun s '??:??'
                  manualEntryErrorMsg.innerText = 'Upozorenje: Vrijeme nije u formatu HH:MM. Dodano kao "??:??".';
                  manualEntryErrorMsg.style.display = 'block';
                  parsedTime = '??:??'; // Koristi default ako je format pogre≈°an ali polje nije prazno
             }
        }


        // Kreiranje objekta za ruƒçni unos
        const newItem = {
            amount: parsedAmount,
            qrCode: `MANUAL_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`, // Jedinstveni ID
            time: parsedTime,
            datv: null, // Nema 'datv' za ruƒçni unos
            scanTimestamp: Date.now() // Timestamp kad je raƒçun *dodan* ruƒçno
        };

        // Dodavanje u povijest (trenutna sesija)
        povijest.push(newItem); // Raƒçun se dodaje PRVI
        ukupno += parsedAmount;

        // Smanjenje brojaƒça ako je aktivno
         if (isCounterDecrementActive && brojac > 0) {
              brojac--;
              console.log("Brojaƒç smanjen (ruƒçni unos) na:", brojac); // Ostavljen ovaj log
              saveBrojac();
              checkSharePrompt(); // A≈æuriraj share prompt ako je brojaƒç do≈°ao do 0
         } else {
              // console.log("Brojaƒç nije smanjen (ruƒçni unos). Aktivno:", isCounterDecrementActive, "Vrijednost:", brojac); // KOMENTIRANO: Previ≈°e logova
         }

        // Spremanje nesaƒçuvanog stanja
        try {
            localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length);
            localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno);
        } catch (lsError) {
            console.error("Gre≈°ka spremanja nesaƒçuvanog stanja (ruƒçni unos) u localStorage:", lsError); // Ostavljen log gre≈°ke
        }

        // A≈æuriranje prikaza
        updateDisplay();

        // Prikaz poruke i zvuk
        showTemporaryMessage(loadedMsg, "RUƒåNO DODANO", 1000); // Koristi loadedMsg element za kratkotrajnu poruku
        playSound('scan-sound'); // Mo≈æe≈° koristiti isti zvuk kao za sken ili dodati novi 'manual-add-sound'

        // A≈æuriraj info/delete poruku (posljednji dodani item)
        if (deleteWarningDiv) {
             deleteWarningDiv.dataset.lastScanText = `ZADNJI DODAN: ${newItem.time} = ${newItem.amount.toFixed(2)} ‚Ç¨`;
             handleInfoDeleteMessageVisibility();
        }

        // Sakrij modal
        hideManualEntryModal();

         // Logiranje ruƒçnog unosa - MODIFICIRANO
         const manualEntryDetails = {
             amount: parsedAmount,
             time: parsedTime,
             sessionInvoiceNumber: povijest.length, // <-- Dodano: Broj raƒçuna po redu
             isManual: true // <-- Dodano: Oznaka da je ruƒçni unos
         };
         sendLogData({ Event: 'manual_entry_added', Details: JSON.stringify(manualEntryDetails) }); // <-- IZMJENA
    }

    function cancelManualEntry() {
         // Provjeri je li element modala pronaƒëen
         if (!manualEntryModalOverlay) return;

         playSound('click-sound'); // Zvuk na otkazivanje
         hideManualEntryModal();
         // Logiranje otkazivanja
         sendLogData({ Event: 'manual_entry_cancelled' });
    }

    // *** FUNKCIJE ZA UPRAVLJANJE SKENEROM (PREMJE≈†TENE GORE) ***

    // Izdvojena logika za odabir i start kamere
    function startScannerWithCameraSelection(devices, qrConfig) {
        if (!devices || devices.length === 0) {
             if (readerDiv) readerDiv.innerHTML = '<div style="padding: 20px; color: red;">Nema dostupnih kamera na ureƒëaju.</div>';
             console.warn("Nema dostupnih kamera za startanje skenera."); // Ostavljen ovaj log
             if (instructionDiv) instructionDiv.style.display = 'none';
             if (switchCameraButton) switchCameraButton.style.display = 'none';
             isScannerActive = false;
             html5QrCodeInstance = null; // Osiguraj da je instanca null
             return;
        }

        let selectedCameraId = null;
        const savedCameraId = localStorage.getItem(CAMERA_ID_KEY); // Koristi GLOBALNU konstantu CAMERA_ID_KEY

        // 1. Provjeri spremljenu kameru
        if (savedCameraId) {
            const cameraExists = devices.some(d => d.id === savedCameraId);
            if (cameraExists) {
                console.log("Koristim spremljenu kameru:", savedCameraId); // Ostavljen ovaj log
                selectedCameraId = savedCameraId;
            } else {
                console.warn("Spremljena kamera nije pronaƒëena, bri≈°em iz localStorage."); // Ostavljen ovaj log
                localStorage.removeItem(CAMERA_ID_KEY);
            }
        }

        // 2. Ako nema spremljene ILI spremljena ne postoji, koristi default logiku
        if (!selectedCameraId) {
            const rearCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('zadnja') || d.label.toLowerCase().includes('environment'));
            if (rearCamera) {
                console.log("Koristim pronaƒëenu stra≈ænju kameru:", rearCamera.id); // Ostavljen ovaj log
                selectedCameraId = rearCamera.id;
            } else {
                console.log("Nema stra≈ænje kamere, koristim prvu dostupnu:", devices[0].id); // Ostavljen ovaj log
                selectedCameraId = devices[0].id;
            }
        }

        // Osiguraj da imamo *neki* ID ako ima kamera
        if (!selectedCameraId && devices.length > 0) {
             selectedCameraId = devices[0].id; // Fallback na prvu
             console.warn("Fallback na prvu kameru ID:", selectedCameraId); // Ostavljen ovaj log
        }

        // Ako i dalje nema odabranog ID-a (ne bi se smjelo dogoditi ako devices.length > 0 provjeda gore radi)
        if (!selectedCameraId) {
             console.error("Kritiƒçna gre≈°ka: Nije bilo moguƒáe odabrati kameru za start."); // Ostavljen kritiƒçan log
             if (readerDiv) readerDiv.innerHTML = '<div style="padding: 20px; color: red;">Gre≈°ka: Nije moguƒáe odabrati kameru.</div>';
             if (instructionDiv) instructionDiv.style.display = 'none';
             if (switchCameraButton) switchCameraButton.style.display = 'none';
             isScannerActive = false;
             html5QrCodeInstance = null;
             return; // Izlaz iz funkcije
        }

        const finalCameraId = selectedCameraId;

        requestAnimationFrame(() => {
            // Dodatna provjera prije startanja
            if (!html5QrCodeInstance || isScannerActive || document.body.classList.contains('history-view')) {
                 // console.log("[startScannerWithCameraSelection][rAF] Odustajem od startanja (instance null, active, ili history view)."); // KOMENTIRANO: Previ≈°e logova
                 return;
            }
             if (isElementOrParentHidden(readerDiv)) {
                 if (readerDiv) readerDiv.innerHTML = '<div style="padding:20px; color: red;">Gre≈°ka: Reader element je skriven.</div>';
                 console.error("[startScannerWithCameraSelection][rAF] Reader je skriven, ne mogu startati kameru."); // Ostavljen kritiƒçan log
                 isScannerActive = false; // Osiguraj da nije aktivno
                 html5QrCodeInstance = null; // Nulliraj instancu na gre≈°ku starta
                 return; // Izlaz iz funkcije
             }

            console.log(`[startScannerWithCameraSelection][rAF] Poku≈°avam startati kameru: ${finalCameraId}`); // Ostavljen ovaj log
            html5QrCodeInstance.start(
                finalCameraId,
                qrConfig,
                handleScan,
                (errorMessage) => { /* Ignoriraj non-matched QR */ }
            ).then(() => {
                console.log(`>>> [startScannerWithCameraSelection][rAF] start() OK za kameru: ${finalCameraId}`); // Ostavljen ovaj log
                isScannerActive = true;
                // Spremi ID *uspje≈°no pokrenute* kamere
                localStorage.setItem(CAMERA_ID_KEY, finalCameraId); // Koristi GLOBALNU konstantu CAMERA_ID_KEY
                console.log("Spremljen ID aktivne kamere u localStorage:", finalCameraId); // Ostavljen ovaj log

                // Poka≈æi gumb za promjenu tek kad je kamera uspje≈°no startala I ima vi≈°e od jedne dostupne
                if (switchCameraButton && availableCameras.length > 1) {
                     switchCameraButton.style.display = 'block';
                }

                // Prikaz upute i vezanje listenera nakon uspje≈°nog starta i kratke pauze
                setTimeout(() => {
                    // console.log("[startScannerWithCameraSelection][rAF][then-delay] Prikazujem uputu i ve≈æem listener."); // KOMENTIRANO: Previ≈°e logova
                    if (instructionDiv && document.body.classList.contains('scanner-view')) {
                        instructionDiv.style.display = 'block';
                    }
                    // Listener je dodan u DOMContentLoaded, ne treba ga ponovno dodavati ovdje
                    // if (!visibilityListenerAttached) {
                    //     attachVisibilityListener();
                    // }
                }, 50); // Kraƒáa pauza
            }).catch(err => {
                console.error(`>>> [startScannerWithCameraSelection][rAF] start() FAILED za kameru ${finalCameraId}:`, err); // Ostavljen log gre≈°ke
                isScannerActive = false; // Oznaƒçi kao neaktivno
                html5QrCodeInstance = null; // Nulliraj instancu na gre≈°ku starta
                if (readerDiv) readerDiv.innerHTML = `<div style="padding: 20px; color: red;">Gre≈°ka startanja kamere (${err.name || err.message || err}). Provjerite dozvole ili poku≈°ajte odabrati drugu kameru.</div>`;
                if (instructionDiv) instructionDiv.style.display = 'none';
                // Poka≈æi gumb i ako faila, da mogu probati drugu (ako ih ima vi≈°e)
                 if (switchCameraButton && availableCameras.length > 1) {
                     switchCameraButton.style.display = 'block';
                }
                // Ne bri≈°emo spremljeni ID, mo≈æda iduƒái put uspije ili se mo≈æe odabrati druga

                // Logiranje gre≈°ke starta kamere
                sendLogData({ Event: 'camera_start_failed', Details: { cameraId: finalCameraId, errorName: err.name, errorMessage: err.message } });
            });
        });
    }

    // Funkcija za inicijalizaciju skenera
    function initializeScanner() {
        if (document.body.classList.contains('history-view') || isScannerActive) {
             // console.log("[initializeScanner] Nema potrebe za pokretanjem (history view ili veƒá aktivno)."); // KOMENTIRANO: Previ≈°e logova
             // Ako je veƒá aktivan i u scanner view, samo provjeri prikaz gumba kamere
             if (isScannerActive && document.body.classList.contains('scanner-view')) {
                 if (switchCameraButton && availableCameras.length > 1) {
                      switchCameraButton.style.display = 'block';
                 }
             }
             return;
        }
        console.log("[initializeScanner] Pokreƒáem..."); // Ostavljen ovaj log
        if (readerDiv) readerDiv.innerHTML = ''; // Oƒçisti prethodne poruke/video
        if (instructionDiv) instructionDiv.style.display = 'none'; // Sakrij uputu dok se ne pokrene
        if (switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb dok kamera ne radi
        if (cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij overlay
        if (loadedMsg) loadedMsg.style.display = 'none'; // Sakrij poruke pri init skenera
        if (duplicateWarning) duplicateWarning.style.display = 'none'; // Sakrij duplicate warning pri init skenera
         // Sakrij modal za ruƒçni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             hideManualEntryModal(); // Sakrij bez zvuka otkazivanja
         }

        // A≈æuriraj UI elemente koji se kontroliraju stanjem aplikacije
        checkSharePrompt(); // A≈æuriraj prikaz share prompta
        updateRunningTextVisibility(); // A≈æuriraj prikaz teksta koji trƒçi
        updateDeactivatedIndicator(); // A≈æuriraj prikaz indikatora deaktivacije

        // Kreiraj novu instancu svaki put kad se pokreƒáe
        html5QrCodeInstance = new Html5Qrcode("reader");
        const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Dohvati kamere SAMO jednom pri prvoj inicijalizaciji (ili ako lista nije napunjena)
         if (availableCameras.length === 0) {
             console.log("[initializeScanner] Dohvaƒáam popis kamera prvi put..."); // Ostavljen ovaj log
             Html5Qrcode.getCameras().then(devices => {
                 console.log("[initializeScanner] Dostupne kamere (inicijalno dohvatio):", devices); // Ostavljen ovaj log
                 availableCameras = devices; // <--- SPREMI POPIS KAMERA
                 startScannerWithCameraSelection(devices, qrConfig); // Proslijedi popis i pokreni skener
             }).catch(err => {
                 // Ova gre≈°ka se dogaƒëa ako getCameras() faila na poƒçetku
                 console.error("[initializeScanner] Gre≈°ka dohvaƒáanja kamera (getCameras failed):", err); // Ostavljen log gre≈°ke
                 isScannerActive = false;
                 availableCameras = []; // <--- Postavi na prazan niz ako getCameras faila
                 if (readerDiv) readerDiv.innerHTML = `<div style="padding: 20px; color: red;">Gre≈°ka pristupa kamerama (${err.name || err.message || err}). Provjerite dozvole.</div>`;
                 if (instructionDiv) instructionDiv.style.display = 'none';
                 if (switchCameraButton) switchCameraButton.style.display = 'none'; // Nema kamera, nema gumba
                 html5QrCodeInstance = null;

                 // Logiranje gre≈°ke getCameras
                 sendLogData({ Event: 'get_cameras_failed', Details: { errorName: err.name, errorMessage: err.message } });
             });
         } else {
             console.log("[initializeScanner] Koristim veƒá dohvaƒáeni popis kamera:", availableCameras); // Ostavljen ovaj log
             startScannerWithCameraSelection(availableCameras, qrConfig); // Koristi postojeƒái popis i pokreni skener
         }
    };

    // Funkcija za zaustavljanje skenera
    function stopScanner() {
        console.log("stopScanner: Pokrenuto."); // Ostavljen ovaj log
        // Sakrij sve UI elemente skenera neovisno o tome je li skener aktivan
        if(runningTextContainer) runningTextContainer.style.display = 'none';
        if(sharePromptOverlay) sharePromptOverlay.style.display = 'none';
        if(counterDeactivatedIndicator) counterDeactivatedIndicator.style.display = 'none';
        if(switchCameraButton) switchCameraButton.style.display = 'none'; // Sakrij gumb kad se skener gasi
        if(cameraSelectionOverlay) cameraSelectionOverlay.style.display = 'none'; // Sakrij i overlay
        if(loadedMsg) loadedMsg.style.display = 'none'; // Sakrij poruke pri ga≈°enju skenera
        if(duplicateWarning) duplicateWarning.style.display = 'none'; // Sakrij duplicate warning pri ga≈°enju skenera
         if(manualEntryModalOverlay) manualEntryModalOverlay.style.display = 'none'; // Sakrij modal za ruƒçni unos


        const instanceToStop = html5QrCodeInstance;
        if (instanceToStop && isScannerActive) {
            console.log("Zaustavljam skener (instance postoji i active je)..."); // Ostavljen ovaj log
            isScannerActive = false; // Postavi na false PRIJE poziva stop()
            if (instructionDiv) instructionDiv.style.display = 'none';

            // Postavi timeout za sluƒçaj da stop() obeƒáanje nikad ne proƒëe na nekim ureƒëajima
            const timeoutPromise = new Promise((_, reject) =>
                setTimeout(() => reject(new Error("Timeout waiting for stop()")), 3000) // 3 sekunde timeout
            );

            return Promise.race([instanceToStop.stop(), timeoutPromise]).then(() => {
                console.log("Skener uspje≈°no zaustavljen."); // Ostavljen ovaj log
            }).catch(err => {
                console.warn("Gre≈°ka ili timeout pri zaustavljanju skenera:", err); // Ostavljen log upozorenja
                 // Logiranje gre≈°ke stop skenera
                 sendLogData({ Event: 'camera_stop_failed', Details: { errorName: err.name, errorMessage: err.message } });
            }).finally(() => {
                 // console.log("stopScanner finally blok. ƒåistim DOM i instancu."); // KOMENTIRANO: Previ≈°e logova
                 if (readerDiv) readerDiv.innerHTML = ''; // Oƒçisti prikaz svejedno
                 html5QrCodeInstance = null; // Nulliraj instancu nakon zaustavljanja ili timeouta
                 // console.log("stopScanner finally blok zavr≈°en."); // KOMENTIRANO: Previ≈°e logova
            });
        } else {
             // console.log("Skener nije aktivan ili instanca ne postoji/veƒá zaustavljena, nema potrebe za zaustavljanjem (stopScanner)."); // KOMENTIRANO: Previ≈°e logova
             isScannerActive = false; // Osiguraj da je false
             if (readerDiv) readerDiv.innerHTML = ''; // Oƒçisti za svaki sluƒçaj
             html5QrCodeInstance = null; // Osiguraj null
             // console.log("stopScanner zavr≈°en bez akcije."); // KOMENTIRANO: Previ≈°e logova
             return Promise.resolve(); // Vrati resolved promise
        }
    };


    // Funkcija za promjenu odabrane kamere
    function toggleCameraSelection() {
         playSound('click-sound');
         if (!cameraSelectionOverlay || !cameraListUl || !switchCameraButton) {
             console.error("Nedostaju elementi za odabir kamere."); // Ostavljen kritiƒçan log
             return;
         }

         // Sakrij modal za ruƒçni unos ako je otvoren
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             cancelManualEntry(); // Koristi cancel za zvuk i log
         }

         // Koristi SPREMLJENI popis availableCameras (treba biti popunjen iz initializeScanner)
         if (!availableCameras || availableCameras.length <= 1) {
              console.warn("Nema dostupnih kamera za odabir ili samo jedna (koristi se spremljena lista)."); // Ostavljen log upozorenja
              showTemporaryMessage(loadedMsg, "Nema drugih kamera za odabir.", 1500); // Koristimo loadedMsg za ovu poruku
              cameraSelectionOverlay.style.display = 'none'; // Osiguraj da je skriven
              return;
         }

         // Ako je overlay vidljiv, sakrij ga
         if (cameraSelectionOverlay.style.display === 'block') {
             cameraSelectionOverlay.style.display = 'none';
             return;
         }

         // Inaƒçe, koristi spremljeni popis kamera i prika≈æi ih
         cameraListUl.innerHTML = ''; // Oƒçisti prethodni popis
         const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY); // Koristi GLOBALNU konstantu

         availableCameras.forEach(device => {
             const listItem = document.createElement('li');
             listItem.textContent = device.label || `Kamera ${device.id.substring(0, 8)}...`; // Prikaz labela, fallback na ID
             listItem.dataset.cameraId = device.id;
             listItem.title = device.label || device.id; // Puni label u tooltipu

             // Opcionalno: Oznaci trenutno odabranu
             if (device.id === currentActiveCameraId) {
                 listItem.classList.add('selected-camera');
             }

             // Dodaj listener
             listItem.addEventListener('click', () => {
                 switchCamera(device.id, device.label);
             });
             cameraListUl.appendChild(listItem); // Append original, not clone
         });

         cameraSelectionOverlay.style.display = 'block'; // Poka≈æi overlay
    }

    function switchCamera(selectedCameraId, cameraLabel) {
        playSound('click-sound');
        console.log(`Odabrana kamera: ID=${selectedCameraId}, Label=${cameraLabel || 'N/A'}`); // Ostavljen ovaj log

        if (cameraSelectionOverlay) {
             cameraSelectionOverlay.style.display = 'none'; // Sakrij popis
        }

        const currentActiveCameraId = localStorage.getItem(CAMERA_ID_KEY); // Koristi GLOBALNU konstantu
        if(selectedCameraId === currentActiveCameraId && isScannerActive) {
            console.log("Odabrana je veƒá aktivna kamera, nema potrebe za restartom."); // Ostavljen ovaj log
             showTemporaryMessage(loadedMsg, `Kamera: ${cameraLabel || 'Veƒá aktivna'}`, 1500); // Koristimo loadedMsg za ovu poruku
             // Logiranje odabira iste kamere
             sendLogData({ Event: 'camera_switch_selected_same', Details: { cameraId: selectedCameraId, label: cameraLabel } });
            return;
        }

        // Spremi novi odabir PRIJE restartanja
        localStorage.setItem(CAMERA_ID_KEY, selectedCameraId); // Koristi GLOBALNU konstantu
        sendLogData({ Event: 'camera_switch_attempt', Details: { cameraId: selectedCameraId, label: cameraLabel } }); // Log poku≈°aja

        // Restartaj skener
        showTemporaryMessage(loadedMsg, `Mijenjam na: ${cameraLabel || 'Kamera'}...`, 1000); // Koristimo loadedMsg za ovu poruku
        stopScanner().finally(() => {
             console.log("Nakon stopScanner, pozivam initializeScanner za novu kameru."); // Ostavljen ovaj log
             // initializeScanner() ƒáe sada automatski odabrati spremljeni ID
             initializeScanner(); // initializeScanner logira uspjeh/neuspjeh starta
        });
    }


    // Funkcija za uƒçitavanje pune povijesti iz lokalne pohrane
    function loadFullHistoryFromLocalStorage() {
         try {
              const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
              if (historyJson) {
                   const loadedHistory = JSON.parse(historyJson);
                   // Validacija i konverzija datuma/timestampa
                   return loadedHistory.map(group => ({
                        timestamp: group.timestamp || Date.now(), // Koristi postojeƒái timestamp ili generiraj novi
                        lastQrTime: group.lastQrTime || '??:??', // Koristi postojeƒáe vrijeme ili default
                        name: group.name || null, // Koristi postojeƒái naziv ili null
                        racuni: Array.isArray(group.racuni) ? group.racuni.map(item => ({
                             ...item, // Kopiraj postojeƒáa svojstva
                             scanTimestamp: item.scanTimestamp || 0 // Osiguraj scanTimestamp
                             // Nema potrebe provjeravati format iznosa, vremena ili qrCode-a pri uƒçitavanju ovdje,
                             // pretpostavljamo da su spremljeni ispravno ili da ƒáe biti obraƒëeni kasnije ako nevaljaju.
                        })) : [] // Ako racuni nije array, postavi na prazan array
                   }));
              }
              return []; // Vrati prazan array ako nema spremljene povijesti
         } catch (error) {
              console.error("Gre≈°ka uƒçitavanja povijesti iz localStorage:", error); // Ostavljen log gre≈°ke
              // U sluƒçaju gre≈°ke (npr. corrupted JSON), obri≈°i neispravan podatak i vrati prazan array
              // OPREZ: Ovo bri≈°e SVE podatke ako su korumpirani!
              // Mo≈æda je bolje samo vratiti prazan array i ostaviti korumpiran podatak dok korisnik ruƒçno ne obri≈°e?
              // Za sada, neka obri≈°e ako ne mo≈æe uƒçitati.
              try {
                  localStorage.removeItem(HISTORY_STORAGE_KEY);
                  console.warn("Korumpirana povijest obrisana iz localStorage."); // Ostavljen log upozorenja
              } catch (lsError) {
                  console.error("Gre≈°ka pri brisanju korumpirane povijesti:", lsError); // Ostavljen log gre≈°ke
              }
              return []; // Vrati prazan array
         }
     }

     // Funkcija za spremanje pune povijesti u lokalnu pohranu
     function saveFullHistoryToLocalStorage(fullHistory) {
         try {
              localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(fullHistory));
              console.log("Puna povijest spremljena."); // Ostavljen ovaj log
         } catch (error) {
              console.error("Gre≈°ka spremanja povijesti u localStorage:", error); // Ostavljen log gre≈°ke
              // Ovo mo≈æe ukazivati da je localStorage pun
              alert("Gre≈°ka: Nije moguƒáe spremiti povijest. Va≈°a pohrana je mo≈æda puna.");
         }
     }


    // *** FUNKCIJE ZA RENDERIRANJE HISTORY VIEWA (PREMJE≈†TENE GORE) ***
    function clearDynamicHeaderContent() { if (historyDynamicHeaderContentDiv) { historyDynamicHeaderContentDiv.innerHTML = ''; } }

    function renderHistoryView(dateToShow = currentlyViewedDate) {
        console.log("renderHistoryView: Pokrenuto za datum:", dateToShow); // Ostavljen ovaj log
        previousHistoryViewState = 'day-view'; // Postavi trenutno stanje prikaza

        // Osiguraj da je currentlyViewedDate uvijek na poƒçetku dana
        currentlyViewedDate = new Date(dateToShow);
        currentlyViewedDate.setHours(0, 0, 0, 0);

        const punaPovijest = loadFullHistoryFromLocalStorage();
        /* console.log("renderHistoryView: Uƒçitana povijest iz localStorage:", punaPovijest); */ // KOMENTIRANO: Previ≈°e logova

        if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) {
             console.error("renderHistoryView: Kritiƒçni DOM elementi nedostaju!"); // Ostavljen kritiƒçan log
             // Trebalo bi se pobrinuti da se ovo ne dogodi provjerom u DOMContentLoaded
             return;
        }

        clearDynamicHeaderContent(); // Oƒçisti prethodni sadr≈æaj dinamiƒçkog headera

        // Priprema podataka za prikaz dana
        const opcijeDana = { weekday: 'long' };
        const opcijeDatuma = { day: '2-digit', month: '2-digit', year: 'numeric' };
        let imeDana = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDana);
        imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); // Kapitaliziraj prvo slovo
        const formatiraniDatum = currentlyViewedDate.toLocaleDateString('hr-HR', opcijeDatuma);

        // Filtriraj sesije za prikazani dan
        const startOfDay = new Date(currentlyViewedDate);
        const endOfDay = new Date(currentlyViewedDate);
        endOfDay.setHours(23, 59, 59, 999);

        const sesijeZaPrikazaniDan = punaPovijest.filter(grupa => {
            const grupaDate = new Date(grupa.timestamp);
             // Dodatna provjera da se izbjegnu NaN datumi
            if (isNaN(grupaDate.getTime())) return false;
            return grupaDate >= startOfDay && grupaDate <= endOfDay;
        });
        sesijeZaPrikazaniDan.sort((a, b) => a.timestamp - b.timestamp); // Sortiraj sesije kronolo≈°ki unutar dana

        // Izraƒçunaj ukupno za prikazani dan
        const brojRacunaOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.length, 0);
        const ukupanIznosOvajDan = sesijeZaPrikazaniDan.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0);

        // --- Renderiranje Dinamiƒçkog Headera ---
        // Info o datumu i gumb za prebacivanje na Svi Dani
        const dateInfoDiv = document.createElement('div');
        dateInfoDiv.id = 'history-date-info';
         const currentViewDateStr = getISODateString(currentlyViewedDate);
         const hasOtherDays = punaPovijest.some(grupa => {
             const grupaDateStr = getISODateString(new Date(grupa.timestamp));
              return grupaDateStr && grupaDateStr !== currentViewDateStr;
         });

        dateInfoDiv.innerHTML = `<span style="font-weight: bold;">${imeDana}, ${formatiraniDatum}</span> <button id="history-view-toggle-btn" style="background-color: yellow; color: black; padding: 0.4em 0.8em; font-size: 0.9em; font-weight: bold;" ${!hasOtherDays ? 'disabled' : ''}>OSTALI DANI ></button>`;
        historyDynamicHeaderContentDiv.appendChild(dateInfoDiv);

         // Re-attach listener za gumb "OSTALI DANI"
         const historyViewToggleButton = dateInfoDiv.querySelector('#history-view-toggle-btn');
         if (historyViewToggleButton) {
             const newHistoryViewToggleButton = historyViewToggleButton.cloneNode(true);
             historyViewToggleButton.parentNode.replaceChild(newHistoryViewToggleButton, historyViewToggleButton); // Zamijeni gumb da ukloni stari listener
             // Dodaj novi listener SAMO ako gumb nije disabled
             if (!newHistoryViewToggleButton.disabled) {
                 newHistoryViewToggleButton.addEventListener('click', () => {
                     playSound('click-sound'); // Zvuk na klik
                     renderAllDaysView(); // Prebaci na prikaz svih dana
                 });
                  // Dodaj stilove za kursor/opacity ako nije disabled
                  newHistoryViewToggleButton.style.cursor = 'pointer';
                  newHistoryViewToggleButton.style.opacity = '1';
             } else {
                  // Dodaj stilove za kursor/opacity ako je disabled
                  newHistoryViewToggleButton.style.cssText += ';cursor: not-allowed; opacity: 0.7;'; // Koristi cssText za override
             }
         }


        // Info o ukupnom broju raƒçuna i iznosu za ovaj dan
        const summaryInfoDiv = document.createElement('div');
        summaryInfoDiv.id = 'history-summary-info';
        summaryInfoDiv.innerHTML = `<span>RAƒåUNA: <span style="font-weight: bold;">${brojRacunaOvajDan}</span></span> <span style="font-weight: bold;">UKUPNO: ${ukupanIznosOvajDan.toFixed(2)} ‚Ç¨</span>`;
        historyDynamicHeaderContentDiv.appendChild(summaryInfoDiv);

        // --- Renderiranje Sadr≈æaja Povijesti za Dan ---
        const uputaHtml = `<p id="history-select-group-text" style="text-align: center; color: black; font-weight: bold; font-style: normal; margin-bottom: 1em; margin-top: 0.5em; font-size: 0.9em;">IZABERI SKEN ILI <button id="start-search-btn" style="background:none; border:none; padding:0; color:blue; text-decoration:underline; cursor:pointer; font-size:inherit; font-weight:bold;">(TRA≈ΩI)</button></p>`;

        let sesijeHtml = '<ul id="scan-group-list" style="list-style: none; padding: 0; margin: 0;">';
        if (sesijeZaPrikazaniDan.length === 0) {
             sesijeHtml += '<li style="text-align:center; color: grey; border: none; cursor: default; padding: 1em 0;"><i>Nema spremljenih skenova za ovaj dan.</i></li>';
        } else {
             // Generiraj HTML za svaku sesiju ovog dana
             sesijeZaPrikazaniDan.forEach((sesija, index) => {
                  sesijeHtml += generirajHtmlZaSpremljenuGrupu(sesija, index + 1);
             });
        }
        sesijeHtml += '</ul>';

        historyContentDiv.innerHTML = uputaHtml + sesijeHtml;

        // Dodaj gumb "IZBRI≈†I OVAJ DAN" ako ima skenova za ovaj dan
        if (sesijeZaPrikazaniDan.length > 0) {
            const clearDayButton = document.createElement('button');
            clearDayButton.id = 'clear-day-btn';
            clearDayButton.className = 'red-btn';
            clearDayButton.style.margin = '2em auto 1em auto'; // Centriraj gumb
            clearDayButton.style.display = 'block';
            clearDayButton.innerText = 'IZBRI≈†I OVAJ DAN';
            historyContentDiv.appendChild(clearDayButton); // Dodaj gumb na dno sadr≈æaja

             // Re-attach listener za gumb "IZBRI≈†I OVAJ DAN"
             clearDayButton.dataset.confirming = 'false'; // Inicijalno stanje potvrde
             const newClearDayBtn = clearDayButton.cloneNode(true);
             clearDayButton.parentNode.replaceChild(newClearDayBtn, clearDayButton); // Zamijeni gumb da ukloni stari listener
             newClearDayBtn.addEventListener('click', () => {
                 if (newClearDayBtn.disabled) return; // Ne radi ni≈°ta ako je disabled

                 if (newClearDayBtn.dataset.confirming !== 'true') {
                      // Prvi klik - prebaci u mod potvrde
                      playSound('click-sound'); // Zvuk na prvi klik za potvrdu
                      newClearDayBtn.innerText = "Potvrdi Brisanje Dana?";
                      newClearDayBtn.classList.add('confirm-mode');
                      newClearDayBtn.dataset.confirming = 'true'; // Postavi confirming na true
                       sendLogData({ Event: 'delete_day_prompt', Details: getISODateString(currentlyViewedDate) }); // Logiranje poku≈°aja
                 } else {
                      // Drugi klik - POTVRDA brisanja
                      // Nema click sound ovdje, remove-sound ƒáe svirati ako brisanje uspije
                      const dateToConfirmDelete = new Date(currentlyViewedDate); // Dohvati datum za brisanje
                      deleteScansForDay(dateToConfirmDelete); // Pozovi funkciju za brisanje dana (ona sadr≈æi playSound('remove-sound') na uspjeh i log)
                      // Stanje gumba ƒáe se resetirati globalnim klik handlerom ili pri renderu nakon brisanja
                 }
             });

             // Listener na cijelu history-page za resetiranje confirm moda gumba "IZBRI≈†I OVAJ DAN"
             const dayParentPageClickHandler = (e) => {
                 const currentClearDayBtn = document.getElementById('clear-day-btn'); // Ponovno dohvati gumb jer je zamijenjen
                 // Resetiraj samo ako je gumb u confirm modu i klik NIJE na gumb
                 if (currentClearDayBtn && currentClearDayBtn.dataset.confirming === 'true' && !currentClearDayBtn.contains(e.target)) {
                      currentClearDayBtn.innerText = "IZBRI≈†I OVAJ DAN"; // Vrati poƒçetni tekst
                      currentClearDayBtn.classList.remove('confirm-mode'); // Ukloni confirm klasu
                      currentClearDayBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                       sendLogData({ Event: 'delete_day_cancelled_outside', Details: getISODateString(currentlyViewedDate) }); // Logiranje otkazivanja klikom izvan gumba
                 }
             };
             // Ukloni prethodni listener prije dodavanja novog (da se ne duplicira)
             historyPageDiv.removeEventListener('click', dayParentPageClickHandler, true);
             // Dodaj listener na historyPageDiv (koristi capturing phase=true da se okine prije inner elemenata)
             historyPageDiv.addEventListener('click', dayParentPageClickHandler, true);

        }

        // Re-attach listener na listu sesija za klik (otvaranje detalja)
        const groupList = document.getElementById('scan-group-list');
        if (groupList) {
             const newGroupList = groupList.cloneNode(true); // Kloniraj listu s listenerima
             groupList.parentNode.replaceChild(newGroupList, groupList); // Zamijeni staru listu novom
             newGroupList.addEventListener('click', (e) => {
                 const clickedLi = e.target.closest('li[data-timestamp]'); // Pronaƒëi najbli≈æi <li> sa data-timestamp
                 if (clickedLi && clickedLi.dataset.timestamp) {
                      const timestamp = clickedLi.dataset.timestamp;
                      const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); // Pronaƒëi sesiju po timestampu

                      if (selectedGroup) {
                           playSound('click-sound'); // Zvuk na klik
                           previousHistoryViewState = 'day-view'; // Postavi prethodno stanje
                           renderGroupDetailView(selectedGroup); // Prikazi detalje te sesije
                      } else {
                           console.error("Nije pronaƒëena grupa za timestamp:", timestamp); // Ostavljen kritiƒçan log
                           alert("Gre≈°ka otvaranja detalja.");
                      }
                 }
             });
        }

        // Re-attach listener za gumb "TRA≈ΩI"
        const searchBtn = document.getElementById('start-search-btn');
        if(searchBtn) {
            const newSearchBtn = searchBtn.cloneNode(true);
            searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn);
            newSearchBtn.addEventListener('click', startSearch); // Pozovi startSearch funkciju
        }

        console.log("renderHistoryView: Renderiranje zavr≈°eno."); // Ostavljen ovaj log
    }

    // Funkcija za generiranje HTML-a za pojedinu spremljenu grupu/sesiju u listi
    function generirajHtmlZaSpremljenuGrupu(grupa, redniBroj) {
      const vrijemeSpremanja = new Date(grupa.timestamp);
      const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0');
      const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0');
      const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`;
      const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0);
      const zadnjeVrijeme = grupa.lastQrTime || '??:??'; // Koristi '??:??' ako lastQrTime nije postavljen
      // Prikaz naziva sesije ili defaultni tekst "SKEN U HH:MM"
      const prikazNaziva = grupa.name ? `<span class="session-name-history">${grupa.name} U ${vrijemeSpremanjaFormatirano}</span>` : `<span class="scan-time-history">SKEN U ${vrijemeSpremanjaFormatirano}</span>`;

      // ISPRAVLJENI HTML STRING: Uklonjen vi≈°ak </span> na kraju (UZROK SINTAKSNE GRE≈†KE)
      return `<li data-timestamp="${grupa.timestamp}" style="background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s ease;"><span style="flex-shrink: 0; display: inline-flex; align-items: center; min-width: 0; flex-grow: 1; overflow: hidden;"><span style="margin-right: 5px; flex-shrink: 0;">${redniBroj}.</span> ${prikazNaziva}</span><span class="scan-group-last-qr-time" style="flex-shrink: 0; margin-left: 15px;">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span><span style="font-weight: bold; margin-left: auto; padding-left: 10px; flex-shrink: 0;">${ukupnoGrupa.toFixed(2)} ‚Ç¨</span></li>`;
    }

    // Funkcija za renderiranje detaljnog prikaza jedne sesije
    function renderGroupDetailView(groupData) {
        if (!historyContentDiv || !groupData || !groupData.racuni || !historyDynamicHeaderContentDiv) {
             console.error("Nedostaju podaci za detalje."); // Ostavljen kritiƒçan log
             renderHistoryView(); // Vrati se na prikaz dana ako podaci nedostaju
             return;
        }

        clearDynamicHeaderContent(); // Oƒçisti dinamiƒçki header

        // Priprema podataka
        const sessionTimestamp = groupData.timestamp;
        const vrijemeSpremanja = new Date(sessionTimestamp);
        const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0');
        const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0');
        const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`;
        const ukupnoGrupa = groupData.racuni.reduce((sum, item) => sum + item.amount, 0);
        const brojRacunaSesije = groupData.racuni.length;
        const naslovDetalja = groupData.name ? groupData.name : `SKEN U ${vrijemeSpremanjaFormatirano}`;

        // --- Renderiranje Dinamiƒçkog Headera (Detalji sesije) ---
        const detailHeaderDiv = document.createElement('div');
        detailHeaderDiv.id = 'detail-header-info';
        detailHeaderDiv.innerHTML = `
             <button id="back-to-group-list-btn" style="background-color: #6c757d; color: white; padding: 0.4em 0.8em; font-size: 0.9em; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">< Lista</button>
             <h3 style="margin: 0; text-align: center; flex-grow: 1; font-size: 1.1em;">${naslovDetalja}</h3>
             <span style="font-weight: bold; font-size: 1.1em; flex-shrink: 0; padding-left: 5px;">${ukupnoGrupa.toFixed(2)} ‚Ç¨</span>
        `;
        historyDynamicHeaderContentDiv.appendChild(detailHeaderDiv);

        const detailSummaryDiv = document.createElement('div');
        detailSummaryDiv.id = 'detail-summary-info';
        detailSummaryDiv.innerHTML = `
             <span>RAƒåUNA: <span style="font-weight: bold;">${brojRacunaSesije}</span></span>
             <span style="font-weight: bold;">UKUPNO: ${ukupnoGrupa.toFixed(2)} ‚Ç¨</span>
        `;
        historyDynamicHeaderContentDiv.appendChild(detailSummaryDiv);


        // --- Renderiranje Sadr≈æaja (Lista raƒçuna) ---
        let detailListHtml = '<ul id="detail-scan-list">';
        const racuniZaPrikaz = groupData.racuni;

        racuniZaPrikaz.forEach((racun, index) => {
             const vrijemeRacuna = racun.time !== '??:??' ? `${racun.time}` : 'Vrijeme?';
             detailListHtml += `
                 <li>
                      <span style="color: #333; min-width: 80px;">${index + 1}. ${vrijemeRacuna}</span>
                      <span style="font-weight: bold; margin-left: auto;">${racun.amount.toFixed(2)} ‚Ç¨${racun.qrCode.startsWith('MANUAL_') ? ' (ruƒçno)' : ''}</span>
                 </li>`;
        });
        detailListHtml += `</ul>`;

        // Dodaj gumb "IZBRI≈†I OVAJ SKEN"
        detailListHtml += `<button id="delete-session-btn" class="red-btn" data-timestamp="${sessionTimestamp}" style="margin: 2em auto 1em auto; display: block;">IZBRI≈†I OVAJ SKEN</button>`;

        historyContentDiv.innerHTML = detailListHtml;

        // Re-attach listener za gumb "< Lista"
        const backBtn = document.getElementById('back-to-group-list-btn');
        if (backBtn) {
             const newBackBtn = backBtn.cloneNode(true);
             backBtn.parentNode.replaceChild(newBackBtn, backBtn);
             newBackBtn.addEventListener('click', () => {
                 playSound('click-sound'); // Zvuk na klik
                 console.log("Vraƒáanje iz detalja, prethodno stanje:", previousHistoryViewState); // Ostavljen ovaj log
                 // Vrati se na prethodni prikaz (danas, svi dani, rezultati pretrage...)
                 switch (previousHistoryViewState) {
                      case 'day-search-results':
                           // Vrati se na rezultate pretrage za taj dan
                           renderHistoryView(currentlyViewedDate); // Renderiraj dan
                           startSearch(); // Pokreni search mod
                           const searchInputDay = document.getElementById('search-input');
                           if(searchInputDay) searchInputDay.value = lastSearchTerm; // Vrati zadnji pojam
                           executeSearch(); // Izvr≈°i pretragu ponovno
                           break;
                      case 'all-days-search-results':
                           // Vrati se na rezultate pretrage za sve dane
                           renderAllDaysView(); // Renderiraj svi dani
                           const searchInputAll = document.getElementById('all-days-search-input');
                           if(searchInputAll) searchInputAll.value = lastSearchTerm; // Vrati zadnji pojam
                           executeAllDaysSearch(); // Izvr≈°i pretragu ponovno
                           break;
                      case 'day-view':
                      default:
                           // Vrati se na prikaz dana (default)
                           renderHistoryView(currentlyViewedDate);
                           break;
                 }
             });
        }

        // Re-attach listener za gumb "IZBRI≈†I OVAJ SKEN"
        const deleteSessionBtn = document.getElementById('delete-session-btn');
        if(deleteSessionBtn) {
             deleteSessionBtn.dataset.confirming = 'false'; // Inicijalno stanje potvrde
             const newDeleteSessionBtn = deleteSessionBtn.cloneNode(true);
             deleteSessionBtn.parentNode.replaceChild(newDeleteSessionBtn, deleteSessionBtn); // Zamijeni gumb
             newDeleteSessionBtn.addEventListener('click', () => {
                 if (newDeleteSessionBtn.disabled) return; // Ne radi ni≈°ta ako je disabled

                 if (newDeleteSessionBtn.dataset.confirming !== 'true') {
                      // Prvi klik - prebaci u mod potvrde
                      playSound('click-sound'); // Zvuk na prvi klik za potvrdu
                      newDeleteSessionBtn.innerText = "Potvrdi brisanje?";
                      newDeleteSessionBtn.classList.add('confirm-mode');
                      newDeleteSessionBtn.dataset.confirming = 'true'; // Postavi confirming na true
                       sendLogData({ Event: 'delete_session_prompt', Details: groupData.timestamp }); // Logiranje poku≈°aja
                 } else {
                      // Drugi klik - POTVRDA brisanja
                      // Nema click sound ovdje, remove-sound ƒáe svirati ako brisanje uspije
                      const timestampToDelete = newDeleteSessionBtn.dataset.timestamp; // Dohvati timestamp za brisanje
                      deleteSpecificSession(timestampToDelete); // Pozovi funkciju za brisanje sesije (ona sadr≈æi playSound('remove-sound') na uspjeh i log)
                      // Stanje gumba ƒáe se resetirati globalnim klik handlerom ili pri renderu nakon brisanja
                 }
             });

             // Listener na cijelu history-page za resetiranje confirm moda gumba "IZBRI≈†I OVAJ SKEN"
             const detailClickHandler = (e) => {
                 const currentDeleteBtn = document.getElementById('delete-session-btn'); // Ponovno dohvati gumb
                 // Resetiraj samo ako je gumb u confirm modu i klik NIJE na gumb
                 if (currentDeleteBtn && currentDeleteBtn.dataset.confirming === 'true' && !currentDeleteBtn.contains(e.target)) {
                      currentDeleteBtn.innerText = "IZBRI≈†I OVAJ SKEN"; // Vrati poƒçetni tekst
                      currentDeleteBtn.classList.remove('confirm-mode'); // Ukloni confirm klasu
                      currentDeleteBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                       sendLogData({ Event: 'delete_session_cancelled_outside', Details: groupData.timestamp }); // Logiranje otkazivanja
                  }
             };
             // Ukloni prethodni listener prije dodavanja novog (da se ne duplicira)
             historyPageDiv.removeEventListener('click', detailClickHandler, true);
             // Dodaj listener na historyPageDiv (koristi capturing phase=true)
             historyPageDiv.addEventListener('click', detailClickHandler, true);

        } else {
             console.warn("Gumb #delete-session-btn nije pronaƒëen nakon renderiranja."); // Ostavljen log upozorenja
        }
    }


     // Funkcija za brisanje svih skenova za odreƒëeni dan
     function deleteScansForDay(dateToDelete) {
         if (!(dateToDelete instanceof Date) || isNaN(dateToDelete)) {
              console.error("Poku≈°aj brisanja dana s neispravnim datumom."); // Ostavljen kritiƒçan log
              alert("Gre≈°ka: Nije moguƒáe identificirati dan za brisanje.");
               // Resetiraj stanje gumba u sluƒçaju gre≈°ke
               const clearDayBtn = document.getElementById('clear-day-btn');
               if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') {
                    clearDayBtn.innerText = "IZBRI≈†I OVAJ DAN";
                    clearDayBtn.classList.remove('confirm-mode');
                    clearDayBtn.dataset.confirming = 'false';
               }
              return;
         }

         const dateToDeleteStr = getISODateString(dateToDelete);
          if (!dateToDeleteStr) {
               console.error("Nije moguƒáe formatirati datum za brisanje dana."); // Ostavljen kritiƒçan log
                // Resetiraj stanje gumba u sluƒçaju gre≈°ke
               const clearDayBtn = document.getElementById('clear-day-btn');
               if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') {
                    clearDayBtn.innerText = "IZBRI≈†I OVAJ DAN";
                    clearDayBtn.classList.remove('confirm-mode');
                    clearDayBtn.dataset.confirming = 'false';
               }
               return;
          }

         console.log("Brisanje svih skenova za dan:", dateToDeleteStr); // Ostavljen ovaj log

         let punaPovijest = loadFullHistoryFromLocalStorage();
         const originalLength = punaPovijest.length;

         // Filtriraj sesije koje pripadaju danu za brisanje radi logiranja
         const sessionsToDelete = punaPovijest.filter(grupa => {
             const grupaDate = new Date(grupa.timestamp);
             if (isNaN(grupaDate.getTime())) return false; // Ignoriraj neispravne datume
              const grupaDateStr = getISODateString(grupaDate);
              return grupaDateStr === dateToDeleteStr;
         });

         // Kreiraj novu povijest bez sesija za taj dan
         const filtriranaPovijest = punaPovijest.filter(grupa => {
              const grupaDate = new Date(grupa.timestamp);
              if (isNaN(grupaDate.getTime())) return true; // Zadr≈æi neispravne datume (ili ih obri≈°i? Ovisi o politici)
              const grupaDateStr = getISODateString(grupaDate);
              return grupaDateStr !== dateToDeleteStr;
         });

         const newLength = filtriranaPovijest.length;
         console.log(`Originalna du≈æina: ${originalLength}, Nova du≈æina: ${newLength}`); // Ostavljen ovaj log

         if (newLength < originalLength) {
              // Ako je barem jedna sesija obrisana (duljina se smanjila)
              saveFullHistoryToLocalStorage(filtriranaPovijest); // Spremi modificiranu povijest
              playSound('remove-sound'); // ZVUK ZA BRISANJE DANA (smeƒáe.mp3)
              alert(`Svi skenovi za ${dateToDelete.toLocaleDateString('hr-HR')} obrisani.`);

              // Logiranje uspje≈°nog brisanja dana
              const dayDetails = {
                   date: dateToDeleteStr,
                   sessionCount: sessionsToDelete.length, // Broj sesija obrisanih za taj dan
                   totalCount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.length, 0), // Ukupan broj raƒçuna obrisanih
                   totalAmount: sessionsToDelete.reduce((sum, s) => sum + s.racuni.reduce((gSum, r) => gSum + r.amount, 0), 0) // Ukupan iznos obrisanih raƒçuna
              };
              sendLogData({ Event: 'day_deleted_confirmed', Details: JSON.stringify(dayDetails) });

              // Nakon brisanja, vrati se na prikaz svih dana
              renderAllDaysView();
         } else {
              // Ako nijedna sesija nije pronaƒëena/obrisana za taj dan
              console.warn("Nisu pronaƒëeni skenovi za brisanje za dan:", dateToDeleteStr); // Ostavljen log upozorenja
              alert("Gre≈°ka: Nisu pronaƒëeni skenovi za ovaj dan."); // Obavijesti korisnika

              // Resetiraj stanje gumba za brisanje dana
              const clearDayBtn = document.getElementById('clear-day-btn');
              if(clearDayBtn && clearDayBtn.dataset.confirming === 'true') {
                   clearDayBtn.innerText = "IZBRI≈†I OVAJ DAN";
                   clearDayBtn.classList.remove('confirm-mode');
                   clearDayBtn.dataset.confirming = 'false';
              }
         }
     }

     // Funkcija za brisanje specifiƒçne sesije
     function deleteSpecificSession(timestampString) {
         if (!timestampString) {
              console.error("Poku≈°aj brisanja bez timestampa."); // Ostavljen kritiƒçan log
              alert("Gre≈°ka: Nije moguƒáe identificirati sken.");
               // Resetiraj stanje gumba u sluƒçaju gre≈°ke
               const deleteBtn = document.getElementById('delete-session-btn');
               if(deleteBtn && deleteBtn.dataset.confirming === 'true') {
                   deleteBtn.innerText = "IZBRI≈†I OVAJ SKEN";
                   deleteBtn.classList.remove('confirm-mode');
                   deleteBtn.dataset.confirming = 'false';
               }
              return;
         }

         const timestampToDelete = Number(timestampString);
         if (isNaN(timestampToDelete)) {
              console.error("Neva≈æeƒái timestamp za brisanje:", timestampString); // Ostavljen kritiƒçan log
              alert("Gre≈°ka: Neva≈æeƒái identifikator skena.");
              // Resetiraj stanje gumba u sluƒçaju gre≈°ke
              const deleteBtn = document.getElementById('delete-session-btn');
              if(deleteBtn && deleteBtn.dataset.confirming === 'true') {
                  deleteBtn.innerText = "IZBRI≈†I OVAJ SKEN";
                  deleteBtn.classList.remove('confirm-mode');
                  deleteBtn.dataset.confirming = 'false';
              }
              return;
         }

         console.log("Brisanje sesije s timestampom:", timestampToDelete); // Ostavljen ovaj log
         let punaPovijest = loadFullHistoryFromLocalStorage();
         const originalLength = punaPovijest.length;

         // Pronaƒëi sesiju za logiranje prije nego se filtrira
         const sessionToDelete = punaPovijest.find(grupa => {
              if (typeof grupa.timestamp !== 'number' || isNaN(grupa.timestamp)) {
                   return false; // Ignoriraj neispravne entryje
              }
              return grupa.timestamp === timestampToDelete;
         });


         const filtriranaPovijest = punaPovijest.filter(grupa => {
              // Ukljuƒçi grupe s neispravnim timestampom, osim ako im je timestamp=timestampToDelete
              if (typeof grupa.timestamp !== 'number' || isNaN(grupa.timestamp)) {
                   return true; // Zadr≈æi neispravne entryje ako njihov timestamp nije timestampToDelete
              }
              // Zadr≈æi grupe ƒçiji timestamp nije jednak timestampToDelete
              return grupa.timestamp !== timestampToDelete;
         });

         const newLength = filtriranaPovijest.length; // <-- Ispravljeno
         console.log(`Originalna du≈æina: ${originalLength}, Nova du≈æina: ${newLength}`); // Ostavljen ovaj log

         if (newLength < originalLength) {
              // Ako je barem jedna sesija obrisana
              saveFullHistoryToLocalStorage(filtriranaPovijest); // Spremi modificiranu povijest
              playSound('remove-sound'); // ZVUK ZA BRISANJE SPREMLJENE SESIJE (smeƒáe.mp3)
              alert("Sken obrisan iz povijesti.");

              // Logiranje uspje≈°nog brisanja sesije
              sendLogData({ Event: 'session_deleted_confirmed', Details: { timestamp: timestampToDelete, name: sessionToDelete?.name || null, count: sessionToDelete?.racuni.length || 0, total: sessionToDelete?.racuni.reduce((sum, item) => sum + item.amount, 0) || 0 } });

              // Nakon brisanja, vrati se na prikaz dana ili all-days, ovisno odakle si do≈°ao
              switch (previousHistoryViewState) {
                   case 'day-search-results':
                   case 'day-view':
                       // Vrati se na prikaz dana. renderHistoryView ƒáe se pobrinuti za re-renderiranje dana
                       // ako je obrisana sesija bila u tom danu.
                       renderHistoryView(currentlyViewedDate);
                       break;
                   case 'all-days-search-results':
                   case 'all-days-view':
                       // Vrati se na prikaz svih dana. renderAllDaysView ƒáe se pobrinuti za re-renderiranje.
                       renderAllDaysView();
                       break;
                  default:
                      // Fallback, vrati se na prikaz dana
                      renderHistoryView(currentlyViewedDate);
              }
         } else {
              // Ako sesija nije pronaƒëena
              console.warn("Sesija za brisanje nije pronaƒëena:", timestampToDelete); // Ostavljen log upozorenja
              alert("Gre≈°ka: Sken nije pronaƒëen."); // Obavijesti korisnika

              // Resetiraj stanje gumba za brisanje sesije
              const deleteBtn = document.getElementById('delete-session-btn');
              if(deleteBtn && deleteBtn.dataset.confirming === 'true') {
                   deleteBtn.innerText = "IZBRI≈†I OVAJ SKEN";
                   deleteBtn.classList.remove('confirm-mode');
                   deleteBtn.dataset.confirming = 'false';
              }
         }
     }

    // Funkcija za renderiranje prikaza svih dana
    function renderAllDaysView() {
        previousHistoryViewState = 'all-days-view'; // Postavi trenutno stanje prikaza
        const punaPovijest = loadFullHistoryFromLocalStorage();

        if (!historyContentDiv || !historyPageDiv || !historyDynamicHeaderContentDiv) {
             console.error("renderAllDaysView: Kritiƒçni DOM elementi nedostaju!"); // Ostavljen kritiƒçan log
             return;
        }

        clearDynamicHeaderContent(); // Oƒçisti dinamiƒçki header

        // --- Renderiranje Dinamiƒçkog Headera (Svi Dani) ---
        const searchBarHtml = `
             <div id="all-days-search-container">
                 <div style="display: flex; gap: 5px;">
                     <input type="text" id="all-days-search-input" placeholder="UPI≈†I ZA PRETRAGU..." style="flex-grow: 1; padding: 0.5em; font-size: 0.9em;">
                     <button id="execute-all-days-search-btn" style="padding: 0.5em 0.6em; font-size: 0.9em;">Tra≈æi</button>
                     <button id="close-all-days-search-btn" style="padding: 0.5em 0.6em; background-color: #ccc; font-size: 0.9em;">Svi Dani</button>
                 </div>
             </div>
             <div id="all-days-summary-info" style="display: none;"></div>
        `;
        historyDynamicHeaderContentDiv.innerHTML = searchBarHtml;

        // --- Renderiranje Sadr≈æaja (Mjesto za listu dana/rezultate i gumbe) ---
        const resultsPlaceholderHtml = `<div id="search-results-all-days"><p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p></div>`;
        historyContentDiv.innerHTML = resultsPlaceholderHtml; // Ovo ƒáe se zamijeniti listom dana ili rezultatima pretrage

        // Dohvati reference na novododane elemente
        const searchInput = document.getElementById('all-days-search-input');
        const executeBtn = document.getElementById('execute-all-days-search-btn');
        const closeBtn = document.getElementById('close-all-days-search-btn');
        const searchResultsContainer = document.getElementById('search-results-all-days'); // Ovo je div unutar history-content
        const allDaysSummaryContainer = document.getElementById('all-days-summary-info'); // Ovo je div unutar history-sticky-header dynamic content

        // Grupiraj sesije po danu i sortiraj dane (od najnovijeg)
        const sessionsByDate = punaPovijest.reduce((acc, session) => {
             const sessionDate = new Date(session.timestamp);
              if (isNaN(sessionDate.getTime())) return acc; // Ignoriraj neispravne datume u sesijama
             const dateStr = getISODateString(sessionDate);
              if (!dateStr) return acc; // Zanemari sesije bez ispravnog datuma stringa

             if (!acc[dateStr]) {
                  acc[dateStr] = {
                       date: new Date(sessionDate), // Koristi datum (na 00:00:00)
                       sessions: [],
                       totalAmount: 0,
                       totalCount: 0
                  };
                  acc[dateStr].date.setHours(0, 0, 0, 0); // Postavi vrijeme na poƒçetak dana radi usporedbe
             }
             acc[dateStr].sessions.push(session);
             acc[dateStr].totalAmount += session.racuni.reduce((sum, item) => sum + item.amount, 0);
             acc[dateStr].totalCount += session.racuni.length;
             return acc;
        }, {});

        const sortedDays = Object.values(sessionsByDate).sort((a, b) => b.date - a.date); // Sortiraj po datumu desc

         // Re-attach listeners za elemente pretrage u All Days headeru
         if(searchInput && executeBtn && closeBtn && searchResultsContainer && allDaysSummaryContainer) {
              // Listener za Enter tipku u search inputu
              const newSearchInput = searchInput.cloneNode(true);
              searchInput.parentNode.replaceChild(newSearchInput, searchInput);
              newSearchInput.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter') {
                      e.preventDefault(); // Sprijeƒçi defaultnu Enter akciju (npr. submit forme)
                      executeAllDaysSearch();
                  }
              });

              // Listener za gumb "Tra≈æi"
              const newExecuteBtn = executeBtn.cloneNode(true);
              executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn);
              newExecuteBtn.addEventListener('click', () => {
                  executeAllDaysSearch(); // Izvr≈°i pretragu
              });

              // Listener za gumb "Svi Dani" (zatvara pretragu, prikazuje listu dana)
              const newCloseBtn = closeBtn.cloneNode(true);
              closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
              newCloseBtn.addEventListener('click', () => {
                  playSound('click-sound'); // Zvuk na klik
                  newSearchInput.value = ''; // Oƒçisti search input
                  lastSearchTerm = ''; // Resetiraj zadnji pojam za pretragu
                  renderAllDaysList(sortedDays, searchResultsContainer); // Prika≈æi listu svih dana

                  // A≈æuriraj i prika≈æi ukupni sa≈æetak za SVE dane
                  const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0);
                  const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0);
                  allDaysSummaryContainer.innerHTML = `<span>RAƒåUNA: <span style="font-weight: bold;">${totalCountAll}</span></span><span style="font-weight: bold;">UKUPNO: ${totalAmountAll.toFixed(2)} ‚Ç¨</span>`;
                   allDaysSummaryContainer.style.display = punaPovijest.length > 0 ? 'flex' : 'none'; // Prikazi ako ima povijesti
              });
         } else {
              console.error("Nisu pronaƒëeni svi elementi za pretragu u All Days View."); // Ostavljen kritiƒçan log
         }


         // Dodaj gumbe "NATRAG", "IZBRI≈†I SVU POVIJEST", "Izvezi", "Uvezi" ako ima povijesti
         // Ovi gumbi su unutar history-content
        if (punaPovijest.length > 0) {
             const backButtonHtml = `<button id="back-to-current-day-btn" style="background-color: #6c757d; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">< NATRAG</button>`;
             const clearAllButtonHtml = `<button id="clear-history-btn" class="red-btn" style="padding: 0.5em 1em; font-size: 1em;">IZBRI≈†I SVU POVIJEST</button>`;
             const exportButtonHtml = `<button id="export-history-btn" style="background-color: #007bff; color: white; margin-right: 10px; padding: 0.5em 1em; font-size: 1em;">Izvezi povijest</button>`;
             const importButtonHtml = `<button id="import-history-btn" style="background-color: #28a745; color: white; padding: 0.5em 1em; font-size: 1em;">Uvezi povijest</button>`;


             const buttonsHtml = `
                 <div style="text-align: center; margin-top: 1.5em; margin-bottom: 1em;">
                      ${backButtonHtml}${clearAllButtonHtml}
                 </div>
                 <div style="text-align: center; margin-top: 1em; margin-bottom: 1em;">
                     ${exportButtonHtml}${importButtonHtml}
                 </div>
             `;

             // Provjeri jesu li gumbi veƒá dodani (kako bi se izbjeglo dupliciranje listenera)
             if (!document.getElementById('back-to-current-day-btn')) { // Provjeri samo jedan gumb
                  historyContentDiv.insertAdjacentHTML('beforeend', buttonsHtml);
             }


             // Dohvati reference na gumbe NAKON ≈°to su potencijalno dodani
             const backToDayBtn = document.getElementById('back-to-current-day-btn');
             const clearAllBtn = document.getElementById('clear-history-btn');
             const exportBtn = document.getElementById('export-history-btn');
             const importBtnDisplay = document.getElementById('import-history-btn'); // Gumb koji se prikazuje

             // Re-attach listener za gumb "NATRAG"
             if (backToDayBtn) {
                  const newBackBtn = backToDayBtn.cloneNode(true);
                  backToDayBtn.parentNode.replaceChild(newBackBtn, backToDayBtn);
                  newBackBtn.addEventListener('click', () => {
                       playSound('click-sound'); // Zvuk na klik
                       renderHistoryView(currentlyViewedDate); // Vrati se na prikaz dana (zadnji prikazani dan)
                  });
             } else { console.error("Gumb #back-to-current-day-btn nije pronaƒëen."); } // Ostavljen kritiƒçan log


             // Re-attach listener za gumb "IZBRI≈†I SVU POVIJEST"
             if (clearAllBtn) {
                 // Onemoguƒái gumb ako je povijest prazna (iako bi cijeli blok s gumbima trebao biti skriven tad)
                 if (punaPovijest.length === 0) {
                      clearAllBtn.disabled = true;
                      clearAllBtn.style.opacity = '0.6';
                      clearAllBtn.style.cursor = 'not-allowed';
                 } else {
                      clearAllBtn.disabled = false;
                      clearAllBtn.style.opacity = '1';
                      clearAllBtn.style.cursor = 'pointer';
                 }

                  clearAllBtn.dataset.confirming = 'false'; // Inicijalno stanje potvrde
                  const newClearAllBtn = clearAllBtn.cloneNode(true);
                  clearAllBtn.parentNode.replaceChild(newClearAllBtn, clearAllBtn); // Zamijeni gumb
                  newClearAllBtn.addEventListener('click', () => {
                      if (newClearAllBtn.disabled) return; // Ne radi ni≈°ta ako je disabled

                      if (newClearAllBtn.dataset.confirming !== 'true') {
                           // Prvi klik - prebaci u mod potvrde
                           playSound('click-sound'); // Zvuk na prvi klik za potvrdu
                           newClearAllBtn.innerText = "Potvrdi Brisanje SVEGA?";
                           newClearAllBtn.classList.add('confirm-mode');
                           newClearAllBtn.dataset.confirming = 'true'; // Postavi confirming na true
                            sendLogData({ Event: 'clear_all_prompt' }); // Logiranje poku≈°aja
                       } else {
                           // Drugi klik - POTVRDA brisanja SVEGA
                           // Nema click sound ovdje, remove-sound ƒáe svirati ako brisanje uspije
                           // Bri≈°i SVE iz localStorage-a
                           localStorage.removeItem(HISTORY_STORAGE_KEY);
                           localStorage.removeItem(COUNTER_KEY);
                           localStorage.removeItem(COUNTER2_KEY);
                           localStorage.removeItem(COUNTER_ACTIVE_KEY);
                           localStorage.removeItem(USER_ID_KEY); // Resetiraj i usera
                           localStorage.removeItem(FIRST_USE_KEY); // Resetiraj i timestamp
                           localStorage.removeItem(UNSAVED_COUNT_KEY); // Bri≈°i nesaƒçuvano
                           localStorage.removeItem(UNSAVED_AMOUNT_KEY); // Bri≈°i nesaƒçuvano
                           localStorage.removeItem(CAMERA_ID_KEY); /* <<< Bri≈°i spremljenu kameru */

                           alert("Sva spremljena povijest i podaci brojaƒça/kamere obrisani."); // Obavijesti korisnika

                            // Logiranje brisanja svega
                            sendLogData({ Event: 'clear_all_confirmed' });

                           // Resetiraj globalne varijable
                           povijest = [];
                           ukupno = 0;
                           currentSessionName = null;
                           currentlyViewedDate = new Date(); currentlyViewedDate.setHours(0,0,0,0);

                           // Uƒçitaj resetirano stanje (brojaƒçi ƒáe biti null -> inicijaliziraju se na 0)
                           loadCountersState(); // Ova funkcija SADA NE ZOVEE updateDeactivatedIndicator

                           // Reinicijaliziraj User Tracking (dobit ƒáe novi ID)
                           initializeUserTracking();

                           // Ponovno dohvati podatke iz Sheeta (ovo ƒáe a≈æurirati tekst poruka i brojaƒç2)
                           // Zatim renderiraj prikaz svih dana i a≈æuriraj UI indikator
                           fetchSheetData().then(() => {
                                // Nakon uspje≈°nog fetchSheetData, tada pozovi render i UI update
                                renderAllDaysView();
                                updateDeactivatedIndicator(); // A≈æuriraj UI indikator nakon reseta i uƒçitavanja stanja
                           }).catch(() => {
                                // ƒåak i ako fetch Sheet-a ne uspije, renderiraj i a≈æuriraj UI
                                tekstPoruka = ""; // Resetiraj tekst poruke
                                updateRunningText(); // Osiguraj da se prazan tekst ne prikazuje s animacijom
                                renderAllDaysView();
                                updateDeactivatedIndicator(); // A≈æuriraj UI indikator nakon reseta
                           });

                           playSound('remove-sound'); // ZVUK ZA BRISANJE CIJELE POVIJESTI (smeƒáe.mp3)
                       }
                   });

                   // Listener na cijelu history-page za resetiranje confirm moda gumba "IZBRI≈†I SVU POVIJEST"
                   const allDaysParentClickHandler = (e) => {
                       const currentClearAllBtn = document.getElementById('clear-history-btn'); // Ponovno dohvati gumb
                       // Resetiraj samo ako je gumb u confirm modu i klik NIJE na gumb
                       if (currentClearAllBtn && currentClearAllBtn.dataset.confirming === 'true' && !currentClearAllBtn.contains(e.target)) {
                           currentClearAllBtn.innerText = "IZBRI≈†I SVU POVIJEST"; // Vrati poƒçetni tekst
                           currentClearAllBtn.classList.remove('confirm-mode'); // Ukloni confirm klasu
                           currentClearAllBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                            sendLogData({ Event: 'clear_all_cancelled_outside' }); // Logiranje otkazivanja
                       }
                   };
                   // Ukloni prethodni listener prije dodavanja novog
                   historyPageDiv.removeEventListener('click', allDaysParentClickHandler, true);
                   // Dodaj listener na historyPageDiv (capturing phase)
                   historyPageDiv.addEventListener('click', allDaysParentClickHandler, true);
             } else { console.error("Gumb #clear-history-btn nije pronaƒëen."); } // Ostavljen kritiƒçan log


             // Re-attach listener za gumb "Izvezi povijest"
             if (exportBtn) {
                 const newExportBtn = exportBtn.cloneNode(true);
                 exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
                 newExportBtn.addEventListener('click', exportHistory); // Pozovi export funkciju
             } else { console.error("Gumb #export-history-btn nije pronaƒëen."); } // Ostavljen kritiƒçan log

             // Re-attach listener za gumb "Uvezi povijest"
             // Ovaj gumb samo trigera klik na skriveni file input
             if (importBtnDisplay) {
                 const newImportBtn = importBtnDisplay.cloneNode(true);
                 importBtnDisplay.parentNode.replaceChild(newImportBtn, importBtnDisplay);
                 newImportBtn.addEventListener('click', importHistory); // Pozovi import funkciju
             } else { console.error("Gumb #import-history-btn nije pronaƒëen."); } // Ostavljen kritiƒçan log

        }


         // Prika≈æi listu dana i ukupni sa≈æetak svih dana pri prvom renderu "Svi Dani"
         // ili ako je pretraga prazna
        if (punaPovijest.length > 0 && searchResultsContainer && allDaysSummaryContainer) {
             renderAllDaysList(sortedDays, searchResultsContainer); // Prika≈æi listu dana
             const totalCountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.length, 0);
             const totalAmountAll = punaPovijest.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0);
             allDaysSummaryContainer.innerHTML = `<span>RAƒåUNA: <span style="font-weight: bold;">${totalCountAll}</span></span><span style="font-weight: bold;">UKUPNO: ${totalAmountAll.toFixed(2)} ‚Ç¨</span>`;
             allDaysSummaryContainer.style.display = 'flex'; // Prikazi sa≈æetak
        } else {
             // Ako nema povijesti, sakrij sa≈æetak
             if (allDaysSummaryContainer) allDaysSummaryContainer.style.display = 'none';
             // Placeholder text u searchResultsContainer veƒá ka≈æe da nema povijesti
        }

    }

    // Funkcija za renderiranje liste dana ili rezultata pretrage po danima
    function renderAllDaysList(daysData, containerElement) {
        if (!containerElement) return; // Check if container exists

        const opcijeDana = { weekday: 'long' };
        const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' };

        let daysHtml = '<ul id="all-days-list-rendered" style="list-style: none; padding: 0; margin: 0;">';

        if (daysData.length === 0) {
             // Prikazi poruku ako nema dana ili nema rezultata pretrage
             if (containerElement.id === 'search-results-all-days' && document.getElementById('all-days-search-input')?.value.trim()) {
                  daysHtml += '<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za tra≈æeni pojam.</i></li>';
             } else {
                  daysHtml += '<li style="text-align:center; color: grey; padding: 1em 0;"><i>Nema spremljene povijesti.</i></li>';
             }
        } else {
             // Generiraj HTML za svaki dan
             daysData.forEach(dayInfo => {
                  let imeDana = dayInfo.date.toLocaleDateString('hr-HR', opcijeDana);
                  imeDana = imeDana.charAt(0).toUpperCase() + imeDana.slice(1); // Kapitaliziraj
                  const formatiraniDatum = dayInfo.date.toLocaleDateString('hr-HR', opcijeDatuma);
                  const isoDate = getISODateString(dayInfo.date); // ISO format za data-atribut

                  daysHtml += `
                       <li data-date-iso="${isoDate}" style="background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                           <span style="font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">${imeDana}, ${formatiraniDatum}</span>
                           <div style="flex-shrink: 0; text-align: right;">
                                <span style="font-size: 0.9em; color: #555; white-space: nowrap;">Raƒçuna: ${dayInfo.totalCount}</span>
                                <span style="font-weight: bold; margin-left: 15px; white-space: nowrap;">${dayInfo.totalAmount.toFixed(2)} ‚Ç¨</span>
                           </div>
                       </li>`;
             });
        }

        daysHtml += '</ul>';
        containerElement.innerHTML = daysHtml; // Postavi generirani HTML

        // Re-attach listener na listu dana za klik (otvaranje prikaza za taj dan)
        const listElement = containerElement.querySelector('ul');
        if (listElement) {
             const newListElement = listElement.cloneNode(true); // Kloniraj listu
             listElement.parentNode.replaceChild(newListElement, listElement); // Zamijeni staru listu
             newListElement.addEventListener('click', (e) => {
                  const clickedDayLi = e.target.closest('li[data-date-iso]'); // Pronaƒëi najbli≈æi <li> sa data-date-iso
                  if (clickedDayLi && clickedDayLi.dataset.dateIso) {
                       const selectedDate = new Date(clickedDayLi.dataset.dateIso + 'T00:00:00'); // Kreiraj datum objekt
                       playSound('click-sound'); // Zvuk na klik
                       currentlyViewedDate = selectedDate; // Postavi trenutni datum prikaza
                       renderHistoryView(selectedDate); // Prikazi povijest za taj dan
                  }
             });
        }
    }


    // Funkcija za pokretanje pretrage iz prikaza dana (sada pretra≈æuje SVE)
    function startSearch() {
        playSound('click-sound'); // Zvuk na klik
        console.log("Pokretanje pretrage (sada pretra≈æuje SVE)..."); // Ostavljen ovaj log

        if (!historyContentDiv || !historyDynamicHeaderContentDiv) {
             console.error("startSearch: Kritiƒçni DOM elementi nedostaju!"); // Ostavljen kritiƒçan log
             return;
        }

        // Sakrij elemente specifiƒçne za prikaz dana
        const originalList = document.getElementById('scan-group-list');
        if(originalList) originalList.style.display = 'none';
        const originalInstruction = document.getElementById('history-select-group-text');
        if(originalInstruction) originalInstruction.style.display = 'none';
        const clearDayBtn = document.getElementById('clear-day-btn');
        if(clearDayBtn) clearDayBtn.style.display = 'none'; // Sakrij gumb za brisanje dana

        // Sakrij elemente vezane za datum i sa≈æetak dana iz headera
        const dateInfoDiv = document.getElementById('history-date-info');
        const summaryInfoDiv = document.getElementById('history-summary-info');
        if (dateInfoDiv) dateInfoDiv.style.display = 'none';
        if (summaryInfoDiv) summaryInfoDiv.style.display = 'none';

        // Dodaj ili prika≈æi search container u dinamiƒçkom headeru
        let searchContainer = document.getElementById('search-container');
        if (!searchContainer) {
             searchContainer = document.createElement('div');
             searchContainer.id = 'search-container';
             // HTML za search input i gumbe unutar headera
             searchContainer.innerHTML = `
                 <div style="display: flex; gap: 10px; margin-bottom: 0.8em;">
                     <input type="text" id="search-input" placeholder="Pretra≈æi SVE (Datum, Dan, Naziv...)" style="flex-grow: 1; padding: 0.5em;">
                     <button id="execute-search-btn" style="padding: 0.5em 1em;">Tra≈æi</button>
                     <button id="close-search-btn" style="padding: 0.5em 1em; background-color: #ccc;">Zatvori</button>
                 </div>
                 <div id="search-summary-info-day" style="display: none;"></div> <!-- Sa≈æetak rezultata unutar headera -->
             `;
             historyDynamicHeaderContentDiv.appendChild(searchContainer);
        }
        searchContainer.style.display = 'block'; // Prikazi search container


        // Resetiraj sadr≈æaj history-content i prika≈æi placeholder za rezultate
        historyContentDiv.innerHTML = '<div id="search-results"><p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu.</i></p></div>';
        const searchResultsDiv = document.getElementById('search-results'); // Ovo je div unutar history-content
        if(searchResultsDiv) searchResultsDiv.style.display = 'block'; // Prikazi ga

        // Dohvati elemente unutar search containera (svje≈æe ili postojeƒáe)
        const searchInput = document.getElementById('search-input');
        const executeBtn = document.getElementById('execute-search-btn');
        const closeBtn = document.getElementById('close-search-btn');
        const searchSummaryDay = document.getElementById('search-summary-info-day'); // Sa≈æetak rezultata

        // Inicijaliziraj input i fokusiraj ga
        if (searchInput) {
             searchInput.value = ''; // Oƒçisti prethodni pojam
             searchInput.focus(); // Fokusiraj input
        }

        // Sakrij i oƒçisti sa≈æetak rezultata
        if (searchSummaryDay) {
             searchSummaryDay.style.display = 'none';
             searchSummaryDay.innerHTML = '';
        }


        // Re-attach listener za gumb "Tra≈æi"
        if (executeBtn) {
             const newExecuteBtn = executeBtn.cloneNode(true);
             executeBtn.parentNode.replaceChild(newExecuteBtn, executeBtn);
             newExecuteBtn.addEventListener('click', executeSearch); // Pozovi executeSearch
        } else { console.error("Gumb #execute-search-btn nije pronaƒëen."); } // Ostavljen kritiƒçan log


        // Re-attach listener za gumb "Zatvori"
        if (closeBtn) {
             const newCloseBtn = closeBtn.cloneNode(true);
             closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
             newCloseBtn.addEventListener('click', () => {
                  playSound('click-sound'); // Zvuk na klik
                  if (searchContainer) searchContainer.style.display = 'none'; // Sakrij search container
                  renderHistoryView(currentlyViewedDate); // Vrati se na prikaz dana (zadnji prikazani dan)
             });
        } else { console.error("Gumb #close-search-btn nije pronaƒëen."); } // Ostavljen kritiƒçan log


        // Re-attach listener za Enter tipku u search inputu
        if (searchInput) {
             const newSearchInput = searchInput.cloneNode(true);
             searchInput.parentNode.replaceChild(newSearchInput, searchInput);
             newSearchInput.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter') {
                       e.preventDefault(); // Sprijeƒçi defaultnu Enter akciju
                       executeSearch(); // Izvr≈°i pretragu
                  }
             });
        }

    }

    // Funkcija za izvr≈°avanje pretrage (sada pretra≈æuje SVE dane)
    function executeSearch() {
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('search-results'); // Rezultati idu u #search-results div unutar history-content
        const summaryContainer = document.getElementById('search-summary-info-day'); // Sa≈æetak ide u #search-summary-info-day div unutar dinamiƒçkog headera

        if (!searchInput || !resultsContainer || !summaryContainer) {
             console.error("executeSearch: Nedostaju DOM elementi."); // Ostavljen kritiƒçan log
             return;
        }

        const searchTerm = searchInput.value.trim().toLowerCase();
        lastSearchTerm = searchInput.value.trim(); // Spremi zadnji pojam za povratak iz detalja
        const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim());

        /* console.log("--- executeSearch (Sada pretra≈æuje SVE DANE) ---");
        console.log("Tra≈æim pojam:", searchTerm);
        console.log("Normalizirani datum za pretragu:", normalizedSearchDate); */ // KOMENTIRANO: Previ≈°e logova

        resultsContainer.innerHTML = ''; // Oƒçisti prethodne rezultate
        summaryContainer.style.display = 'none'; // Sakrij sa≈æetak
        summaryContainer.innerHTML = ''; // Oƒçisti sa≈æetak

        if (!searchTerm && !normalizedSearchDate) {
             // Ako je pojam prazan, prika≈æi uputu
             resultsContainer.innerHTML = '<p style="text-align:center; color: grey;"><i>Unesite pojam za pretragu (datum, dan, naziv, ili dio QR/DATV stringa).</i></p>';
             return; // Zavr≈°i funkciju
        }

        const punaPovijest = loadFullHistoryFromLocalStorage();
        const searchResults = [];

        // Opcije za formatiranje datuma za pretragu
        const opcijeDana = { weekday: 'long' };
        const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' };


        punaPovijest.forEach((grupa, index) => {
             const sessionDate = new Date(grupa.timestamp);
              if (isNaN(sessionDate.getTime())) return; // Preskoƒçi grupe s neispravnim datumom

             /* console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); */ // KOMENTIRANO: Previ≈°e logova

             // Pripremi stringove za usporedbu
             const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); // npr. 08.05.2025
             const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort);     // npr. 08.05.25
             const normalizedSessionDate = getISODateString(sessionDate);                             // npr. 2025-05-08
             let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase();          // npr. ƒçetvrtak
             const sessionName = grupa.name ? grupa.name.toLowerCase() : '';                          // naziv sesije (ili prazno)

             let match = false;
             /* console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); */ // KOMENTIRANO: Previ≈°e logova

             // Prvo provjeri toƒçan datum ako je normaliziran
             if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) {
                  /* console.log("    MATCH: Toƒçan datum!"); */ // KOMENTIRANO: Previ≈°e logova
                  match = true;
             }

             // Ako nije toƒçan datum match ILI ako nije unesen datum, provjeri pojam kao tekst
             if (!match && searchTerm) {
                  /* console.log("    Provjeravam kao tekst..."); */ // KOMENTIRANO: Previ≈°e logova
                  if (formattedDateShort.includes(searchTerm)) {
                       /* console.log("    MATCH: Kratki datum sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                       match = true;
                  } else if (formattedDateNumeric.includes(searchTerm)) {
                       /* console.log("    MATCH: Numeriƒçki datum sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                       match = true;
                  } else if (dayName.includes(searchTerm)) {
                       /* console.log(`    MATCH: Ime dana ('${dayName}') sadr≈æi pojam ('${searchTerm}').`); */ // KOMENTIRANO: Previ≈°e logova
                       match = true;
                  } else if (sessionName && sessionName.includes(searchTerm)) {
                       /* console.log("    MATCH: Naziv sesije sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                       match = true;
                  } else if (grupa.racuni.some(racun =>
                       racun.qrCode.toLowerCase().includes(searchTerm) || // Pretra≈æivanje unutar QR koda
                       (racun.datv && racun.datv.toLowerCase().includes(searchTerm)) || // Pretra≈æivanje unutar DATV stringa (datum i vrijeme)
                       (String(racun.amount).replace('.', ',').includes(searchTerm)) || // Pretra≈æivanje po iznosu (s toƒçkom ili zarezom)
                        (racun.time && racun.time.includes(searchTerm)) // Pretra≈æivanje po vremenu raƒçuna (HH:MM)
                       )) {
                        /* console.log("    MATCH: Sadr≈æaj raƒçuna (QR/DATV/Iznos/Vrijeme) sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                        match = true;
                   }
                   /* else { console.log("    Nema tekstualnog matcha."); } */ // KOMENTIRANO: Previ≈°e logova
             }

             // Ako postoji match, dodaj grupu u rezultate
             if (match) {
                  searchResults.push(grupa);
             }
        });

        /* console.log("Ukupno pronaƒëeno rezultata (SVI DANI):", searchResults.length);
        console.log("--- kraj executeSearch (SVI DANI) ---"); */ // KOMENTIRANO: Previ≈°e logova

        // Renderiraj listu pronaƒëenih sesija i a≈æuriraj sa≈æetak
        renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer);

        // Sakrij originalnu listu sesija za dan i uputu (koje su u history-content)
        const originalList = document.getElementById('scan-group-list');
        if(originalList) originalList.style.display = 'none';
        const originalInstruction = document.getElementById('history-select-group-text');
        if(originalInstruction) originalInstruction.style.display = 'none';
        const clearDayBtn = document.getElementById('clear-day-btn');
        if(clearDayBtn) clearDayBtn.style.display = 'none'; // Sakrij gumb za brisanje dana

         // Prika≈æi div s rezultatima
         resultsContainer.style.display = 'block';


         sendLogData({ Event: 'history_search_day_view', Details: { term: searchTerm, resultCount: searchResults.length } }); // Logiranje pretrage
    }


    // Funkcija za izvr≈°avanje pretrage SVIH dana (iz prikaza Svi Dani)
    function executeAllDaysSearch() {
        const searchInput = document.getElementById('all-days-search-input');
        const resultsContainer = document.getElementById('search-results-all-days'); // Rezultati idu u #search-results-all-days div unutar history-content
        const summaryContainer = document.getElementById('all-days-summary-info'); // Sa≈æetak ide u #all-days-summary-info div unutar dinamiƒçkog headera

        if (!searchInput || !resultsContainer || !summaryContainer) {
             console.error("executeAllDaysSearch: Nedostaju DOM elementi."); // Ostavljen kritiƒçan log
             return;
        }

        const searchTerm = searchInput.value.trim().toLowerCase();
        lastSearchTerm = searchInput.value.trim(); // Spremi zadnji pojam za povratak iz detalja
        const normalizedSearchDate = normalizeDateForSearch(searchInput.value.trim());

        /* console.log("--- executeAllDaysSearch ---");
        console.log("Tra≈æim pojam:", searchTerm);
        console.log("Normalizirani datum za pretragu:", normalizedSearchDate); */ // KOMENTIRANO: Previ≈°e logova


        resultsContainer.innerHTML = ''; // Oƒçisti prethodne rezultate
        summaryContainer.style.display = 'none'; // Sakrij sa≈æetak
        summaryContainer.innerHTML = ''; // Oƒçisti sa≈æetak

        if (!searchTerm && !normalizedSearchDate) {
             // Ako je pojam prazan, prika≈æi uputu
             resultsContainer.innerHTML = '<p style="text-align:center; color: grey; padding: 1em 0;"><i>Unesite pojam za pretragu ili kliknite "Svi Dani" za prikaz liste.</i></p>';
             return; // Zavr≈°i funkciju
        }

        const punaPovijest = loadFullHistoryFromLocalStorage();
        const searchResults = [];

         // Opcije za formatiranje datuma za pretragu (iste kao u executeSearch)
         const opcijeDana = { weekday: 'long' };
         const opcijeDatumaNumeric = { day: '2-digit', month: '2-digit', year: 'numeric' };
         const opcijeDatumaShort = { day: '2-digit', month: '2-digit', year: '2-digit' };

        punaPovijest.forEach((grupa, index) => {
            const sessionDate = new Date(grupa.timestamp);
             if (isNaN(sessionDate.getTime())) return; // Preskoƒçi grupe s neispravnim datumom

            /* console.log(`Provjeravam sesiju #${index + 1} (Timestamp: ${grupa.timestamp})`); */ // KOMENTIRANO: Previ≈°e logova

            // Pripremi stringove za usporedbu
            const formattedDateNumeric = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaNumeric); // npr. 08.05.2025
            const formattedDateShort = sessionDate.toLocaleDateString('hr-HR', opcijeDatumaShort);     // npr. 08.05.25
            const normalizedSessionDate = getISODateString(sessionDate);                             // npr. 2025-05-08
            let dayName = sessionDate.toLocaleDateString('hr-HR', opcijeDana).toLowerCase();          // npr. ƒçetvrtak
            const sessionName = grupa.name ? grupa.name.toLowerCase() : '';                          // naziv sesije (ili prazno)

            let match = false;
            /* console.log(`  -> Sesija Datum (ISO): ${normalizedSessionDate}, Dan: ${dayName}, Naziv: ${sessionName || 'N/A'}`); */ // KOMENTIRANO: Previ≈°e logova

            // Prvo provjeri toƒçan datum ako je normaliziran
            if (normalizedSearchDate && normalizedSessionDate && normalizedSessionDate === normalizedSearchDate) {
                 /* console.log("    MATCH: Toƒçan datum!"); */ // KOMENTIRANO: Previ≈°e logova
                 match = true;
            }

            // Ako nije toƒçan datum match ILI ako nije unesen datum, provjeri pojam kao tekst
            if (!match && searchTerm) {
                 /* console.log("    Provjeravam kao tekst..."); */ // KOMENTIRANO: Previ≈°e logova
                 if (formattedDateShort.includes(searchTerm)) {
                      /* console.log("    MATCH: Kratki datum sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                      match = true;
                 } else if (formattedDateNumeric.includes(searchTerm)) {
                      /* console.log("    MATCH: Numeriƒçki datum sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                      match = true;
                 } else if (dayName.includes(searchTerm)) {
                      /* console.log(`    MATCH: Ime dana ('${dayName}') sadr≈æi pojam ('${searchTerm}').`); */ // KOMENTIRANO: Previ≈°e logova
                      match = true;
                 } else if (sessionName && sessionName.includes(searchTerm)) {
                      /* console.log("    MATCH: Naziv sesije sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                      match = true;
                 } else if (grupa.racuni.some(racun =>
                       racun.qrCode.toLowerCase().includes(searchTerm) || // Pretra≈æivanje unutar QR koda
                       (racun.datv && racun.datv.toLowerCase().includes(searchTerm)) || // Pretra≈æivanje unutar DATV stringa (datum i vrijeme)
                       (String(racun.amount).replace('.', ',').includes(searchTerm)) || // Pretra≈æivanje po iznosu (s toƒçkom ili zarezom)
                        (racun.time && racun.time.includes(searchTerm)) // Pretra≈æivanje po vremenu raƒçuna (HH:MM)
                      )) {
                      /* console.log("    MATCH: Sadr≈æaj raƒçuna (QR/DATV/Iznos/Vrijeme) sadr≈æi pojam."); */ // KOMENTIRANO: Previ≈°e logova
                      match = true;
                 }
                  /* else { console.log("    Nema tekstualnog matcha."); } */ // KOMENTIRANO: Previ≈°e logova
            }

            // Ako postoji match, dodaj grupu u rezultate
            if (match) {
                 searchResults.push(grupa);
            }
        });

        /* console.log("Ukupno pronaƒëeno rezultata (SVI DANI):", searchResults.length);
        console.log("--- kraj executeAllDaysSearch ---"); */ // KOMENTIRANO: Previ≈°e logova

        // Renderiraj listu pronaƒëenih sesija i a≈æuriraj sa≈æetak
        renderSessionSearchResults(searchResults, resultsContainer, searchTerm, summaryContainer);

        // Gumb za brisanje SVE povijesti i gumbi za uvoz/izvoz ostaju vidljivi
        // (nalaze se izvan #search-results-all-days diva unutar #history-content)

         // Prika≈æi div s rezultatima
         resultsContainer.style.display = 'block';

         sendLogData({ Event: 'history_search_all_days', Details: { term: searchTerm, resultCount: searchResults.length } }); // Logiranje pretrage u "Svi Dani"
    }


    // Funkcija za renderiranje liste sesija (za rezultate pretrage ili listu dana po danima)
    function renderSessionSearchResults(results, containerElement, searchTerm, summaryContainer) {
        if (!containerElement || !summaryContainer) {
             console.error("renderSessionSearchResults: Nedostaju DOM elementi."); // Ostavljen kritiƒçan log
             return;
        }

        containerElement.innerHTML = ''; // Oƒçisti prethodni sadr≈æaj
        summaryContainer.innerHTML = ''; // Oƒçisti sa≈æetak
        summaryContainer.style.display = 'none'; // Sakrij sa≈æetak dok se ne popuni

        if (results.length === 0) {
             // Prikazi poruku ako nema rezultata
             containerElement.innerHTML = '<p style="text-align:center; color: grey; padding: 1em 0;"><i>Nema rezultata za tra≈æeni pojam.</i></p>';
             return; // Zavr≈°i funkciju
        }

        // Izraƒçunaj ukupno za rezultate pretrage
        const brojRacunaRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.length, 0);
        const ukupanIznosRezultati = results.reduce((sum, grupa) => sum + grupa.racuni.reduce((gSum, item) => gSum + item.amount, 0), 0);

        // A≈æuriraj i prika≈æi sa≈æetak rezultata
        summaryContainer.innerHTML = `<span>RAƒåUNA: <span style="font-weight: bold;">${brojRacunaRezultati}</span></span><span style="font-weight: bold;">UKUPNO: ${ukupanIznosRezultati.toFixed(2)} ‚Ç¨</span>`;
        summaryContainer.style.display = 'flex'; // Prikazi sa≈æetak


        // Sortiraj rezultate po timestampu (od najnovijeg)
        results.sort((a, b) => b.timestamp - a.timestamp);

        let resultsHtml = '<ul id="search-results-list" style="list-style: none; padding: 0; margin: 0;">';
        const opcijeDatuma = { day: '2-digit', month: '2-digit', year: '2-digit' };

        results.forEach(grupa => {
             const vrijemeSpremanja = new Date(grupa.timestamp);
              if (isNaN(vrijemeSpremanja.getTime())) return; // Preskoƒçi grupe s neispravnim datumom

             const datumString = vrijemeSpremanja.toLocaleDateString('hr-HR', opcijeDatuma); // Format datuma spremanja
             const satiSpremanja = vrijemeSpremanja.getHours().toString().padStart(2, '0');
             const minuteSpremanja = vrijemeSpremanja.getMinutes().toString().padStart(2, '0');
             const vrijemeSpremanjaFormatirano = `${satiSpremanja}:${minuteSpremanja}`;

             const ukupnoGrupa = grupa.racuni.reduce((sum, item) => sum + item.amount, 0);
             const zadnjeVrijeme = grupa.lastQrTime || '??:??'; // Zadnje vrijeme iz QR-a (ako postoji)

             const prikazNaziva = grupa.name ? `<span class="session-name-history">${grupa.name}</span>` : `<span class="scan-time-history">SKEN</span>`;

             resultsHtml += `
                  <li data-timestamp="${grupa.timestamp}" style="border: 1px solid #eee; border-radius: 4px; padding: 10px 12px; margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; cursor: pointer;">
                       <div style="font-weight: bold; margin-right: 8px; color: #666;">${datumString}</div> <!-- Datum spremanja -->
                       <div style="flex-grow: 1; min-width: 100px; display: inline-flex; align-items: center;">
                           ${prikazNaziva} <!-- Naziv sesije ili "SKEN" -->
                           <span style="font-size:0.9em; color:#555; margin-left: 5px;">u ${vrijemeSpremanjaFormatirano}</span> <!-- Vrijeme spremanja -->
                       </div>
                       <div style="flex-shrink: 0; margin-left: auto; padding-left: 10px; text-align: right;">
                           <span class="scan-group-last-qr-time">${zadnjeVrijeme !== '??:??' ? 'zadnji iz ' + zadnjeVrijeme : ''}</span> <!-- Zadnje vrijeme iz QR-a -->
                           <span style="font-weight: bold; margin-left: 10px;">${ukupnoGrupa.toFixed(2)} ‚Ç¨</span> <!-- Ukupno za sesiju -->
                       </div>
                  </li>`;
        });

        resultsHtml += '</ul>';
        containerElement.innerHTML = resultsHtml; // Postavi generirani HTML

        // Re-attach listener na listu rezultata za klik (otvaranje detalja)
        const resultsList = containerElement.querySelector('ul');
        if (resultsList) {
             const newListElement = resultsList.cloneNode(true); // Kloniraj listu
             resultsList.parentNode.replaceChild(newListElement, resultsList); // Zamijeni staru listu
             newListElement.addEventListener('click', (e) => {
                  const clickedLi = e.target.closest('li[data-timestamp]'); // Pronaƒëi najbli≈æi <li> sa data-timestamp
                  if (clickedLi && clickedLi.dataset.timestamp) {
                       const timestamp = clickedLi.dataset.timestamp;
                       const punaPovijest = loadFullHistoryFromLocalStorage(); // Ponovno uƒçitaj povijest
                       const selectedGroup = punaPovijest.find(g => String(g.timestamp) === timestamp); // Pronaƒëi sesiju

                       if (selectedGroup) {
                            playSound('click-sound'); // Zvuk na klik
                            // Postavi prethodno stanje prikaza na temelju KONTENJERA rezultata
                            if (containerElement.id === 'search-results') {
                                previousHistoryViewState = 'day-search-results'; // Pretraga iz prikaza dana
                                lastSearchTerm = document.getElementById('search-input')?.value.trim() || ''; // Zapamti pojam
                            } else if (containerElement.id === 'search-results-all-days') {
                                previousHistoryViewState = 'all-days-search-results'; // Pretraga iz prikaza svih dana
                                lastSearchTerm = document.getElementById('all-days-search-input')?.value.trim() || ''; // Zapamti pojam
                            }
                             // Postavi trenutni datum prikaza na datum odabrane sesije (za povratak na taj dan)
                            currentlyViewedDate = new Date(selectedGroup.timestamp);
                            currentlyViewedDate.setHours(0,0,0,0);

                            renderGroupDetailView(selectedGroup); // Prikazi detalje te sesije
                       } else {
                            console.error("Nije pronaƒëena grupa iz rezultata pretrage:", timestamp); // Ostavljen kritiƒçan log
                            alert("Gre≈°ka pri otvaranju detalja.");
                       }
                  }
             });
        }
    }


    // *** FUNKCIJE ZA IZVOZ I UVOZ POVIJESTI (PREMJE≈†TENE GORE) ***

    function exportHistory() {
        playSound('click-sound'); // Zvuk na klik
        const punaPovijest = loadFullHistoryFromLocalStorage(); // Uƒçitaj spremljenu povijest

        // Pripremi objekt za nesaƒçuvano stanje (ako postoji)
        const unsavedData = (povijest.length > 0 || currentSessionName) ?
            { count: povijest.length, amount: ukupno, currentSession: povijest, currentName: currentSessionName || null }
            : null;

        // Provjeri ima li uopƒáe podataka za izvoz
        if (punaPovijest.length === 0 && !unsavedData) {
            alert("Nema povijesti za izvoz.");
             sendLogData({ Event: 'history_exported', Details: 'no_data' }); // Logiranje izvoza (nema podataka)
            return;
        }

        try {
            // Kreiraj objekt s podacima za izvoz (format v2)
            const dataToExport = {
                 savedHistory: punaPovijest, // Spremljena povijest
                 unsavedState: unsavedData, // Nesaƒçuvano stanje
                 exportTimestamp: new Date().toISOString(), // Vrijeme izvoza
                 appVersion: '1.0.0' // Mo≈æe≈° dodati verziju aplikacije ako je prati≈°
            };

            const historyJson = JSON.stringify(dataToExport, null, 2); // Konvertiraj u JSON string, formatiran s 2 razmaka uvlake
            const blob = new Blob([historyJson], { type: 'application/json' }); // Kreiraj Blob objekt
            const url = URL.createObjectURL(blob); // Kreiraj URL za Blob

            // Kreiraj nevidljivi 'a' (link) element za download
            const a = document.createElement('a');
            a.href = url;
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            a.download = `qr_racunator_povijest_${dateStr}.json`; // Naziv datoteke
            document.body.appendChild(a); // Dodaj element u DOM (potrebno za neke preglednike, npr. Firefox)
            a.click(); // Simuliraj klik na link za pokretanje downloada

            document.body.removeChild(a); // Ukloni element iz DOM-a
            URL.revokeObjectURL(url); // Oslobodi memoriju kori≈°tenu za Blob URL

            alert("Povijest je izvezena kao JSON datoteka."); // Obavijesti korisnika

             // Logiranje uspje≈°nog izvoza
             const exportDetails = { savedItemCount: punaPovijest.length, unsavedItemCount: unsavedData ? unsavedData.count : 0 };
             sendLogData({ Event: 'history_exported', Details: JSON.stringify(exportDetails) });

        } catch (error) {
            console.error("Gre≈°ka pri izvozu povijesti:", error); // Ostavljen log gre≈°ke
            alert("Gre≈°ka pri izvozu povijesti."); // Obavijesti korisnika o gre≈°ci
             // Logiranje gre≈°ke pri izvoza
            sendLogData({ Event: 'history_export_failed', Details: error.message });
        }
    }

    function importHistory() {
        playSound('click-sound'); // Zvuk na klik

        const fileInput = document.getElementById('import-file-input');
        if (!fileInput) {
            console.error("Input za datoteku za uvoz nije pronaƒëen."); // Ostavljen kritiƒçan log
            alert("Gre≈°ka pri pokretanju uvoza.");
            return;
        }

        // Klikni na skriveni input da otvori dijalog za odabir datoteke
        fileInput.click();

        // Dodaj listener za promjenu (kad korisnik odabere datoteku)
        // Koristimo "once: true" da se listener automatski ukloni nakon prvog okidanja
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; // Dohvati odabranu datoteku
            if (!file) {
                console.log("Nije odabrana datoteka za uvoz."); // Ostavljen ovaj log
                fileInput.value = ''; // Resetiraj input da omoguƒái ponovni odabir iste datoteke
                 sendLogData({ Event: 'history_import_cancelled', Details: 'no_file_selected' }); // Log otkazivanja
                return;
            }

            const reader = new FileReader(); // Kreiraj FileReader
            reader.onload = (e) => { // Listener za uƒçitavanje datoteke
                try {
                    const rawData = e.target.result; // Sadr≈æaj datoteke kao tekst
                    const importedData = JSON.parse(rawData); // Parsiraj JSON

                    // Pobolj≈°ana validacija i uƒçitavanje formata v1 ili v2
                     let historyToImport = null;
                     let unsavedToImport = null;

                     if (Array.isArray(importedData)) {
                         // Format v1 (samo niz sesija)
                         historyToImport = importedData;
                         console.log("Uvezen format v1."); // Ostavljen ovaj log
                     } else if (typeof importedData === 'object' && importedData !== null && Array.isArray(importedData.savedHistory)) {
                         // Format v2 (sa savedHistory i opcionalno unsavedState)
                          historyToImport = importedData.savedHistory;
                          unsavedToImport = importedData.unsavedState;
                          console.log("Uvezen format v2."); // Ostavljen ovaj log
                     } else {
                          // Neispravan format
                          throw new Error("Neispravan format datoteke. Oƒçekuje se niz sesija ili objekt s 'savedHistory'.");
                     }

                    // Dodatna validacija strukture uvezenih sesija (osnovna provjera)
                    if (!historyToImport.every(group =>
                         typeof group === 'object' && group !== null &&
                         Array.isArray(group.racuni) &&
                         group.racuni.every(racun =>
                             typeof racun === 'object' && racun !== null &&
                             typeof racun.amount === 'number' && typeof racun.qrCode === 'string'
                             // Ne moramo strogo validirati 'time', 'datv', 'scanTimestamp'
                         )
                    )) {
                         throw new Error("Neispravna struktura podataka unutar spremljene povijesti.");
                    }

                    // Validacija uvezene nesaƒçuvane sesije (ako postoji i ispravna je)
                     if (unsavedToImport) {
                         if (typeof unsavedToImport !== 'object' || unsavedToImport === null ||
                              typeof unsavedToImport.count !== 'number' || typeof unsavedToImport.amount !== 'number' || !Array.isArray(unsavedToImport.currentSession) ||
                              (unsavedToImport.currentName !== null && typeof unsavedToImport.currentName !== 'string' && typeof unsavedToImport.currentName !== 'undefined') || // Dodana provjera za undefined
                              !unsavedToImport.currentSession.every(racun =>
                                   typeof racun === 'object' && racun !== null &&
                                   typeof racun.amount === 'number' && typeof racun.qrCode === 'string'
                              )
                         ) {
                              console.warn("Uvezeni podaci sadr≈æe neispravno formatirano nesaƒçuvano stanje. Ignoriram nesaƒçuvano stanje."); // Ostavljen log upozorenja
                              unsavedToImport = null; // Ignoriraj neispravno nesaƒçuvano stanje
                         }
                     }


                    // Potvrda prepisivanja
                    const confirmMessage = `Pronaƒëeno ${historyToImport.length} spremljenih sesija ${unsavedToImport && unsavedToImport.count > 0 ? ` i nesaƒçuvano stanje (${unsavedToImport.count} raƒçuna)` : ''} u datoteci.\n\n≈Ωelite li PREPISATI va≈°u trenutnu povijest i nesaƒçuvano stanje ovim podacima?\n(Trenutna povijest i nesaƒçuvano stanje ƒáe biti trajno izbrisani!)`;
                    if (confirm(confirmMessage)) {
                        // Korisnik je potvrdio - bri≈°emo SVE lokalne podatke
                        localStorage.removeItem(HISTORY_STORAGE_KEY);
                        localStorage.removeItem(COUNTER_KEY);
                        localStorage.removeItem(COUNTER2_KEY);
                        localStorage.removeItem(COUNTER_ACTIVE_KEY);
                        localStorage.removeItem(USER_ID_KEY); // Resetiraj i usera
                        localStorage.removeItem(FIRST_USE_KEY); // Resetiraj i timestamp
                        localStorage.removeItem(UNSAVED_COUNT_KEY); // Bri≈°i nesaƒçuvano
                        localStorage.removeItem(UNSAVED_AMOUNT_KEY); // Bri≈°i nesaƒçuvano
                        localStorage.removeItem(CAMERA_ID_KEY); /* <<< Bri≈°i spremljenu kameru */


                        saveFullHistoryToLocalStorage(historyToImport); // Spremi uvezenu spremljenu povijest

                        // Uƒçitaj uvezeno nesaƒçuvano stanje ili resetiraj trenutnu sesiju
                         if (unsavedToImport && unsavedToImport.currentSession && unsavedToImport.currentSession.length > 0) { // Uƒçitaj samo ako postoji i ima raƒçuna
                             povijest = unsavedToImport.currentSession;
                             ukupno = unsavedToImport.amount;
                             currentSessionName = unsavedToImport.currentName || null; // Osiguraj da je null ako je undefined u JSON-u
                             // Spremi uvezeno nesaƒçuvano stanje u localStorage (kao da je upravo skenirano)
                             try { localStorage.setItem(UNSAVED_COUNT_KEY, povijest.length); localStorage.setItem(UNSAVED_AMOUNT_KEY, ukupno); } catch (lsError) { console.error("Gre≈°ka spremanja uvezenog nesaƒçivanog stanja u localStorage:", lsError); } // Ostavljen log gre≈°ke
                             console.log(`Uvezeno nesaƒçuvano stanje: ${povijest.length} raƒçuna, ${ukupno.toFixed(2)} ‚Ç¨, Naziv: ${currentSessionName || 'N/A'}`); // Ostavljen ovaj log
                         } else {
                             // Ako nema nesaƒçuvanog stanja u datoteci ili je prazno, resetiraj trenutnu sesiju
                             povijest = [];
                             ukupno = 0;
                             currentSessionName = null;
                              console.log("Nema nesaƒçuvanog stanja u uvezenoj datoteci, trenutna sesija je prazna."); // Ostavljen ovaj log
                              try { localStorage.removeItem(UNSAVED_COUNT_KEY); localStorage.removeItem(UNSAVED_AMOUNT_KEY); } catch(lsError) { console.error("Gre≈°ka brisanja starog nesaƒçuvanog stanja nakon uvoza:", lsError); } // Ostavljen log gre≈°ke
                         }


                        // Resetiraj UI elemente vezane za trenutnu sesiju (gumbe, poruke)
                        if (deleteWarningDiv) {
                             delete deleteWarningDiv.dataset.lastScanText;
                             delete deleteWarningDiv.dataset.beforeConfirmText;
                             delete deleteWarningDiv.dataset.lastNameText;
                             delete deleteWarningDiv.dataset.beforeConfirmNameText;
                        }
                         resetRemoveMode(); // Resetiraj Obri≈°i gumb modove
                         resetOcistiMode(); // Resetiraj Oƒçisti gumb mod


                        loadCountersState(); // Uƒçitaj brojaƒçe (bit ƒáe resetirani na 0 ako ih je brisanje obrisalo) - OVDJE NE ZOVEMO updateDeactivatedIndicator
                        initializeUserTracking(); // Reinicijaliziraj usera (dobit ƒáe novi ID ako je obrisan)
                        updateDisplay(); // A≈æuriraj prikaz trenutne sesije (ukupno, broj raƒçuna, mala povijest, ime sesije)

                        alert("Povijest uspje≈°no uvezena i lokalni podaci resetirani."); // Obavijesti korisnika

                         // Logiranje uspje≈°nog uvoza (prepisivanja)
                         const importDetails = { savedItemCount: historyToImport.length, unsavedItemCount: unsavedToImport ? unsavedToImport.count : 0, mode: 'overwrite' };
                         sendLogData({ Event: 'history_imported', Details: JSON.stringify(importDetails) });

                        // Nakon uvoza, prika≈æi all days view s novim podacima
                         // Moramo priƒçekati da se fetchSheetData zavr≈°i jer ono utjeƒçe na prikaz AllDaysView-a
                         fetchSheetData().then(() => {
                             // Nakon uspje≈°nog fetchSheetData, tada pozovi render i UI update
                             renderAllDaysView(); // Renderiraj All Days View nakon dohvaƒáanja Sheeta
                             updateDeactivatedIndicator(); // A≈æuriraj UI indikator nakon reseta i uƒçitavanja stanja
                         }).catch(() => {
                              // ƒåak i ako fetch Sheet-a ne uspije, renderiraj i a≈æuriraj UI
                              tekstPoruka = ""; // Resetiraj tekst poruke na prazno
                              updateRunningText(); // Osiguraj da se prazan tekst ne prikazuje s animacijom
                              renderAllDaysView(); // Renderiraj All Days View
                              updateDeactivatedIndicator(); // A≈æuriraj UI indikator nakon reseta
                         });


                    } else {
                        // Korisnik je otkazao uvoz
                        alert("Uvoz otkazan.");
                        // Logiranje otkazanog uvoza
                        sendLogData({ Event: 'history_import_cancelled', Details: 'user_cancelled' });
                    }

                } catch (error) {
                    // Gre≈°ka pri parsiranju ili validaciji
                    console.error("Gre≈°ka pri obradi datoteke za uvoz:", error); // Ostavljen log gre≈°ke
                    alert(`Gre≈°ka pri uvozu povijesti: ${error.message}`); // Obavijesti korisnika o gre≈°ci
                     // Logiranje gre≈°ke pri uvoza
                    sendLogData({ Event: 'history_import_failed', Details: error.message });
                } finally {
                    fileInput.value = ''; // Resetiraj input da omoguƒái ponovni odabir iste datoteke
                }
            };
            reader.onerror = (error) => {
                 console.error("FileReader error:", error); // Ostavljen log gre≈°ke
                 alert("Gre≈°ka pri ƒçitanju datoteke.");
                 fileInput.value = ''; // Resetiraj input
                 sendLogData({ Event: 'history_import_failed', Details: `FileReader error: ${error.message}` }); // Log gre≈°ke ƒçitanja datoteke
            };
            reader.readAsText(file); // ƒåitaj datoteku kao tekst
        }, { once: true }); // Listener se automatski uklanja nakon prvog okidanja
    }


    // *** UPRAVLJANJE VIDLJIVO≈†ƒÜU KARTICE PREGLEDNIKA (PREMJE≈†TENO GORE) ***
     // Funkcija koja se poziva pri promjeni vidljivosti dokumenta
     function handleVisibilityChange() {
        if (document.visibilityState === 'visible' && document.body.classList.contains('scanner-view')) {
             console.log("Aplikacija postala vidljiva u Scanner View."); // Ostavljen ovaj log
            // U initializeScanner() se vr≈°i provjera je li veƒá aktivan
            initializeScanner(); // Pokreni skener ako smo u scanner view i aplikacija je postala vidljiva
        } else if (document.visibilityState === 'hidden') {
             console.log("Aplikacija postala nevidljiva, zaustavljam skener."); // Ostavljen ovaj log
            stopScanner(); // Zaustavi skener kad tab nije vidljiv
        }
    };

    // Funkcija za dodavanje listenera za promjenu vidljivosti
    function attachVisibilityListener() {
        if (visibilityListenerAttached) return; // Dodaj listener samo jednom
        document.addEventListener("visibilitychange", handleVisibilityChange);
        visibilityListenerAttached = true;
        console.log("Visibility listener dodan."); // Ostavljen ovaj log
    }


    // *** GLOBALNI CLICK LISTENER (PREMJE≈†TENO GORE) ***
    // Ovaj listener zatvara modale/overlaye i resetira gumbe kad se klikne izvan njih
    function globalClickListener(event) {
        // Zatvori popis kamera ako se klikne izvan njega i izvan gumba za promjenu kamere
        if (cameraSelectionOverlay && cameraSelectionOverlay.style.display === 'block') {
             const isClickInsideOverlay = cameraSelectionOverlay.contains(event.target);
             const isClickOnSwitchButton = switchCameraButton && switchCameraButton.contains(event.target);
             if (!isClickInsideOverlay && !isClickOnSwitchButton) {
                 cameraSelectionOverlay.style.display = 'none';
             }
        }

        // Zatvori Manual Entry modal ako se klikne na overlay (ali ne na content)
         if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
             const manualEntryModalContent = document.getElementById('manual-entry-modal-content');
             const isClickInsideManualModal = manualEntryModalContent && manualEntryModalContent.contains(event.target);
             const isClickOnManualEntryBtn = manualEntryBtn && manualEntryBtn.contains(event.target); // Allow clicking the toggle button
             // Takoƒëer dozvoli klik na inpute i gumbe unutar modala
             const isClickInsideModalContent = manualEntryModalContent && manualEntryModalContent.contains(event.target);

             // Zatvori modal samo ako se klikne na pozadinu overlay-a (ne na sadr≈æaj modala i ne na gumb koji ga otvara)
             if (!isClickInsideModalContent && !isClickOnManualEntryBtn) {
                 cancelManualEntry(); // Koristi cancel za zvuk i log
             }
         }


        // Ostatak logike za resetiranje gumba za potvrdu (ako se klikne izvan njih u scanner view)
        const isClickOnRemoveButton = removeButton && removeButton.contains(event.target);
        const isClickOnOcistiButton = ocistiButton && ocistiButton.contains(event.target);
        const isClickOnNameInput = sessionNameInput && sessionNameInput.contains(event.target);
        const isClickOnAddNameBtn = addNameBtn && addNameBtn.contains(event.target);
        const isClickOnEditIcon = event.target.classList.contains('edit-icon'); // Klik na "Uredi" span
        const isClickOnDeleteWarning = deleteWarningDiv && deleteWarningDiv.style.display !== 'none' && deleteWarningDiv.contains(event.target); // Klik na samu delete/info poruku (unutar nje ne bi trebalo biti elemenata za klik)
        const isClickOnHistoryDeleteButton = event.target.closest('#clear-day-btn, #delete-session-btn, #clear-history-btn'); // Selektiraj SVE gumbe za brisanje u povijesti (unutar history view)
        const isClickOnHistoryButton = historyToggleButton && historyToggleButton.contains(event.target); // History toggle button (POVIJEST gumb)
        const isClickOnShareButton = shareButton && shareButton.contains(event.target); // Share button (DIJELI RAƒåUNATOR)


        // Reset Remove button (skener view) if in confirm mode and clicked outside its area (button + delete warning)
        if ((removeConfirm || removeNameConfirm) && document.body.classList.contains('scanner-view') && !isClickOnRemoveButton && !isClickOnDeleteWarning) {
            resetRemoveMode();
             // console.log("Resetirao Remove button iz global click (outside confirm area)."); // KOMENTIRANO: Previ≈°e logova
        }

        // Reset Ocisti button (skener view) if in confirm mode and clicked outside its area (button)
        if (ocistiConfirm && document.body.classList.contains('scanner-view') && !isClickOnOcistiButton) {
            resetOcistiMode();
             // console.log("Resetirao Ocisti button iz global click (outside)."); // KOMENTIRANO: Previ≈°e logova
        }

        // Save name if input is visible (active for editing) and clicked outside name area (input, add/edit button)
         const isClickInsideNameArea = isClickOnNameInput || isClickOnAddNameBtn || isClickOnEditIcon;
        if (sessionNameInput && sessionNameInput.style.display === 'block' && !isClickInsideNameArea) {
             // console.log("Save name triggered by click outside name input area."); // KOMENTIRANO: Previ≈°e logova
            saveName(); // Pozovi saveName na blur ako je input bio aktivan
             // Logiranje spremanja naziva klikom izvan polja
             // Logika logiranja je veƒá unutar saveName()
        }

        // Reset History Delete Buttons if in confirm mode and clicked outside *any* of them AND outside History/Share buttons AND outside Name Area
        // Ovo osigurava da klik na te gumbe u history view ne poni≈°ti confirm mode drugih gumba
        if (document.body.classList.contains('history-view') && !isClickOnHistoryDeleteButton && !isClickOnHistoryButton && !isClickOnShareButton && !isClickInsideNameArea) {
             const clearDayBtn = document.getElementById('clear-day-btn');
             if (clearDayBtn && clearDayBtn.dataset.confirming === 'true') {
                  clearDayBtn.innerText = "IZBRI≈†I OVAJ DAN";
                  clearDayBtn.classList.remove('confirm-mode');
                  clearDayBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                  // console.log("Resetirao clearDayBtn iz global click (outside)"); // KOMENTIRANO: Previ≈°e logova
                   sendLogData({ Event: 'delete_day_cancelled_outside', Details: getISODateString(currentlyViewedDate) }); // Logiranje otkazivanja
             }
              const deleteSessionBtn = document.getElementById('delete-session-btn');
              if (deleteSessionBtn && deleteSessionBtn.dataset.confirming === 'true') {
                   deleteSessionBtn.innerText = "IZBRI≈†I OVAJ SKEN";
                   deleteSessionBtn.classList.remove('confirm-mode');
                   deleteSessionBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                   // console.log("Resetirao deleteSessionBtn iz global click (outside)"); // KOMENTIRANO: Previ≈°e logova
                   // Log cancellation, session ID je te≈°ko dobiti ovdje pouzdano
              }
              const clearAllBtn = document.getElementById('clear-history-btn');
              if (clearAllBtn && clearAllBtn.dataset.confirming === 'true') {
                   clearAllBtn.innerText = "IZBRI≈†I SVU POVIJEST";
                   clearAllBtn.classList.remove('confirm-mode');
                   clearAllBtn.dataset.confirming = 'false'; // Resetiraj confirming na false
                   // console.log("Resetirao clearAllBtn iz global click (outside)"); // KOMENTIRANO: Previ≈°e logova
                    sendLogData({ Event: 'clear_all_cancelled_outside' }); // Logiranje otkazivanja
              }
        }
    }


    // *** INICIJALIZACIJA APLIKACIJE ***
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM spreman..."); // Ostavljen ovaj log

        // --- DOHVAƒÜANJE SVIH DOM ELEMENATA (PREMJE≈†TENO NA SAM POƒåETAK DOMContentLoaded) ---
        totalDiv = document.getElementById('total');
        totalContainer = document.getElementById('total-container');
        ocistiButton = document.getElementById('ocisti-button');
        invoiceCountDiv = document.getElementById('invoice-count');
        historyList = document.getElementById('historyList');
        removeButton = document.getElementById('remove-from-list-btn');
        duplicateWarning = document.getElementById('duplicate-warning');
        loadedMsg = document.getElementById('loaded-message');
        instructionDiv = document.getElementById('scan-instruction');
        deleteWarningDiv = document.getElementById('delete-warning');
        shareButton = document.getElementById('share-button');
        readerDiv = document.getElementById('reader');
        historyToggleButton = document.getElementById('history-toggle-btn');
        historyDiv = document.getElementById('history');
        historyPageDiv = document.getElementById('history-page');
        backToScannerButton = document.getElementById('back-to-scanner-btn');
        historyContentDiv = document.getElementById('history-content');
        sessionNameContainer = document.getElementById('session-name-container');
        addNameBtn = document.getElementById('add-name-btn');
        sessionNameInput = document.getElementById('session-name-input');
        sessionNameDisplay = document.getElementById('session-name-display');
        sessionNameText = document.getElementById('session-name-text');
        historyStickyHeaderDiv = document.getElementById('history-sticky-header');
        historyDynamicHeaderContentDiv = document.getElementById('history-dynamic-header-content');
        runningTextContainer = document.getElementById('running-text-container');
        runningTextSpan = runningTextContainer ? runningTextContainer.querySelector('span') : null;
        sharePromptOverlay = document.getElementById('share-prompt-overlay');
        counterDeactivatedIndicator = document.getElementById('counter-deactivated-indicator');
        switchCameraButton = document.getElementById('switch-camera-btn');
        cameraSelectionOverlay = document.getElementById('camera-selection-overlay');
        cameraListUl = document.getElementById('camera-list');
        // DOHVATI ELEMENTE ZA RUƒåNI UNOS
        manualEntryBtn = document.getElementById('manual-entry-btn');
        manualEntryModalOverlay = document.getElementById('manual-entry-modal-overlay');
        manualAmountInput = document.getElementById('manual-amount-input');
        manualTimeInput = document.getElementById('manual-time-input');
        manualAddBtn = document.getElementById('manual-add-btn');
        manualCancelBtn = document.getElementById('manual-cancel-btn');
        manualEntryErrorMsg = document.getElementById('manual-entry-error');
        // Import file input je potreban globally za importHistory() funkciju
        importFileInput = document.getElementById('import-file-input');
        // --- KRAJ DOHVAƒÜANJA SVIH DOM ELEMENATA ---


        // Provjera osnovnih elemenata (ukljuƒçujuƒái nove) - Sada se provjerava NAKON ≈°to smo ih poku≈°ali dohvatiti
        if (!readerDiv || !historyPageDiv || !historyContentDiv || !backToScannerButton || !historyToggleButton || !sessionNameContainer || !historyStickyHeaderDiv || !historyDynamicHeaderContentDiv || !runningTextContainer || !runningTextSpan || !sharePromptOverlay || !counterDeactivatedIndicator || !loadedMsg || !duplicateWarning || !switchCameraButton || !cameraSelectionOverlay || !cameraListUl || !manualEntryBtn || !manualEntryModalOverlay || !manualAmountInput || !manualTimeInput || !manualAddBtn || !manualCancelBtn || !manualEntryErrorMsg || !importFileInput) {
            console.error("GRE≈†KA: Nedostaju kritiƒçni DOM elementi! Provjerite konzolu za detalje."); // Ostavljen kritiƒçan log
             // Ispi≈°i koji elementi nedostaju
            const missing = [];
            if (!readerDiv) missing.push('#reader');
            if (!historyPageDiv) missing.push('#history-page');
            if (!historyContentDiv) missing.push('#history-content');
            if (!backToScannerButton) missing.push('#back-to-scanner-btn');
            if (!historyToggleButton) missing.push('#history-toggle-btn');
            if (!sessionNameContainer) missing.push('#session-name-container');
            if (!historyStickyHeaderDiv) missing.push('#history-sticky-header');
            if (!historyDynamicHeaderContentDiv) missing.push('#history-dynamic-header-content');
            if (!runningTextContainer) missing.push('#running-text-container');
            if (!runningTextSpan) missing.push('#running-text-container span'); // Dodana provjera za span
            if (!sharePromptOverlay) missing.push('#share-prompt-overlay');
            if (!counterDeactivatedIndicator) missing.push('#counter-deactivated-indicator');
            if (!loadedMsg) missing.push('#loaded-message');
            if (!duplicateWarning) missing.push('#duplicate-warning');
            if (!switchCameraButton) missing.push('#switch-camera-btn');
            if (!cameraSelectionOverlay) missing.push('#camera-selection-overlay');
            if (!cameraListUl) missing.push('#camera-list');
            if (!manualEntryBtn) missing.push('#manual-entry-btn'); // Provjera novog gumba
            if (!manualEntryModalOverlay) missing.push('#manual-entry-modal-overlay'); // Provjera modala
            if (!manualAmountInput) missing.push('#manual-amount-input');
            if (!manualTimeInput) missing.push('#manual-time-input');
            if (!manualAddBtn) missing.push('#manual-add-btn');
            if (!manualCancelBtn) missing.push('#manual-cancel-btn');
            if (!manualEntryErrorMsg) missing.push('#manual-entry-error');
            if (!importFileInput) missing.push('#import-file-input'); // Provjera import inputa


            console.error("Nedostaju elementi:", missing.join(', ')); // Ostavljen kritiƒçan log

            document.body.innerHTML = '<div style="padding: 20px; color: red; font-weight: bold;">Gre≈°ka pri uƒçitavanju aplikacije. Nedostaju kljuƒçni elementi. Osvje≈æite stranicu ili provjerite konzolu za detalje.</div>';
             sendLogData({ Event: 'critical_dom_missing', Details: missing.join(', ')}); // Log kritiƒçne gre≈°ke (neƒáe poslati ako URL ne radi, ali dobro je imati u kodu)
            return; // Zaustavi daljnju inicijalizaciju
        }


        // Globalni listener i listeneri za standardne gumbe (Povijest, Share, itd.)
        document.body.addEventListener('click', globalClickListener, true);

        // --- DODANO: Listener za promjenu veliƒçine prozora (resize) ---
         window.addEventListener('resize', () => {
             // Ponovno izraƒçunaj i primijeni trajanje animacije ako smo u prikazu skenera I tekst postoji
             if (document.body.classList.contains('scanner-view') && tekstPoruka) {
                 console.log("Window resized, recalculating running text animation duration."); // Ostavljen ovaj log
                 updateRunningText(); // Ovo ƒáe ponovno izraƒçunati trajanje i primijeniti animaciju
             }
             // Opcionalno: Kod za ponovno pokretanje kamere pri promjeni veliƒçine, ako je potrebno na nekim ureƒëajima/preglednicima
             // Trenutna initializeScanner/visibilitychange logika bi trebala hendlati veƒáinu sluƒçajeva
         });
         // --- KRAJ DODANOG LISTENERA ---


        // Listener za gumb POVIJEST
        if (historyToggleButton) {
             // Using cloneNode(true) and replaceChild to ensure fresh listeners are attached
             const newHistoryToggleButton = historyToggleButton.cloneNode(true);
             historyToggleButton.parentNode.replaceChild(newHistoryToggleButton, historyToggleButton);
             historyToggleButton = newHistoryToggleButton; // Update the variable reference
             historyToggleButton.addEventListener('click', () => { console.log("Klik na 'POVIJEST' gumb detektiran."); playSound('click-sound'); switchToHistoryView(); }); // Ostavljen ovaj log
        } else { console.error("DOM spreman, ali #history-toggle-btn nije pronaƒëen!"); } // Ostavljen kritiƒçan log

        // Listener za gumb < NA SKENER
        if (backToScannerButton) { backToScannerButton.addEventListener('click', () => { playSound('click-sound'); switchToScannerView(); }); }

        // Listener za SHARE gumb
        if (navigator.share && typeof navigator.share === 'function') {
            if (shareButton) {
                shareButton.style.display = 'block';
                 // Using cloneNode(true) and replaceChild
                 const newShareButton = shareButton.cloneNode(true);
                 shareButton.parentNode.replaceChild(newShareButton, shareButton);
                 shareButton = newShareButton; // Update reference
                shareButton.addEventListener('click', async () => {
                    if (removeConfirm || removeNameConfirm) resetRemoveMode();
                    if (ocistiConfirm) resetOcistiMode();
                    // Sakrij modal za ruƒçni unos ako je otvoren prije dijeljenja
                    if (manualEntryModalOverlay && manualEntryModalOverlay.style.display === 'flex') {
                        hideManualEntryModal(); // Sakrij bez zvuka otkazivanja
                    }
                    const shareData = {
                        title: 'QR SKENER-RAƒåUNATOR',
                        text: 'Skenira i zbraja raƒçune bez instaliranja. Isprobaj!',
                        url: 'https://soboslikar.github.io/QR-RACUNATOR/'
                    };
                    try {
                        await navigator.share(shareData);
                        console.log('Share dijalog zatvoren (vjerojatno uspje≈°no)...'); // Ostavljen ovaj log
                         sendLogData({ Event: 'share_success' }); // Log success
                    } catch (err) {
                        console.error('Gre≈°ka dijeljenja:', err); // Ostavljen log gre≈°ke
                        if (err.name === 'AbortError') {
                            console.log('Korisnik odustao od dijeljenja.'); // Ostavljen ovaj log
                             sendLogData({ Event: 'share_cancelled' }); // Log cancellation
                        } else {
                             console.log('Do≈°lo je do druge gre≈°ke pri dijeljenju.'); // Ostavljen ovaj log
                             showTemporaryMessage(loadedMsg, "Dijeljenje neuspje≈°no.", 1500);
                              sendLogData({ Event: 'share_failed', Details: err.message }); // Log error
                        }
                    } finally {
                         // <-- DODANO/IZMIJENJENO: Resetiranje brojaƒça i UI-ja nakon poku≈°aja dijeljenja (uspjeh ili neuspjeh)
                         console.log("Share attempt finished. Checking counter state for reset.");
                        if (brojac === 0 && brojac2 > 0) { // Resetiraj samo ako je brojaƒç do≈°ao do 0 i prag je veƒái od 0
                            brojac = brojac2; // Postavi brojaƒç1 na vrijednost brojaƒça2
                            saveBrojac(); // Spremi novu vrijednost brojaƒça1
                            console.log("Brojaƒç resetiran na prag:", brojac);
                            // Logiranje automatskog reseta brojaƒça nakon dijeljenja
                             sendLogData({ Event: 'share_counter_reset', Details: brojac });
                        } else {
                             console.log("Brojaƒç nije resetiran. Stanje: brojac=" + brojac + ", brojac2=" + brojac2);
                        }
                         checkSharePrompt(); // Ponovno provjeri state (sakrit ƒáe prompt ako je brojaƒç > 0)
                         updateRunningTextVisibility(); // Update running text visibility
                         updateDeactivatedIndicator(); // Update indicator visibility
                         console.log("UI updated after share attempt.");
                    }
                });
            }
        } else {
             console.log("navigator.share API nije podr≈æan ili dostupan."); // Ostavljen ovaj log
             if (shareButton) shareButton.style.display = 'none';
             sendLogData({ Event: 'share_api_not_supported' }); // Log nedostatka podr≈°ke
        }


        // Listener za UNOS IMENA (Enter/Escape) i blur
        if(sessionNameInput) {
            sessionNameInput.addEventListener('keydown', (e) => {
                // Provjeri da input nije skriven (tj. da je aktivan za unos)
                 if (sessionNameInput.style.display === 'none') return;

                if (e.key === 'Enter') {
                    e.preventDefault(); saveName();
                } else if (e.key === 'Escape') {
                    e.preventDefault(); // Sprijeƒçi defaultnu Escape akciju
                    // Resetiraj input i sakrij ga
                    sessionNameInput.value = currentSessionName || '';
                    sessionNameInput.style.display = 'none';
                    updateNameDisplay();
                    // Ako je brisanje naziva bilo aktivno, resetiraj i taj mod
                    if(removeNameConfirm) resetRemoveMode();
                     // Logiranje otkazivanja unosa naziva
                    sendLogData({ Event: 'session_name_input_cancelled_escape' });
                }
            });
             // Listener za blur sa inputa za ime
            sessionNameInput.addEventListener('blur', saveName); // Ve≈æi blur listener na input polje
        } else { console.error("DOM spreman, ali #session-name-input nije pronaƒëen!"); } // Ostavljen kritiƒçan log


        // Listener za gumb za promjenu kamere
        if (switchCameraButton) {
             // Using cloneNode(true) and replaceChild
             const newSwitchCameraButton = switchCameraButton.cloneNode(true);
             switchCameraButton.parentNode.replaceChild(newSwitchCameraButton, switchCameraButton);
             switchCameraButton = newSwitchCameraButton; // Update reference
            switchCameraButton.addEventListener('click', toggleCameraSelection);
        } else { console.error("DOM spreman, ali #switch-camera-btn nije pronaƒëen!"); } // Ostavljen kritiƒçan log

        // --- NOVI LISTENER za RUƒåNI UNOS gumb ---
        if (manualEntryBtn) {
            // Na klik uvijek prika≈æi modal za ruƒçni unos
            manualEntryBtn.addEventListener('click', showManualEntryModal);
        } else { console.error("DOM spreman, ali #manual-entry-btn nije pronaƒëen!"); } // Ostavljen kritiƒçan log


        // --- NOVI LISTENERI za modal ruƒçnog unosa ---
        if (manualAddBtn) {
            manualAddBtn.addEventListener('click', addManualEntry);
        } else { console.error("DOM spreman, ali #manual-add-btn nije pronaƒëen!"); } // Ostavljen kritiƒçan log

        if (manualCancelBtn) {
             manualCancelBtn.addEventListener('click', cancelManualEntry);
        } else { console.error("DOM spreman, ali #manual-cancel-btn nije pronaƒëen!"); } // Ostavljen kritiƒçan log

        if (manualEntryModalOverlay) {
            // Omoguƒái Enter tipku unutar modala za "Dodaj raƒçun" i Escape za "Odustani"
            const handleManualEntryKeydown = (e) => {
                // Provjeri da modal NIJE skriven, inaƒçe ignore
                if (manualEntryModalOverlay.style.display === 'none') return;

                if (e.key === 'Enter') {
                     // Provjeri je li fokus na amount inputu ili time inputu
                     if (document.activeElement === manualAmountInput || document.activeElement === manualTimeInput) {
                          e.preventDefault(); // Sprijeƒçi defaultnu Enter akciju (npr. submit forme)
                          addManualEntry(); // Poku≈°aj dodati raƒçun
                     }
                     // Ako fokus nije na input polju, ne radi ni≈°ta na Enter (mo≈æda je na gumbu, pa gumb hendla klik)
                } else if (e.key === 'Escape') {
                     e.preventDefault(); // Sprijeƒçi defaultnu Escape akciju
                     cancelManualEntry(); // Odustani
                }
            };
            // Dodaj listener na sam modal overlay (bolje nego content, pokriva vi≈°e)
            manualEntryModalOverlay.addEventListener('keydown', handleManualEntryKeydown);

        } else { console.error("DOM spreman, ali #manual-entry-modal-overlay nije pronaƒëen!"); } // Ostavljen kritiƒçan log

        // --- Listener za input datoteku kod uvoza (povezan unutar importHistory) ---
        // Referenca na importFileInput je veƒá dohvatio na poƒçetku DOMContentLoaded
        // Event listener je unutar importHistory funkcije


        // --- REDOSLIJED INICIJALIZACIJE UNUTAR DOMContentLoaded (KLJUƒåNO ZA ISPRAVAK GRE≈†KE) ---
        // 1. DOM elementi su veƒá dohvƒáeni na poƒçetku DOMContentLoaded

        // 2. Uƒçitaj lokalno stanje brojaƒça (Ova funkcija SADA NE ZOVEE updateDeactivatedIndicator)
        loadCountersState();

        // 3. *SADA*, nakon ≈°to su DOM elementi dohvaƒáeni i stanje brojaƒça uƒçitano, a≈æuriraj indikator.
        updateDeactivatedIndicator(); // <-- ISPRAVAK GRE≈†KE: Poziv premje≈°ten OVDJE.

        // 4. Inicijalizuj UserID i FirstUseTimestamp
        initializeUserTracking();

        // 5. Napravi inicijalni update prikaza (ukupno, broj raƒçuna, ime sesije)
        // Povijest (mala lista) ƒáe se a≈æurirati unutar updateDisplay ako je scanner-view
        updateDisplay();

        // 6. Provjeri view i pokreni inicijalizaciju skenera ILI rendiranje povijesti
        console.log("Provjeravam inicijalni view..."); // Ostavljen ovaj log
        if (document.body.classList.contains('scanner-view')) {
            console.log("Init: Scanner view - Pokreƒáem inicijalizaciju skenera..."); // Ostavljen ovaj log
             // initializeScanner sada dohvaƒáa i sprema popis kamera, te starta skener.
             // Takoƒëer postavlja isScannerActive i prikazuje gumb kamere ako treba.
            initializeScanner();
            // Visibility listener attachaj ƒçim krene≈° u scanner view
            attachVisibilityListener();
        } else {
            console.log("Init: History view - Renderiram povijest."); // Ostavljen ovaj log
            renderHistoryView(currentlyViewedDate);
            // Nema potrebe za visibility listenerom u history view
        }

        // 7. Pokreni dohvaƒáanje podataka iz Sheeta u pozadini
        // Callback dohvaƒáanja podataka a≈æurira UI elemente koji ovise o podacima iz Sheeta
        fetchSheetData().then(() => {
            console.log("Sheet podaci dohvaƒáeni. Pripremam 'app_loaded' log."); // Ostavljen ovaj log

            // Logiraj uspje≈°no uƒçitavanje (bez info o nesaƒçuvanom) - MODIFICIRANO
            const appLoadedDetails = { status: 'ok', fetchSuccess: true }; // Jednostavni status
            const appLoadedEventData = { Event: 'app_loaded', Details: JSON.stringify(appLoadedDetails) };
            sendLogData(appLoadedEventData); // <-- IZMJENA

            // A≈æuriraj UI koji ovisi o sheet podacima
            updateRunningText(); // Ovo ƒáe sada ispravno prikazati ili sakriti tekst i postaviti animaciju
            checkSharePrompt();
            updateDeactivatedIndicator(); // A≈æuriraj indikator nakon uƒçitavanja stanja aktivacije

             // Ako si u history view, ponovno renderiraj da ukljuƒçi potencijalno nove podatke (tekst)
             if (document.body.classList.contains('history-view')) {
                 console.log("A≈æuriram prikaz povijesti nakon dohvaƒáanja podataka."); // Ostavljen ovaj log
                 renderHistoryView(currentlyViewedDate);
             } else {
                 // console.log("A≈æuriram UI skenera nakon dohvaƒáanja podataka."); // KOMENTIRANO: Previ≈°e logova
                 // UI specifiƒçan za skener (poput gumba kamere) se a≈æurira u initializeScanner
             }
            console.log("Inicijalizacija (pozadinska obrada) zavr≈°ena."); // Ostavljen ovaj log
        }).catch(error => {
             console.error("Gre≈°ka tijekom pozadinskog dohvaƒáanja podataka:", error); // Ostavljen log gre≈°ke
             // Logiraj gre≈°ku pri uƒçitavanju (bez info o nesaƒçuvanom) - MODIFICIRANO
             const appLoadedErrorEventData = { Event: 'app_loaded', Details: JSON.stringify({ status: 'error', fetchError: error.toString() }) };
             sendLogData(appLoadedErrorEventData); // <-- IZMJENA

             console.log("Inicijalizacija zavr≈°ena (s gre≈°kom pozadinskog dohvaƒáanja)."); // Ostavljen ovaj log
             // I dalje a≈æuriraj UI koji ne ovisi o sheet podacima ili koristi default/spremljene vrijednosti
             tekstPoruka = ""; // Resetiraj tekst poruke na prazno ako dohvaƒáanje faila
             updateRunningText(); // Postavit ƒáe se na prazno
             checkSharePrompt(); // Prompt ƒáe se mo≈æda pokazati ako brojaƒç1=0 i brojaƒç2=0
             updateDeactivatedIndicator(); // Ovisno o localStorage stanju
             if (document.body.classList.contains('history-view')) { renderHistoryView(currentlyViewedDate); }
             // Skener UI ƒáe biti a≈æuriran unutar initializeScanner ako je bio aktivan
        });
        console.log("Osnovna inicijalizacija zavr≈°ena (dohvaƒáanje ide u pozadini)."); // Ostavljen ovaj log
    }); // Kraj DOMContentLoaded
    console.log(">>> KRAJ SKRIPTE <<<"); // Ostavljen ovaj log
  </script>

  <!-- Statcounter kod -->
  <script type="text/javascript"> var sc_project=12702047; var sc_invisible=1; var sc_security="e75d2592"; var scJsHost = "https://"; (function() { var sc = document.createElement('script'); sc.type = 'text/javascript'; sc.async = true; sc.src = scJsHost + "statcounter.com/counter/counter.js"; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sc, s); })(); </script>
  <noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12702047/0/e75d2592/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- Kraj Statcounter koda -->

</body>
</html>
